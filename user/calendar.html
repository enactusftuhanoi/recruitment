<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lịch phỏng vấn - Ứng viên</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f6f8; }
    .user-info { display: flex; align-items: center; gap: 15px; background: #fff; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .user-info img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
    #schedule-list { padding: 20px; display: grid; gap: 20px; }
    .schedule-card { background: #fff; border-radius: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .schedule-card h3 { margin: 0 0 10px; }
    .schedule-card p { margin: 4px 0; }
    .schedule-card button { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; }
    .vote-btn { background: #007bff; color: #fff; }
    .edit-btn { background: #ffc107; color: #000; }
    #vote-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
    #vote-modal.hidden { display: none; }
    .modal-content { background: #fff; border-radius: 10px; padding: 20px; width: 400px; max-width: 90%; }
    .modal-content h3 { margin-top: 0; }
    .modal-content label { display: block; margin: 8px 0; }
    .modal-content button { margin-top: 15px; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; }
    #confirm-vote { background: #28a745; color: #fff; }
    #close-modal { background: #dc3545; color: #fff; margin-left: 10px; }
  </style>
</head>
<body>
  <div class="user-info">
    <img id="user-avatar" src="" alt="Avatar">
    <h2 id="user-name"></h2>
    <p id="user-email"></p>
  </div>
  <div id="schedule-list"></div>

  <div id="vote-modal" class="hidden">
    <div class="modal-content">
      <h3 id="modal-title"></h3>
      <p id="modal-details"></p>
      <div id="modal-slots"></div>
      <button id="confirm-vote">Xác nhận</button>
      <button id="close-modal">Đóng</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuTvBn8Xl01DYddVXQ7M0L24K3l-GyG0c",
      authDomain: "enactusftuhanoi-tracuu.firebaseapp.com",
      projectId: "enactusftuhanoi-tracuu",
      storageBucket: "enactusftuhanoi-tracuu.appspot.com",
      messagingSenderId: "611356979403",
      appId: "1:611356979403:web:2c9a4cffb2b323ce3deb4e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "/";
        return;
      }
      currentUser = user;
      document.getElementById('user-avatar').src = user.photoURL || 'default.png';
      document.getElementById('user-name').textContent = user.displayName || '';
      document.getElementById('user-email').textContent = user.email || '';

      loadSchedules();
    });

    async function loadSchedules() {
      const list = document.getElementById('schedule-list');
      list.innerHTML = '';
      const schedulesSnap = await getDocs(collection(db, 'schedules'));
      const userRef = doc(db, 'users', currentUser.uid);
      const userSnap = await getDoc(userRef);
      const userData = userSnap.data() || {};

      schedulesSnap.forEach(docSnap => {
        const s = docSnap.data();
        const voteData = userData.votes?.[docSnap.id];

        const card = document.createElement('div');
        card.className = 'schedule-card';
        card.innerHTML = `
          <h3>${s.title}</h3>
          <p><b>Ngày:</b> ${s.date}</p>
          <p><b>Địa điểm:</b> ${s.location} (${s.type})</p>
          ${s.slots.map((slot, idx) => `<p>Ca ${idx+1}: ${slot.start} - ${slot.end}</p>`).join('')}
          ${voteData ? `<span>✅ Đã vote</span> ${s.allowEdit ? `<button data-id="${docSnap.id}" class="edit-btn">Sửa vote</button>` : ''}` : `<button data-id="${docSnap.id}" class="vote-btn">Vote</button>`}
        `;
        list.appendChild(card);
      });

      document.querySelectorAll('.vote-btn, .edit-btn').forEach(btn => {
        btn.addEventListener('click', () => openVoteModal(btn.dataset.id));
      });
    }

    let currentScheduleId = null;
    function openVoteModal(scheduleId) {
      currentScheduleId = scheduleId;
      document.getElementById('modal-slots').innerHTML = '';
      getDoc(doc(db, 'schedules', scheduleId)).then(snap => {
        if (!snap.exists()) return;
        const s = snap.data();
        document.getElementById('modal-title').textContent = s.title;
        document.getElementById('modal-details').textContent = s.details || '';
        const container = document.getElementById('modal-slots');
        s.slots.forEach((slot, idx) => {
          const label = document.createElement('label');
          label.innerHTML = `<input type="${s.canVoteMultiple ? 'checkbox' : 'radio'}" name="slot" value="${idx}"> Ca ${idx+1}: ${slot.start} - ${slot.end}`;
          container.appendChild(label);
        });
        document.getElementById('vote-modal').classList.remove('hidden');
      });
    }

    document.getElementById('close-modal').onclick = () => {
      document.getElementById('vote-modal').classList.add('hidden');
    };

    document.getElementById('confirm-vote').onclick = async () => {
      const selected = Array.from(document.querySelectorAll('#modal-slots input:checked')).map(i => parseInt(i.value));
      if (!selected.length) {
        alert('Vui lòng chọn ít nhất một ca');
        return;
      }
      const userRef = doc(db, 'users', currentUser.uid);
      const userSnap = await getDoc(userRef);
      const userData = userSnap.data() || {};
      const newVotes = userData.votes || {};
      newVotes[currentScheduleId] = { slots: selected };
      await updateDoc(userRef, {
        votes: newVotes,
        interviewStatus: 'Đã vote lịch'
      });
      document.getElementById('vote-modal').classList.add('hidden');
      loadSchedules();
    };
  </script>
</body>
</html>
