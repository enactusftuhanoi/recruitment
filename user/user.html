<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar | Enactus FTU Hanoi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Clash+Display:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root {
            --primary: #F8F3CE;
            --primary-light: #FFD54F;
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --white: #FFFFFF;
            --error: #EF4444;
            --error-light: #FEE2E2;
            --success: #10B981;
            --success-light: #D1FAE5;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --info: #3B82F6;
            --info-light: #DBEAFE;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        body {
            background-color: var(--gray-50);
            color: var(--gray-800);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background-color: var(--white);
            padding: 16px 24px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 50px;
            width: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--gray-800);
        }

        .logout-btn {
            padding: 8px 16px;
            background-color: var(--gray-100);
            border: none;
            border-radius: var(--border-radius);
            color: var(--gray-700);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }

        .logout-btn:hover {
            background-color: var(--error-light);
            color: var(--error);
        }

        .logout-btn i {
            margin-right: 8px;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background-color: var(--white);
            border-bottom: 1px solid var(--gray-200);
            padding: 0 24px;
        }

        .nav-tab {
            padding: 16px 24px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 2px solid transparent;
        }

        .nav-tab:hover {
            color: var(--gray-800);
        }

        .nav-tab.active {
            color: var(--info);
            border-bottom: 2px solid var(--info);
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Calendar Selector */
        .calendar-selector {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .calendar-selector select {
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 14px;
            background-color: var(--white);
            color: var(--gray-800);
            min-width: 200px;
        }

        /* Calendar View */
        .calendar-view {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background-color: var(--gray-100);
            border-bottom: 1px solid var(--gray-200);
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .calendar-nav button {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--gray-600);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .calendar-nav button:hover {
            background-color: var(--gray-200);
        }

        .calendar-week-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: var(--gray-100);
            border-bottom: 1px solid var(--gray-200);
        }

        .calendar-week-day {
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--gray-700);
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: 120px;
        }

        .calendar-day {
            border-right: 1px solid var(--gray-200);
            border-bottom: 1px solid var(--gray-200);
            padding: 8px;
            overflow-y: auto;
        }

        .calendar-day:last-child {
            border-right: none;
        }

        .calendar-day-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .day-number {
            font-weight: 600;
            color: var(--gray-800);
        }

        .day-events {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .day-event {
            background-color: var(--info-light);
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .day-event:hover {
            background-color: var(--info);
            color: var(--white);
        }

        /* Events List */
        .events-container {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .events-header {
            padding: 16px 20px;
            background-color: var(--gray-100);
            border-bottom: 1px solid var(--gray-200);
        }

        .events-title {
            font-weight: 600;
            color: var(--gray-800);
        }

        .events-list {
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .event-item {
            background-color: var(--gray-50);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .event-item:hover {
            background-color: var(--gray-100);
        }

        .event-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .event-title {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 4px;
        }

        .event-department {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            background-color: var(--info-light);
            color: var(--info);
        }

        .event-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
        }

        .status-active {
            background-color: var(--success-light);
            color: var(--success);
        }

        .status-completed {
            background-color: var(--gray-200);
            color: var(--gray-600);
        }

        .status-hidden {
            background-color: var(--warning-light);
            color: var(--warning);
        }

        .event-details {
            font-size: 12px;
            color: var(--gray-600);
            margin-bottom: 8px;
        }

        .event-slots {
            font-size: 12px;
            color: var(--gray-500);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--white);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-500);
        }

        .modal-body {
            padding: 24px;
        }

        .event-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .event-info-item {
            display: flex;
            flex-direction: column;
        }

        .event-info-label {
            font-size: 12px;
            color: var(--gray-500);
            margin-bottom: 4px;
        }

        .event-info-value {
            font-weight: 500;
            color: var(--gray-800);
        }

        .slots-container {
            margin-bottom: 20px;
        }

        .slot-card {
            background-color: var(--gray-50);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .slot-card:hover {
            background-color: var(--gray-100);
        }

        .slot-card.selected {
            background-color: var(--primary);
            border: 2px solid var(--primary-light);
        }

        .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .slot-title {
            font-weight: 600;
            color: var(--gray-800);
        }

        .slot-votes {
            font-size: 12px;
            color: var(--gray-600);
        }

        .slot-time {
            font-size: 14px;
            color: var(--gray-700);
        }

        .slot-location {
            font-size: 12px;
            color: var(--gray-600);
            margin-top: 4px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary {
            background-color: var(--info);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: var(--gray-100);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background-color: var(--gray-200);
        }

        .btn-success {
            background-color: var(--success);
            color: var(--white);
        }

        .btn-success:hover {
            background-color: #0d9668;
        }

        /* No Events Message */
        .no-events {
            text-align: center;
            padding: 40px 20px;
        }

        .no-events i {
            font-size: 64px;
            color: var(--gray-300);
            margin-bottom: 16px;
        }

        .no-events h3 {
            font-size: 20px;
            color: var(--gray-600);
            margin-bottom: 16px;
        }

        .no-events p {
            color: var(--gray-500);
            margin-bottom: 24px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px 20px;
        }

        .loading i {
            font-size: 32px;
            color: var(--gray-400);
            margin-bottom: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                padding: 12px 16px;
            }
            
            .calendar-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .calendar-selector select {
                width: 100%;
            }
            
            .event-info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <img src="/assets/logo_den.png" alt="Enactus FTU Hanoi Logo">
        </div>
        
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">U</div>
            <button class="logout-btn" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                Đăng xuất
            </button>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-tabs">
        <div class="nav-tab" onclick="window.location.href='profile.html'">
            <i class="fas fa-user" style="margin-right: 8px;"></i>
            Hồ sơ
        </div>
        <div class="nav-tab active">
            <i class="fas fa-calendar-alt" style="margin-right: 8px;"></i>
            Calendar
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div id="loading" class="loading">
            <i class="fas fa-spinner"></i>
            <p>Đang tải lịch...</p>
        </div>

        <div id="calendar-content" style="display: none;">
            <!-- Calendar Selector -->
            <div class="calendar-selector">
                <select id="calendar-select">
                    <option value="">Chọn đợt</option>
                </select>
            </div>

            <!-- Calendar View -->
            <div class="calendar-view">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button id="prev-week"><i class="fas fa-chevron-left"></i></button>
                        <span id="current-week">Tuần 1-7 Tháng 1, 2023</span>
                        <button id="next-week"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="calendar-week-days">
                    <div class="calendar-week-day">Thứ 2</div>
                    <div class="calendar-week-day">Thứ 3</div>
                    <div class="calendar-week-day">Thứ 4</div>
                    <div class="calendar-week-day">Thứ 5</div>
                    <div class="calendar-week-day">Thứ 6</div>
                    <div class="calendar-week-day">Thứ 7</div>
                    <div class="calendar-week-day">Chủ nhật</div>
                </div>
                <div class="calendar-days" id="calendar-days">
                    <!-- Days will be populated by JavaScript -->
                </div>
            </div>

            <!-- Events List -->
            <div class="events-container">
                <div class="events-header">
                    <div class="events-title">Lịch phỏng vấn của bạn</div>
                </div>
                <div class="events-list" id="events-list">
                    <!-- Events will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div id="no-events" class="no-events" style="display: none;">
            <i class="fas fa-calendar-times"></i>
            <h3>Không có lịch phỏng vấn nào</h3>
            <p>Hiện tại không có lịch phỏng vấn nào dành cho bạn. Vui lòng kiểm tra lại sau.</p>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div class="modal" id="event-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="event-detail-title">Chi tiết lịch</h2>
                <button class="modal-close" id="close-event-detail-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="event-info-grid">
                    <div class="event-info-item">
                        <div class="event-info-label">Đợt</div>
                        <div class="event-info-value" id="detail-calendar">Đợt 1</div>
                    </div>
                    <div class="event-info-item">
                        <div class="event-info-label">Ban</div>
                        <div class="event-info-value" id="detail-department">Truyền thông (MD)</div>
                    </div>
                    <div class="event-info-item">
                        <div class="event-info-label">Vòng</div>
                        <div class="event-info-value" id="detail-round">Vòng 2: Phỏng vấn nhóm</div>
                    </div>
                    <div class="event-info-item">
                        <div class="event-info-label">Hình thức</div>
                        <div class="event-info-value" id="detail-format">Online</div>
                    </div>
                    <div class="event-info-item">
                        <div class="event-info-label">Thời gian</div>
                        <div class="event-info-value" id="detail-time">10:00 - 12:00, 15/10/2023</div>
                    </div>
                    <div class="event-info-item">
                        <div class="event-info-label">Trạng thái</div>
                        <div class="event-info-value" id="detail-status">Active</div>
                    </div>
                </div>
                
                <div class="slots-container">
                    <h3 style="margin-bottom: 12px;">Chọn ca phỏng vấn</h3>
                    <div id="detail-slots-container">
                        <!-- Slots will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="close-modal-btn">Đóng</button>
                    <button class="btn btn-success" id="vote-btn" style="display: none;">Vote ca này</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOP2j0qV0Ge-q2-Y9zo9Qc3eLmgtVOK3k",
            authDomain: "recruitment-enactusftuhanoi.firebaseapp.com",
            projectId: "recruitment-enactusftuhanoi",
            storageBucket: "recruitment-enactusftuhanoi.firebasestorage.app",
            messagingSenderId: "658928769643",
            appId: "1:658928769643:web:ef4e26633b7c41c922ef2e",
            measurementId: "G-BJT7ZPKYE3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global variables
        let currentUser = null;
        let userApplication = null;
        let currentCalendar = null;
        let calendars = [];
        let events = [];
        let currentWeekStart = new Date();
        let currentEvent = null;
        let selectedSlot = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Check authentication state
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    document.getElementById('user-avatar').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U';
                    loadUserApplication();
                } else {
                    // Redirect to login if not authenticated
                    window.location.href = 'login.html';
                }
            });
        }

        // Check authentication và quyền truy cập
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in
                document.getElementById('user-avatar').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U';
                
                try {
                    // Kiểm tra quyền truy cập calendar
                    const hasAccess = await checkCalendarAccess(user.email);
                    
                    if (!hasAccess) {
                        alert('Bạn không có quyền truy cập lịch phỏng vấn. Vui lòng liên hệ BTC nếu đây là nhầm lẫn.');
                        window.location.href = 'profile.html';
                        return;
                    }
                    
                    // Kiểm tra lịch đã được công bố chưa
                    const scheduleDoc = await db.collection('system').doc('interview_schedule').get();
                    
                    if (!scheduleDoc.exists || scheduleDoc.data().published !== true) {
                        alert('Lịch phỏng vấn chưa được công bố. Vui lòng quay lại sau.');
                        window.location.href = 'profile.html';
                        return;
                    }
                    
                    // Check if user has an application
                    const snapshot = await db.collection('applications')
                                        .where('email', '==', user.email)
                                        .limit(1)
                                        .get();
                    
                    if (snapshot.empty) {
                        // No application found, redirect to form
                        window.location.href = 'form.html';
                    } else {
                        // Application found
                        applicationData = snapshot.docs[0].data();
                        applicationData.id = snapshot.docs[0].id;
                        
                        // Check if user already has interview schedule
                        if (applicationData.interview_schedule) {
                            selectedSlots = applicationData.interview_schedule;
                        }
                        
                        // Load interview schedule
                        await loadInterviewSchedule();
                        
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('calendar-content').style.display = 'block';
                        
                        // Update selection count
                        updateSelectionCount();
                    }
                } catch (error) {
                    console.error('Error checking application:', error);
                    alert('Có lỗi xảy ra khi kiểm tra thông tin ứng viên');
                }
            } else {
                // User is not signed in, redirect to login
                window.location.href = 'login.html';
            }
        });

        // Kiểm tra quyền truy cập calendar
        async function checkCalendarAccess(userEmail) {
            try {
                const votingCandidate = await db.collection('voting_candidates')
                    .where('email', '==', userEmail)
                    .limit(1)
                    .get();
                    
                return !votingCandidate.empty;
            } catch (error) {
                console.error('Error checking calendar access:', error);
                return false;
            }
        }

        async function loadUserApplication() {
            try {
                console.log('Loading application for:', currentUser.email);
                
                const snapshot = await db.collection('applications')
                    .where('email', '==', currentUser.email)
                    .limit(1)
                    .get();
                
                if (snapshot.empty) {
                    console.log('No application found for:', currentUser.email);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('no-events').style.display = 'block';
                    return;
                }
                
                userApplication = snapshot.docs[0].data();
                userApplication.id = snapshot.docs[0].id;
                console.log('Application loaded:', userApplication);
                
                await loadCalendars();
                setupEventListeners();
                
            } catch (error) {
                console.error('Error loading user application:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('no-events').style.display = 'block';
            }
        }

        async function loadCalendars() {
            try {
                // Load calendars from Firestore
                const snapshot = await db.collection('calendars')
                    .where('is_hidden', '==', false)
                    .get();
                
                calendars = [];
                const calendarSelect = document.getElementById('calendar-select');
                calendarSelect.innerHTML = '<option value="">Chọn đợt</option>';
                
                let hasAccessibleCalendars = false;
                
                snapshot.forEach(doc => {
                    const calendar = { id: doc.id, ...doc.data() };
                    
                    // KIỂM TRA ứng viên có thuộc department được phép truy cập không
                    const userDepartments = [
                        userApplication.priority_position, 
                        userApplication.secondary_position
                    ].filter(Boolean); // Loại bỏ null/undefined
                    
                    const hasAccess = userDepartments.some(dept => 
                        calendar.accessible_departments && 
                        calendar.accessible_departments.includes(dept)
                    );
                    
                    if (hasAccess && !calendar.is_hidden) {
                        calendars.push(calendar);
                        hasAccessibleCalendars = true;
                        
                        const option = document.createElement('option');
                        option.value = calendar.id;
                        option.textContent = calendar.name;
                        calendarSelect.appendChild(option);
                    }
                });
                
                if (hasAccessibleCalendars) {
                    currentCalendar = calendars[0].id;
                    calendarSelect.value = currentCalendar;
                    await loadEvents(); // THÊM await ở đây
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('calendar-content').style.display = 'block';
                } else {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('no-events').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading calendars:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('no-events').style.display = 'block';
            }
        }

        async function loadEvents() {
            if (!currentCalendar) return;
            
            try {
                // Load events from Firestore
                const snapshot = await db.collection('calendar_events')
                    .where('calendar_id', '==', currentCalendar)
                    .where('is_hidden', '==', false)
                    .get();
                
                events = [];
                snapshot.forEach(doc => {
                    const event = { id: doc.id, ...doc.data() };
                    
                    // CHỈ hiển thị events cho department ứng viên apply
                    const isUserDepartment = 
                        event.department === userApplication.priority_position || 
                        event.department === userApplication.secondary_position;
                    
                    // CHỈ hiển thị events chưa bị ẩn (bỏ điều kiện thời gian để test)
                    const isActiveEvent = !event.is_hidden; // TẠM THỜI bỏ điều kiện thời gian
                    
                    if (isUserDepartment && isActiveEvent) {
                        events.push(event);
                    }
                });
                
                console.log('Loaded events:', events); // THÊM log để debug
                
                updateEventsList();
                updateCalendarView();
                
                // Hiển thị content sau khi load xong events
                document.getElementById('loading').style.display = 'none';
                document.getElementById('calendar-content').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('no-events').style.display = 'block';
            }
        }

        function setupEventListeners() {
            // Calendar selector
            document.getElementById('calendar-select').addEventListener('change', function() {
                currentCalendar = this.value;
                loadEvents();
            });

            // Week navigation
            document.getElementById('prev-week').addEventListener('click', function() {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                updateCalendarView();
            });

            document.getElementById('next-week').addEventListener('click', function() {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                updateCalendarView();
            });

            // Logout button
            document.getElementById('logout-btn').addEventListener('click', function() {
                auth.signOut().then(() => {
                    window.location.href = 'login.html';
                });
            });

            // Modal close buttons
            document.getElementById('close-event-detail-modal').addEventListener('click', function() {
                hideModal('event-detail-modal');
            });

            document.getElementById('close-modal-btn').addEventListener('click', function() {
                hideModal('event-detail-modal');
            });

            // Vote button
            document.getElementById('vote-btn').addEventListener('click', voteForSlot);

            // Initialize calendar view
            updateCalendarView();
            document.getElementById('loading').style.display = 'none';
            if (events.length > 0) {
                document.getElementById('calendar-content').style.display = 'block';
            } else {
                document.getElementById('no-events').style.display = 'block';
            }
        }

        function updateCalendarView() {
            const calendarDays = document.getElementById('calendar-days');
            calendarDays.innerHTML = '';
            
            // Calculate the week dates
            const weekStart = new Date(currentWeekStart);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1); // Start from Monday
            
            // Update week display
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const options = { day: 'numeric', month: 'numeric', year: 'numeric' };
            document.getElementById('current-week').textContent = 
                `Tuần ${weekStart.getDate()}-${weekEnd.getDate()} Tháng ${weekStart.getMonth() + 1}, ${weekStart.getFullYear()}`;
            
            // Create day elements
            for (let i = 0; i < 7; i++) {
                const day = new Date(weekStart);
                day.setDate(day.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day.getDate();
                
                dayHeader.appendChild(dayNumber);
                dayElement.appendChild(dayHeader);
                
                const dayEvents = document.createElement('div');
                dayEvents.className = 'day-events';
                
                // Filter events for this day
                const dayEventsList = events.filter(event => {
                    const eventDate = event.start_time.toDate();
                    return eventDate.getDate() === day.getDate() && 
                           eventDate.getMonth() === day.getMonth() && 
                           eventDate.getFullYear() === day.getFullYear();
                });
                
                // Add events to the day
                dayEventsList.forEach(event => {
                    const eventElement = document.createElement('div');
                    eventElement.className = 'day-event';
                    eventElement.textContent = `${event.title} | ${getDepartmentName(event.department)}`;
                    eventElement.addEventListener('click', function() {
                        showEventDetail(event);
                    });
                    dayEvents.appendChild(eventElement);
                });
                
                dayElement.appendChild(dayEvents);
                calendarDays.appendChild(dayElement);
            }
        }

        function updateEventsList() {
            const eventsList = document.getElementById('events-list');
            eventsList.innerHTML = '';
            
            if (events.length === 0) {
                eventsList.innerHTML = '<div class="no-events" style="padding: 20px; text-align: center; color: var(--gray-500);">Không có lịch phỏng vấn nào</div>';
                return;
            }
            
            events.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = 'event-item';
                eventElement.addEventListener('click', function() {
                    showEventDetail(event);
                });
                
                const eventHeader = document.createElement('div');
                eventHeader.className = 'event-item-header';
                
                const eventTitle = document.createElement('div');
                eventTitle.className = 'event-title';
                eventTitle.textContent = event.title;
                
                const eventDepartment = document.createElement('div');
                eventDepartment.className = 'event-department';
                eventDepartment.textContent = getDepartmentName(event.department);
                
                const eventStatus = document.createElement('div');
                eventStatus.className = `event-status ${getEventStatusClass(event)}`;
                eventStatus.textContent = getEventStatusText(event);
                
                eventHeader.appendChild(eventTitle);
                eventHeader.appendChild(eventDepartment);
                eventHeader.appendChild(eventStatus);
                
                const eventDetails = document.createElement('div');
                eventDetails.className = 'event-details';
                eventDetails.textContent = `${getRoundName(event.round)} • ${formatDate(event.start_time.toDate())}`;
                
                const eventSlots = document.createElement('div');
                eventSlots.className = 'event-slots';
                eventSlots.textContent = `Slots: ${event.slots ? event.slots.length : 0}`;
                
                eventElement.appendChild(eventHeader);
                eventElement.appendChild(eventDetails);
                eventElement.appendChild(eventSlots);
                
                eventsList.appendChild(eventElement);
            });
        }

        function showEventDetail(event) {
            currentEvent = event;
            selectedSlot = null;
            
            // Set event details
            document.getElementById('event-detail-title').textContent = event.title;
            document.getElementById('detail-calendar').textContent = getCalendarName(event.calendar_id);
            document.getElementById('detail-department').textContent = getDepartmentName(event.department);
            document.getElementById('detail-round').textContent = getRoundName(event.round);
            document.getElementById('detail-format').textContent = event.format === 'online' ? 'Online' : 'Offline';
            document.getElementById('detail-time').textContent = 
                `${formatDateTime(event.start_time.toDate())} - ${formatTime(event.end_time.toDate())}`;
            document.getElementById('detail-status').textContent = getEventStatusText(event);
            
            // Populate slots
            const slotsContainer = document.getElementById('detail-slots-container');
            slotsContainer.innerHTML = '';
            
            if (event.slots && event.slots.length > 0) {
                event.slots.forEach(slot => {
                    const slotElement = document.createElement('div');
                    slotElement.className = 'slot-card';
                    slotElement.addEventListener('click', function() {
                        selectSlot(slotElement, slot);
                    });
                    
                    const slotHeader = document.createElement('div');
                    slotHeader.className = 'slot-header';
                    
                    const slotTitle = document.createElement('div');
                    slotTitle.className = 'slot-title';
                    slotTitle.textContent = `Ca ${slot.slot_number}`;
                    
                    const slotVotes = document.createElement('div');
                    slotVotes.className = 'slot-votes';
                    slotVotes.textContent = `${slot.votes ? slot.votes.length : 0} người vote`;
                    
                    slotHeader.appendChild(slotTitle);
                    slotHeader.appendChild(slotVotes);
                    
                    const slotTime = document.createElement('div');
                    slotTime.className = 'slot-time';
                    slotTime.textContent = `${slot.date} ${slot.start_time} - ${slot.end_time}`;
                    
                    const slotLocation = document.createElement('div');
                    slotLocation.className = 'slot-location';
                    slotLocation.textContent = event.format === 'online' ? 'Online' : (event.location || 'Chưa cập nhật');
                    
                    slotElement.appendChild(slotHeader);
                    slotElement.appendChild(slotTime);
                    slotElement.appendChild(slotLocation);
                    
                    slotsContainer.appendChild(slotElement);
                    
                    // Check if user has already voted for this slot
                    if (slot.votes && slot.votes.some(vote => vote.email === currentUser.email)) {
                        selectSlot(slotElement, slot);
                    }
                });
                
                // Show vote button if event is not locked
                document.getElementById('vote-btn').style.display = event.is_locked ? 'none' : 'block';
            } else {
                slotsContainer.textContent = 'Chưa có ca nào được tạo';
                document.getElementById('vote-btn').style.display = 'none';
            }
            
            // Show modal
            showModal('event-detail-modal');
        }

        function selectSlot(slotElement, slot) {
            if (currentEvent && currentEvent.is_locked) return;
            
            // Deselect all slots
            document.querySelectorAll('.slot-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select clicked slot
            slotElement.classList.add('selected');
            selectedSlot = slot;
        }

async function voteForSlot() {
    if (!currentEvent || !selectedSlot) {
        alert('Vui lòng chọn một ca để vote');
        return;
    }
    
    if (currentEvent.is_locked) {
        alert('Lịch này đã bị khóa, không thể vote');
        return;
    }
    
    try {
        // KIỂM TRA ứng viên đã vote cho event này chưa
        const eventDoc = await db.collection('calendar_events').doc(currentEvent.id).get();
        const eventData = eventDoc.data();
        
        let alreadyVoted = false;
        let userVoteCount = 0;
        
        eventData.slots.forEach(slot => {
            if (slot.votes) {
                slot.votes.forEach(vote => {
                    if (vote.email === currentUser.email) {
                        userVoteCount++;
                        if (slot.slot_number === selectedSlot.slot_number) {
                            alreadyVoted = true;
                        }
                    }
                });
            }
        });
        
        if (alreadyVoted) {
            alert('Bạn đã vote cho ca này rồi!');
            return;
        }
        
        if (userVoteCount >= 1 && !currentEvent.allow_multiple_slots) {
            alert('Bạn đã vote cho lịch này rồi và không được phép vote nhiều ca!');
            return;
        }
        
        // THÊM vote
        const voteData = {
            fullname: userApplication.fullname,
            email: currentUser.email,
            application_id: userApplication.id,
            department: userApplication.priority_position,
            voted_at: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Tìm index của slot cần update
        const slotIndex = eventData.slots.findIndex(slot => slot.slot_number === selectedSlot.slot_number);
        
        if (slotIndex === -1) {
            alert('Không tìm thấy slot để vote');
            return;
        }
        
        // Tạo array votes mới hoặc thêm vào array hiện có
        const currentVotes = eventData.slots[slotIndex].votes || [];
        const updatedVotes = [...currentVotes, voteData];
        
        await db.collection('calendar_events').doc(currentEvent.id).update({
            [`slots.${slotIndex}.votes`]: updatedVotes
        });
        
        alert('Đã vote thành công!');
        hideModal('event-detail-modal');
        loadEvents();
        
    } catch (error) {
        console.error('Error voting for slot:', error);
        alert('Có lỗi xảy ra khi vote: ' + error.message);
    }
}

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Helper functions
        function getDepartmentName(code) {
            const departments = {
                'MD': 'Truyền thông',
                'HR': 'Nhân sự',
                'PD': 'Dự án',
                'ER': 'Đối ngoại'
            };
            return departments[code] || code;
        }

        function getRoundName(round) {
            const rounds = {
                'round1': 'Vòng 1: Đơn',
                'round2': 'Vòng 2: Phỏng vấn nhóm',
                'round3': 'Vòng 3: Teamwork',
                'round4': 'Vòng 4: Phỏng vấn cá nhân'
            };
            return rounds[round] || round;
        }

        function getCalendarName(calendarId) {
            const calendar = calendars.find(c => c.id === calendarId);
            return calendar ? calendar.name : 'Unknown Calendar';
        }

        function getEventStatusClass(event) {
            if (event.is_hidden) return 'status-hidden';
            if (event.is_locked) return 'status-completed';
            return 'status-active';
        }

        function getEventStatusText(event) {
            if (event.is_hidden) return 'Hidden';
            if (event.is_locked) return 'Completed';
            return 'Active';
        }

        function formatDate(date) {
            return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
        }

        function formatDateTime(date) {
            return `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}, ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
        }

        function formatTime(date) {
            return `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        }
    </script>
</body>
</html>