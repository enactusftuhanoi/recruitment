<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback VÃ²ng 3 | Enactus FTU Hanoi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root {
            --primary: #f8f3ce;
            --primary-light: #ffd54f;
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --white: #ffffff;
            --error: #ef4444;
            --error-light: #fee2e2;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --info: #3b82f6;
            --info-light: #dbeafe;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Plus Jakarta Sans", sans-serif;
        }

        body {
            background-color: var(--gray-50);
            color: var(--gray-800);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background-color: var(--white);
            padding: 16px 24px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 50px;
            width: auto;
        }

        .logo-text {
            margin-left: 12px;
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--gray-800);
        }

        .logout-btn {
            padding: 8px 16px;
            background-color: var(--gray-100);
            border: none;
            border-radius: var(--border-radius);
            color: var(--gray-700);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }

        .logout-btn:hover {
            background-color: var(--error-light);
            color: var(--error);
        }

        .logout-btn i {
            margin-right: 8px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 24px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        /* Feedback Form */
        .feedback-container {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
        }

        .feedback-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
            text-align: center;
        }

        .feedback-subtitle {
            font-size: 16px;
            color: var(--gray-600);
            margin-bottom: 24px;
            text-align: center;
        }

        .section {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 8px;
            font-size: 20px;
        }

        .question {
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 12px;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .option:hover {
            background-color: var(--gray-50);
        }

        .option.selected {
            background-color: var(--primary);
            border-color: var(--primary-light);
        }

        .option input[type="radio"] {
            margin-top: 2px;
        }

        .option label {
            cursor: pointer;
            flex: 1;
        }

        .text-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
        }

        .text-input:focus {
            outline: none;
            border-color: var(--info);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .rating-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 16px 0;
        }

        .rating-option {
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
        }

        .rating-option:hover {
            transform: scale(1.2);
        }

        .rating-option.selected {
            transform: scale(1.2);
            color: var(--warning);
        }

        .tag-input-container {
            position: relative;
        }

        .tag-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .tag-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .tag-suggestion {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-200);
        }

        .tag-suggestion:hover {
            background-color: var(--gray-50);
        }

        .tag-suggestion:last-child {
            border-bottom: none;
        }

        .tag {
            display: inline-block;
            background-color: var(--info-light);
            color: var(--info);
            padding: 4px 8px;
            border-radius: 16px;
            margin: 4px;
            font-size: 14px;
        }

        .tag i {
            margin-left: 6px;
            cursor: pointer;
        }

        .char-counter {
            font-size: 12px;
            color: var(--gray-500);
            text-align: right;
            margin-top: 4px;
        }

        .submit-btn {
            width: 100%;
            padding: 14px;
            background-color: var(--success);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 16px;
        }

        .submit-btn:hover {
            background-color: var(--success-light);
            color: var(--success);
        }

        .submit-btn:disabled {
            background-color: var(--gray-300);
            color: var(--gray-500);
            cursor: not-allowed;
        }

        /* Status Messages */
        .status-message {
            padding: 12px 16px;
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            display: none;
        }

        .status-success {
            background-color: var(--success-light);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-error {
            background-color: var(--error-light);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .status-warning {
            background-color: var(--warning-light);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        /* Access Denied */
        .access-denied {
            text-align: center;
            padding: 60px 24px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .access-denied i {
            font-size: 64px;
            color: var(--error);
            margin-bottom: 24px;
        }

        .access-denied h2 {
            color: var(--error);
            margin-bottom: 16px;
        }

        .access-denied p {
            color: var(--gray-600);
            margin-bottom: 24px;
        }

        /* Footer */
        .footer {
            background-color: var(--white);
            padding: 16px 24px;
            text-align: center;
            color: var(--gray-500);
            font-size: 14px;
            border-top: 1px solid var(--gray-200);
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
            }

            .main-content {
                padding: 16px;
            }

            .feedback-container {
                padding: 16px;
            }

            .rating-container {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <img src="../assets/logo_den.png" alt="Enactus FTU Hanoi Logo">
            <div class="logo-text">Enactus FTU Hanoi</div>
        </div>
        <div class="user-section">
            <div class="user-avatar" id="user-avatar">U</div>
            <button class="logout-btn" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                ÄÄng xuáº¥t
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Status Messages -->
        <div id="status-message" class="status-message"></div>

        <!-- Access Denied (hidden by default) -->
        <div id="access-denied" class="access-denied" style="display: none;">
            <i class="fas fa-lock"></i>
            <h2>KhÃ´ng cÃ³ quyá»n truy cáº­p</h2>
            <p>Báº¡n chÆ°a ÄÆ°á»£c cáº¥p quyá»n Äá» gá»­i feedback hoáº·c khÃ´ng náº±m trong danh sÃ¡ch á»©ng viÃªn vÃ²ng 3.</p>
            <button class="logout-btn" onclick="window.location.href='../dashboard.html'">
                <i class="fas fa-arrow-left"></i>
                Quay vá» Dashboard
            </button>
        </div>

        <!-- Feedback Form (hidden by default) -->
        <div id="feedback-form-container" class="feedback-container" style="display: none;">
            <h1 class="feedback-title">Feedback VÃ²ng 3 - Teamwork</h1>
            <p class="feedback-subtitle">Chia sáº» tráº£i nghiá»m cá»§a báº¡n sau quÃ¡ trÃ¬nh tham gia vÃ²ng 3</p>

            <form id="feedback-form">
                <!-- Pháº§n 1: Reflect báº£n thÃ¢n -->
                <div class="section">
                    <h2 class="section-title">
                        <i class="fas fa-brain"></i>
                        Pháº§n 1. Reflect báº£n thÃ¢n
                    </h2>

                    <!-- CÃ¢u 1 -->
                    <div class="question">
                        <p class="question-text">CÃ¢u 1: Tuáº§n teamwork cá»§a báº¡n lÃ â¦</p>
                        <div class="options-container">
                            <div class="option">
                                <input type="radio" id="q1-option1" name="q1" value="Má»t chuyáº¿n Äi chill ð">
                                <label for="q1-option1">Má»t chuyáº¿n Äi chill ð</label>
                            </div>
                            <div class="option">
                                <input type="radio" id="q1-option2" name="q1" value="Má»t cÆ¡n lá»c deadline ð">
                                <label for="q1-option2">Má»t cÆ¡n lá»c deadline ð</label>
                            </div>
                            <div class="option">
                                <input type="radio" id="q1-option3" name="q1" value="Má»t bÃ i há»c lá»n ð">
                                <label for="q1-option3">Má»t bÃ i há»c lá»n ð</label>
                            </div>
                            <div class="option">
                                <input type="radio" id="q1-option4" name="q1" value="Má»t ká»· niá»m ÄÃ¡ng nhá» ð">
                                <label for="q1-option4">Má»t ká»· niá»m ÄÃ¡ng nhá» ð</label>
                            </div>
                            <div class="option">
                                <input type="radio" id="q1-option5" name="q1" value="Má»t combo cá»§a táº¥t cáº£ nhá»¯ng thá»© trÃªn ð">
                                <label for="q1-option5">Má»t combo cá»§a táº¥t cáº£ nhá»¯ng thá»© trÃªn ð</label>
                            </div>
                        </div>
                    </div>

                    <!-- CÃ¢u 2 -->
                    <div class="question">
                        <p class="question-text">CÃ¢u 2: Báº¡n tháº¥y mÃ¬nh "level up" nháº¥t á» Äiá»m nÃ o sau vÃ²ng nÃ y?</p>
                        <input type="text" class="text-input" id="q2" placeholder="CÃ¢u ngáº¯n (1 dÃ²ng)" maxlength="100">
                    </div>
                </div>

                <!-- Pháº§n 2: Team Lead -->
                <div class="section">
                    <h2 class="section-title">
                        <i class="fas fa-crown"></i>
                        Pháº§n 2. Team Lead
                    </h2>

                    <!-- CÃ¢u 3 -->
                    <div class="question">
                        <p class="question-text">CÃ¢u 3: Náº¿u cháº¥m Äiá»m Team Lead cá»§a báº¡n trÃªn thang ð1â5, báº¡n sáº½ cho bao nhiÃªu?</p>
                        <div class="rating-container">
                            <div class="rating-option" data-value="1">ð</div>
                            <div class="rating-option" data-value="2">ðð</div>
                            <div class="rating-option" data-value="3">ððð</div>
                            <div class="rating-option" data-value="4">ðððð</div>
                            <div class="rating-option" data-value="5">ððððð</div>
                        </div>
                        <input type="hidden" id="q3" name="q3">
                    </div>

                    <!-- CÃ¢u 4 -->
                    <div class="question">
                        <p class="question-text">CÃ¢u 4: Má»t Äiá»u báº¡n thÃ­ch nháº¥t á» Lead lÃ  gÃ¬?</p>
                        <input type="text" class="text-input" id="q4" placeholder="CÃ¢u ngáº¯n (optional)" maxlength="100">
                    </div>
                </div>

                <!-- Pháº§n 3: ThÃ nh viÃªn nhÃ³m -->
                <div class="section">
                    <h2 class="section-title">
                        <i class="fas fa-users"></i>
                        Pháº§n 3. ThÃ nh viÃªn nhÃ³m
                    </h2>

                    <!-- CÃ¢u 5 -->
                    <div class="question">
                        <p class="question-text">CÃ¢u 5: KhÃ´ng khÃ­ lÃ m viá»c cá»§a nhÃ³m báº¡n lÃ  kiá»u:</p>
                        <div class="options-container">
                            <div class="option">
                                <input type="radio" id="q5-option1" name="q5" value="NÄng lÆ°á»£ng dá»i dÃ o ð">
                                <label for="q5-option1">NÄng lÆ°á»£ng dá»i dÃ o ð</label>
                            </div>
                            <div class="option">
                                <input type="radio" id="q5-option2" name="q5" value="Táº­p trung vÃ  nghiÃªm tÃºc ð¤">
                                <label for="q5-option2">Táº­p trung vÃ  nghiÃªm tÃºc ð¤</label>
                            </div>
                            <div class="option">
                                <input type="radio" id="q5-option3" name="q5" value="Chill vÃ  nháº¹ nhÃ ng ð">
                                <label for="q5-option3">Chill vÃ  nháº¹ nhÃ ng ð</label>
                            </div>
                            <div class="option">
                                <input type="radio" id="q5-option4" name="q5" value="Há»n loáº¡n nhÆ°ng ÄÃ¡ng yÃªu ð­">
                                <label for="q5-option4">Há»n loáº¡n nhÆ°ng ÄÃ¡ng yÃªu ð­</label>
                            </div>
                        </div>
                    </div>

                    <!-- CÃ¢u 6 -->
                    <div class="question">
                        <p class="question-text">CÃ¢u 6: HÃ£y tag má»t ngÆ°á»i trong team mÃ  báº¡n tháº¥y ÄÃ¡ng há»c há»i nháº¥t (vÃ  lÃ½ do nhá» xÃ­u nhÃ© ð¬)</p>
                        <div class="tag-input-container">
                            <input type="text" class="text-input tag-input" id="q6-input" placeholder="GÃµ @ Äá» tag thÃ nh viÃªn">
                            <div class="tag-suggestions" id="tag-suggestions"></div>
                        </div>
                        <div id="q6-tags" style="margin-top: 8px;"></div>
                        <input type="hidden" id="q6" name="q6">
                    </div>
                </div>

                <!-- Pháº§n 4: Supporters -->
                <div class="section">
                    <h2 class="section-title">
                        <i class="fas fa-hands-helping"></i>
                        Pháº§n 4. Supporters
                    </h2>

                    <!-- CÃ¢u 7 -->
                    <div class="question">
                        <p class="question-text">CÃ¢u 7: Supporters ÄÃ£ giÃºp team báº¡n tháº¿ nÃ o?</p>
                        <div class="options-container">
                            <div class="option">
                                <input type="radio" id="q7-option1" name="q7" value="Cá»±c ká»³ táº­n tÃ¢m">
                                <label for="q7-option1">Cá»±c ká»³ táº­n tÃ¢m</label>
                            </div>
                            <div class="option">
                                <input type="radio" id="q7-option2" name="q7" value="LuÃ´n sáºµn sÃ ng há» trá»£">
                                <label for="q7-option2">LuÃ´n sáºµn sÃ ng há» trá»£</label>
                            </div>
                            <div class="option">
                                <input type="radio" id="q7-option3" name="q7" value="ÄÃ´i khi hÆ¡i Ã­t tÆ°Æ¡ng tÃ¡c">
                                <label for="q7-option3">ÄÃ´i khi hÆ¡i Ã­t tÆ°Æ¡ng tÃ¡c</label>
                            </div>
                            <div class="option">
                                <input type="radio" id="q7-option4" name="q7" value="KhÃ¡c">
                                <label for="q7-option4">KhÃ¡c (viáº¿t thÃªm náº¿u muá»n)</label>
                            </div>
                        </div>
                        <input type="text" class="text-input" id="q7-other" placeholder="Ghi chÃº thÃªm (náº¿u cÃ³)" style="margin-top: 8px; display: none;" maxlength="100">
                    </div>
                </div>

                <!-- Pháº§n 5: Tráº£i lÃ²ng & gÃ³p Ã½ -->
                <div class="section">
                    <h2 class="section-title">
                        <i class="fas fa-comment-dots"></i>
                        Pháº§n 5. Tráº£i lÃ²ng & gÃ³p Ã½
                    </h2>

                    <!-- CÃ¢u 8 -->
                    <div class="question">
                        <p class="question-text">CÃ¢u 8: Má»t cÃ¢u "tráº£i lÃ²ng" ngáº¯n vá» vÃ²ng 3 nÃ y nÃ¨ ð¬</p>
                        <textarea class="text-input" id="q8" placeholder="Giá»i háº¡n 200 kÃ½ tá»±" rows="3" maxlength="200"></textarea>
                        <div class="char-counter"><span id="q8-counter">0</span>/200</div>
                    </div>

                    <!-- CÃ¢u 9 -->
                    <div class="question">
                        <p class="question-text">CÃ¢u 9: Náº¿u BTC vÃ²ng 3 lÃ  má»t ngÆ°á»i báº¡n, báº¡n muá»n gá»­i gÃ¬ cho há»?</p>
                        <div class="options-container">
                            <div class="option">
                                <input type="checkbox" id="q9-option1" name="q9" value="Cáº£m Æ¡n">
                                <label for="q9-option1">â¤ï¸ Cáº£m Æ¡n</label>
                            </div>
                            <div class="option">
                                <input type="checkbox" id="q9-option2" name="q9" value="GÃ³p Ã½ nhá»">
                                <label for="q9-option2">ð¡ GÃ³p Ã½ nhá»</label>
                            </div>
                            <div class="option">
                                <input type="checkbox" id="q9-option3" name="q9" value="Cáº£ hai">
                                <label for="q9-option3">ð Cáº£ hai</label>
                            </div>
                        </div>
                        <textarea class="text-input" id="q9-details" placeholder="Chi tiáº¿t gÃ³p Ã½ (náº¿u cÃ³)" rows="3" style="margin-top: 8px; display: none;" maxlength="300"></textarea>
                        <div class="char-counter"><span id="q9-counter">0</span>/300</div>
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="submit-btn" disabled>Gá»­i Feedback</button>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        Â© 2023 Enactus FTU Hanoi. All rights reserved.
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOP2j0qV0Ge-q2-Y9zo9Qc3eLmgtVOK3k",
            authDomain: "recruitment-enactusftuhanoi.firebaseapp.com",
            projectId: "recruitment-enactusftuhanoi",
            storageBucket: "recruitment-enactusftuhanoi.firebasestorage.app",
            messagingSenderId: "658928769643",
            appId: "1:658928769643:web:ef4e26633b7c41c922ef2e",
            measurementId: "G-BJT7ZPKYE3",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global State
        const userEmail = sessionStorage.getItem("email");
        let userRole = sessionStorage.getItem("role") || null;
        let currentUser = null;
        let teamMembers = [];
        let feedbackSubmitted = false;

        // Check authentication
        if (!userEmail || !userRole) {
            window.location.href = "../login.html";
        }

        // Auth state listener
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const snap = await db
                        .collection("account")
                        .where("email", "==", user.email)
                        .limit(1)
                        .get();

                    if (!snap.empty) {
                        const doc = snap.docs[0];
                        const data = doc.data();

                        userRole = data.role || userRole;
                        currentUser = {
                            id: doc.id,
                            ...data
                        };

                        // Update session storage
                        sessionStorage.setItem("role", userRole);
                        sessionStorage.setItem("department", data.department || "");

                        // Update UI
                        updateUserInfo(currentUser.fullname || currentUser.email);

                        // Check if user is eligible for feedback
                        await checkEligibility();
                    } else {
                        // Account doesn't exist
                        await auth.signOut();
                        window.location.href = "../login.html";
                        return;
                    }
                } catch (e) {
                    console.error("Lá»i khi láº¥y account:", e);
                    showStatus("CÃ³ lá»i xáº£y ra khi táº£i thÃ´ng tin ngÆ°á»i dÃ¹ng", "error");
                }
            } else {
                window.location.href = "../login.html";
            }
        });

        // Update user info in the header
        function updateUserInfo(fullname) {
            const userAvatarEl = document.getElementById("user-avatar");
            if (userAvatarEl) userAvatarEl.textContent = fullname.charAt(0).toUpperCase();
        }

        // Check if user is eligible for feedback
        async function checkEligibility() {
            try {
                // Check if user is in round 3 and has a team
                const appSnapshot = await db
                    .collection("applications")
                    .where("email", "==", currentUser.email)
                    .limit(1)
                    .get();

                if (appSnapshot.empty) {
                    showAccessDenied();
                    return;
                }

                const appDoc = appSnapshot.docs[0];
                const appData = appDoc.data();

                if (appData.current_round !== "round3") {
                    showAccessDenied();
                    return;
                }

                if (!appData.round3 || !appData.round3.team) {
                    showAccessDenied();
                    return;
                }

                // Check if user has permission
                if (!appData.feedback_permission) {
                    showAccessDenied();
                    return;
                }

                // Get team members
                await loadTeamMembers(appData.round3.team);

                // Check if feedback already submitted
                await checkFeedbackSubmission(appDoc.id);

                // Show feedback form
                showFeedbackForm();

            } catch (error) {
                console.error("Lá»i khi kiá»m tra Äiá»u kiá»n:", error);
                showStatus("CÃ³ lá»i xáº£y ra khi kiá»m tra Äiá»u kiá»n", "error");
            }
        }

        // Load team members for tagging
        async function loadTeamMembers(teamName) {
            try {
                const teamSnapshot = await db
                    .collection("applications")
                    .where("round3.team", "==", teamName)
                    .get();

                teamMembers = [];
                teamSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.email !== currentUser.email) { // Exclude current user
                        teamMembers.push({
                            id: doc.id,
                            name: data.fullname,
                            email: data.email
                        });
                    }
                });

                console.log("Team members loaded:", teamMembers);
            } catch (error) {
                console.error("Lá»i khi táº£i danh sÃ¡ch thÃ nh viÃªn:", error);
            }
        }

        // Check if feedback already submitted
        async function checkFeedbackSubmission(appId) {
            try {
                const feedbackSnapshot = await db
                    .collection("feedback")
                    .where("applicantId", "==", appId)
                    .limit(1)
                    .get();

                if (!feedbackSnapshot.empty) {
                    feedbackSubmitted = true;
                    showStatus("Báº¡n ÄÃ£ gá»­i feedback trÆ°á»c ÄÃ³. Cáº£m Æ¡n báº¡n ÄÃ£ ÄÃ³ng gÃ³p Ã½ kiáº¿n!", "success");
                    document.getElementById("submit-btn").disabled = true;
                    document.getElementById("submit-btn").textContent = "ÄÃ£ gá»­i Feedback";
                }
            } catch (error) {
                console.error("Lá»i khi kiá»m tra feedback:", error);
            }
        }

        // Show access denied message
        function showAccessDenied() {
            document.getElementById("access-denied").style.display = "block";
            document.getElementById("feedback-form-container").style.display = "none";
        }

        // Show feedback form
        function showFeedbackForm() {
            document.getElementById("access-denied").style.display = "none";
            document.getElementById("feedback-form-container").style.display = "block";
            document.getElementById("submit-btn").disabled = false;
        }

        // Show status message
        function showStatus(message, type) {
            const statusEl = document.getElementById("status-message");
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = "block";

            // Auto hide after 5 seconds for success messages
            if (type === "success") {
                setTimeout(() => {
                    statusEl.style.display = "none";
                }, 5000);
            }
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', function() {
                auth.signOut().then(() => {
                    sessionStorage.clear();
                    window.location.href = "../login.html";
                });
            });

            // Rating options
            document.querySelectorAll('.rating-option').forEach(option => {
                option.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    document.getElementById('q3').value = value;
                    
                    // Update UI
                    document.querySelectorAll('.rating-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
            });

            // Option selection styling
            document.querySelectorAll('.option input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    // Remove selected class from all options in this question
                    const questionOptions = this.closest('.options-container').querySelectorAll('.option');
                    questionOptions.forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to current option
                    this.closest('.option').classList.add('selected');
                    
                    // Show/hide other input for question 7
                    if (this.name === 'q7' && this.value === 'KhÃ¡c') {
                        document.getElementById('q7-other').style.display = 'block';
                    } else if (this.name === 'q7') {
                        document.getElementById('q7-other').style.display = 'none';
                    }
                });
            });

            // Character counters
            document.getElementById('q8').addEventListener('input', function() {
                document.getElementById('q8-counter').textContent = this.value.length;
            });

            document.getElementById('q9-details').addEventListener('input', function() {
                document.getElementById('q9-counter').textContent = this.value.length;
            });

            // Question 9 checkboxes
            document.querySelectorAll('#q9-option1, #q9-option2, #q9-option3').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const detailsEl = document.getElementById('q9-details');
                    const anyChecked = document.querySelectorAll('input[name="q9"]:checked').length > 0;
                    
                    if (anyChecked) {
                        detailsEl.style.display = 'block';
                    } else {
                        detailsEl.style.display = 'none';
                    }
                });
            });

            // Tag input for question 6
            const tagInput = document.getElementById('q6-input');
            const tagSuggestions = document.getElementById('tag-suggestions');
            const tagsContainer = document.getElementById('q6-tags');
            const hiddenInput = document.getElementById('q6');
            let selectedTags = [];

            tagInput.addEventListener('input', function() {
                const value = this.value;
                
                if (value.includes('@')) {
                    const searchTerm = value.split('@').pop().toLowerCase();
                    
                    if (searchTerm.length > 0) {
                        const filteredMembers = teamMembers.filter(member => 
                            member.name.toLowerCase().includes(searchTerm)
                        );
                        
                        showTagSuggestions(filteredMembers);
                    } else {
                        showTagSuggestions(teamMembers);
                    }
                } else {
                    hideTagSuggestions();
                }
            });

            tagInput.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && this.value === '' && selectedTags.length > 0) {
                    // Remove last tag when backspace is pressed on empty input
                    removeTag(selectedTags[selectedTags.length - 1].id);
                }
            });

            function showTagSuggestions(members) {
                tagSuggestions.innerHTML = '';
                
                if (members.length === 0) {
                    tagSuggestions.innerHTML = '<div class="tag-suggestion">KhÃ´ng tÃ¬m tháº¥y thÃ nh viÃªn</div>';
                } else {
                    members.forEach(member => {
                        // Skip if already tagged
                        if (selectedTags.some(tag => tag.id === member.id)) return;
                        
                        const div = document.createElement('div');
                        div.className = 'tag-suggestion';
                        div.textContent = member.name;
                        div.addEventListener('click', () => {
                            addTag(member);
                            tagInput.value = '';
                            hideTagSuggestions();
                        });
                        tagSuggestions.appendChild(div);
                    });
                }
                
                tagSuggestions.style.display = 'block';
            }

            function hideTagSuggestions() {
                tagSuggestions.style.display = 'none';
            }

            function addTag(member) {
                // Check if already tagged
                if (selectedTags.some(tag => tag.id === member.id)) return;
                
                selectedTags.push(member);
                updateTagsDisplay();
            }

            function removeTag(memberId) {
                selectedTags = selectedTags.filter(tag => tag.id !== memberId);
                updateTagsDisplay();
            }

            function updateTagsDisplay() {
                tagsContainer.innerHTML = '';
                selectedTags.forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'tag';
                    tagEl.innerHTML = `${tag.name} <i class="fas fa-times"></i>`;
                    tagEl.querySelector('i').addEventListener('click', () => removeTag(tag.id));
                    tagsContainer.appendChild(tagEl);
                });
                
                // Update hidden input
                hiddenInput.value = JSON.stringify(selectedTags);
            }

            // Form submission
            document.getElementById('feedback-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (feedbackSubmitted) {
                    showStatus("Báº¡n ÄÃ£ gá»­i feedback trÆ°á»c ÄÃ³", "error");
                    return;
                }

                // Validate form
                if (!validateForm()) {
                    return;
                }

                // Get application ID
                const appSnapshot = await db
                    .collection("applications")
                    .where("email", "==", currentUser.email)
                    .limit(1)
                    .get();

                if (appSnapshot.empty) {
                    showStatus("KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin á»©ng viÃªn", "error");
                    return;
                }

                const appDoc = appSnapshot.docs[0];
                const appData = appDoc.data();

                // Prepare feedback data
                const feedbackData = {
                    applicantId: appDoc.id,
                    applicantName: appData.fullname,
                    applicantEmail: appData.email,
                    team: appData.round3?.team || "KhÃ´ng xÃ¡c Äá»nh",
                    timestamp: new Date(),
                    q1: document.querySelector('input[name="q1"]:checked')?.value || "",
                    q2: document.getElementById('q2').value,
                    q3: document.getElementById('q3').value,
                    q4: document.getElementById('q4').value,
                    q5: document.querySelector('input[name="q5"]:checked')?.value || "",
                    q6: selectedTags,
                    q7: document.querySelector('input[name="q7"]:checked')?.value === 'KhÃ¡c' 
                         ? document.getElementById('q7-other').value 
                         : document.querySelector('input[name="q7"]:checked')?.value || "",
                    q8: document.getElementById('q8').value,
                    q9: Array.from(document.querySelectorAll('input[name="q9"]:checked')).map(cb => cb.value),
                    q9Details: document.getElementById('q9-details').value
                };

                // Submit to Firebase
                try {
                    await db.collection("feedback").add(feedbackData);
                    feedbackSubmitted = true;
                    showStatus("Cáº£m Æ¡n báº¡n ÄÃ£ gá»­i feedback! Ã kiáº¿n cá»§a báº¡n ráº¥t quan trá»ng vá»i chÃºng mÃ¬nh â¤ï¸", "success");
                    document.getElementById("submit-btn").disabled = true;
                    document.getElementById("submit-btn").textContent = "ÄÃ£ gá»­i Feedback";
                } catch (error) {
                    console.error("Lá»i khi gá»­i feedback:", error);
                    showStatus("CÃ³ lá»i xáº£y ra khi gá»­i feedback. Vui lÃ²ng thá»­ láº¡i!", "error");
                }
            });
        });

        // Form validation
        function validateForm() {
            // Check required fields
            if (!document.querySelector('input[name="q1"]:checked')) {
                showStatus("Vui lÃ²ng tráº£ lá»i CÃ¢u 1", "error");
                return false;
            }

            if (!document.getElementById('q2').value.trim()) {
                showStatus("Vui lÃ²ng tráº£ lá»i CÃ¢u 2", "error");
                return false;
            }

            if (!document.getElementById('q3').value) {
                showStatus("Vui lÃ²ng cháº¥m Äiá»m Team Lead (CÃ¢u 3)", "error");
                return false;
            }

            if (!document.querySelector('input[name="q5"]:checked')) {
                showStatus("Vui lÃ²ng tráº£ lá»i CÃ¢u 5", "error");
                return false;
            }

            if (!document.querySelector('input[name="q7"]:checked')) {
                showStatus("Vui lÃ²ng tráº£ lá»i CÃ¢u 7", "error");
                return false;
            }

            if (!document.getElementById('q8').value.trim()) {
                showStatus("Vui lÃ²ng tráº£ lá»i CÃ¢u 8", "error");
                return false;
            }

            return true;
        }
    </script>
</body>
</html>