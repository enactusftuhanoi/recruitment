<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | Enactus FTU Hanoi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Clash+Display:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root {
            --primary: #F8F3CE;
            --primary-light: #FFD54F;
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --white: #FFFFFF;
            --error: #EF4444;
            --error-light: #FEE2E2;
            --success: #10B981;
            --success-light: #D1FAE5;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --info: #3B82F6;
            --info-light: #DBEAFE;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        body {
            background-color: var(--gray-50);
            color: var(--gray-800);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background-color: var(--white);
            padding: 16px 24px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 50px;
            width: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--gray-800);
        }

        .logout-btn {
            padding: 8px 16px;
            background-color: var(--gray-100);
            border: none;
            border-radius: var(--border-radius);
            color: var(--gray-700);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }

        .logout-btn:hover {
            background-color: var(--error-light);
            color: var(--error);
        }

        .logout-btn i {
            margin-right: 8px;
        }

        /* Main Content */
        .main-content {
            max-width: 1000px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Profile Card */
        .profile-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 600;
            color: var(--gray-800);
            margin-right: 20px;
        }

        .profile-details h2 {
            font-family: 'Clash Display', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .profile-details p {
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .profile-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-top: 8px;
        }

        .status-new {
            background-color: var(--info-light);
            color: var(--info);
        }

        .status-pending {
            background-color: var(--warning-light);
            color: var(--warning);
        }

        .status-pass {
            background-color: var(--success-light);
            color: var(--success);
        }

        .status-not-pass {
            background-color: var(--error-light);
            color: var(--error);
        }

        .status-interviewed {
            background-color: var(--info-light);
            color: var(--info);
        }

        .status-voted {
            background-color: var(--primary);
            color: var(--gray-800);
        }

        .status-success {
            background-color: var(--primary);
            color: var(--gray-800);
            font-weight: bold;
        }

        /* Application Info */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .info-item {
            padding: 16px;
            background-color: var(--gray-50);
            border-radius: var(--border-radius);
        }

        .info-label {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 8px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 500;
            color: var(--gray-800);
        }

        /* Round Progress */
        .rounds-container {
            margin-top: 32px;
        }

        .rounds-title {
            font-family: 'Clash Display', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--gray-200);
        }

        .round-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
            transition: var(--transition);
        }

        .round-card:last-child {
            margin-bottom: 0;
        }

        .round-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            cursor: pointer;
        }

        .round-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .round-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .round-details {
            display: none;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--gray-200);
        }

        .round-details.active {
            display: block;
        }

        .detail-item {
            margin-bottom: 12px;
        }

        .detail-label {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 16px;
            color: var(--gray-800);
        }

        /* No Application Message */
        .no-application {
            text-align: center;
            padding: 40px 20px;
        }

        .no-application i {
            font-size: 64px;
            color: var(--gray-300);
            margin-bottom: 16px;
        }

        .no-application h3 {
            font-size: 20px;
            color: var(--gray-600);
            margin-bottom: 16px;
        }

        .no-application p {
            color: var(--gray-500);
            margin-bottom: 24px;
        }

        .action-btn {
            padding: 12px 24px;
            background-color: var(--primary);
            border: none;
            border-radius: var(--border-radius);
            color: var(--gray-800);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-block;
        }

        .action-btn:hover {
            background-color: var(--primary-light);
        }

        .notification-card {
            background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
            border: 2px solid #FFD54F;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .notification-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .notification-header h3 {
            font-family: 'Clash Display', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            margin-left: 12px;
        }

        .notification-content p {
            margin-bottom: 8px;
            color: var(--gray-700);
        }

        .notification-actions {
            margin-top: 16px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--gray-800);
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px 20px;
        }

        .loading i {
            font-size: 32px;
            color: var(--gray-400);
            margin-bottom: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-avatar {
                margin-right: 0;
                margin-bottom: 16px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <img src="/assets/logo_den.png" alt="Enactus FTU Hanoi Logo">
        </div>
        
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">U</div>
            <button class="logout-btn" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                ƒêƒÉng xu·∫•t
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div id="loading" class="loading">
            <i class="fas fa-spinner"></i>
            <p>ƒêang t·∫£i th√¥ng tin...</p>
        </div>

        <div id="profile-content" style="display: none;">
            <!-- Interview Schedule Notification - ƒê∆ØA L√äN TR√äN C√ôNG -->
            <div id="interview-notification" class="notification-card" style="display: none;">
                <div class="notification-header">
                    <i class="fas fa-calendar-alt" style="color: #FFD54F; font-size: 24px;"></i>
                    <h3>Ch·ªçn l·ªãch ph·ªèng v·∫•n</h3>
                </div>
                <div class="notification-content">
                    <p>Ban t·ªï ch·ª©c ƒë√£ c√¥ng b·ªë l·ªãch ph·ªèng v·∫•n. Vui l√≤ng ch·ªçn √≠t nh·∫•t 3 khung gi·ªù ph·ªèng v·∫•n m√† b·∫°n c√≥ th·ªÉ tham gia.</p>
                    <p><strong>Th·ªùi h·∫°n:</strong> <span id="notification-deadline">ƒêang c·∫≠p nh·∫≠t</span></p>
                </div>
                <div class="notification-actions">
                    <button class="btn btn-primary" id="go-to-calendar-btn">
                        <i class="fas fa-arrow-right"></i>
                         Ch·ªçn l·ªãch ph·ªèng v·∫•n
                    </button>
                </div>
            </div>

            <!-- Vote Status Card -->
            <div id="vote-status" class="notification-card" style="display: none; background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%); border: 2px solid #10B981;">
                <div class="notification-header">
                    <i class="fas fa-check-circle" style="color: #10B981; font-size: 24px;"></i>
                    <h3>ƒê√£ ch·ªçn l·ªãch ph·ªèng v·∫•n</h3>
                </div>
                <div class="notification-content">
                    <p>B·∫°n ƒë√£ ho√†n th√†nh vi·ªác ch·ªçn l·ªãch ph·ªèng v·∫•n. BTC s·∫Ω li√™n h·ªá v·ªõi b·∫°n ƒë·ªÉ x√°c nh·∫≠n l·ªãch ph·ªèng v·∫•n ch√≠nh th·ª©c.</p>
                    <p><strong>S·ªë ca ƒë√£ ch·ªçn:</strong> <span id="selected-slots-count">0</span>/3 ca</p>
                </div>
                <div class="notification-actions">
                    <button class="btn btn-secondary" id="view-calendar-btn">
                        <i class="fas fa-eye"></i>
                        Xem l·∫°i l·ªãch ƒë√£ ch·ªçn
                    </button>
                </div>
            </div>

            <!-- Profile Card -->
            <div class="profile-card">
                <div class="profile-header">
                    <div class="profile-avatar" id="profile-avatar">U</div>
                    <div class="profile-details">
                        <h2 id="profile-name">H·ªç t√™n ·ª©ng vi√™n</h2>
                        <p id="profile-email">email@example.com</p>
                        <p id="profile-phone">0123456789</p>
                        <span class="profile-status" id="profile-status">ƒêang x·ª≠ l√Ω</span>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Nguy·ªán v·ªçng 1</div>
                        <div class="info-value" id="priority-department">Ch∆∞a c√≥ th√¥ng tin</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Nguy·ªán v·ªçng 2</div>
                        <div class="info-value" id="secondary-department">Ch∆∞a c√≥ th√¥ng tin</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">V√≤ng hi·ªán t·∫°i</div>
                        <div class="info-value" id="current-round">Ch∆∞a c√≥ th√¥ng tin</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Th·ªùi gian ·ª©ng tuy·ªÉn</div>
                        <div class="info-value" id="application-time">Ch∆∞a c√≥ th√¥ng tin</div>
                    </div>
                </div>
            </div>

            <!-- Rounds Progress -->
            <div class="rounds-container">
                <h3 class="rounds-title">Qu√° tr√¨nh ·ª©ng tuy·ªÉn</h3>
                <div id="rounds-list">
                    <!-- Rounds will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div id="no-application" class="no-application" style="display: none;">
            <i class="fas fa-file-alt"></i>
            <h3>B·∫°n ch∆∞a ƒëi·ªÅn ƒë∆°n ·ª©ng tuy·ªÉn</h3>
            <p>H√£y ƒëi·ªÅn ƒë∆°n ·ª©ng tuy·ªÉn ƒë·ªÉ tham gia v√†o qu√° tr√¨nh tuy·ªÉn th√†nh vi√™n c·ªßa Enactus FTU Hanoi</p>
            <a href="/user/form.html" class="action-btn">ƒêi·ªÅn ƒë∆°n ngay</a>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOP2j0qV0Ge-q2-Y9zo9Qc3eLmgtVOK3k",
            authDomain: "recruitment-enactusftuhanoi.firebaseapp.com",
            projectId: "recruitment-enactusftuhanoi",
            storageBucket: "recruitment-enactusftuhanoi.firebasestorage.app",
            messagingSenderId: "658928769643",
            appId: "1:658928769643:web:ef4e26633b7c41c922ef2e",
            measurementId: "G-BJT7ZPKYE3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global State
        let userData = null;
        let applicationData = null;

        // Check authentication
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in
                document.getElementById('user-avatar').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U';
                
                try {
                    // Check if user has an application
                    const snapshot = await db.collection('applications')
                                          .where('email', '==', user.email)
                                          .limit(1)
                                          .get();
                    
                    if (snapshot.empty) {
                        // No application found
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('no-application').style.display = 'block';
                    } else {
                        // Application found
                        applicationData = snapshot.docs[0].data();
                        applicationData.id = snapshot.docs[0].id;
                        
                        // Load user data
                        await loadUserData(user);
                        
                        // Render application data
                        renderApplicationData();

                        checkInterviewNotification();
                        
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('profile-content').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error checking application:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra th√¥ng tin ·ª©ng vi√™n');
                }
            } else {
                // User is not signed in, redirect to login
                window.location.href = 'login.html';
            }
        });

        // Load user data
        async function loadUserData(user) {
            userData = {
                displayName: user.displayName,
                email: user.email,
                photoURL: user.photoURL
            };
            
            // Update avatar
            const avatarElement = document.getElementById('profile-avatar');
            if (user.photoURL) {
                avatarElement.style.backgroundImage = `url(${user.photoURL})`;
                avatarElement.style.backgroundSize = 'cover';
                avatarElement.textContent = '';
            } else {
                avatarElement.textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U';
            }
        }

        // Render application data
function renderApplicationData() {
    if (!applicationData) return;
    
    // Basic info
    document.getElementById('profile-name').textContent = applicationData.fullname || 'Kh√¥ng c√≥ d·ªØ li·ªáu';
    document.getElementById('profile-email').textContent = applicationData.email || 'Kh√¥ng c√≥ d·ªØ li·ªáu';
    document.getElementById('profile-phone').textContent = applicationData.phone || 'Kh√¥ng c√≥ d·ªØ li·ªáu';
    
    // Departments
    document.getElementById('priority-department').textContent = getDepartmentName(applicationData.priority_position) || 'Kh√¥ng c√≥ d·ªØ li·ªáu';
    document.getElementById('secondary-department').textContent = getDepartmentName(applicationData.secondary_position) || 'Kh√¥ng c√≥ d·ªØ li·ªáu';
    
    // Current round and status
    const currentRound = applicationData.current_round || 'round1';
    document.getElementById('current-round').textContent = getRoundText(currentRound);
    
    const status = computeOverallStatus(applicationData);
    const statusElement = document.getElementById('profile-status');
    statusElement.textContent = getStatusText(status);
    statusElement.className = `profile-status ${getStatusClass(status)}`;
    
    // Application time - FIXED
    if (applicationData.timestamp) {
        let date;
        try {
            // Ki·ªÉm tra n·∫øu l√† Firebase Timestamp
            if (applicationData.timestamp.toDate && typeof applicationData.timestamp.toDate === 'function') {
                date = applicationData.timestamp.toDate();
            } else if (applicationData.timestamp.seconds) {
                // N·∫øu l√† object c√≥ seconds (Firestore timestamp)
                date = new Date(applicationData.timestamp.seconds * 1000);
            } else if (typeof applicationData.timestamp === 'string') {
                // N·∫øu l√† string
                date = new Date(applicationData.timestamp);
            } else if (typeof applicationData.timestamp === 'number') {
                // N·∫øu l√† timestamp number
                date = new Date(applicationData.timestamp);
            } else {
                date = new Date();
            }
            document.getElementById('application-time').textContent = date.toLocaleDateString('vi-VN');
        } catch (error) {
            console.error('Error parsing timestamp:', error);
            document.getElementById('application-time').textContent = 'Ch∆∞a c√≥ th√¥ng tin';
        }
    } else {
        document.getElementById('application-time').textContent = 'Ch∆∞a c√≥ th√¥ng tin';
    }
    
    // Render rounds
    renderRounds();
}

        function isEliminatedBefore(type, roundNumber) {
            if (!applicationData) return false;
            for (let i = 1; i < roundNumber; i++) {
                const st = applicationData['round' + i + '_' + type + '_status'];
                if (st === 'not-pass') return true;
            }
            return false;
        }


        /* ---------- DOM helpers ---------- */
        function createDetailItem(label, value) {
            var wrap = document.createElement('div');
            wrap.className = 'detail-item';
            var lab = document.createElement('div');
            lab.className = 'detail-label';
            lab.textContent = label;
            var val = document.createElement('div');
            val.className = 'detail-value';
            val.textContent = value;
            wrap.appendChild(lab);
            wrap.appendChild(val);
            return wrap;
        }

        /* ---------- build fragment chi ti·∫øt cho 1 v√≤ng (kh√¥ng d√πng innerHTML) ---------- */
        function buildRoundDetailsFragment(roundId) {
            var frag = document.createDocumentFragment();
            if (!applicationData) {
                frag.appendChild(createDetailItem('', 'Ch∆∞a c√≥ th√¥ng tin chi ti·∫øt'));
                return frag;
            }

            if (roundId === 'round1') {
                ['priority', 'secondary'].forEach(function(type) {
                    var dept = (type === 'priority' ? applicationData.priority_position : applicationData.secondary_position);
                    if (!dept) return;
                    var status = getRound1Status(type);
                    frag.appendChild(createDetailItem('Ban ' + getDepartmentName(dept) + ' (' + type + ')', 'Tr·∫°ng th√°i: ' + getStatusText(status)));
                });
                frag.appendChild(createDetailItem('H√¨nh th·ª©c ·ª©ng tuy·ªÉn', applicationData.application_type || 'Form tr·ª±c tuy·∫øn'));
                
                var ts = 'ƒêang c·∫≠p nh·∫≠t';
                if (applicationData.timestamp) {
                    try {
                        let date;
                        if (applicationData.timestamp.toDate && typeof applicationData.timestamp.toDate === 'function') {
                            date = applicationData.timestamp.toDate();
                        } else if (applicationData.timestamp.seconds) {
                            date = new Date(applicationData.timestamp.seconds * 1000);
                        } else if (typeof applicationData.timestamp === 'string') {
                            date = new Date(applicationData.timestamp);
                        } else if (typeof applicationData.timestamp === 'number') {
                            date = new Date(applicationData.timestamp);
                        }
                        if (date) {
                            ts = date.toLocaleString('vi-VN');
                        }
                    } catch (error) {
                        console.error('Error parsing timestamp:', error);
                    }
                }
                frag.appendChild(createDetailItem('Th·ªùi gian n·ªôp ƒë∆°n', ts));
                return frag;
            }

            if (roundId === 'round2' || roundId === 'round3' || roundId === 'round4') {
                var roundObj = applicationData[roundId] || {};
                var roundNum = (roundId === 'round2' ? 2 : (roundId === 'round3' ? 3 : 4));
                ['priority', 'secondary'].forEach(function(type) {
                    if (isEliminatedBefore(type, roundNum)) return; // n·∫øu ban ƒë√£ out tr∆∞·ªõc ƒë√≥ th√¨ ko show detail
                    var dept = (type === 'priority' ? applicationData.priority_position : applicationData.secondary_position);
                    if (!dept) return;
                    var data = roundObj[type] || {};
                    var status = applicationData[roundId + '_' + type + '_status'] || 'pending';
                    frag.appendChild(createDetailItem('Ban ' + getDepartmentName(dept) + ' (' + type + ')', 'Tr·∫°ng th√°i: ' + getStatusText(status)));

                    if (roundId === 'round2') {
                        frag.appendChild(createDetailItem('Th·ªùi gian', data.time || 'ƒêang c·∫≠p nh·∫≠t'));
                        frag.appendChild(createDetailItem('ƒê·ªãa ƒëi·ªÉm', data.location || 'ƒêang c·∫≠p nh·∫≠t'));
                        frag.appendChild(createDetailItem('Ghi ch√∫', data.note || 'Kh√¥ng c√≥'));
                    } else if (roundId === 'round3') {
                        frag.appendChild(createDetailItem('Th·ª≠ th√°ch', data.challenge || 'ƒêang c·∫≠p nh·∫≠t'));
                        frag.appendChild(createDetailItem('Th·ªùi h·∫°n', data.deadline || 'ƒêang c·∫≠p nh·∫≠t'));
                        frag.appendChild(createDetailItem('H∆∞·ªõng d·∫´n', data.instructions || 'ƒêang c·∫≠p nh·∫≠t'));
                    } else if (roundId === 'round4') {
                        frag.appendChild(createDetailItem('Th·ªùi gian', data.time || 'ƒêang c·∫≠p nh·∫≠t'));
                        frag.appendChild(createDetailItem('ƒê·ªãa ƒëi·ªÉm', data.location || 'ƒêang c·∫≠p nh·∫≠t'));
                        frag.appendChild(createDetailItem('Ng∆∞·ªùi ph·ªèng v·∫•n', data.interviewer || 'ƒêang c·∫≠p nh·∫≠t'));
                        frag.appendChild(createDetailItem('H√¨nh th·ª©c', data.method || 'ƒêang c·∫≠p nh·∫≠t'));
                        frag.appendChild(createDetailItem('Ghi ch√∫', data.note || 'Kh√¥ng c√≥'));
                    }
                });
                return frag;
            }

            if (roundId === 'success') {
                frag.appendChild(createDetailItem('K·∫øt qu·∫£ cu·ªëi c√πng', getStatusText(applicationData.final_status || 'pending')));
                return frag;
            }

            frag.appendChild(createDetailItem('', 'Ch∆∞a c√≥ th√¥ng tin chi ti·∫øt'));
            return frag;
        }

        /* ---------- renderRounds (DOM-based, kh√¥ng d√πng template literals) ---------- */
        function renderRounds() {
            var roundsList = document.getElementById('rounds-list');
            if (!roundsList) return;
            roundsList.innerHTML = '';

            var roundDefs = [
                { id: 'round1', title: 'V√≤ng 1: ƒê∆°n ·ª©ng tuy·ªÉn', status: computeRoundStatus('round1') },
                { id: 'round2', title: 'V√≤ng 2: Ph·ªèng v·∫•n nh√≥m', status: computeRoundStatus('round2') },
                { id: 'round3', title: 'V√≤ng 3: Th·ª≠ th√°ch', status: computeRoundStatus('round3') },
                { id: 'round4', title: 'V√≤ng 4: Ph·ªèng v·∫•n c√° nh√¢n', status: computeRoundStatus('round4') },
            ];

            var currentRound = applicationData.current_round || 'round1';

            // Map round -> s·ªë th·ª© t·ª±
            var roundIndex = { round1: 1, round2: 2, round3: 3, round4: 4 };
            var maxIndex = roundIndex[currentRound];

            for (var i = 0; i < roundDefs.length; i++) {
                var round = roundDefs[i];

                // ‚õî D·ª´ng n·∫øu v∆∞·ª£t qu√° v√≤ng hi·ªán t·∫°i
                if (roundIndex[round.id] > maxIndex) break;

                var pri = applicationData[round.id + '_priority_status'];
                var sec = applicationData[round.id + '_secondary_status'];

                // N·∫øu c·∫£ 2 ban c√πng not-pass ·ªü v√≤ng n√†y -> d·ª´ng
                if (pri === 'not-pass' && sec === 'not-pass') {
                    break;
                }

                // N·∫øu c·∫£ 2 ban ƒë√£ b·ªã lo·∫°i tr∆∞·ªõc ƒë√≥ -> d·ª´ng
                var bothOutBefore = isEliminatedBefore('priority', i + 1) && isEliminatedBefore('secondary', i + 1);
                if (bothOutBefore) {
                    break;
                }

                // build card b·∫±ng DOM
                var roundCard = document.createElement('div');
                roundCard.className = 'round-card';

                var header = document.createElement('div');
                header.className = 'round-header';
                (function(rid){ header.addEventListener('click', function(){ toggleRoundDetails(rid); }); })(round.id);

                var titleDiv = document.createElement('div');
                titleDiv.className = 'round-title';
                titleDiv.textContent = round.title;

                var statusDiv = document.createElement('div');
                statusDiv.className = 'round-status ' + getStatusClass(round.status);
                statusDiv.textContent = getStatusText(round.status);

                header.appendChild(titleDiv);
                header.appendChild(statusDiv);

                var detailsDiv = document.createElement('div');
                detailsDiv.className = 'round-details';
                detailsDiv.id = 'details-' + round.id;
                detailsDiv.appendChild(buildRoundDetailsFragment(round.id));

                roundCard.appendChild(header);
                roundCard.appendChild(detailsDiv);
                roundsList.appendChild(roundCard);

                if (round.id === currentRound) {
                    (function(rid){ setTimeout(function(){ 
                        var el = document.getElementById('details-' + rid); 
                        if (el) el.classList.add('active'); 
                    }, 300); })(round.id);
                }
            }
        }

        // Check and show interview notification
        async function checkInterviewNotification() {
            try {
                const scheduleDoc = await db.collection('system').doc('interview_schedule').get();
                const notificationElement = document.getElementById('interview-notification');
                const voteStatusElement = document.getElementById('vote-status');
                
                if (scheduleDoc.exists) {
                    const scheduleData = scheduleDoc.data();
                    
                    // Ki·ªÉm tra n·∫øu l·ªãch ƒë√£ ƒë∆∞·ª£c c√¥ng b·ªë V√Ä user c√≥ quy·ªÅn ch·ªçn l·ªãch
                    if (scheduleData.published === true) {
                        const hasVotingRights = await checkVotingRights();
                        
                        if (hasVotingRights) {
                            // KI·ªÇM TRA ·ª®NG VI√äN ƒê√É VOTE CH∆ØA
                            const hasVoted = applicationData.interview_schedule && applicationData.interview_schedule.length >= 3;
                            
                            if (!hasVoted) {
                                // CH∆ØA vote ƒë·ªß - hi·ªÉn th·ªã th√¥ng b√°o ch·ªçn l·ªãch
                                notificationElement.style.display = 'block';
                                voteStatusElement.style.display = 'none';
                                
                                // Hi·ªÉn th·ªã th·ªùi gian c√¥ng b·ªë
                                if (scheduleData.published_at) {
                                    const publishDate = scheduleData.published_at.toDate();
                                    const deadlineDate = new Date(publishDate);
                                    deadlineDate.setDate(deadlineDate.getDate() + 3);
                                    
                                    document.getElementById('notification-deadline').textContent = 
                                        `ƒê·∫øn h·∫øt ng√†y ${deadlineDate.getDate()}/${deadlineDate.getMonth() + 1}`;
                                }
                            } else {
                                // ƒê√É vote ƒë·ªß - hi·ªÉn th·ªã tr·∫°ng th√°i ho√†n th√†nh
                                notificationElement.style.display = 'none';
                                voteStatusElement.style.display = 'block';
                                
                                // Hi·ªÉn th·ªã s·ªë ca ƒë√£ ch·ªçn
                                document.getElementById('selected-slots-count').textContent = 
                                    applicationData.interview_schedule.length;
                            }
                        } else {
                            // Kh√¥ng c√≥ quy·ªÅn vote
                            notificationElement.style.display = 'none';
                            voteStatusElement.style.display = 'none';
                        }
                    } else {
                        // L·ªãch ch∆∞a c√¥ng b·ªë
                        notificationElement.style.display = 'none';
                        voteStatusElement.style.display = 'none';
                    }
                } else {
                    // Kh√¥ng c√≥ l·ªãch
                    notificationElement.style.display = 'none';
                    voteStatusElement.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking interview notification:', error);
                // ·∫®n c·∫£ hai th√¥ng b√°o n·∫øu c√≥ l·ªói
                document.getElementById('interview-notification').style.display = 'none';
                document.getElementById('vote-status').style.display = 'none';
            }
        }

        // Th√™m event listener cho n√∫t xem l·∫°i l·ªãch
        document.getElementById('view-calendar-btn').addEventListener('click', function() {
            checkCalendarAccessBeforeRedirect();
        });

        // Ki·ªÉm tra user c√≥ trong danh s√°ch ƒë∆∞·ª£c vote kh√¥ng
        async function checkVotingRights() {
            try {
                const user = auth.currentUser;
                if (!user) return false;
                
                const votingCandidate = await db.collection('voting_candidates')
                    .where('email', '==', user.email)
                    .limit(1)
                    .get();
                    
                return !votingCandidate.empty;
            } catch (error) {
                console.error('Error checking voting rights:', error);
                return false;
            }
        }

        // Th√™m event listener cho n√∫t chuy·ªÉn ƒë·∫øn calendar - C·∫¨P NH·∫¨T
        document.getElementById('go-to-calendar-btn').addEventListener('click', function() {
            // Ki·ªÉm tra l·∫°i quy·ªÅn tr∆∞·ªõc khi chuy·ªÉn trang
            checkCalendarAccessBeforeRedirect();
        });

        // üîí KI·ªÇM TRA QUY·ªÄN TR∆Ø·ªöC KHI CHUY·ªÇN ƒê·∫æN CALENDAR
        async function checkCalendarAccessBeforeRedirect() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }

                const hasAccess = await checkVotingRights();
                if (!hasAccess) {
                    alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p l·ªãch ph·ªèng v·∫•n. Vui l√≤ng li√™n h·ªá BTC.');
                    return;
                }

                const scheduleDoc = await db.collection('system').doc('interview_schedule').get();
                if (!scheduleDoc.exists || scheduleDoc.data().published !== true) {
                    alert('L·ªãch ph·ªèng v·∫•n ch∆∞a ƒë∆∞·ª£c c√¥ng b·ªë. Vui l√≤ng quay l·∫°i sau.');
                    return;
                }

                // T·∫•t c·∫£ ƒëi·ªÅu ki·ªán ƒë·ªÅu h·ª£p l·ªá, chuy·ªÉn ƒë·∫øn calendar
                window.location.href = 'calendar.html';
            } catch (error) {
                console.error('Error checking access before redirect:', error);
                alert('C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra quy·ªÅn truy c·∫≠p.');
            }
        }

        /* ---------- toggleRoundDetails (gi·ªØ nguy√™n) ---------- */
        function toggleRoundDetails(roundId) {
            var detailsElement = document.getElementById('details-' + roundId);
            if (!detailsElement) return;
            if (detailsElement.classList.contains('active')) detailsElement.classList.remove('active');
            else detailsElement.classList.add('active');
        }

        // Check if round is completed
        function isRoundCompleted(roundId) {
            if (!applicationData) return false;
            
            const currentRound = applicationData.current_round || 'round1';
            const roundIndex = {
                'round1': 1,
                'round2': 2,
                'round3': 3,
                'round4': 4,
                'success': 5
            };
            
            return roundIndex[roundId] < roundIndex[currentRound];
        }

        /* ---------- merge status c·ªßa 2 ban (d√πng chung) ---------- */
        function mergeStatus(priority, secondary) {
            if (priority === 'pass' || secondary === 'pass') return 'pass';
            if (priority === 'not-pass' && secondary === 'not-pass') return 'not-pass';
            if (priority === 'pending' || secondary === 'pending') return 'pending';
            return priority || secondary || 'pending';
        }

        /* ---------- ki·ªÉm tra ban ƒë√£ b·ªã lo·∫°i ·ªü v√≤ng tr∆∞·ªõc ch∆∞a ---------- */
        function isEliminatedBefore(type, roundNumber) {
            if (!applicationData) return false;
            // check round1 special boolean schema too
            for (var i = 1; i < roundNumber; i++) {
                if (i === 1) {
                    if (type === 'priority' && applicationData.priorityRejected) return true;
                    if (type === 'secondary' && applicationData.secondaryRejected) return true;
                } else {
                    var st = applicationData['round' + i + '_' + type + '_status'];
                    if (st === 'not-pass') return true;
                }
            }
            return false;
        }


        /* ---------- helper: convert round1 boolean flags -> status ---------- */
        function getRound1Status(type) {
            if (!applicationData) return 'pending';
            if (type === 'priority') {
                if (applicationData.priorityAccepted) return 'pass';
                if (applicationData.priorityRejected) return 'not-pass';
            } else {
                if (applicationData.secondaryAccepted) return 'pass';
                if (applicationData.secondaryRejected) return 'not-pass';
            }
            return 'pending';
        }

        // Helper function to format timestamp safely
function formatTimestamp(timestamp) {
    if (!timestamp) return null;
    
    try {
        let date;
        if (timestamp.toDate && typeof timestamp.toDate === 'function') {
            date = timestamp.toDate();
        } else if (timestamp.seconds) {
            date = new Date(timestamp.seconds * 1000);
        } else if (typeof timestamp === 'string') {
            date = new Date(timestamp);
        } else if (typeof timestamp === 'number') {
            date = new Date(timestamp);
        } else {
            return null;
        }
        return date.toLocaleString('vi-VN');
    } catch (error) {
        console.error('Error formatting timestamp:', error);
        return null;
    }
}

        // Get round details
        function getRoundDetails(roundId) {
            if (!applicationData) return '<p>Ch∆∞a c√≥ th√¥ng tin chi ti·∫øt</p>';

            let details = '';

            switch(roundId) {
                case 'round1':
                    ['priority','secondary'].forEach(type => {
                        const dept = (type === 'priority' ? applicationData.priority_position : applicationData.secondary_position);
                        if (!dept) return;
                        const status = getRound1Status(type); // d√πng convert m·ªõi
                        details += `
                            <div class="detail-item">
                                <div class="detail-label">Ban ${dept} (${type})</div>
                                <div class="detail-value">Tr·∫°ng th√°i: ${getStatusText(status)}</div>
                            </div>
                        `;
                    });

                    details += `
                        <div class="detail-item">
                            <div class="detail-label">H√¨nh th·ª©c ·ª©ng tuy·ªÉn</div>
                            <div class="detail-value">${applicationData.application_type || 'Form tr·ª±c tuy·∫øn'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Th·ªùi gian n·ªôp ƒë∆°n</div>
                            <div class="detail-value">${formatTimestamp(applicationData.timestamp) || 'ƒêang c·∫≠p nh·∫≠t'}</div>
                        </div>
                    `;
                    break;

                case 'round2':
                    const round2 = applicationData.round2 || {};
                    ['priority','secondary'].forEach(type => {
                        if (isEliminatedBefore(type, 2)) return;
                        const dept = type === 'priority' ? applicationData.priority_position : applicationData.secondary_position;
                        if (!dept) return;
                        const data = round2[type] || {};
                        const status = applicationData[`round2_${type}_status`] || 'pending';
                        details += `
                            <div class="detail-item">
                                <div class="detail-label">Ban ${dept} (${type})</div>
                                <div class="detail-value">Tr·∫°ng th√°i: ${getStatusText(status)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Th·ªùi gian</div>
                                <div class="detail-value">${data.time || 'ƒêang c·∫≠p nh·∫≠t'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">ƒê·ªãa ƒëi·ªÉm</div>
                                <div class="detail-value">${data.location || 'ƒêang c·∫≠p nh·∫≠t'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Ghi ch√∫</div>
                                <div class="detail-value">${data.note || 'Kh√¥ng c√≥'}</div>
                            </div>
                        `;
                    });
                    break;

                case 'round3':
                    const round3 = applicationData.round3 || {};
                    ['priority','secondary'].forEach(type => {
                        if (isEliminatedBefore(type, 3)) return;
                        const dept = type === 'priority' ? applicationData.priority_position : applicationData.secondary_position;
                        if (!dept) return;
                        const data = round3[type] || {};
                        const status = applicationData[`round3_${type}_status`] || 'pending';
                        details += `
                            <div class="detail-item">
                                <div class="detail-label">Ban ${dept} (${type})</div>
                                <div class="detail-value">Tr·∫°ng th√°i: ${getStatusText(status)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Th·ª≠ th√°ch</div>
                                <div class="detail-value">${data.challenge || 'ƒêang c·∫≠p nh·∫≠t'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Th·ªùi h·∫°n</div>
                                <div class="detail-value">${data.deadline || 'ƒêang c·∫≠p nh·∫≠t'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">H∆∞·ªõng d·∫´n</div>
                                <div class="detail-value">${data.instructions || 'ƒêang c·∫≠p nh·∫≠t'}</div>
                            </div>
                        `;
                    });
                    break;

                case 'round4':
                    const round4 = applicationData.round4 || {};
                    ['priority','secondary'].forEach(type => {
                        if (isEliminatedBefore(type, 4)) return;
                        const dept = type === 'priority' ? applicationData.priority_position : applicationData.secondary_position;
                        if (!dept) return;
                        const data = round4[type] || {};
                        const status = applicationData[`round4_${type}_status`] || 'pending';
                        details += `
                            <div class="detail-item">
                                <div class="detail-label">Ban ${dept} (${type})</div>
                                <div class="detail-value">Tr·∫°ng th√°i: ${getStatusText(status)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Th·ªùi gian</div>
                                <div class="detail-value">${data.time || 'ƒêang c·∫≠p nh·∫≠t'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">ƒê·ªãa ƒëi·ªÉm</div>
                                <div class="detail-value">${data.location || 'ƒêang c·∫≠p nh·∫≠t'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Ng∆∞·ªùi ph·ªèng v·∫•n</div>
                                <div class="detail-value">${data.interviewer || 'ƒêang c·∫≠p nh·∫≠t'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">H√¨nh th·ª©c</div>
                                <div class="detail-value">${data.method || 'ƒêang c·∫≠p nh·∫≠t'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Ghi ch√∫</div>
                                <div class="detail-value">${data.note || 'Kh√¥ng c√≥'}</div>
                            </div>
                        `;
                    });
                    break;

                case 'success':
                    details = `
                        <div class="detail-item">
                            <div class="detail-label">K·∫øt qu·∫£ cu·ªëi c√πng</div>
                            <div class="detail-value">${getStatusText(applicationData.final_status || 'pending')}</div>
                        </div>
                    `;
                    break;

                default:
                    details = '<p>Ch∆∞a c√≥ th√¥ng tin chi ti·∫øt</p>';
            }

            return details || '<p>Ch∆∞a c√≥ th√¥ng tin chi ti·∫øt</p>';
        }

        // Helper functions from dashboard
        function getDepartmentName(code) {
            switch(code) {
                case 'MD': return 'Truy·ªÅn th√¥ng';
                case 'HR': return 'Nh√¢n s·ª±';
                case 'PD': return 'D·ª± √°n';
                case 'ER': return 'ƒê·ªëi ngo·∫°i';
                default: return code;
            }
        }

        function getRoundText(round) {
            switch(round) {
                case "round1": return "V√≤ng 1: ƒê∆°n";
                case "round2": return "V√≤ng 2: Ph·ªèng v·∫•n nh√≥m";
                case "round3": return "V√≤ng 3: Th·ª≠ th√°ch";
                case "round4": return "V√≤ng 4: Ph·ªèng v·∫•n c√° nh√¢n";
                case "success": return "Th√†nh vi√™n ch√≠nh th·ª©c";
                default: return "Ch∆∞a x√°c ƒë·ªãnh";
            }
        }

        function getDeptStatusForRound(app, type) {
            const round = app.current_round || 'round1';
            let keys = [];
            
            if (round === 'round4') {
                keys = [`round4_${type}_status`, `round3_${type}_status`, `round2_${type}_status`, `${type}_status`];
            } else if (round === 'round3') {
                keys = [`round3_${type}_status`, `round2_${type}_status`, `${type}_status`];
            } else if (round === 'round2') {
                keys = [`round2_${type}_status`, `${type}_status`];
            } else {
                keys = [`${type}_status`];
            }

            for (const k of keys) {
                if (app[k]) return app[k];
            }

            return null;
        }

        function getStatusClass(status) {
            switch(status) {
                case 'new': return 'status-new';
                case 'pending': return 'status-pending';
                case 'pass': return 'status-pass';
                case 'not-pass': return 'status-not-pass';
                case 'interviewed': return 'status-interviewed';
                case 'voted': return 'status-voted';
                case "success": return "status-success";
                default: return 'status-pending';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'new': return 'M·ªõi';
                case 'pending': return 'Pending';
                case 'pass': return 'Pass';
                case 'not-pass': return 'Not pass';
                case 'interviewed': return 'Interviewed';
                case 'voted': return 'Voted';
                case "success": return "Success";
                default: return status;
            }
        }

        /* ---------- compute status cho 1 v√≤ng (round1 x·ª≠ l√Ω kh√°c) ---------- */
        function computeRoundStatus(roundId) {
            if (!applicationData) return 'pending';
            if (roundId === 'round1') {
                var p = getRound1Status('priority');
                var s = getRound1Status('secondary');
                return mergeStatus(p, s);
            } else {
                var p = applicationData[roundId + '_priority_status'];
                var s = applicationData[roundId + '_secondary_status'];
                return mergeStatus(p, s);
            }
        }

        function computeOverallStatus(app) {
            if (!app) return 'pending';

            const current = app.current_round || 'round1';

            // N·∫øu v√≤ng 4 pass => Success
            if (mergeStatus(app.round4_priority_status, app.round4_secondary_status) === 'pass') {
                return 'success';
            }

            if (current === 'round1') {
                if (app.priorityAccepted || app.secondaryAccepted) return 'pass';
                if (app.priorityRejected && (app.secondaryRejected || !app.secondaryAccepted)) return 'not-pass';
                return 'pending';
            } else if (current === 'round2') {
                return mergeStatus(app.round2_priority_status, app.round2_secondary_status);
            } else if (current === 'round3') {
                return mergeStatus(app.round3_priority_status, app.round3_secondary_status);
            } else if (current === 'round4') {
                return mergeStatus(app.round4_priority_status, app.round4_secondary_status);
            }

            return 'pending';
        }

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        });
    </script>
</body>
</html>