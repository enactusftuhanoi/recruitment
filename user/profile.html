<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Ứng Viên | Enactus FTU Hanoi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Clash+Display:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root {
            --primary: #F8F3CE;
            --primary-light: #FFD54F;
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --white: #FFFFFF;
            --error: #EF4444;
            --error-light: #FEE2E2;
            --success: #10B981;
            --success-light: #D1FAE5;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --info: #3B82F6;
            --info-light: #DBEAFE;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        body {
            background-color: var(--gray-50);
            color: var(--gray-800);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background-color: var(--white);
            padding: 16px 24px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 50px;
            width: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--gray-800);
        }

        .logout-btn {
            padding: 8px 16px;
            background-color: var(--gray-100);
            border: none;
            border-radius: var(--border-radius);
            color: var(--gray-700);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }

        .logout-btn:hover {
            background-color: var(--error-light);
            color: var(--error);
        }

        .logout-btn i {
            margin-right: 8px;
        }

        /* Main Content */
        .main-content {
            max-width: 1000px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Profile Card */
        .profile-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 600;
            color: var(--gray-800);
            margin-right: 20px;
        }

        .profile-details h2 {
            font-family: 'Clash Display', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .profile-details p {
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .profile-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-top: 8px;
        }

        .status-new {
            background-color: var(--info-light);
            color: var(--info);
        }

        .status-pending {
            background-color: var(--warning-light);
            color: var(--warning);
        }

        .status-pass {
            background-color: var(--success-light);
            color: var(--success);
        }

        .status-not-pass {
            background-color: var(--error-light);
            color: var(--error);
        }

        .status-interviewed {
            background-color: var(--info-light);
            color: var(--info);
        }

        .status-voted {
            background-color: var(--primary);
            color: var(--gray-800);
        }

        .status-success {
            background-color: var(--primary);
            color: var(--gray-800);
            font-weight: bold;
        }

        /* Application Info */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .info-item {
            padding: 16px;
            background-color: var(--gray-50);
            border-radius: var(--border-radius);
        }

        .info-label {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 8px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 500;
            color: var(--gray-800);
        }

        /* Round Progress */
        .rounds-container {
            margin-top: 32px;
        }

        .rounds-title {
            font-family: 'Clash Display', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--gray-200);
        }

        .round-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
            transition: var(--transition);
        }

        .round-card:last-child {
            margin-bottom: 0;
        }

        .round-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            cursor: pointer;
        }

        .round-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .round-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .round-details {
            display: none;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--gray-200);
        }

        .round-details.active {
            display: block;
        }

        .detail-item {
            margin-bottom: 12px;
        }

        .detail-label {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 16px;
            color: var(--gray-800);
        }

        /* No Application Message */
        .no-application {
            text-align: center;
            padding: 40px 20px;
        }

        .no-application i {
            font-size: 64px;
            color: var(--gray-300);
            margin-bottom: 16px;
        }

        .no-application h3 {
            font-size: 20px;
            color: var(--gray-600);
            margin-bottom: 16px;
        }

        .no-application p {
            color: var(--gray-500);
            margin-bottom: 24px;
        }

        .action-btn {
            padding: 12px 24px;
            background-color: var(--primary);
            border: none;
            border-radius: var(--border-radius);
            color: var(--gray-800);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-block;
        }

        .action-btn:hover {
            background-color: var(--primary-light);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px 20px;
        }

        .loading i {
            font-size: 32px;
            color: var(--gray-400);
            margin-bottom: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-avatar {
                margin-right: 0;
                margin-bottom: 16px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <img src="/assets/logo_den.png" alt="Enactus FTU Hanoi Logo">
        </div>
        
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">U</div>
            <button class="logout-btn" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                Đăng xuất
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div id="loading" class="loading">
            <i class="fas fa-spinner"></i>
            <p>Đang tải thông tin...</p>
        </div>

        <div id="profile-content" style="display: none;">
            <!-- Profile Card -->
            <div class="profile-card">
                <div class="profile-header">
                    <div class="profile-avatar" id="profile-avatar">U</div>
                    <div class="profile-details">
                        <h2 id="profile-name">Họ tên ứng viên</h2>
                        <p id="profile-email">email@example.com</p>
                        <p id="profile-phone">0123456789</p>
                        <span class="profile-status" id="profile-status">Đang xử lý</span>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Ban ưu tiên</div>
                        <div class="info-value" id="priority-department">Chưa có thông tin</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Ban dự bị</div>
                        <div class="info-value" id="secondary-department">Chưa có thông tin</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Vòng hiện tại</div>
                        <div class="info-value" id="current-round">Chưa có thông tin</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Thời gian ứng tuyển</div>
                        <div class="info-value" id="application-time">Chưa có thông tin</div>
                    </div>
                </div>
            </div>

            <!-- Rounds Progress -->
            <div class="rounds-container">
                <h3 class="rounds-title">Quá trình ứng tuyển</h3>
                <div id="rounds-list">
                    <!-- Rounds will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div id="no-application" class="no-application" style="display: none;">
            <i class="fas fa-file-alt"></i>
            <h3>Bạn chưa điền đơn ứng tuyển</h3>
            <p>Hãy điền đơn ứng tuyển để tham gia vào quá trình tuyển thành viên của Enactus FTU Hanoi</p>
            <a href="/user/form.html" class="action-btn">Điền đơn ngay</a>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOP2j0qV0Ge-q2-Y9zo9Qc3eLmgtVOK3k",
            authDomain: "recruitment-enactusftuhanoi.firebaseapp.com",
            projectId: "recruitment-enactusftuhanoi",
            storageBucket: "recruitment-enactusftuhanoi.firebasestorage.app",
            messagingSenderId: "658928769643",
            appId: "1:658928769643:web:ef4e26633b7c41c922ef2e",
            measurementId: "G-BJT7ZPKYE3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global State
        let userData = null;
        let applicationData = null;

        // Check authentication
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in
                document.getElementById('user-avatar').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U';
                
                try {
                    // Check if user has an application
                    const snapshot = await db.collection('applications')
                                          .where('email', '==', user.email)
                                          .limit(1)
                                          .get();
                    
                    if (snapshot.empty) {
                        // No application found
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('no-application').style.display = 'block';
                    } else {
                        // Application found
                        applicationData = snapshot.docs[0].data();
                        applicationData.id = snapshot.docs[0].id;
                        
                        // Load user data
                        await loadUserData(user);
                        
                        // Render application data
                        renderApplicationData();
                        
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('profile-content').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error checking application:', error);
                    alert('Có lỗi xảy ra khi kiểm tra thông tin ứng viên');
                }
            } else {
                // User is not signed in, redirect to login
                window.location.href = 'login.html';
            }
        });

        // Load user data
        async function loadUserData(user) {
            userData = {
                displayName: user.displayName,
                email: user.email,
                photoURL: user.photoURL
            };
            
            // Update avatar
            const avatarElement = document.getElementById('profile-avatar');
            if (user.photoURL) {
                avatarElement.style.backgroundImage = `url(${user.photoURL})`;
                avatarElement.style.backgroundSize = 'cover';
                avatarElement.textContent = '';
            } else {
                avatarElement.textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U';
            }
        }

        // Render application data
        function renderApplicationData() {
            if (!applicationData) return;
            
            // Basic info
            document.getElementById('profile-name').textContent = applicationData.fullname || 'Chưa cung cấp';
            document.getElementById('profile-email').textContent = applicationData.email || 'Chưa cung cấp';
            document.getElementById('profile-phone').textContent = applicationData.phone || 'Chưa cung cấp';
            
            // Departments
            document.getElementById('priority-department').textContent = getDepartmentName(applicationData.priority_position) || 'Chưa cung cấp';
            document.getElementById('secondary-department').textContent = getDepartmentName(applicationData.secondary_position) || 'Chưa cung cấp';
            
            // Current round and status
            const currentRound = applicationData.current_round || 'round1';
            document.getElementById('current-round').textContent = getRoundText(currentRound);
            
            const status = computeOverallStatus(applicationData);
            const statusElement = document.getElementById('profile-status');
            statusElement.textContent = getStatusText(status);
            statusElement.className = `profile-status ${getStatusClass(status)}`;
            
            // Application time
            if (applicationData.timestamp) {
                const date = applicationData.timestamp.toDate();
                document.getElementById('application-time').textContent = date.toLocaleDateString('vi-VN');
            } else {
                document.getElementById('application-time').textContent = 'Chưa có thông tin';
            }
            
            // Render rounds
            renderRounds();
        }

        // Render rounds
        function renderRounds() {
            const roundsList = document.getElementById('rounds-list');
            roundsList.innerHTML = '';
            
            const rounds = [
                { id: 'round1', title: 'Vòng 1: Đơn ứng tuyển', status: applicationData.status || 'new' },
                { id: 'round2', title: 'Vòng 2: Phỏng vấn nhóm', status: getDeptStatusForRound(applicationData, 'priority') || 'pending' },
                { id: 'round3', title: 'Vòng 3: Thử thách', status: getDeptStatusForRound(applicationData, 'priority') || 'pending' },
                { id: 'round4', title: 'Vòng 4: Phỏng vấn cá nhân', status: getDeptStatusForRound(applicationData, 'priority') || 'pending' },
                { id: 'success', title: 'Kết quả cuối cùng', status: applicationData.final_status || 'pending' }
            ];
            
            // Sort rounds: current round first, then completed, then pending
            const currentRound = applicationData.current_round || 'round1';
            
            rounds.forEach(round => {
                const roundCard = document.createElement('div');
                roundCard.className = 'round-card';
                
                const isCurrent = round.id === currentRound;
                const isCompleted = isRoundCompleted(round.id);
                
                roundCard.innerHTML = `
                    <div class="round-header" onclick="toggleRoundDetails('${round.id}')">
                        <div class="round-title">${round.title}</div>
                        <div class="round-status ${getStatusClass(round.status)}">${getStatusText(round.status)}</div>
                    </div>
                    <div class="round-details" id="details-${round.id}">
                        ${getRoundDetails(round.id)}
                    </div>
                `;
                
                roundsList.appendChild(roundCard);
                
                // Auto-expand current round
                if (isCurrent) {
                    setTimeout(() => {
                        document.getElementById(`details-${round.id}`).classList.add('active');
                    }, 300);
                }
            });
        }

        // Toggle round details
        function toggleRoundDetails(roundId) {
            const detailsElement = document.getElementById(`details-${roundId}`);
            detailsElement.classList.toggle('active');
        }

        // Check if round is completed
        function isRoundCompleted(roundId) {
            if (!applicationData) return false;
            
            const currentRound = applicationData.current_round || 'round1';
            const roundIndex = {
                'round1': 1,
                'round2': 2,
                'round3': 3,
                'round4': 4,
                'success': 5
            };
            
            return roundIndex[roundId] < roundIndex[currentRound];
        }

        // Get round details
        function getRoundDetails(roundId) {
            if (!applicationData) return '<p>Chưa có thông tin chi tiết</p>';
            
            let details = '';
            
            switch(roundId) {
                case 'round1':
                    details = `
                        <div class="detail-item">
                            <div class="detail-label">Hình thức ứng tuyển</div>
                            <div class="detail-value">${applicationData.application_type || 'Form trực tuyến'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Thời gian nộp đơn</div>
                            <div class="detail-value">${applicationData.timestamp ? applicationData.timestamp.toDate().toLocaleString('vi-VN') : 'Chưa có thông tin'}</div>
                        </div>
                    `;
                    break;
                    
                case 'round2':
                    const round2Data = applicationData.round2 || {};
                    details = `
                        <div class="detail-item">
                            <div class="detail-label">Thời gian</div>
                            <div class="detail-value">${round2Data.time || 'Chưa có thông tin'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Địa điểm</div>
                            <div class="detail-value">${round2Data.location || 'Chưa có thông tin'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ghi chú</div>
                            <div class="detail-value">${round2Data.note || 'Không có ghi chú'}</div>
                        </div>
                    `;
                    break;
                    
                case 'round3':
                    const round3Data = applicationData.round3 || {};
                    details = `
                        <div class="detail-item">
                            <div class="detail-label">Thử thách</div>
                            <div class="detail-value">${round3Data.challenge || 'Chưa có thông tin'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Thời hạn</div>
                            <div class="detail-value">${round3Data.deadline || 'Chưa có thông tin'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Hướng dẫn</div>
                            <div class="detail-value">${round3Data.instructions || 'Chưa có thông tin'}</div>
                        </div>
                    `;
                    break;
                    
                case 'round4':
                    const round4Data = applicationData.round4 || {};
                    details = `
                        <div class="detail-item">
                            <div class="detail-label">Thời gian</div>
                            <div class="detail-value">${round4Data.time || 'Chưa có thông tin'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Địa điểm</div>
                            <div class="detail-value">${round4Data.location || 'Chưa có thông tin'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Người phỏng vấn</div>
                            <div class="detail-value">${round4Data.interviewer || 'Chưa có thông tin'}</div>
                        </div>
                    `;
                    break;
                    
                case 'success':
                    details = `
                        <div class="detail-item">
                            <div class="detail-label">Kết quả</div>
                            <div class="detail-value">${applicationData.final_status === 'pass' ? 'Chúc mừng bạn đã trở thành thành viên chính thức của Enactus FTU Hanoi!' : 'Ứng tuyển của bạn chưa thành công'}</div>
                        </div>
                        ${applicationData.final_department ? `
                        <div class="detail-item">
                            <div class="detail-label">Ban được phân công</div>
                            <div class="detail-value">${getDepartmentName(applicationData.final_department)}</div>
                        </div>
                        ` : ''}
                    `;
                    break;
                    
                default:
                    details = '<p>Chưa có thông tin chi tiết</p>';
            }
            
            return details;
        }

        // Helper functions from dashboard
        function getDepartmentName(code) {
            switch(code) {
                case 'MD': return 'Truyền thông';
                case 'HR': return 'Nhân sự';
                case 'PD': return 'Dự án';
                case 'ER': return 'Đối ngoại';
                default: return code;
            }
        }

        function getRoundText(round) {
            switch(round) {
                case "round1": return "Vòng 1: Đơn";
                case "round2": return "Vòng 2: Phỏng vấn nhóm";
                case "round3": return "Vòng 3: Thử thách";
                case "round4": return "Vòng 4: Phỏng vấn cá nhân";
                case "success": return "Thành viên chính thức";
                default: return "Chưa xác định";
            }
        }

        function getDeptStatusForRound(app, type) {
            const round = app.current_round || 'round1';
            let keys = [];
            
            if (round === 'round4') {
                keys = [`round4_${type}_status`, `round3_${type}_status`, `round2_${type}_status`, `${type}_status`];
            } else if (round === 'round3') {
                keys = [`round3_${type}_status`, `round2_${type}_status`, `${type}_status`];
            } else if (round === 'round2') {
                keys = [`round2_${type}_status`, `${type}_status`];
            } else {
                keys = [`${type}_status`];
            }

            for (const k of keys) {
                if (app[k]) return app[k];
            }

            return null;
        }

        function getStatusClass(status) {
            switch(status) {
                case 'new': return 'status-new';
                case 'pending': return 'status-pending';
                case 'pass': return 'status-pass';
                case 'not-pass': return 'status-not-pass';
                case 'interviewed': return 'status-interviewed';
                case 'voted': return 'status-voted';
                case "success": return "status-success";
                default: return 'status-pending';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'new': return 'Mới';
                case 'pending': return 'Đang chờ';
                case 'pass': return 'Đạt';
                case 'not-pass': return 'Không đạt';
                case 'interviewed': return 'Đã phỏng vấn';
                case 'voted': return 'Đã bình chọn';
                case "success": return "Thành công";
                default: return status;
            }
        }

        function computeOverallStatus(application) {
            const round = application.current_round || "round1";
            if (round === "success" || application.status === "success") {
                return "success";
            }

            const p = getDeptStatusForRound(application, "priority");
            const s = getDeptStatusForRound(application, "secondary");
            const perRoundStatus = application[`${round}_status`] || null;

            if (perRoundStatus === 'voted' || perRoundStatus === 'interviewed') return perRoundStatus;
            if (p === "pass" || s === "pass") return "pass";
            if ((p === "not-pass" && s === "not-pass") || (p === "not-pass" && !s) || (!p && s === "not-pass")) return "not-pass";
            if (perRoundStatus === "pass" || perRoundStatus === "not-pass") return perRoundStatus;

            if (round === "round1") return application.status || "new";
            return "pending";
        }

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        });
    </script>
</body>
</html>