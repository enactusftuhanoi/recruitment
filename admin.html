<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin | Enactus FTU Hanoi</title>
  <link rel="icon" href="/assets/icon.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #1a73e8;
      --primary-dark: #0d62cb;
      --primary-light: #e8f0fe;
      --secondary: #f5f7fa;
      --accent: #ff6b6b;
      --success: #4caf50;
      --warning: #ff9800;
      --info: #17a2b8;
      --text: #202124;
      --text-light: #5f6368;
      --border: #dadce0;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 0;
      line-height: 1.6;
    }

    .app-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 50px;
      height: 50px;
      background: var(--primary);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }

    .logo-text {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    .admin-actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      border: none;
      white-space: nowrap;
    }

    .logout-btn {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.25);
    }

    .logout-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(26, 115, 232, 0.35);
    }

    .refresh-btn {
      background: white;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .refresh-btn:hover {
      background: var(--primary-light);
    }
    
    .export-btn {
      background: var(--success);
      color: white;
    }

    /* Dashboard Stats */
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: var(--transition);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    
    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 15px;
    }
    
    .stat-1 .stat-icon { background: rgba(26, 115, 232, 0.15); color: var(--primary); }
    .stat-2 .stat-icon { background: rgba(76, 175, 80, 0.15); color: var(--success); }
    .stat-3 .stat-icon { background: rgba(255, 152, 0, 0.15); color: var(--warning); }
    .stat-4 .stat-icon { background: rgba(23, 162, 184, 0.15); color: var(--info); }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 16px;
      color: var(--text-light);
      text-align: center;
    }

    /* Page Title */
    .page-title {
      text-align: center;
      margin-bottom: 30px;
      color: var(--text);
      font-size: 32px;
      position: relative;
      padding-bottom: 15px;
    }

    .page-title:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: var(--primary);
      border-radius: 2px;
    }

    /* Search and Filters */
    .search-filters {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .search-box {
      flex: 1;
      min-width: 300px;
    }
    
    .filter-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .filter-select {
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      min-width: 150px;
    }

    /* Login Box */
    #loginBox {
      max-width: 500px;
      margin: 100px auto;
      padding: 40px;
      background: white;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      text-align: center;
    }

    .login-title {
      font-size: 28px;
      color: var(--primary);
      margin-bottom: 30px;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      text-align: left;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-light);
    }

    .form-input {
      width: 100%;
      padding: 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 16px;
      transition: var(--transition);
    }

    .form-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
      outline: none;
    }

    .login-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: var(--transition);
      margin-top: 10px;
    }

    .login-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(26, 115, 232, 0.35);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 15px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 12px 25px;
      border-radius: 8px;
      background: white;
      border: 1px solid var(--border);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      white-space: nowrap;
    }

    .tab-btn:hover, .tab-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .tab-content {
      display: none;
      padding: 25px;
      background: white;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      margin-bottom: 30px;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    /* Tables */
    .user-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .user-table th, .user-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .user-table th {
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      position: relative;
    }
    
    .user-table th:hover {
      background: rgba(26, 115, 232, 0.2);
    }
    
    .user-table th.sort-asc::after {
      content: ' \25B2';
      font-size: 12px;
    }
    
    .user-table th.sort-desc::after {
      content: ' \25BC';
      font-size: 12px;
    }

    .user-table tr:hover {
      background: rgba(26, 115, 232, 0.03);
    }

    .action-btn-small {
      padding: 8px 15px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .action-btn-small:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    .action-btn-small.warning {
      background: var(--warning);
    }
    
    .action-btn-small.success {
      background: var(--success);
    }

    /* Form elements */
    .select-box {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 16px;
      margin-top: 8px;
      margin-bottom: 20px;
      transition: var(--transition);
      background: white;
    }

    .select-box:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
      outline: none;
    }

    .input-box {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 16px;
      margin-top: 8px;
      margin-bottom: 15px;
      transition: var(--transition);
      background: white;
    }

    .input-box:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
      outline: none;
    }

    .form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-col {
      flex: 1;
    }

    .save-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
    }

    .save-btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    .btn {
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      border: none;
      text-decoration: none;
      background: var(--primary);
      color: white;
    }
    
    .btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-outline:hover {
      background: var(--primary-light);
    }

    /* Round Details */
    .round-box {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      background: var(--primary-light);
    }

    .round-title {
      font-size: 18px;
      color: var(--primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Profile Preview */
    .preview-box {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--card-shadow);
    }
    
    .preview-title {
      color: var(--primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .preview-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .preview-section {
      background: #f9fbfd;
      border-radius: 8px;
      padding: 15px;
      border-left: 3px solid var(--primary);
    }
    
    .preview-label {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 5px;
    }
    
    .preview-value {
      font-size: 16px;
      font-weight: 600;
    }

    /* Footer */
    .admin-footer {
      text-align: center;
      padding: 30px 0;
      color: var(--text-light);
      font-size: 14px;
      margin-top: 40px;
      border-top: 1px solid var(--border);
    }

    /* Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive Design */
    @media (max-width: 900px) {
      .admin-header {
        flex-direction: column;
        gap: 20px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 10px;
      }
      
      .preview-content {
        grid-template-columns: 1fr;
      }
      
      .search-filters {
        flex-direction: column;
      }
      
      .search-box {
        min-width: 100%;
      }
    }

    @media (max-width: 768px) {
      .tabs {
        flex-direction: column;
      }
      
      .tab-btn {
        width: 100%;
      }
      
      .user-table {
        display: block;
        overflow-x: auto;
      }
      
      .dashboard-stats {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    @media (max-width: 480px) {
      .dashboard-stats {
        grid-template-columns: 1fr;
      }
    }
    
    /* Alert messages */
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .alert-success {
      background: rgba(76, 175, 80, 0.15);
      border: 1px solid var(--success);
      color: var(--success);
    }
    
    .alert-error {
      background: rgba(255, 107, 107, 0.15);
      border: 1px solid var(--accent);
      color: var(--accent);
    }
    
    .alert-warning {
      background: rgba(255, 152, 0, 0.15);
      border: 1px solid var(--warning);
      color: var(--warning);
    }
    
    .alert-info {
      background: rgba(23, 162, 184, 0.15);
      border: 1px solid var(--info);
      color: var(--info);
    }
  </style>
</head>
<body>
  <!-- üîê Khu v·ª±c ƒëƒÉng nh·∫≠p -->
  <div id="loginBox">
    <div class="login-title">
      <i class="fas fa-lock"></i> ƒêƒÉng nh·∫≠p qu·∫£n tr·ªã
    </div>
    <form class="login-form" id="loginForm">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="loginEmail" class="form-input" placeholder="Nh·∫≠p email qu·∫£n tr·ªã" required>
      </div>
      <div class="form-group">
        <label class="form-label">M·∫≠t kh·∫©u</label>
        <input type="password" id="loginPassword" class="form-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
      </div>
      <button type="button" class="login-btn" id="loginButton">
        <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
      </button>
    </form>
  </div>

  <!-- üìã N·ªôi dung qu·∫£n tr·ªã (·∫©n khi ch∆∞a ƒëƒÉng nh·∫≠p) -->
  <div id="adminContent" style="display: none;">
    <div class="app-container">
      <div class="admin-header">
        <div class="logo">
          <div class="logo-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="logo-text">ENACTUS FTU HANOI - QU·∫¢N TR·ªä</div>
        </div>
        <div class="admin-actions">
          <button id="refreshButton" class="action-btn refresh-btn">
            <i class="fas fa-sync-alt"></i>
            L√†m m·ªõi
          </button>
          <button id="exportButton" class="action-btn export-btn">
            <i class="fas fa-file-export"></i>
            Xu·∫•t CSV
          </button>
          <button id="logoutBtn" class="action-btn logout-btn">
            <i class="fas fa-sign-out-alt"></i>
            ƒêƒÉng xu·∫•t
          </button>
        </div>
      </div>

      <h1 class="page-title">üìã Qu·∫£n l√Ω ·ª©ng vi√™n</h1>
      
      <!-- Th·ªëng k√™ t·ªïng quan -->
      <div class="dashboard-stats">
        <div class="stat-card stat-1">
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-value" id="totalCandidates">0</div>
          <div class="stat-label">T·ªïng ·ª©ng vi√™n</div>
        </div>
        
        <div class="stat-card stat-2">
          <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-value" id="completedCandidates">0</div>
          <div class="stat-label">ƒê√£ ho√†n th√†nh</div>
        </div>
        
        <div class="stat-card stat-3">
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-value" id="inProgressCandidates">0</div>
          <div class="stat-label">ƒêang trong qu√° tr√¨nh</div>
        </div>
        
        <div class="stat-card stat-4">
          <div class="stat-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="stat-value" id="pendingCandidates">0</div>
          <div class="stat-label">Ch·ªù x·ª≠ l√Ω</div>
        </div>
      </div>
      
      <!-- T√¨m ki·∫øm v√† l·ªçc -->
      <div class="search-filters">
        <div class="search-box">
          <input type="text" id="searchInput" class="input-box" placeholder="T√¨m ki·∫øm ·ª©ng vi√™n...">
        </div>
        <div class="filter-group">
          <select id="statusFilter" class="filter-select">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="Ch·ªù x·ª≠ l√Ω">Ch·ªù x·ª≠ l√Ω</option>
            <option value="ƒê√£ duy·ªát">ƒê√£ duy·ªát</option>
            <option value="T·ª´ ch·ªëi">T·ª´ ch·ªëi</option>
          </select>
          
          <select id="roundFilter" class="filter-select">
            <option value="">T·∫•t c·∫£ v√≤ng</option>
            <option value="1">V√≤ng ƒë∆°n</option>
            <option value="2">Ph·ªèng v·∫•n nh√≥m</option>
            <option value="3">Th·ª≠ th√°ch</option>
            <option value="4">Ph·ªèng v·∫•n c√° nh√¢n</option>
            <option value="5">ƒê√£ ho√†n th√†nh</option>
          </select>
        </div>
      </div>
      
      <div class="tabs">
        <button class="tab-btn active" data-tab="usersTab">üë§ Danh s√°ch ·ª©ng vi√™n</button>
        <button class="tab-btn" data-tab="roundsTab">üîÑ Tr·∫°ng th√°i v√≤ng</button>
        <button class="tab-btn" data-tab="detailTab">üìù Chi ti·∫øt v√≤ng</button>
        <button class="tab-btn" data-tab="historyTab">üìä L·ªãch s·ª≠ ho·∫°t ƒë·ªông</button>
      </div>

      <!-- Danh s√°ch th√≠ sinh -->
      <section id="usersTab" class="tab-content active">
        <h2><i class="fas fa-users"></i> Danh s√°ch ·ª©ng vi√™n</h2>
        <table class="user-table">
          <thead>
            <tr>
              <th data-sort="fullname">H·ªç t√™n</th>
              <th data-sort="email">Email</th>
              <th data-sort="current_round">V√≤ng hi·ªán t·∫°i</th>
              <th data-sort="status">Tr·∫°ng th√°i</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="userList"></tbody>
        </table>
      </section>

      <!-- Tr·∫°ng th√°i v√≤ng -->
      <section id="roundsTab" class="tab-content">
        <h2><i class="fas fa-tasks"></i> Tr·∫°ng th√°i c√°c v√≤ng</h2>
        <div class="form-group">
          <label class="form-label">Ch·ªçn ·ª©ng vi√™n</label>
          <select id="selectedUserIdRounds" class="select-box">
            <option value="">-- Ch·ªçn ·ª©ng vi√™n --</option>
          </select>
        </div>
        <div id="roundsContainer"></div>
        
        <!-- Xem tr∆∞·ªõc profile -->
        <div id="profilePreview" class="preview-box">
          <h3 class="preview-title"><i class="fas fa-eye"></i> Xem tr∆∞·ªõc tr√™n Profile</h3>
          <div class="preview-content">
            <div class="preview-section">
              <div class="preview-label">Tr·∫°ng th√°i v√≤ng:</div>
              <div id="previewStatus" class="preview-value">ƒêang t·∫£i...</div>
            </div>
            <div class="preview-section">
              <div class="preview-label">Chi ti·∫øt v√≤ng hi·ªán t·∫°i:</div>
              <div id="previewRound" class="preview-value">ƒêang t·∫£i...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Chi ti·∫øt v√≤ng -->
      <section id="detailTab" class="tab-content">
        <h2><i class="fas fa-info-circle"></i> Chi ti·∫øt t·ª´ng v√≤ng</h2>
        <div class="form-group">
          <label class="form-label">Ch·ªçn ·ª©ng vi√™n</label>
          <select id="selectedUserIdDetails" class="select-box">
            <option value="">-- Ch·ªçn ·ª©ng vi√™n --</option>
          </select>
        </div>
        <div id="roundDetailContainer"></div>
      </section>
      
      <!-- L·ªãch s·ª≠ ho·∫°t ƒë·ªông -->
      <section id="historyTab" class="tab-content">
        <h2><i class="fas fa-history"></i> L·ªãch s·ª≠ ho·∫°t ƒë·ªông</h2>
        <div class="form-group">
          <label class="form-label">Ch·ªçn ·ª©ng vi√™n</label>
          <select id="selectedUserIdHistory" class="select-box">
            <option value="">-- Ch·ªçn ·ª©ng vi√™n --</option>
          </select>
        </div>
        <div class="round-box">
          <h3 class="round-title"><i class="fas fa-clock"></i> L·ªãch s·ª≠ thay ƒë·ªïi</h3>
          <div id="historyList"></div>
        </div>
      </section>
      
      <div class="admin-footer">
        <p>¬© 2025 Recruitment | Enactus FTU Hanoi</p>
        <p>Li√™n h·ªá: tuhm@vief.edu.vn | Phone: 0362977206</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuTvBn8Xl01DYddVXQ7M0L24K3l-GyG0c",
      authDomain: "enactusftuhanoi-tracuu.firebaseapp.com",
      projectId: "enactusftuhanoi-tracuu",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userList = document.getElementById("userList");
    const roundsContainer = document.getElementById("roundsContainer");
    const roundDetailContainer = document.getElementById("roundDetailContainer");
    const previewStatus = document.getElementById("previewStatus");
    const previewRound = document.getElementById("previewRound");
    const historyList = document.getElementById("historyList");

    const steps = [
      "V√≤ng ƒë∆°n", "Ph·ªèng v·∫•n nh√≥m", "Th·ª≠ th√°ch", "Ph·ªèng v·∫•n c√° nh√¢n"
    ];

    let usersData = [];
    let currentSelectedUser = null;
    let currentSortField = null;
    let currentSortDirection = 'asc';
    let filteredUsersData = [];

    // H√†m hi·ªÉn th·ªã th√¥ng b√°o
    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
      `;
      
      const container = document.querySelector('.app-container');
      if (container) {
        container.insertBefore(alertDiv, container.firstChild);
        
        setTimeout(() => {
          alertDiv.remove();
        }, 5000);
      }
    }

    // K·∫øt n·ªëi v·ªõi profile
    function updateProfilePreview(user) {
      if (!user) {
        previewStatus.innerHTML = "Ch∆∞a ch·ªçn ·ª©ng vi√™n";
        previewRound.innerHTML = "Ch∆∞a ch·ªçn ·ª©ng vi√™n";
        return;
      }
      
      const currentRound = user.current_round || 1;
      const roundStatus = currentRound <= 4 ? 
        `V√≤ng ${currentRound}: ${steps[currentRound-1]}` : 
        "‚úÖ ƒê√£ ho√†n th√†nh t·∫•t c·∫£ v√≤ng";
      
      previewStatus.innerHTML = roundStatus;
      
      const roundInfo = user[`round_${currentRound}`] || {};
      let roundDetails = "Ch∆∞a c√≥ th√¥ng tin";
      
      if (roundInfo.time || roundInfo.note) {
        roundDetails = `
          <div><strong>Th·ªùi gian:</strong> ${roundInfo.time || "Ch∆∞a c·∫≠p nh·∫≠t"}</div>
          <div><strong>Ghi ch√∫:</strong> ${roundInfo.note || "Kh√¥ng c√≥ ghi ch√∫"}</div>
        `;
      }
      
      previewRound.innerHTML = roundDetails;
    }

    // H√†m t·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng
    async function loadUsers() {
      try {
        const snapshot = await getDocs(collection(db, "users"));
        usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        filteredUsersData = [...usersData];
        
        updateStats();
        populateUserDropdown();
        renderUsers();
        
        if (currentSelectedUser) {
          const user = usersData.find(u => u.id === currentSelectedUser);
          if (user) updateProfilePreview(user);
        }
      } catch (error) {
        console.error("L·ªói t·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng:", error);
        showAlert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng. Vui l√≤ng th·ª≠ l·∫°i.", "error");
      }
    }
    
    function updateStats() {
      document.getElementById('totalCandidates').textContent = usersData.length;
      
      const completed = usersData.filter(u => u.current_round > 4).length;
      document.getElementById('completedCandidates').textContent = completed;
      
      const inProgress = usersData.filter(u => u.current_round > 0 && u.current_round <= 4).length;
      document.getElementById('inProgressCandidates').textContent = inProgress;
      
      const pending = usersData.filter(u => u.status === 'Ch·ªù x·ª≠ l√Ω').length;
      document.getElementById('pendingCandidates').textContent = pending;
    }

    function populateUserDropdown() {
      const selectRounds = document.getElementById("selectedUserIdRounds");
      const selectDetails = document.getElementById("selectedUserIdDetails");
      const selectHistory = document.getElementById("selectedUserIdHistory");

      if (selectRounds) {
        selectRounds.innerHTML = `<option value="">-- Ch·ªçn ·ª©ng vi√™n --</option>`;
        usersData.forEach(user => {
          selectRounds.innerHTML += `<option value="${user.id}">${user.fullname} (${user.email})</option>`;
        });
      }

      if (selectDetails) {
        selectDetails.innerHTML = `<option value="">-- Ch·ªçn ·ª©ng vi√™n --</option>`;
        usersData.forEach(user => {
          selectDetails.innerHTML += `<option value="${user.id}">${user.fullname} (${user.email})</option>`;
        });
      }
      
      if (selectHistory) {
        selectHistory.innerHTML = `<option value="">-- Ch·ªçn ·ª©ng vi√™n --</option>`;
        usersData.forEach(user => {
          selectHistory.innerHTML += `<option value="${user.id}">${user.fullname} (${user.email})</option>`;
        });
      }
    }

    function renderUsers() {
      userList.innerHTML = filteredUsersData.map(user => `
        <tr>
          <td>${user.fullname}</td>
          <td>${user.email}</td>
          <td>${user.current_round <= 4 ? `V√≤ng ${user.current_round}` : "‚úÖ ƒê√£ ho√†n th√†nh"}</td>
          <td>
            <select class="status-select" data-user-id="${user.id}" style="padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
              <option value="Ch·ªù x·ª≠ l√Ω" ${user.status === 'Ch·ªù x·ª≠ l√Ω' ? 'selected' : ''}>Ch·ªù x·ª≠ l√Ω</option>
              <option value="ƒê√£ duy·ªát" ${user.status === 'ƒê√£ duy·ªát' ? 'selected' : ''}>ƒê√£ duy·ªát</option>
              <option value="T·ª´ ch·ªëi" ${user.status === 'T·ª´ ch·ªëi' ? 'selected' : ''}>T·ª´ ch·ªëi</option>
            </select>
          </td>
          <td>
            <button class="action-btn-small" data-user-id="${user.id}" data-action="edit">
              <i class="fas fa-edit"></i> Ch·ªânh s·ª≠a
            </button>
            <button class="action-btn-small success" data-user-id="${user.id}" data-action="view">
              <i class="fas fa-eye"></i> Xem
            </button>
          </td>
        </tr>
      `).join("");
      
      // Th√™m s·ª± ki·ªán cho c√°c n√∫t h√†nh ƒë·ªông
      document.querySelectorAll('.action-btn-small').forEach(btn => {
        btn.addEventListener('click', function() {
          const userId = this.dataset.userId;
          const action = this.dataset.action;
          
          if (action === 'edit') {
            editUser(userId);
          } else if (action === 'view') {
            viewProfile(userId);
          }
        });
      });
      
      // Th√™m s·ª± ki·ªán cho dropdown tr·∫°ng th√°i
      document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', function() {
          const userId = this.dataset.userId;
          updateStatus(userId, this.value);
        });
      });
    }
    
    // H√†m l·ªçc ·ª©ng vi√™n
    function filterUsers() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const roundFilter = document.getElementById('roundFilter').value;
      
      filteredUsersData = usersData.filter(user => {
        const nameMatch = user.fullname.toLowerCase().includes(searchTerm);
        const emailMatch = user.email.toLowerCase().includes(searchTerm);
        const statusMatch = statusFilter ? user.status === statusFilter : true;
        
        let roundMatch = true;
        if (roundFilter) {
          if (roundFilter === '5') {
            roundMatch = user.current_round > 4;
          } else {
            roundMatch = user.current_round == roundFilter;
          }
        }
        
        return (nameMatch || emailMatch) && statusMatch && roundMatch;
      });
      
      renderUsers();
    }
    
    // H√†m s·∫Øp x·∫øp
    function sortUsers(field) {
      if (currentSortField === field) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortField = field;
        currentSortDirection = 'asc';
      }
      
      document.querySelectorAll('th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
      });
      
      const header = document.querySelector(`th[data-sort="${field}"]`);
      if (header) {
        header.classList.add(`sort-${currentSortDirection}`);
      }
      
      filteredUsersData.sort((a, b) => {
        let valueA = a[field] || '';
        let valueB = b[field] || '';
        
        if (field === 'current_round') {
          return currentSortDirection === 'asc' ? 
            valueA - valueB : valueB - valueA;
        }
        
        if (valueA < valueB) return currentSortDirection === 'asc' ? -1 : 1;
        if (valueA > valueB) return currentSortDirection === 'asc' ? 1 : -1;
        return 0;
      });
      
      renderUsers();
    }

    // H√†m ch·ªânh s·ª≠a th√¥ng tin ·ª©ng vi√™n
    async function editUser(uid) {
      const user = usersData.find(u => u.id === uid);
      const name = prompt("H·ªç t√™n:", user.fullname);
      const email = prompt("Email:", user.email);
      if (name && email) {
        try {
          await updateDoc(doc(db, "users", uid), { fullname: name, email });
          loadUsers();
          showAlert("ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin ·ª©ng vi√™n!", "success");
        } catch (error) {
          console.error("L·ªói c·∫≠p nh·∫≠t:", error);
          showAlert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng tin ·ª©ng vi√™n.", "error");
        }
      }
    }
    
    // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i
    async function updateStatus(uid, status) {
      try {
        await updateDoc(doc(db, "users", uid), { status });
        const userIndex = usersData.findIndex(u => u.id === uid);
        if (userIndex !== -1) {
          usersData[userIndex].status = status;
        }
        showAlert("ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i!", "success");
      } catch (error) {
        console.error("L·ªói c·∫≠p nh·∫≠t:", error);
        showAlert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i.", "error");
      }
    }

    // H√†m xem profile
    function viewProfile(uid) {
      const user = usersData.find(u => u.id === uid);
      if (user) {
        document.getElementById('selectedUserIdRounds').value = uid;
        renderSelectedRoundUser();
        showTab('roundsTab');
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector('.tab-btn[data-tab="roundsTab"]').classList.add('active');
      }
    }

    // H√†m hi·ªÉn th·ªã tab
    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
    }
    
    // H√†m render th√¥ng tin v√≤ng
    function renderSelectedRoundUser() {
      const uid = document.getElementById("selectedUserIdRounds").value;
      currentSelectedUser = uid;
      renderRounds(uid);
    }

    function renderSelectedDetailUser() {
      const uid = document.getElementById("selectedUserIdDetails").value;
      renderRoundDetails(uid);
    }
    
    function loadUserHistory() {
      const uid = document.getElementById("selectedUserIdHistory").value;
      if (!uid) {
        historyList.innerHTML = '<p>Vui l√≤ng ch·ªçn ·ª©ng vi√™n ƒë·ªÉ xem l·ªãch s·ª≠</p>';
        return;
      }
      
      const histories = [
        { date: '2025-07-01 14:30', action: 'ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh "ƒê√£ duy·ªát"' },
        { date: '2025-06-28 10:15', action: 'ƒê√£ chuy·ªÉn sang v√≤ng 3: Th·ª≠ th√°ch' },
        { date: '2025-06-25 16:45', action: 'ƒê√£ ho√†n th√†nh v√≤ng 2: Ph·ªèng v·∫•n nh√≥m' },
        { date: '2025-06-20 09:30', action: 'ƒê√£ g·ª≠i th√¥ng b√°o v·ªÅ l·ªãch ph·ªèng v·∫•n' },
        { date: '2025-06-15 11:20', action: 'ƒê√£ ƒëƒÉng k√Ω ·ª©ng tuy·ªÉn' }
      ];
      
      historyList.innerHTML = `
        <table class="user-table">
          <thead>
            <tr>
              <th>Th·ªùi gian</th>
              <th>Ho·∫°t ƒë·ªông</th>
            </tr>
          </thead>
          <tbody>
            ${histories.map(history => `
              <tr>
                <td>${history.date}</td>
                <td>${history.action}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderRounds(uid) {
      const user = usersData.find(u => u.id === uid);
      if (!user) {
        roundsContainer.innerHTML = "<p class='no-data'>Vui l√≤ng ch·ªçn ·ª©ng vi√™n</p>";
        updateProfilePreview(null);
        return;
      }

      roundsContainer.innerHTML = `
        <div class="round-box">
          <h3 class="round-title"><i class="fas fa-user"></i> ${user.fullname}</h3>
          <div class="form-group">
            <label class="form-label">C·∫≠p nh·∫≠t v√≤ng hi·ªán t·∫°i:</label>
            <select class="select-box" id="roundSelect-${user.id}">
              ${[1, 2, 3, 4, 5].map(i => `
                <option value="${i}" ${i == user.current_round ? "selected" : ""}>
                  ${i <= 4 ? `V√≤ng ${i}: ${steps[i-1]}` : "‚úÖ ƒê√£ ho√†n th√†nh"}
                </option>
              `).join("")}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Th√™m v√†o l·ªãch Google:</label>
            <a href="https://calendar.google.com/calendar/render?action=TEMPLATE&text=Ph·ªèng+v·∫•n+${user.fullname}&details=Ph·ªèng+v·∫•n+cho+v·ªã+tr√≠+th√†nh+vi√™n+Enactus" 
               target="_blank" class="btn">
              <i class="fab fa-google"></i> Th√™m v√†o Google Calendar
            </a>
          </div>
        </div>
      `;
      
      // Th√™m s·ª± ki·ªán cho dropdown v√≤ng
      document.getElementById(`roundSelect-${user.id}`).addEventListener('change', function() {
        changeRound(user.id, this.value);
      });
      
      updateProfilePreview(user);
    }

    function renderRoundDetails(uid) {
      const user = usersData.find(u => u.id === uid);
      if (!user) {
        roundDetailContainer.innerHTML = "<p class='no-data'>Vui l√≤ng ch·ªçn ·ª©ng vi√™n</p>";
        return;
      }

      const roundsHTML = [1, 2, 3, 4].map(i => {
        const info = user[`round_${i}`] || {};
        return `
          <div class="round-box">
            <h3 class="round-title"><i class="fas fa-circle"></i> V√≤ng ${i}: ${steps[i - 1]}</h3>
            <div class="form-group">
              <label class="form-label">Th·ªùi gian:</label>
              <input type="text" class="input-box" value="${info.time || ''}" 
                     placeholder="VD: 15:00 - 17:00, Th·ª© 7 ng√†y 15/07/2023" 
                     id="time-${user.id}-${i}">
            </div>
            <div class="form-group">
              <label class="form-label">ƒê·ªãa ƒëi·ªÉm:</label>
              <input type="text" class="input-box" value="${info.location || ''}" 
                     placeholder="ƒê·ªãa ƒëi·ªÉm di·ªÖn ra" 
                     id="location-${user.id}-${i}">
            </div>
            <div class="form-group">
              <label class="form-label">Ng∆∞·ªùi ph·ªèng v·∫•n:</label>
              <input type="text" class="input-box" value="${info.interviewer || ''}" 
                     placeholder="Ng∆∞·ªùi ph·ª• tr√°ch" 
                     id="interviewer-${user.id}-${i}">
            </div>
            <div class="form-group">
              <label class="form-label">Ghi ch√∫:</label>
              <textarea class="input-box" id="note-${user.id}-${i}" 
                     placeholder="Ghi ch√∫ cho ·ª©ng vi√™n">${info.note || ''}</textarea>
            </div>
            <button class="save-btn" data-user-id="${user.id}" data-round="${i}">
              <i class="fas fa-save"></i> L∆∞u th√¥ng tin
            </button>
          </div>
        `;
      }).join("");
      roundDetailContainer.innerHTML = `<div>${roundsHTML}</div>`;
      
      // Th√™m s·ª± ki·ªán cho c√°c n√∫t l∆∞u
      document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const userId = this.dataset.userId;
          const round = this.dataset.round;
          saveRound(userId, round);
        });
      });
    }

    // H√†m thay ƒë·ªïi v√≤ng
    async function changeRound(uid, value) {
      try {
        await updateDoc(doc(db, "users", uid), { current_round: parseInt(value) });
        loadUsers();
        showAlert("ƒê√£ c·∫≠p nh·∫≠t v√≤ng hi·ªán t·∫°i!", "success");
        
        const user = usersData.find(u => u.id === uid);
        if (user) {
          user.current_round = parseInt(value);
          updateProfilePreview(user);
        }
      } catch (error) {
        console.error("L·ªói c·∫≠p nh·∫≠t:", error);
        showAlert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t v√≤ng hi·ªán t·∫°i.", "error");
      }
    }

    // H√†m l∆∞u th√¥ng tin v√≤ng
    async function saveRound(uid, round) {
      const time = document.getElementById(`time-${uid}-${round}`).value;
      const location = document.getElementById(`location-${uid}-${round}`).value;
      const interviewer = document.getElementById(`interviewer-${uid}-${round}`).value;
      const note = document.getElementById(`note-${uid}-${round}`).value;
      
      try {
        await updateDoc(doc(db, "users", uid), {
          [`round_${round}`]: { time, location, interviewer, note }
        });
        showAlert("ƒê√£ l∆∞u th√¥ng tin v√≤ng th√†nh c√¥ng!", "success");
        
        const user = usersData.find(u => u.id === uid);
        if (user) {
          user[`round_${round}`] = { time, location, interviewer, note };
          updateProfilePreview(user);
        }
      } catch (error) {
        console.error("L·ªói l∆∞u v√≤ng:", error);
        showAlert("Kh√¥ng th·ªÉ l∆∞u th√¥ng tin v√≤ng.", "error");
      }
    }
    
    // H√†m xu·∫•t CSV
    function exportToCSV() {
      let csvContent = "H·ªç t√™n,Email,V√≤ng hi·ªán t·∫°i,Tr·∫°ng th√°i\n";
      
      filteredUsersData.forEach(user => {
        const round = user.current_round <= 4 ? `V√≤ng ${user.current_round}` : "ƒê√£ ho√†n th√†nh";
        csvContent += `"${user.fullname}","${user.email}","${round}","${user.status || ''}"\n`;
      });
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'danh_sach_ung_vien.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showAlert('ƒê√£ xu·∫•t file CSV th√†nh c√¥ng!', 'success');
    }

    // H√†m ƒëƒÉng nh·∫≠p
    async function login() {
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;
      
      if (!email || !password) {
        showAlert("Vui l√≤ng nh·∫≠p email v√† m·∫≠t kh·∫©u.", "warning");
        return;
      }
      
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("adminContent").style.display = "block";
        loadUsers();
        showAlert("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!", "success");
      } catch (error) {
        console.error("L·ªói ƒëƒÉng nh·∫≠p:", error);
        showAlert("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra email v√† m·∫≠t kh·∫©u.", "error");
      }
    }

    // H√†m ƒëƒÉng xu·∫•t
    async function logout() {
      try {
        await signOut(auth);
        document.getElementById("loginBox").style.display = "block";
        document.getElementById("adminContent").style.display = "none";
        document.getElementById("loginForm").reset();
        showAlert("B·∫°n ƒë√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!", "info");
      } catch (error) {
        console.error("L·ªói ƒëƒÉng xu·∫•t:", error);
        showAlert("ƒêƒÉng xu·∫•t th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.", "error");
      }
    }

    // Kh·ªüi t·∫°o s·ª± ki·ªán
    function initEventListeners() {
      // N√∫t ƒëƒÉng nh·∫≠p
      document.getElementById('loginButton').addEventListener('click', login);
      
      // N√∫t l√†m m·ªõi
      document.getElementById('refreshButton').addEventListener('click', loadUsers);
      
      // N√∫t ƒëƒÉng xu·∫•t
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      // N√∫t xu·∫•t CSV
      document.getElementById('exportButton').addEventListener('click', exportToCSV);
      
      // T√¨m ki·∫øm v√† l·ªçc
      document.getElementById('searchInput').addEventListener('input', filterUsers);
      document.getElementById('statusFilter').addEventListener('change', filterUsers);
      document.getElementById('roundFilter').addEventListener('change', filterUsers);
      
      // Dropdown ch·ªçn ·ª©ng vi√™n
      document.getElementById('selectedUserIdRounds').addEventListener('change', renderSelectedRoundUser);
      document.getElementById('selectedUserIdDetails').addEventListener('change', renderSelectedDetailUser);
      document.getElementById('selectedUserIdHistory').addEventListener('change', loadUserHistory);
      
      // Tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          showTab(this.dataset.tab);
        });
      });
      
      // S·∫Øp x·∫øp b·∫£ng
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.addEventListener('click', function() {
          sortUsers(this.dataset.sort);
        });
      });
    }

    // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("adminContent").style.display = "block";
        loadUsers();
      } else {
        document.getElementById("loginBox").style.display = "block";
        document.getElementById("adminContent").style.display = "none";
      }
    });

    // Kh·ªüi ch·∫°y ·ª©ng d·ª•ng
    document.addEventListener('DOMContentLoaded', function() {
      initEventListeners();
    });
  </script>
</body>
</html>
