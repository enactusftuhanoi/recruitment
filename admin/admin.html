<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin | Enactus FTU Hanoi</title>
  <link rel="favicon" href="/favicon.ico" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css">
  <style>
    :root {
      --primary: #1a73e8;
      --primary-dark: #0d62cb;
      --primary-light: #e8f0fe;
      --secondary: #f5f7fa;
      --accent: #ff6b6b;
      --success: #4caf50;
      --warning: #ff9800;
      --info: #17a2b8;
      --text: #202124;
      --text-light: #5f6368;
      --border: #dadce0;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
    }

    body {
      background: #f5f7fa;
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Header styles */
    .admin-header {
      background: white;
      padding: 15px 30px;
      box-shadow: var(--card-shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 50px;
      height: 50px;
      background: var(--primary);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
    }

    .logo-text {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    .admin-actions {
      display: flex;
      gap: 15px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      border: none;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-outline {
      background: white;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .btn-outline:hover {
      background: var(--primary-light);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    /* Main container */
    .app-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Dashboard stats */
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-title {
      font-size: 16px;
      color: var(--text-light);
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
    }

    /* Filter section */
    .filter-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--card-shadow);
    }

    .filter-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    .filter-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-light);
    }

    .filter-input {
      width: 100%;
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 15px;
    }

    /* Main tabs */
    .main-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 15px;
      flex-wrap: wrap;
    }

    .main-tab-btn {
      padding: 12px 25px;
      border-radius: 8px;
      background: white;
      border: 1px solid var(--border);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      white-space: nowrap;
    }

    .main-tab-btn:hover, .main-tab-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .main-tab-content {
      display: none;
    }

    .main-tab-content.active {
      display: block;
      animation: fadeIn 0.4s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Candidate table */
    .candidate-table-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      overflow-x: auto;
    }

    .candidate-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .candidate-table th, 
    .candidate-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .candidate-table th {
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      position: relative;
    }

    .candidate-table th.sort-asc::after {
      content: ' \25B2';
      font-size: 12px;
    }
    
    .candidate-table th.sort-desc::after {
      content: ' \25BC';
      font-size: 12px;
    }

    .candidate-table tr:hover {
      background: rgba(26, 115, 232, 0.03);
    }

    .badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .badge-primary {
      background: var(--primary-light);
      color: var(--primary);
    }

    .badge-success {
      background: rgba(76, 175, 80, 0.15);
      color: var(--success);
    }

    .badge-warning {
      background: rgba(255, 152, 0, 0.15);
      color: var(--warning);
    }

    .badge-danger {
      background: rgba(255, 107, 107, 0.15);
      color: var(--accent);
    }

    .action-btn {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: var(--transition);
    }

    .action-btn-sm {
      padding: 5px 10px;
      font-size: 13px;
    }

    .btn-view {
      background: var(--primary);
      color: white;
    }

    .btn-edit {
      background: var(--warning);
      color: white;
    }

    .btn-delete {
      background: var(--accent);
      color: white;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      overflow: auto;
    }

    .modal-content {
      background: white;
      margin: 5% auto;
      padding: 30px;
      border-radius: 12px;
      width: 80%;
      max-width: 800px;
      box-shadow: 0 5px 30px rgba(0,0,0,0.3);
      animation: modalFadeIn 0.3s;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-50px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      font-size: 24px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .close-modal {
      font-size: 28px;
      cursor: pointer;
      color: var(--text-light);
    }

    .candidate-detail {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 30px;
    }

    .candidate-avatar {
      text-align: center;
    }

    .avatar-img {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary-light);
      margin-bottom: 20px;
      background-color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ccc;
      font-size: 40px;
    }

    .candidate-status {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      margin-bottom: 20px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .info-card {
      background: #f9fbfd;
      border-radius: 8px;
      padding: 15px;
      border-left: 3px solid var(--primary);
    }

    .info-label {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 5px;
    }

    .info-value {
      font-size: 16px;
      font-weight: 600;
    }

    /* Round details */
    .round-section {
      margin-top: 30px;
    }

    .round-title {
      font-size: 20px;
      color: var(--primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .round-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .detail-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: var(--card-shadow);
    }

    .detail-title {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 5px;
    }

    .detail-content {
      font-size: 16px;
      font-weight: 600;
    }

    /* Round management tabs */
    .round-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 15px;
    }

    .round-tab-btn {
      padding: 10px 20px;
      border-radius: 6px;
      background: white;
      border: 1px solid var(--border);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

    .round-tab-btn:hover, .round-tab-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .round-tab-content {
      display: none;
    }

    .round-tab-content.active {
      display: block;
      animation: fadeIn 0.4s;
    }

    /* Form elements */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-light);
    }

    .form-control {
      width: 100%;
      padding: 10px 15px;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-size: 15px;
    }

    .form-control:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    }

    /* History section */
    .history-item {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: var(--card-shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-date {
      font-weight: 600;
      color: var(--text-light);
      min-width: 150px;
    }

    .history-action {
      flex: 1;
    }

    /* Responsive */
    @media (max-width: 992px) {
      .candidate-detail {
        grid-template-columns: 1fr;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .dashboard-stats {
        grid-template-columns: 1fr 1fr;
      }
      
      .modal-content {
        width: 95%;
        padding: 20px;
      }
      
      .main-tabs {
        flex-direction: column;
      }
      
      .main-tab-btn {
        width: 100%;
      }
    }

    @media (max-width: 576px) {
      .dashboard-stats {
        grid-template-columns: 1fr;
      }
      
      .admin-header {
        flex-direction: column;
        gap: 15px;
      }
      
      .admin-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      .round-tabs {
        flex-direction: column;
      }
      
      .round-tab-btn {
        width: 100%;
      }
      
      .history-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- Admin Content (hidden until login) -->
  <div id="adminContent" style="display: none;">
    <!-- Header -->
    <div class="admin-header">
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="logo-text">ENACTUS FTU HANOI - QUẢN TRỊ</div>
      </div>
      <div class="admin-actions">
        <button id="refreshButton" class="btn btn-outline">
          <i class="fas fa-sync-alt"></i> Làm mới
        </button>
        <button id="exportButton" class="btn btn-success">
          <i class="fas fa-file-export"></i> Xuất CSV
        </button>
        <button id="logoutBtn" class="btn btn-primary">
          <i class="fas fa-sign-out-alt"></i> Đăng xuất
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="app-container">
      <h1 style="margin: 30px 0 20px; color: var(--text);">
        <i class="fas fa-users"></i> Quản lý ứng viên
      </h1>
      
      <!-- Dashboard Stats -->
      <div class="dashboard-stats">
        <div class="stat-card">
          <div class="stat-title">Tổng ứng viên</div>
          <div class="stat-value" id="totalCandidates">0</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-title">Đã hoàn thành</div>
          <div class="stat-value" id="completedCandidates">0</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-title">Đang trong quá trình</div>
          <div class="stat-value" id="inProgressCandidates">0</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-title">Chờ xử lý</div>
          <div class="stat-value" id="pendingCandidates">0</div>
        </div>
      </div>
      
      <!-- Main Tabs -->
      <div class="main-tabs">
        <button class="main-tab-btn active" data-tab="candidatesTab">
          <i class="fas fa-users"></i> Danh sách ứng viên
        </button>
        <button class="main-tab-btn" data-tab="roundsTab">
          <i class="fas fa-tasks"></i> Quản lý vòng
        </button>
        <button class="main-tab-btn" data-tab="settingsTab">
          <i class="fas fa-cog"></i> Cấp quyền
        </button>
      </div>

      <div class="mb-3">
        <label for="round-select">Chuyển tất cả ứng viên pass sang vòng:</label>
        <select id="round-select" class="form-select">
          <option value="1">Vòng 1 - Vòng đơn</option>
          <option value="2">Vòng 2 - Phỏng vấn nhóm</option>
          <option value="3">Vòng 3 - Thử thách</option>
          <option value="4">Vòng 4 - Phỏng vấn cá nhân</option>
          <option value="5">Hoàn thành</option>
        </select>
        <button id="update-round-btn" class="btn btn-primary mt-2">Cập nhật vòng</button>
      </div>
      
      <!-- Candidates Tab -->
      <div id="candidatesTab" class="main-tab-content active">
        <!-- Filter Section -->
        <div class="filter-section">
          <h3 style="margin-bottom: 15px; color: var(--primary);">
            <i class="fas fa-filter"></i> Bộ lọc ứng viên
          </h3>
          
          <div class="filter-row">
            <div class="filter-group">
              <label class="filter-label">Tìm kiếm</label>
              <input type="text" id="searchInput" class="filter-input" placeholder="Tìm theo tên, email, SĐT...">
            </div>
            
            <div class="filter-group">
              <label class="filter-label">Ban ứng tuyển</label>
              <select id="departmentFilter" class="filter-input">
                <option value="">Tất cả ban</option>
                <option value="HR">Nhân sự</option>
                <option value="MD">Truyền thông</option>
                <option value="ER">Đối ngoại</option>
                <option value="PD">Dự án</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label class="filter-label">Vòng hiện tại</label>
              <select id="roundFilter" class="filter-input">
                <option value="">Tất cả vòng</option>
                <option value="1">Vòng đơn</option>
                <option value="2">Phỏng vấn nhóm</option>
                <option value="3">Thử thách</option>
                <option value="4">Phỏng vấn cá nhân</option>
                <option value="5">Đã hoàn thành</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label class="filter-label">Trạng thái</label>
              <select id="statusFilter" class="filter-input">
                <option value="">Tất cả trạng thái</option>
                <option value="pending">Pending</option>
                <option value="pass">Pass</option>
                <option value="not pass">Not pass</option>
                <option value="voted">Voted</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Candidate Table -->
        <div class="candidate-table-container">
          <table class="candidate-table">
            <thead>
              <tr>
                <th data-sort="fullname">Họ tên</th>
                <th data-sort="department">Ban ứng tuyển</th>
                <th data-sort="email">Email</th>
                <th data-sort="phone">SĐT</th>
                <th data-sort="current_round">Vòng hiện tại</th>
                <th data-sort="status">Trạng thái</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody id="candidateList">
              <!-- Candidate data will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Rounds Management Tab -->
      <div id="roundsTab" class="main-tab-content">
        <div class="filter-section">
          <h3 style="margin-bottom: 15px; color: var(--primary);">
            <i class="fas fa-tasks"></i> Quản lý vòng tuyển dụng
          </h3>
          
          <div class="filter-row">
            <div class="filter-group">
              <label class="filter-label">Chọn ứng viên</label>
              <select id="roundCandidateSelect" class="filter-input">
                <option value="">-- Chọn ứng viên --</option>
              </select>
            </div>
          </div>
        </div>
        
        <div id="roundManagementContent" style="display: none;">
          <!-- Round Tabs -->
          <div class="round-tabs">
            <button class="round-tab-btn active" data-tab="round1Tab">Vòng đơn</button>
            <button class="round-tab-btn" data-tab="round2Tab">Phỏng vấn nhóm</button>
            <button class="round-tab-btn" data-tab="round3Tab">Thử thách</button>
            <button class="round-tab-btn" data-tab="round4Tab">Phỏng vấn cá nhân</button>
          </div>
          
          <!-- Round 1 Content -->
          <div id="round1Tab" class="round-tab-content active">
            <div class="form-group">
              <label class="form-label">Trạng thái</label>
              <select class="form-control" id="round1StatusSelect">
              </select>
            </div>
            <button class="btn btn-primary" id="saveRound1Btn">
              <i class="fas fa-save"></i> Lưu thông tin
            </button>
          </div>
          
          <!-- Vòng 2 - Phỏng vấn nhóm -->
          <div id="round2Tab" class="round-tab-content">
            <h4>Vòng 2: Phỏng vấn nhóm</h4>

            <!-- Ban ưu tiên -->
            <h5>Ban ưu tiên</h5>
            <div class="form-group">
              <label id="round2PriorityLabel">Trạng thái (Ban ưu tiên)</label>
              <select id="round2PriorityStatusSelect" class="form-control">
                <option value="pending">Pending</option>
                <option value="pass">Pass</option>
                <option value="not pass">Not pass</option>
                <option value="voted">Voted</option>
              </select>
            </div>
            <div class="form-group">
              <label>Thời gian</label>
              <input type="datetime-local" id="round2PriorityTime" class="form-control">
            </div>
            <div class="form-group">
              <label>Địa điểm</label>
              <input type="text" id="round2PriorityLocation" class="form-control">
            </div>
            <div class="form-group">
              <label>Thành viên nhóm</label>
              <input type="text" id="round2PriorityMembers" class="form-control" placeholder="Nhập tên các thành viên">
            </div>
            <div class="form-group">
              <label>Ghi chú</label>
              <textarea id="round2PriorityNote" class="form-control"></textarea>
            </div>

            <hr>

            <!-- Ban dự bị -->
            <h5>Ban dự bị</h5>
            <div class="form-group">
              <label id="round2SecondaryLabel">Trạng thái (Ban ưu tiên)</label>
              <select id="round2SecondaryStatusSelect" class="form-control">
                <option value="pending">Pending</option>
                <option value="pass">Pass</option>
                <option value="not pass">Not pass</option>
                <option value="voted">Voted</option>
              </select>
            </div>
            <div class="form-group">
              <label>Thời gian</label>
              <input type="datetime-local" id="round2SecondaryTime" class="form-control">
            </div>
            <div class="form-group">
              <label>Địa điểm</label>
              <input type="text" id="round2SecondaryLocation" class="form-control">
            </div>
            <div class="form-group">
              <label>Thành viên nhóm</label>
              <input type="text" id="round2SecondaryMembers" class="form-control" placeholder="Nhập tên các thành viên">
            </div>
            <div class="form-group">
              <label>Ghi chú</label>
              <textarea id="round2SecondaryNote" class="form-control"></textarea>
            </div>

            <button class="btn btn-primary mt-3" onclick="saveRoundData(2)">Lưu vòng 2</button>
          </div>
          
          <!-- Vòng 3 - Thử thách -->
          <div id="round3Tab" class="round-tab-content">
            <h4>Vòng 3: Thử thách</h4>

            <!-- Ban ưu tiên -->
            <h5>Ban ưu tiên</h5>
            <div class="form-group">
              <label id="round3PriorityLabel">Trạng thái (Ban ưu tiên)</label>
              <select id="round3PriorityStatusSelect" class="form-control">
                <option value="pending">Pending</option>
                <option value="pass">Pass</option>
                <option value="not pass">Not pass</option>
                <option value="voted">Voted</option>
              </select>
            </div>
            <div class="form-group">
              <label>Đề bài thử thách</label>
              <input type="text" id="round3PriorityChallenge" class="form-control">
            </div>
            <div class="form-group">
              <label>Tài liệu</label>
              <input type="text" id="round3PriorityMaterials" class="form-control">
            </div>
            <div class="form-group">
              <label>Deadline</label>
              <input type="datetime-local" id="round3PriorityDeadline" class="form-control">
            </div>
            <div class="form-group">
              <label>Pitching</label>
              <input type="text" id="round3PriorityPitching" class="form-control">
            </div>
            <div class="form-group">
              <label>Cố vấn</label>
              <input type="text" id="round3PriorityAdvisor" class="form-control">
            </div>
            <div class="form-group">
              <label>Thành viên nhóm</label>
              <input type="text" id="round3PriorityMembers" class="form-control" placeholder="Nhập tên các thành viên">
            </div>
            <div class="form-group">
              <label>Ghi chú</label>
              <textarea id="round3PriorityNote" class="form-control"></textarea>
            </div>

            <hr>

            <!-- Ban dự bị -->
            <h5>Ban dự bị</h5>
            <div class="form-group">
              <label id="round3SecondaryLabel">Trạng thái (Ban ưu tiên)</label>
              <select id="round3SecondaryStatusSelect" class="form-control">
                <option value="pending">Pending</option>
                <option value="pass">Pass</option>
                <option value="not pass">Not pass</option>
                <option value="voted">Voted</option>
              </select>
            </div>
            <div class="form-group">
              <label>Đề bài thử thách</label>
              <input type="text" id="round3SecondaryChallenge" class="form-control">
            </div>
            <div class="form-group">
              <label>Tài liệu</label>
              <input type="text" id="round3SecondaryMaterials" class="form-control">
            </div>
            <div class="form-group">
              <label>Deadline</label>
              <input type="datetime-local" id="round3SecondaryDeadline" class="form-control">
            </div>
            <div class="form-group">
              <label>Pitching</label>
              <input type="text" id="round3SecondaryPitching" class="form-control">
            </div>
            <div class="form-group">
              <label>Cố vấn</label>
              <input type="text" id="round3SecondaryAdvisor" class="form-control">
            </div>
            <div class="form-group">
              <label>Thành viên nhóm</label>
              <input type="text" id="round3SecondaryMembers" class="form-control" placeholder="Nhập tên các thành viên">
            </div>
            <div class="form-group">
              <label>Ghi chú</label>
              <textarea id="round3SecondaryNote" class="form-control"></textarea>
            </div>

            <button class="btn btn-primary mt-3" onclick="saveRoundData(3)">Lưu vòng 3</button>
          </div>

          
          <!-- Vòng 4 - Phỏng vấn cá nhân -->
          <div id="round4Tab" class="round-tab-content">
            <h4>Vòng 4: Phỏng vấn cá nhân</h4>

            <!-- Ban ưu tiên -->
            <h5>Ban ưu tiên</h5>
            <div class="form-group">
              <label id="round4PriorityLabel">Trạng thái (Ban ưu tiên)</label>
              <select id="round4PriorityStatusSelect" class="form-control">
                <option value="pending">Pending</option>
                <option value="pass">Pass</option>
                <option value="not pass">Not pass</option>
                <option value="voted">Voted</option>
              </select>
            </div>
            <div class="form-group">
              <label>Thời gian</label>
              <input type="datetime-local" id="round4PriorityTime" class="form-control">
            </div>
            <div class="form-group">
              <label>Địa điểm</label>
              <input type="text" id="round4PriorityLocation" class="form-control">
            </div>
            <div class="form-group">
              <label>Người phỏng vấn</label>
              <input type="text" id="round4PriorityInterviewer" class="form-control">
            </div>
            <div class="form-group">
              <label>Ghi chú</label>
              <textarea id="round4PriorityNote" class="form-control"></textarea>
            </div>

            <hr>

            <!-- Ban dự bị -->
            <h5>Ban dự bị</h5>
            <div class="form-group">
              <label id="round4SecondaryLabel">Trạng thái (Ban ưu tiên)</label>
              <select id="round4SecondaryStatusSelect" class="form-control">
                <option value="pending">Pending</option>
                <option value="pass">Pass</option>
                <option value="not pass">Not pass</option>
                <option value="voted">Voted</option>
              </select>
            </div>
            <div class="form-group">
              <label>Thời gian</label>
              <input type="datetime-local" id="round4SecondaryTime" class="form-control">
            </div>
            <div class="form-group">
              <label>Địa điểm</label>
              <input type="text" id="round4SecondaryLocation" class="form-control">
            </div>
            <div class="form-group">
              <label>Người phỏng vấn</label>
              <input type="text" id="round4SecondaryInterviewer" class="form-control">
            </div>
            <div class="form-group">
              <label>Ghi chú</label>
              <textarea id="round4SecondaryNote" class="form-control"></textarea>
            </div>

            <button class="btn btn-primary mt-3" onclick="saveRoundData(4)">Lưu vòng 4</button>
          </div>

        
        <div id="noCandidateSelected" class="filter-section" style="text-align: center; padding: 50px;">
          <i class="fas fa-user-slash" style="font-size: 48px; color: var(--text-light); margin-bottom: 20px;"></i>
          <h3 style="color: var(--text-light);">Vui lòng chọn ứng viên để quản lý vòng tuyển dụng</h3>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Candidate Detail Modal -->
  <div id="candidateModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-user"></i> 
          <span id="modalCandidateName">Chi tiết ứng viên</span>
        </h2>
        <span class="close-modal">&times;</span>
      </div>
      
      <div class="candidate-detail">
        <div class="candidate-avatar">
          <div class="avatar-img" id="modalAvatar">
            <i class="fas fa-user"></i>
          </div>
          <button class="btn btn-primary" id="editCandidateBtn">
            <i class="fas fa-edit"></i> Chỉnh sửa
          </button>
        </div>
        
        <div>
          <div class="candidate-status">
            <div class="status-item">
              <span>Ban ứng tuyển:</span>
              <span class="badge badge-primary" id="modalDepartment">Nhân sự</span>
            </div>
            <div class="status-item">
              <span>Vòng hiện tại:</span>
              <span class="badge badge-success" id="modalCurrentRound">Vòng 1</span>
            </div>
            <div class="status-item">
              <span>Trạng thái:</span>
              <span class="badge badge-warning" id="modalStatus">Chờ xử lý</span>
            </div>
          </div>
          
          <div class="info-grid">
            <div class="info-card">
              <div class="info-label">Họ và tên</div>
              <div class="info-value" id="modalFullName">Chưa có dữ liệu</div>
            </div>
            <div class="info-card">
              <div class="info-label">Giới tính</div>
              <div class="info-value" id="modalGender">Chưa có dữ liệu</div>
            </div>
            <div class="info-card">
              <div class="info-label">Email</div>
              <div class="info-value" id="modalEmail">Chưa có dữ liệu</div>
            </div>
            <div class="info-card">
              <div class="info-label">Số điện thoại</div>
              <div class="info-value" id="modalPhone">Chưa có dữ liệu</div>
            </div>
            <div class="info-card">
              <div class="info-label">Ngày sinh</div>
              <div class="info-value" id="modalBirthdate">Chưa có dữ liệu</div>
            </div>
            <div class="info-card">
              <div class="info-label">Trường</div>
              <div class="info-value" id="modalSchool">Chưa có dữ liệu</div>
            </div>
            <div class="info-card">
              <div class="info-label">Khoa/Ngành</div>
              <div class="info-value" id="modalMajor">Chưa có dữ liệu</div>
            </div>
            <div class="info-card">
              <div class="info-label">Facebook</div>
              <div class="info-value" id="modalFacebook">Chưa có dữ liệu</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Candidate Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-edit"></i> 
          <span id="editModalTitle">Chỉnh sửa thông tin ứng viên</span>
        </h2>
        <span class="close-modal">&times;</span>
      </div>
      
      <div class="form-group">
        <label class="form-label">Họ và tên</label>
        <input type="text" class="form-control" id="editFullName">
      </div>
      
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" class="form-control" id="editEmail">
      </div>
      
      <div class="form-group">
        <label class="form-label">Số điện thoại</label>
        <input type="tel" class="form-control" id="editPhone">
      </div>
      
      <div class="form-group">
        <label class="form-label">Ban ứng tuyển</label>
        <select class="form-control" id="editDepartment">
          <option value="Nhân sự">Nhân sự</option>
          <option value="Truyền thông">Truyền thông</option>
          <option value="Đối ngoại">Đối ngoại</option>
          <option value="Dự án">Dự án</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Vòng hiện tại</label>
        <select class="form-control" id="editCurrentRound">
          <option value="1">Vòng 1: Vòng đơn</option>
          <option value="2">Vòng 2: Phỏng vấn nhóm</option>
          <option value="3">Vòng 3: Thử thách</option>
          <option value="4">Vòng 4: Phỏng vấn cá nhân</option>
          <option value="5">Hoàn thành</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Trạng thái</label>
        <select class="form-control" id="editStatus">
        </select>
      </div>
      
      <button class="btn btn-primary" id="saveEditBtn" style="width: 100%; padding: 12px; margin-top: 20px;">
        <i class="fas fa-save"></i> Lưu thay đổi
      </button>
    </div>
  </div>

  <!-- Firebase and other scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>
  <!-- Firebase App (namespace version) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module" src="/script/response.js"></script>
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      signOut, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      doc, 
      updateDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAOP2j0qV0Ge-q2-Y9zo9Qc3eLmgtVOK3k",
        authDomain: "recruitment-enactusftuhanoi.firebaseapp.com",
        projectId: "recruitment-enactusftuhanoi",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Toastr configuration
    toastr.options = {
      closeButton: true,
      debug: false,
      newestOnTop: true,
      progressBar: true,
      positionClass: 'toast-bottom-right',
      preventDuplicates: false,
      onclick: null,
      showDuration: '300',
      hideDuration: '1000',
      timeOut: '3000',
      extendedTimeOut: '1000',
      showEasing: 'swing',
      hideEasing: 'linear',
      showMethod: 'fadeIn',
      hideMethod: 'fadeOut'
    };

    // Safe toastr function with fallback
    function showToast(type, message) {
      try {
        if (toastr && toastr[type]) {
          toastr[type](message);
        } else {
          console[type === 'error' ? 'error' : 'log'](message);
          alert(message);
        }
      } catch (e) {
        console.log(message);
        alert(message);
      }
    }

    // DOM elements
    const adminContent = document.getElementById('adminContent');
    const loginForm = document.getElementById('loginForm');
    const loginButton = document.getElementById('loginButton');
    const logoutBtn = document.getElementById('logoutBtn');
    const refreshButton = document.getElementById('refreshButton');
    const exportButton = document.getElementById('exportButton');
    const candidateList = document.getElementById('candidateList');
    const searchInput = document.getElementById('searchInput');
    const departmentFilter = document.getElementById('departmentFilter');
    const roundFilter = document.getElementById('roundFilter');
    const statusFilter = document.getElementById('statusFilter');
    
    // Main tabs elements
    const mainTabButtons = document.querySelectorAll('.main-tab-btn');
    const mainTabContents = document.querySelectorAll('.main-tab-content');
    
    // Round management elements
    const roundCandidateSelect = document.getElementById('roundCandidateSelect');
    const roundManagementContent = document.getElementById('roundManagementContent');
    const noCandidateSelected = document.getElementById('noCandidateSelected');
    const roundTabButtons = document.querySelectorAll('.round-tab-btn');
    const roundTabContents = document.querySelectorAll('.round-tab-content');
    
    // History elements
    const historyCandidateSelect = document.getElementById('historyCandidateSelect');
    const historyContent = document.getElementById('historyContent');
    const historyTypeFilter = document.getElementById('historyTypeFilter');
    
    // Modal elements
    const candidateModal = document.getElementById('candidateModal');
    const editModal = document.getElementById('editModal');
    const closeModalButtons = document.querySelectorAll('.close-modal');
    
    // Stats elements
    const totalCandidates = document.getElementById('totalCandidates');
    const completedCandidates = document.getElementById('completedCandidates');
    const inProgressCandidates = document.getElementById('inProgressCandidates');
    const pendingCandidates = document.getElementById('pendingCandidates');
    
    // Current selected candidate
    let currentCandidateId = null;
    let candidatesData = [];
    let filteredCandidates = [];
    let currentSortField = null;
    let currentSortDirection = 'asc';

    // Logout function
    async function logout() {
      try {
        await signOut(auth);
        adminContent.style.display = 'none';
        // chuyển về trang login (an toàn hơn)
        window.location.href = "/admin/login.html";
        showToast('info', 'Bạn đã đăng xuất');
      } catch (error) {
        console.error('Logout error:', error);
        showToast('error', 'Đăng xuất thất bại');
      }
    }


    // Load candidates from Firestore
    async function loadCandidates() {
      try {
        const snapshot = await getDocs(collection(db, "applications"));
        candidatesData = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
        filteredCandidates = [...candidatesData];

        updateStats();
        renderCandidates();
        populateCandidateSelects();
      } catch (error) {
        console.error('Error loading candidates:', error);
      }
    }


    // Populate candidate select dropdowns
    function populateCandidateSelects() {
      const roundCandidateSelect = document.getElementById('roundCandidateSelect');
      const historyCandidateSelect = document.getElementById('historyCandidateSelect');

      if (roundCandidateSelect) {
        roundCandidateSelect.innerHTML = '<option value="">-- Chọn ứng viên --</option>';
      }
      if (historyCandidateSelect) {
        historyCandidateSelect.innerHTML = '<option value="">-- Chọn ứng viên --</option>';
      }

      candidatesData.forEach(candidate => {
        const option = document.createElement('option');
        option.value = candidate.id;
        option.textContent = `${candidate.fullname || '(Không tên)'} (${candidate.email || 'no-email'})`;

        if (roundCandidateSelect) roundCandidateSelect.appendChild(option.cloneNode(true));
        if (historyCandidateSelect) historyCandidateSelect.appendChild(option.cloneNode(true));
      });
    }

    function safeSetText(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    // Update dashboard stats
    function updateStats() {
      totalCandidates.textContent = candidatesData.length;
      
      const completed = candidatesData.filter(c => c.current_round > 4).length;
      completedCandidates.textContent = completed;
      
      const inProgress = candidatesData.filter(c => c.current_round > 0 && c.current_round <= 4).length;
      inProgressCandidates.textContent = inProgress;
      
      const pending = candidatesData.filter(c => c.status === 'Chờ xử lý').length;
      pendingCandidates.textContent = pending;
    }

    function renderDepartmentBadge(department) {
      let className = "badge-primary";
      if (department === "Nhân sự") className = "badge-success";
      else if (department === "Truyền thông") className = "badge-warning";
      else if (department === "Đối ngoại") className = "badge-danger";
      else if (department === "Dự án") className = "badge-info";

      return `<span class="badge ${className}">${department}</span>`;
    }

    function getBanBadge(candidate, type = "priority") {
      const position = candidate[`${type}_position`];
      if (!position) return "";

      let status = "pending";

      // Duyệt qua các vòng để lấy trạng thái mới nhất
      for (let i = 1; i <= (candidate.current_round || 1); i++) {
        const roundData = candidate[`round_${i}`];
        if (roundData && roundData[type] && roundData[type].status) {
          status = roundData[type].status;
          if (status === "not pass") break; // đã rớt thì chốt luôn
        }
      }

      const badgeClass =
        status === "pass" ? "badge-success"
        : status === "not pass" ? "badge-danger"
        : status === "voted" ? "badge-info"
        : "badge-secondary";

      return `<span class="badge ${badgeClass}">${position}</span>`;
    }

    // Render candidates table
    function renderCandidates() {
      candidateList.innerHTML = filteredCandidates.map(candidate => {
        const currentRound = Number(candidate.current_round) || 1;

        const roundNum = Number(candidate.current_round) || 1;
        const status = resolveRoundStatus(candidate, roundNum);

        // lấy status cho priority & secondary tại vòng hiện tại
        const pStatus = resolveStatus(candidate, currentRound, 'priority');
        const sStatus = resolveStatus(candidate, currentRound, 'secondary');

        const badgeFor = (st) => {
          if (st === 'pass') return 'badge-success';
          if (st === 'not pass') return 'badge-danger';
          if (st === 'voted') return 'badge-info';
          return 'badge-secondary'; // mặc định: pending/chưa có kết quả
        };

        const pBadge = candidate.priority_position 
          ? `<span class="badge ${badgeFor(pStatus)}">${candidate.priority_position}</span>` 
          : '';

        const sBadge = candidate.secondary_position 
          ? `<span class="badge ${badgeFor(sStatus)}">${candidate.secondary_position}</span>` 
          : '';

        return `
          <tr>
            <td>${candidate.fullname || 'Chưa cập nhật'}</td>
            <td>${pBadge} ${sBadge}</td>
            <td>${candidate.email || 'Chưa cập nhật'}</td>
            <td>${candidate.phone || 'Chưa cập nhật'}</td>
            <td>${getRoundBadge(candidate)}</td>
            <td>${getStatusBadge(candidate)}</td>
            <td>
              <button class="action-btn btn-view" data-id="${candidate.id}"><i class="fas fa-eye"></i> Xem</button>
              <button class="action-btn btn-edit action-btn-sm" data-id="${candidate.id}"><i class="fas fa-edit"></i></button>
            </td>
          </tr>
        `;
      }).join('');

      // reattach listeners
      document.querySelectorAll('.btn-view').forEach(btn => {
        btn.addEventListener('click', function() {
          showCandidateDetail(this.getAttribute('data-id'));
        });
      });
      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', function() {
          showEditModal(this.getAttribute('data-id'));
        });
      });
    }



    // Show candidate detail modal
    // --- showCandidateDetail (thay thế, sử dụng safeSetText) ---
    function showCandidateDetail(candidateId) {
      const candidate = candidatesData.find(c => c.id === candidateId);
      if (!candidate) return;

      currentCandidateId = candidateId;

      safeSetText('modalCandidateName', candidate.fullname || 'Ứng viên');
      safeSetText('modalDepartment', candidate.priority_position || candidate.department || 'Chưa chọn');
      // current round: prefer candidate.current_round, fallback to mapStatusToRound if available
      const roundText = (typeof getRoundText === 'function') ? getRoundText(candidate.current_round || (typeof mapStatusToRound === 'function' ? mapStatusToRound(candidate.status) : 1)) : 'Chưa xác định';
      safeSetText('modalCurrentRound', roundText);
      safeSetText('modalStatus', candidate.status || 'Chưa xác định');

      safeSetText('modalFullName', candidate.fullname || 'Chưa cập nhật');
      safeSetText('modalGender', candidate.gender || 'Chưa cập nhật');
      safeSetText('modalEmail', candidate.email || 'Chưa cập nhật');
      safeSetText('modalPhone', candidate.phone || 'Chưa cập nhật');
      // birthdate/dob compatibility
      safeSetText('modalBirthdate', candidate.birthdate || candidate.dob || 'Chưa cập nhật');
      safeSetText('modalSchool', candidate.school || 'Chưa cập nhật');
      safeSetText('modalMajor', candidate.major || candidate.faculty || 'Chưa cập nhật');
      safeSetText('modalFacebook', candidate.facebook || 'Chưa cập nhật');

      // Show modal only if it exists
      const candidateModal = document.getElementById('candidateModal');
      if (candidateModal) candidateModal.style.display = 'block';
    }

// --- chuẩn hoá trạng thái ---
function normalizeStatus(raw) {
  if (raw === null || raw === undefined) return 'pending';
  const s = String(raw).trim().toLowerCase();
  if (s === 'pass' || s.includes('duyệt') || s.includes('đã duyệt') || s.includes('passed')) return 'pass';
  if (s === 'not pass' || s === 'notpass' || s.includes('từ chối') || s.includes('không đạt')) return 'not pass';
  if (s === 'voted' || s.includes('voted') || s.includes('bỏ phiếu')) return 'voted';
  if (s === 'pending' || s.includes('chờ') || s.includes('chưa')) return 'pending';
  return 'pending';
}

// --- trả status cho 1 ban (priority/secondary) ở 1 vòng cụ thể ---
function resolveStatus(candidate, round = 1, type = 'priority') {
  const r = candidate && candidate[`round_${round}`] ? candidate[`round_${round}`] : {};
  let status = null;

  if (r[type] && r[type].status !== undefined && r[type].status !== null) status = r[type].status;
  else if (r[`${type}Status`] !== undefined && r[`${type}Status`] !== null) status = r[`${type}Status`]; // legacy
  else if (candidate && (candidate[`${type}Accepted`] === true || candidate[`${type}Accepted`] === 'true')) status = 'pass';
  else if (candidate && (candidate[`${type}Rejected`] === true || candidate[`${type}Rejected`] === 'true')) status = 'not pass';
  else status = 'pending'; // giữ nguyên

  return normalizeStatus(status);
}

// --- trả trạng thái "của vòng" (kết hợp priority + secondary) ---
function resolveRoundStatus(candidate, round = 1) {
    const pStatus = resolveStatus(candidate, round, 'priority');
    const sStatus = resolveStatus(candidate, round, 'secondary');
    
    const hasPriority = !!candidate.priority_position;
    const hasSecondary = !!candidate.secondary_position;

    // Kịch bản 1: Bị loại ngay lập tức
    // Nếu bất kỳ ban nào ứng tuyển mà bị "not pass", thì cả vòng đó "not pass".
    if ((hasPriority && pStatus === 'not pass') || (hasSecondary && sStatus === 'not pass')) {
        // Nếu ứng tuyển cả 2 ban và cả 2 đều "not pass"
        if (hasPriority && hasSecondary && pStatus === 'not pass' && sStatus === 'not pass') {
            return 'not pass';
        }
        // Nếu chỉ ứng tuyển 1 ban và ban đó "not pass"
        if (!hasSecondary && pStatus === 'not pass') return 'not pass';
        if (!hasPriority && sStatus === 'not pass') return 'not pass';
        
        // Nếu ứng tuyển 2 ban, 1 not pass, 1 pass/pending -> Vẫn còn cơ hội ở ban kia, nên tạm coi là pending
        // Trừ khi bạn muốn chính sách "rớt 1 ban là rớt cả vòng" thì bỏ if dưới và return 'not pass' ngay.
        if (!((pStatus === 'pass' && sStatus === 'not pass') || (sStatus === 'pass' && pStatus === 'not pass'))) {
            return 'not pass';
        }
    }

    // Kịch bản 2: Đã pass
    // Nếu có ít nhất một ban "pass" và không có ban nào "not pass".
    if ((hasPriority && pStatus === 'pass') || (hasSecondary && sStatus === 'pass')) {
        return 'pass';
    }

    // Kịch bản 3: Các trường hợp còn lại (voted, pending) đều là "pending"
    return 'pending';
}

function getRoundBadge(candidate) {
  const roundNames = {
    1: "Đơn",
    2: "Phỏng vấn nhóm",
    3: "Thử thách",
    4: "Phỏng vấn cá nhân",
    5: "Đã hoàn thành"
  };
  const round = Number(candidate.current_round) || 0;
  if (!round || !roundNames[round]) {
    return `<span class="badge badge-warning">Chưa bắt đầu</span>`;
  }
  return `<span class="badge badge-primary">${roundNames[round]}</span>`;
}

function getStatusBadge(candidate) {
  const round = Number(candidate.current_round) || 1;

  // round 1: xét priority + secondary ở round_1
  if (round === 1) {
    const p = resolveStatus(candidate, 1, 'priority');
    const s = resolveStatus(candidate, 1, 'secondary');

    if (p === 'pass' || s === 'pass') return `<span class="badge badge-success">Pass</span>`;
    if (p === 'not pass' && s === 'not pass') return `<span class="badge badge-danger">Not pass</span>`;
    if (p === 'voted' || s === 'voted') return `<span class="badge badge-info">Voted</span>`;
    return `<span class="badge badge-warning">Đang xét</span>`;
  }

  // rounds 2..4: chỉ xét những ban được "up" từ vòng trước (hoặc fallback sang data vòng hiện tại nếu inconsistent)
  const prevRound = Math.max(1, round - 1);
  const prevP = resolveStatus(candidate, prevRound, 'priority');
  const prevS = resolveStatus(candidate, prevRound, 'secondary');

  const activeTypes = [];
  if (prevP === 'pass') activeTypes.push('priority');
  if (prevS === 'pass') activeTypes.push('secondary');

  // lấy status cho các loại active (null nếu không active)
  const pStatus = activeTypes.includes('priority') ? resolveStatus(candidate, round, 'priority') : null;
  const sStatus = activeTypes.includes('secondary') ? resolveStatus(candidate, round, 'secondary') : null;

  // quyết định hiển thị
  if (pStatus === 'pass' || sStatus === 'pass') return `<span class="badge badge-success">Pass</span>`;

  // nếu chỉ 1 active và nó not pass => not pass
  if (activeTypes.length === 1) {
    const only = activeTypes[0];
    const st = only === 'priority' ? pStatus : sStatus;
    if (st === 'not pass') return `<span class="badge badge-danger">Not pass</span>`;
  }

  // nếu 2 active và cả 2 not pass => not pass
  if (activeTypes.length === 2 && pStatus === 'not pass' && sStatus === 'not pass') {
    return `<span class="badge badge-danger">Not pass</span>`;
  }

  if (pStatus === 'voted' || sStatus === 'voted') return `<span class="badge badge-info">Voted</span>`;

  return `<span class="badge badge-warning">Đang xét</span>`;
}

    // Show edit modal
    function showEditModal(candidateId) {
      const candidate = candidatesData.find(c => c.id === candidateId);
      if (!candidate) return;
      
      currentCandidateId = candidateId;
      
      // Fill form with candidate data
      document.getElementById('editFullName').value = candidate.fullname || '';
      document.getElementById('editEmail').value = candidate.email || '';
      document.getElementById('editPhone').value = candidate.phone || '';
      document.getElementById('editDepartment').value = candidate.department || 'Nhân sự';
      document.getElementById('editCurrentRound').value = candidate.current_round || '1';
      document.getElementById('editStatus').value = candidate.status || 'Chờ xử lý';
      
      // Show modal
      editModal.style.display = 'block';
    }

    // Save edited candidate
    async function saveEditedCandidate() {
      if (!currentCandidateId) return;
      
      try {
        const candidateRef = doc(db, "applications", currentCandidateId);
        
        await updateDoc(candidateRef, {
          fullname: document.getElementById('editFullName').value,
          email: document.getElementById('editEmail').value,
          phone: document.getElementById('editPhone').value,
          department: document.getElementById('editDepartment').value,
          current_round: parseInt(document.getElementById('editCurrentRound').value),
          status: document.getElementById('editStatus').value,
          updatedAt: new Date()
        });
        
        // Update local data
        const candidateIndex = candidatesData.findIndex(c => c.id === currentCandidateId);
        if (candidateIndex !== -1) {
          candidatesData[candidateIndex] = {
            ...candidatesData[candidateIndex],
            fullname: document.getElementById('editFullName').value,
            email: document.getElementById('editEmail').value,
            phone: document.getElementById('editPhone').value,
            department: document.getElementById('editDepartment').value,
            current_round: parseInt(document.getElementById('editCurrentRound').value, 10),
            status: document.getElementById('editStatus').value
          };
        }

        // Update filteredCandidates similarly
        const filteredIndex = filteredCandidates.findIndex(c => c.id === currentCandidateId);
        if (filteredIndex !== -1) {
          filteredCandidates[filteredIndex] = {
            ...filteredCandidates[filteredIndex],
            fullname: document.getElementById('editFullName').value,
            email: document.getElementById('editEmail').value,
            phone: document.getElementById('editPhone').value,
            department: document.getElementById('editDepartment').value,
            current_round: parseInt(document.getElementById('editCurrentRound').value, 10),
            status: document.getElementById('editStatus').value
          };
        }

        
        // Update UI
        renderCandidates();
        updateStats();
        populateCandidateSelects();
        
        // Close modal
        editModal.style.display = 'none';
        
        showToast('success', 'Cập nhật thông tin ứng viên thành công');
      } catch (error) {
        console.error('Error updating candidate:', error);
        showToast('error', 'Cập nhật thông tin thất bại');
      }
    }

    // Load round management for selected candidate
    function loadRoundManagement(candidateId) {
      const candidate = candidatesData.find(c => c.id === candidateId);
      if (!candidate) return;
      
      currentCandidateId = candidateId;
      
      // Load round data
      loadRoundData(candidate);
      
      // Show round management content
      roundManagementContent.style.display = 'block';
      noCandidateSelected.style.display = 'none';
    }

    /* ===== helper nhỏ ===== */
    function getEl(id){ return document.getElementById(id); }
    function getVal(id){ const e = getEl(id); return e ? e.value : null; }
    function getMultiValues(id){
      const el = getEl(id);
      if(!el) return null;
      return Array.from(el.selectedOptions).map(o => o.value);
    }

    function disableSection(prefix, disabled = true) {
      [
        "StatusSelect", "Time", "Location", "Members", "Note",
        "Challenge", "Materials", "Deadline", "Pitching", "Advisor", "Interviewer"
      ].forEach(suffix => {
        const el = document.getElementById(prefix + suffix);
        if (el) el.disabled = disabled;
      });
    }

    function loadRoundData(candidate) {
      const getEl = id => document.getElementById(id);
      const setVal = (id, val) => { const el = getEl(id); if (el) el.value = (val ?? ""); };
      const setMulti = (id, values = []) => {
        const el = getEl(id);
        if (el) Array.from(el.options).forEach(opt => opt.selected = values.includes(opt.value));
      };

      // helper: enable/disable set các field theo pattern round{n}{Type}{Suffix}
      const suffixesByRound = {
        1: ["StatusSelect"], // round1 minimal (only status selects used in your markup)
        2: ["StatusSelect","Time","Location","Note","Members"],
        3: ["StatusSelect","Challenge","Materials","Deadline","Pitching","Advisor","Note","Members"],
        4: ["StatusSelect","Time","Location","Interviewer","Note"]
      };
      const setEnabledFor = (round, typeCapital, enabled) => {
        const suffixes = suffixesByRound[round] || [];
        suffixes.forEach(suf => {
          const id = `round${round}${typeCapital}${suf}`;
          const el = getEl(id);
          if (el) el.disabled = !enabled;
        });
      };

      // ---------- set values (keeps same behavior as before) ----------
      const r1 = candidate.round_1 || {};
      setVal("round1PriorityStatusSelect", r1.priority?.status);
      setVal("round1SecondaryStatusSelect", r1.secondary?.status);
      setVal("round1StatusSelect", r1.status);

      const r2 = candidate.round_2 || {};
      setVal("round2PriorityStatusSelect", r2.priority?.status);
      setVal("round2PriorityTime", r2.priority?.time);
      setVal("round2PriorityLocation", r2.priority?.location);
      setVal("round2PriorityNote", r2.priority?.note);
      setVal("round2PriorityMembers", r2.priority?.members);

      setVal("round2SecondaryStatusSelect", r2.secondary?.status);
      setVal("round2SecondaryTime", r2.secondary?.time);
      setVal("round2SecondaryLocation", r2.secondary?.location);
      setVal("round2SecondaryNote", r2.secondary?.note);
      setVal("round2SecondaryMembers", r2.secondary?.members);

      setVal("round2StatusSelect", r2.status);
      setVal("round2Time", r2.time);
      setVal("round2Location", r2.location);
      setVal("round2Note", r2.note);
      setVal("round2Members", r2.members);

      const r3 = candidate.round_3 || {};
      setVal("round3PriorityStatusSelect", r3.priority?.status);
      setVal("round3PriorityChallenge", r3.priority?.challenge);
      setVal("round3PriorityMaterials", r3.priority?.materials);
      setVal("round3PriorityDeadline", r3.priority?.deadline);
      setVal("round3PriorityPitching", r3.priority?.pitching);
      setVal("round3PriorityAdvisor", r3.priority?.advisor);
      setVal("round3PriorityNote", r3.priority?.note);
      setVal("round3PriorityMembers", r3.priority?.members);

      setVal("round3SecondaryStatusSelect", r3.secondary?.status);
      setVal("round3SecondaryChallenge", r3.secondary?.challenge);
      setVal("round3SecondaryMaterials", r3.secondary?.materials);
      setVal("round3SecondaryDeadline", r3.secondary?.deadline);
      setVal("round3SecondaryPitching", r3.secondary?.pitching);
      setVal("round3SecondaryAdvisor", r3.secondary?.advisor);
      setVal("round3SecondaryNote", r3.secondary?.note);
      setVal("round3SecondaryMembers", r3.secondary?.members);

      setVal("round3StatusSelect", r3.status);
      setVal("round3Challenge", r3.challenge);
      setVal("round3Materials", r3.materials);
      setVal("round3Deadline", r3.deadline);
      setVal("round3Pitching", r3.pitching);
      setVal("round3Advisor", r3.advisor);
      setVal("round3Note", r3.note);
      setVal("round3Members", r3.members);

      const r4 = candidate.round_4 || {};
      setVal("round4PriorityStatusSelect", r4.priority?.status);
      setVal("round4PriorityTime", r4.priority?.time);
      setVal("round4PriorityLocation", r4.priority?.location);
      setVal("round4PriorityInterviewer", r4.priority?.interviewer);
      setVal("round4PriorityNote", r4.priority?.note);

      setVal("round4SecondaryStatusSelect", r4.secondary?.status);
      setVal("round4SecondaryTime", r4.secondary?.time);
      setVal("round4SecondaryLocation", r4.secondary?.location);
      setVal("round4SecondaryInterviewer", r4.secondary?.interviewer);
      setVal("round4SecondaryNote", r4.secondary?.note);

      setVal("round4StatusSelect", r4.status);
      setVal("round4Time", r4.time);
      setVal("round4Location", r4.location);
      setVal("round4Interviewer", r4.interviewer);
      setVal("round4Note", r4.note);

      // ---------- enable/disable logic using resolveStatus (canonicalizes values) ----------
      // round2 fields enabled only if round1 that type was 'pass'
      const r1P = resolveStatus(candidate, 1, 'priority'); // 'pass' | 'not pass' | 'pending'...
      const r1S = resolveStatus(candidate, 1, 'secondary');

      setEnabledFor(1, "Priority", true);   // round1 always editable (status select)
      setEnabledFor(1, "Secondary", true);

      setEnabledFor(2, "Priority", r1P === 'pass');
      setEnabledFor(2, "Secondary", r1S === 'pass');

      // round3 based on round2 results
      const r2P = resolveStatus(candidate, 2, 'priority');
      const r2S = resolveStatus(candidate, 2, 'secondary');
      setEnabledFor(3, "Priority", r2P === 'pass');
      setEnabledFor(3, "Secondary", r2S === 'pass');

      // round4 based on round3 results
      const r3P = resolveStatus(candidate, 3, 'priority');
      const r3S = resolveStatus(candidate, 3, 'secondary');
      setEnabledFor(4, "Priority", r3P === 'pass');
      setEnabledFor(4, "Secondary", r3S === 'pass');

      // Optional: disable Save button for a round if neither priority nor secondary is allowed
      [2,3,4].forEach(n => {
        const allow = (resolveStatus(candidate, n-1, 'priority') === 'pass') || (resolveStatus(candidate, n-1, 'secondary') === 'pass');
        const btn = getEl(`saveRound${n}Btn`);
        if (btn) btn.disabled = !allow;
      });
    }

/* ===== saveRoundData: lưu dữ liệu vòng, có kiểm tra pass vòng trước ===== */
async function saveRoundData(roundNumber) {
  if (!currentCandidateId) return;
  const getEl = id => document.getElementById(id);
  const getVal = id => (getEl(id)?.value ?? "").trim();

  const candidate = candidatesData.find(c => c.id === currentCandidateId);
  if (!candidate) return showToast('error', 'Ứng viên không tồn tại');

  const updateData = {};
  const roundField = `round_${roundNumber}`;

  // ✅ Chặn nhảy vòng: chỉ cho phép lên nếu vòng trước có ít nhất 1 ban pass
  if (roundNumber > 1) {
    const prevRound = roundNumber - 1;
    const prevP = resolveStatus(candidate, prevRound, 'priority');
    const prevS = resolveStatus(candidate, prevRound, 'secondary');

    if (prevP !== 'pass' && prevS !== 'pass') {
      return showToast(
        'error',
        `Ứng viên chưa có ban nào pass ở vòng ${prevRound}, không thể lên vòng ${roundNumber}`
      );
    }
  }

  // ===== PRIORITY =====
  const canUpdatePriority = (roundNumber === 1) || (resolveStatus(candidate, roundNumber - 1, 'priority') === 'pass');
  if (canUpdatePriority) {
    if (getEl(`round${roundNumber}PriorityStatusSelect`)) {
      updateData[`${roundField}.priority.status`] =
        normalizeStatus(getVal(`round${roundNumber}PriorityStatusSelect`));
    }
    if (getEl(`round${roundNumber}PriorityTime`)) {
      updateData[`${roundField}.priority.time`] = getVal(`round${roundNumber}PriorityTime`);
    }
    if (getEl(`round${roundNumber}PriorityLocation`)) {
      updateData[`${roundField}.priority.location`] = getVal(`round${roundNumber}PriorityLocation`);
    }
    if (getEl(`round${roundNumber}PriorityMembers`)) {
      updateData[`${roundField}.priority.members`] = getVal(`round${roundNumber}PriorityMembers`);
    }
    if (getEl(`round${roundNumber}PriorityNote`)) {
      updateData[`${roundField}.priority.note`] = getVal(`round${roundNumber}PriorityNote`);
    }
    if (getEl(`round${roundNumber}PriorityChallenge`)) {
      updateData[`${roundField}.priority.challenge`] = getVal(`round${roundNumber}PriorityChallenge`);
    }
    if (getEl(`round${roundNumber}PriorityMaterials`)) {
      updateData[`${roundField}.priority.materials`] = getVal(`round${roundNumber}PriorityMaterials`);
    }
    if (getEl(`round${roundNumber}PriorityDeadline`)) {
      updateData[`${roundField}.priority.deadline`] = getVal(`round${roundNumber}PriorityDeadline`);
    }
    if (getEl(`round${roundNumber}PriorityPitching`)) {
      updateData[`${roundField}.priority.pitching`] = getVal(`round${roundNumber}PriorityPitching`);
    }
    if (getEl(`round${roundNumber}PriorityAdvisor`)) {
      updateData[`${roundField}.priority.advisor`] = getVal(`round${roundNumber}PriorityAdvisor`);
    }
    if (getEl(`round${roundNumber}PriorityInterviewer`)) {
      updateData[`${roundField}.priority.interviewer`] = getVal(`round${roundNumber}PriorityInterviewer`);
    }
  }

  // ===== SECONDARY =====
  const canUpdateSecondary = (roundNumber === 1) || (resolveStatus(candidate, roundNumber - 1, 'secondary') === 'pass');
  if (canUpdateSecondary) {
    if (getEl(`round${roundNumber}SecondaryStatusSelect`)) {
      updateData[`${roundField}.secondary.status`] =
        normalizeStatus(getVal(`round${roundNumber}SecondaryStatusSelect`));
    }
    if (getEl(`round${roundNumber}SecondaryTime`)) {
      updateData[`${roundField}.secondary.time`] = getVal(`round${roundNumber}SecondaryTime`);
    }
    if (getEl(`round${roundNumber}SecondaryLocation`)) {
      updateData[`${roundField}.secondary.location`] = getVal(`round${roundNumber}SecondaryLocation`);
    }
    if (getEl(`round${roundNumber}SecondaryMembers`)) {
      updateData[`${roundField}.secondary.members`] = getVal(`round${roundNumber}SecondaryMembers`);
    }
    if (getEl(`round${roundNumber}SecondaryNote`)) {
      updateData[`${roundField}.secondary.note`] = getVal(`round${roundNumber}SecondaryNote`);
    }
    if (getEl(`round${roundNumber}SecondaryChallenge`)) {
      updateData[`${roundField}.secondary.challenge`] = getVal(`round${roundNumber}SecondaryChallenge`);
    }
    if (getEl(`round${roundNumber}SecondaryMaterials`)) {
      updateData[`${roundField}.secondary.materials`] = getVal(`round${roundNumber}SecondaryMaterials`);
    }
    if (getEl(`round${roundNumber}SecondaryDeadline`)) {
      updateData[`${roundField}.secondary.deadline`] = getVal(`round${roundNumber}SecondaryDeadline`);
    }
    if (getEl(`round${roundNumber}SecondaryPitching`)) {
      updateData[`${roundField}.secondary.pitching`] = getVal(`round${roundNumber}SecondaryPitching`);
    }
    if (getEl(`round${roundNumber}SecondaryAdvisor`)) {
      updateData[`${roundField}.secondary.advisor`] = getVal(`round${roundNumber}SecondaryAdvisor`);
    }
    if (getEl(`round${roundNumber}SecondaryInterviewer`)) {
      updateData[`${roundField}.secondary.interviewer`] = getVal(`round${roundNumber}SecondaryInterviewer`);
    }
  }

  try {
    const candidateRef = doc(db, "applications", currentCandidateId);
    // ✅ cập nhật dữ liệu vòng
    await updateDoc(candidateRef, updateData);

    // ✅ merge dữ liệu ứng viên hiện tại với updateData theo đúng cấu trúc
    const mergedCandidate = JSON.parse(JSON.stringify(candidate)); // deep clone tránh mutate
    for (const key in updateData) {
      const path = key.split(".");
      let obj = mergedCandidate;
      for (let i = 0; i < path.length - 1; i++) {
        if (!obj[path[i]]) obj[path[i]] = {};
        obj = obj[path[i]];
      }
      obj[path[path.length - 1]] = updateData[key];
    }

    // ✅ nếu có ít nhất 1 ban pass thì cập nhật current_round
    const pStatus = resolveStatus(mergedCandidate, roundNumber, 'priority');
    const sStatus = resolveStatus(mergedCandidate, roundNumber, 'secondary');

    if (pStatus === 'pass' || sStatus === 'pass') {
      await updateDoc(candidateRef, { current_round: roundNumber });
    }

    showToast('success', `Lưu vòng ${roundNumber} thành công`);
    await loadCandidates(); // refresh UI
  } catch (err) {
    console.error("Error saving round data:", err);
    showToast('error', 'Có lỗi khi lưu dữ liệu vòng');
  }
}


    function getRoundText(round) {
      const names = {
        0: "Chưa bắt đầu",
        1: "Đơn",
        2: "Phỏng vấn nhóm",
        3: "Thử thách",
        4: "Phỏng vấn cá nhân",
        5: "Đã hoàn thành"
      };
      return names[Number(round)] || 'Chưa xác định';
    }

    window.saveRoundData = saveRoundData;

    /* ===== sửa update-round-btn để dùng round_${newRound} thay vì rounds.${newRound} ===== */
document.getElementById("update-round-btn")?.addEventListener("click", async () => {
  const newRound = Number(document.getElementById("round-select").value);
  if (!newRound) return alert("Hãy chọn vòng!");
  if (!confirm(`Chuyển tất cả ứng viên đã pass sang vòng ${newRound}?`)) return;

  try {
    const snapshot = await getDocs(collection(db, "applications"));
    for (const docSnap of snapshot.docs) {
      const candidate = docSnap.data();
      const docRef = doc(db, "applications", docSnap.id);
      const curRound = Number(candidate.current_round) || 1;
      const currentStatus = resolveRoundStatus(candidate, curRound);
      if (currentStatus === 'pass') {
        await updateDoc(docRef, { current_round: newRound });
      }
    }
    alert(`Đã cập nhật vòng ${newRound} thành công!`);
    await loadCandidates();
  } catch (error) {
    console.error("Lỗi khi cập nhật vòng:", error);
    alert("Có lỗi xảy ra khi cập nhật vòng.");
  }
});



    // Filter candidates
    function filterCandidates() {
      const searchTerm = searchInput.value.toLowerCase();
      const department = departmentFilter.value;
      const round = roundFilter.value;
      const status = statusFilter.value;
      
      filteredCandidates = candidatesData.filter(candidate => {
        // Search filter
        const nameMatch = candidate.fullname?.toLowerCase().includes(searchTerm) || false;
        const emailMatch = candidate.email?.toLowerCase().includes(searchTerm) || false;
        const phoneMatch = candidate.phone?.includes(searchTerm) || false;
        
        // Other filters
        const departmentMatch = department ? candidate.department === department : true;
        const roundMatch = round ? 
          (round === '5' ? candidate.current_round > 4 : candidate.current_round == round) : true;
        const statusMatch = status ? candidate.status === status : true;
        
        return (nameMatch || emailMatch || phoneMatch) && 
               departmentMatch && 
               roundMatch && 
               statusMatch;
      });
      
      renderCandidates();
    }

    // Sort candidates
    function sortCandidates(field) {
      if (currentSortField === field) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortField = field;
        currentSortDirection = 'asc';
      }
      
      // Remove all sort indicators
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
      });
      
      // Add sort indicator to current column
      const header = document.querySelector(`th[data-sort="${field}"]`);
      if (header) {
        header.classList.add(`sort-${currentSortDirection}`);
      }
      
      filteredCandidates.sort((a, b) => {
        let valueA = a[field] || '';
        let valueB = b[field] || '';
        
        if (field === 'current_round') {
          return currentSortDirection === 'asc' ? 
            valueA - valueB : valueB - valueA;
        }
        
        if (valueA < valueB) return currentSortDirection === 'asc' ? -1 : 1;
        if (valueA > valueB) return currentSortDirection === 'asc' ? 1 : -1;
        return 0;
      });
      
      renderCandidates();
    }

    // Export to CSV
    function exportToCSV() {
      if (filteredCandidates.length === 0) {
        showToast('warning', 'Không có dữ liệu để xuất');
        return;
      }
      
      let csvContent = "Họ tên,Ban,Vòng hiện tại,Email,SĐT,Trạng thái\n";
      
      filteredCandidates.forEach(candidate => {
        const round = getRoundText(candidate.current_round);
        csvContent += `"${candidate.fullname || ''}","${candidate.department || ''}","${round}","${candidate.email || ''}","${candidate.phone || ''}","${candidate.status || ''}"\n`;
      });
      
      const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'danh_sach_ung_vien.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('success', 'Xuất file CSV thành công');
    }

    // Switch main tabs
    function switchMainTab(tabId) {
      // Update active tab button
      mainTabButtons.forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.main-tab-btn[data-tab="${tabId}"]`).classList.add('active');
      
      // Update active tab content
      mainTabContents.forEach(content => content.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    }

    // Switch round tabs
    function switchRoundTab(tabId) {
      // Update active tab button
      roundTabButtons.forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.round-tab-btn[data-tab="${tabId}"]`).classList.add('active');
      
      // Update active tab content
      roundTabContents.forEach(content => content.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    }

    // Initialize event listeners
    function initEventListeners() {
      // Lấy các node an toàn (có thể null)
      const loginButton = document.getElementById('loginButton');
      const logoutBtn = document.getElementById('logoutBtn');
      const refreshButton = document.getElementById('refreshButton');
      const exportButton = document.getElementById('exportButton');
      const searchInput = document.getElementById('searchInput');
      const departmentFilter = document.getElementById('departmentFilter');
      const roundFilter = document.getElementById('roundFilter');
      const statusFilter = document.getElementById('statusFilter');

      // Chỉ gắn event nếu phần tử tồn tại
      if (loginButton) loginButton.addEventListener('click', login);
      if (logoutBtn) logoutBtn.addEventListener('click', logout);
      if (refreshButton) refreshButton.addEventListener('click', loadCandidates);
      if (exportButton) exportButton.addEventListener('click', exportToCSV);

      if (searchInput) searchInput.addEventListener('input', filterCandidates);
      if (departmentFilter) departmentFilter.addEventListener('change', filterCandidates);
      if (roundFilter) roundFilter.addEventListener('change', filterCandidates);
      if (statusFilter) statusFilter.addEventListener('change', filterCandidates);

      // Table sorting (guard)
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.addEventListener('click', function() {
          sortCandidates(this.getAttribute('data-sort'));
        });
      });

      // Main tab switching
      document.querySelectorAll('.main-tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          switchMainTab(this.getAttribute('data-tab'));
        });
      });

      // Round tab switching
      document.querySelectorAll('.round-tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const tabId = this.getAttribute('data-tab');
          switchRoundTab(tabId);
        });
      });

      // ... các listener khác: kiểm tra ID trước khi dùng
      const roundCandidateSelect = document.getElementById('roundCandidateSelect');
      if (roundCandidateSelect) {
        roundCandidateSelect.addEventListener('change', function() {
          if (this.value) loadRoundManagement(this.value);
          else {
            const roundManagementContent = document.getElementById('roundManagementContent');
            const noCandidateSelected = document.getElementById('noCandidateSelected');
            if (roundManagementContent) roundManagementContent.style.display = 'none';
            if (noCandidateSelected) noCandidateSelected.style.display = 'block';
          }
        });
      }

      // Modal close handlers — guard
      document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', function() {
          const candidateModal = document.getElementById('candidateModal');
          const editModal = document.getElementById('editModal');
          if (candidateModal) candidateModal.style.display = 'none';
          if (editModal) editModal.style.display = 'none';
        });
      });

      window.addEventListener('click', function(event) {
        const candidateModal = document.getElementById('candidateModal');
        const editModal = document.getElementById('editModal');
        if (event.target === candidateModal && candidateModal) candidateModal.style.display = 'none';
        if (event.target === editModal && editModal) editModal.style.display = 'none';
      });

      // Save buttons guard
      const saveEditBtn = document.getElementById('saveEditBtn');
      if (saveEditBtn) saveEditBtn.addEventListener('click', saveEditedCandidate);

      const saveRound1Btn = document.getElementById('saveRound1Btn');
      if (saveRound1Btn) saveRound1Btn.addEventListener('click', () => saveRoundData(1));
      const saveRound2Btn = document.getElementById('saveRound2Btn');
      if (saveRound2Btn) saveRound2Btn.addEventListener('click', () => saveRoundData(2));
      const saveRound3Btn = document.getElementById('saveRound3Btn');
      if (saveRound3Btn) saveRound3Btn.addEventListener('click', () => saveRoundData(3));
      const saveRound4Btn = document.getElementById('saveRound4Btn');
      if (saveRound4Btn) saveRound4Btn.addEventListener('click', () => saveRoundData(4));
    }


    // Check auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Nếu đã đăng nhập thì hiển thị Admin
        adminContent.style.display = 'block';
        loadCandidates();
      } else {
        // Nếu chưa đăng nhập thì chuyển sang login.html
        window.location.href = "/admin/login.html";
      }
    });

document.getElementById("update-round-btn").addEventListener("click", async () => {
  const newRound = Number(document.getElementById("round-select").value);
  if (!newRound) return alert("Hãy chọn vòng!");

  if (!confirm(`Chuyển tất cả ứng viên đã pass sang vòng ${newRound}?`)) return;

  try {
    const snapshot = await getDocs(collection(db, "applications"));

    for (const docSnap of snapshot.docs) {
      const candidate = docSnap.data();
      const docRef = doc(db, "applications", docSnap.id);

      // chỉ update nếu ứng viên pass vòng hiện tại
      const pass =
        candidate.priorityAccepted === true ||
        candidate.secondaryAccepted === true ||
        candidate.priorityAccepted === "true" ||
        candidate.secondaryAccepted === "true";

      if (pass) {
        await updateDoc(docRef, {
          current_round: newRound,
          [`rounds.${newRound}.status`]: candidate.rounds?.[newRound]?.status || "pending"
        });
      }
    }

    alert(`Đã cập nhật vòng ${newRound} thành công!`);
    await loadCandidates();
  } catch (error) {
    console.error("Lỗi khi cập nhật vòng:", error);
    alert("Có lỗi xảy ra khi cập nhật vòng.");
  }
});

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      initEventListeners();
    });
  </script>
</body>
</html>
