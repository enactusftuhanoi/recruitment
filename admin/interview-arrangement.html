<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview | Enactus FTU Hanoi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Clash+Display:wght@600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #F8F3CE;
            --primary-light: #FFD54F;
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --white: #FFFFFF;
            --error: #EF4444;
            --error-light: #FEE2E2;
            --success: #10B981;
            --success-light: #D1FAE5;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --info: #3B82F6;
            --info-light: #DBEAFE;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        body {
            background-color: var(--gray-50);
            color: var(--gray-800);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background-color: var(--white);
            padding: 16px 24px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 50px;
            width: auto;
        }

        .nav-links {
            display: flex;
            gap: 16px;
        }

        .nav-link {
            padding: 8px 16px;
            border-radius: var(--border-radius);
            color: var(--gray-700);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }

        .nav-link:hover, .nav-link.active {
            background-color: var(--primary);
            color: var(--gray-800);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--gray-800);
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Card */
        .card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .card-header {
            margin-bottom: 20px;
        }

        .card-title {
            font-family: 'Clash Display', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .card-subtitle {
            color: var(--gray-600);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(248, 243, 206, 0.3);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--gray-800);
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
        }

        .btn-secondary {
            background-color: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background-color: var(--gray-300);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #0da271;
        }

        .btn i {
            margin-right: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--gray-600);
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: var(--transition);
        }

        .tab.active {
            color: var(--gray-900);
            border-bottom-color: var(--primary);
        }

        .tab:hover:not(.active) {
            color: var(--gray-800);
        }

        /* Table */
        .table-container {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .applications-table {
            width: 100%;
            border-collapse: collapse;
        }

        .applications-table th {
            background-color: var(--gray-100);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 14px;
            border-bottom: 1px solid var(--gray-200);
        }

        .applications-table td {
            padding: 16px;
            border-bottom: 1px solid var(--gray-200);
            font-size: 14px;
            color: var(--gray-700);
        }

        .applications-table tr:last-child td {
            border-bottom: none;
        }

        .applications-table tr:hover {
            background-color: var(--gray-50);
        }

        /* Department badges */
        .department-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 4px;
        }

        .department-md {
            background-color: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .department-hr {
            background-color: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .department-pd {
            background-color: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .department-er {
            background-color: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px 20px;
        }

        .loading i {
            font-size: 32px;
            color: var(--gray-400);
            margin-bottom: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <img src="/assets/logo_den.png" alt="Enactus FTU Hanoi Logo">
        </div>
        
        <div class="nav-links">
            <a href="dashboard.html" class="nav-link">Dashboard</a>
        <a href="calendar.html" class="nav-link">Calendar</a>
            <a href="interview-arrangement.html" class="nav-link active">Interview</a>
        </div>
        
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">A</div>
        </div>
    </div>

    <!-- Main Content -->
<div class="main-content">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Sắp xếp lịch phỏng vấn</h2>
            <p class="card-subtitle">Tải dữ liệu vote và sắp xếp nhân sự phỏng vấn</p>
        </div>

        <!-- Nguồn dữ liệu ứng viên -->
        <div class="form-group">
            <label class="form-label">Nguồn dữ liệu ứng viên</label>
            <div style="display: flex; gap: 20px; margin-bottom: 16px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="radio" name="data-source" value="calendar" checked> 
                    Lấy từ Calendar
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="radio" name="data-source" value="upload"> 
                    Upload file Excel
                </label>
            </div>
        </div>

        <!-- Upload ứng viên (chỉ hiện khi chọn upload) -->
        <div id="candidate-upload-section" style="display: none; margin-bottom: 16px;">
            <label class="form-label">Tải file dữ liệu ứng viên</label>
            <div style="display: flex; gap: 12px; align-items: center;">
                <input type="file" id="candidate-file" accept=".xlsx,.xls" style="flex: 1; padding: 8px;">
                <button class="btn btn-secondary" id="upload-candidate-btn">
                    <i class="fas fa-upload"></i>
                    Tải lên ứng viên
                </button>
            </div>
            <small style="color: var(--gray-500); margin-top: 8px; display: block;">
                File Excel chứa danh sách ứng viên và slot phỏng vấn đã chọn
            </small>
        </div>

        <!-- Upload vote phỏng vấn -->
        <div class="form-group">
            <label class="form-label">Tải file dữ liệu vote phỏng vấn</label>
            <div style="display: flex; gap: 12px; align-items: center;">
                <input type="file" id="interview-vote-file" accept=".xlsx,.xls" style="flex: 1; padding: 8px;">
                <button class="btn btn-primary" id="upload-vote-btn">
                    <i class="fas fa-upload"></i>
                    Tải lên
                </button>
            </div>
            <small style="color: var(--gray-500); margin-top: 8px; display: block;">
                File Excel chứa dữ liệu vote của nhân sự phỏng vấn (định dạng như file mẫu)
            </small>
        </div>

        <!-- Download templates -->
        <div class="form-group">
            <button class="btn btn-secondary" id="download-template-btn">
                <i class="fas fa-download"></i>
                Tải template vote phỏng vấn
            </button>
            <button class="btn btn-secondary" id="download-candidate-template-btn" style="margin-left: 10px;">
                <i class="fas fa-download"></i>
                Tải template ứng viên
            </button>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading" style="display: none;">
            <i class="fas fa-spinner"></i>
            <p>Đang xử lý dữ liệu...</p>
        </div>

        <!-- Results section -->
        <div id="arrangement-results" style="display: none; margin-top: 24px;">
            <h3 style="margin-bottom: 16px;">Kết quả sắp xếp phỏng vấn</h3>
            
            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-interview-slots">0</div>
                    <div class="stat-label">Tổng số ca phỏng vấn</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-candidates-arranged">0</div>
                    <div class="stat-label">Ứng viên đã sắp xếp</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-interviewers">0</div>
                    <div class="stat-label">Nhân sự phỏng vấn</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-interviews">0</div>
                    <div class="stat-label">Buổi phỏng vấn</div>
                </div>
            </div>

            <!-- Department tabs -->
            <div class="tabs" id="department-tabs">
                <button class="tab active" data-dept="all">Tất cả</button>
                <button class="tab" data-dept="MD">Truyền thông</button>
                <button class="tab" data-dept="HR">Nhân sự</button>
                <button class="tab" data-dept="PD">Dự án</button>
                <button class="tab" data-dept="ER">Đối ngoại</button>
            </div>

            <!-- Interview schedule table -->
            <div class="table-container">
                <table class="applications-table" id="interview-schedule-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Ca phỏng vấn</th>
                            <th>Thời gian</th>
                            <th>Ứng viên</th>
                            <th>Ban ứng tuyển</th>
                            <th>Người phỏng vấn</th>
                            <th>Ban phỏng vấn</th>
                            <th>Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody id="interview-schedule-body">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Export button -->
            <div class="action-buttons">
                <button class="btn btn-secondary" id="preview-schedule-btn">
                    <i class="fas fa-eye"></i>
                    Xem trước
                </button>
                <button class="btn btn-primary" id="export-arrangement-btn">
                    <i class="fas fa-download"></i>
                    Xuất kết quả sắp xếp
                </button>
            </div>
        </div>
    </div>
</div>
</body>
    <script>
        // Sử dụng Firebase compat version để dễ tích hợp
        const firebaseConfig = {
            apiKey: "AIzaSyAOP2j0qV0Ge-q2-Y9zo9Qc3eLmgtVOK3k",
            authDomain: "recruitment-enactusftuhanoi.firebaseapp.com",
            projectId: "recruitment-enactusftuhanoi",
            storageBucket: "recruitment-enactusftuhanoi.firebasestorage.app",
            messagingSenderId: "658928769643",
            appId: "1:658928769643:web:ef4e26633b7c41c922ef2e",
            measurementId: "G-BJT7ZPKYE3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Biến lưu trữ dữ liệu sắp xếp
        let interviewArrangementData = {
            slots: [],
            candidates: [],
            interviewers: [],
            schedule: []
        };

        // Event listener cho nút upload
        document.getElementById('upload-vote-btn').addEventListener('click', function() {
            const fileInput = document.getElementById('interview-vote-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Vui lòng chọn file Excel để tải lên');
                return;
            }
            
            processVoteFile(file);
        });

        // Event listener cho nút tải template
        document.getElementById('download-template-btn').addEventListener('click', function() {
            downloadInterviewTemplate();
        });

        // Event listener cho nút xuất kết quả
        document.getElementById('export-arrangement-btn').addEventListener('click', function() {
            exportInterviewArrangement();
        });

        // Event listener cho nút xem trước
        document.getElementById('preview-schedule-btn').addEventListener('click', function() {
            previewSchedule();
        });

        // Event listener cho các tab department
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('tab') && e.target.dataset.dept) {
                // Xóa active class từ tất cả các tab
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                // Thêm active class cho tab được click
                e.target.classList.add('active');
                
                // Hiển thị dữ liệu theo department
                filterScheduleByDepartment(e.target.dataset.dept);
            }
        });

// Event listener cho radio buttons
document.querySelectorAll('input[name="data-source"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const candidateUploadSection = document.getElementById('candidate-upload-section');
        if (this.value === 'upload') {
            candidateUploadSection.style.display = 'block';
        } else {
            candidateUploadSection.style.display = 'none';
        }
    });
});

// Event listener cho nút upload ứng viên
document.getElementById('upload-candidate-btn').addEventListener('click', function() {
    const fileInput = document.getElementById('candidate-file');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Vui lòng chọn file Excel ứng viên');
        return;
    }
    
    processCandidateFile(file);
});

// Hàm xử lý file ứng viên
async function processCandidateFile(file) {
    try {
        document.getElementById('loading').style.display = 'block';
        
        const data = await readExcelFile(file);
        const candidates = parseCandidateData(data);
        
        // Lấy dữ liệu interviewer từ file vote (nếu đã upload)
        if (interviewArrangementData.interviewers.length === 0) {
            alert('Vui lòng upload file vote phỏng vấn trước');
            document.getElementById('loading').style.display = 'none';
            return;
        }
        
        // Cập nhật dữ liệu ứng viên
        interviewArrangementData.candidates = candidates;
        
        // Thực hiện sắp xếp
        interviewArrangementData.schedule = arrangeInterviews(interviewArrangementData);
        
        // Hiển thị kết quả
        displayArrangementResults(interviewArrangementData);
        
        document.getElementById('loading').style.display = 'none';
        
    } catch (error) {
        console.error('Lỗi xử lý file ứng viên:', error);
        alert('Lỗi khi xử lý file ứng viên: ' + error.message);
        document.getElementById('loading').style.display = 'none';
    }
}

// Hàm parse dữ liệu ứng viên từ file Excel
function parseCandidateData(data) {
    const candidates = [];
    
    if (data.length < 2) {
        throw new Error('File không đúng định dạng');
    }
    
    // Bỏ qua header (dòng đầu tiên)
    for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (!row || row.length < 4) continue;
        
        const candidate = {
            name: row[1] || '', // Cột B: Họ và tên
            department: convertDepartmentNameToCode(row[2] || ''), // Cột C: Ban ưu tiên
            email: '', // File không có email
            availableSlots: []
        };
        
        // Lấy các slot available (cột D đến cuối)
        for (let j = 3; j < row.length; j++) {
            if (row[j] === 'X' || row[j] === 'x' || row[j] === '×') {
                const slotId = `slot_${j-3}`;
                candidate.availableSlots.push(slotId);
            }
        }
        
        // Chỉ thêm ứng viên có tên
        if (candidate.name.trim()) {
            candidates.push(candidate);
        }
    }
    
    console.log(`Đã parse ${candidates.length} ứng viên từ file`);
    return candidates;
}

// Hàm chuyển tên ban sang mã ban
function convertDepartmentNameToCode(departmentName) {
    const departmentMap = {
        'Truyền thông': 'MD',
        'Nhân sự': 'HR', 
        'Dự án': 'PD',
        'Đối ngoại': 'ER',
        'MD': 'MD',
        'HR': 'HR',
        'PD': 'PD', 
        'ER': 'ER'
    };
    return departmentMap[departmentName] || departmentName;
}

// Thêm vào phần download template
function downloadCandidateTemplate() {
    const templateData = [
        ['STT', 'Họ và tên', 'Ban ưu tiên', 'Ban dự bị', 'Ca 01: 09h20 - 09h50', 'Ca 02: 10h00 - 10h30', 'Ca 03: 10h40 - 11h10', 'Ca 04: 11h20 - 11h50', 'Ca 05: 14h00 - 14h30', 'Ca 06: 14h40 - 15h10', 'Ca 07: 15h20 - 15h50', 'Ca 08: 16h00 - 16h30', 'Ca 09: 20h00 - 20h30', 'Ca 10: 20h40 - 21h10', 'Ca 11: 21h20 - 21h50', 'Ca 12: 22h00 - 22h30', 'Ca 01: 08h00 - 08h30', 'Ca 02: 08h40 - 09h10', 'Ca 03: 09h20 - 09h50', 'Ca 04: 10h00 - 10h30', 'Ca 05: 10h40 - 11h10', 'Ca 06: 11h20 - 11h50', 'Ca 07: 14h00 - 14h30', 'Ca 08: 14h40 - 15h10', 'Ca 09: 15h20 - 15h50', 'Ca 10: 16h00 - 16h30'],
        ['1', 'Nguyễn Văn A', 'Truyền thông', 'Nhân sự', 'X', '', 'X', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
        ['2', 'Trần Thị B', 'Nhân sự', 'Dự án', '', 'X', '', 'X', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
    ];
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(templateData);
    XLSX.utils.book_append_sheet(wb, ws, 'Danh sách ứng viên');
    XLSX.writeFile(wb, 'Template_Danh_Sach_Ung_Vien.xlsx');
}

// Thêm nút download template ứng viên trong HTML
document.getElementById('download-template-btn').addEventListener('click', function() {
    downloadInterviewTemplate();
});

// Thêm nút mới
document.getElementById('download-candidate-template-btn').addEventListener('click', function() {
    downloadCandidateTemplate();
});

// Sửa hàm processVoteFile để chỉ xử lý interviewers
async function processVoteFile(file) {
    try {
        document.getElementById('loading').style.display = 'block';
        
        const data = await readExcelFile(file);
        const processedData = await processVoteData(data);
        
        // Chỉ cập nhật interviewers và slots, giữ nguyên candidates nếu có
        interviewArrangementData.slots = processedData.slots;
        interviewArrangementData.interviewers = processedData.interviewers;
        
        // Nếu đã có candidates, thực hiện sắp xếp ngay
        if (interviewArrangementData.candidates.length > 0) {
            interviewArrangementData.schedule = arrangeInterviews(interviewArrangementData);
            displayArrangementResults(interviewArrangementData);
        } else {
            // Chỉ hiển thị thông báo thành công
            alert('Đã tải lên dữ liệu nhân sự phỏng vấn thành công!');
        }
        
        document.getElementById('loading').style.display = 'none';
        
    } catch (error) {
        console.error('Lỗi xử lý file vote:', error);
        alert('Lỗi khi xử lý file: ' + error.message);
        document.getElementById('loading').style.display = 'none';
    }
}


        // Đọc file Excel
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };

                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Xử lý dữ liệu vote - CHỈ xử lý interviewers và slots
async function processVoteData(data) {
    const result = {
        slots: [],
        candidates: [],  // Sẽ được điền từ Calendar hoặc Upload
        interviewers: [], 
        schedule: []
    };

    if (data.length < 2) {
        throw new Error('File không đúng định dạng');
    }

    const headers = data[0];
    const timeSlots = headers.slice(3);

    // Tạo danh sách các ca phỏng vấn
    result.slots = timeSlots.map((slot, index) => {
        return {
            id: `slot_${index}`,
            name: slot,
            date: extractDateFromSlot(slot),
            time: extractTimeFromSlot(slot)
        };
    });

    // Xử lý dữ liệu NHÂN SỰ PHỎNG VẤN từ file upload
    let currentDepartment = '';
    let currentGen = '';

    for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (!row || row.length < 3) continue;

        // Xác định ban và gen
        if (row[0]) currentDepartment = row[0];
        if (row[1]) currentGen = row[1];

        const name = row[2];
        if (!name) continue;

        const interviewer = {
            name: name.trim(),
            department: currentDepartment,
            availableSlots: []
        };

        // Lấy các slot available
        timeSlots.forEach((slot, index) => {
            const slotValue = row[3 + index];
            if (slotValue === 'x' || slotValue === 'X') {
                interviewer.availableSlots.push(result.slots[index].id);
            }
        });

        result.interviewers.push(interviewer);
    }

    // KHÔNG gọi loadCandidatesFromCalendar() ở đây nữa
    // Ứng viên sẽ được load riêng từ Calendar hoặc Upload
    
    return result;
}

        // Thêm hàm để load từ Calendar khi chọn option đó
async function loadFromCalendar() {
    try {
        document.getElementById('loading').style.display = 'block';
        
        interviewArrangementData.candidates = await loadCandidatesFromCalendar();
        
        // Nếu đã có interviewers, thực hiện sắp xếp ngay
        if (interviewArrangementData.interviewers.length > 0) {
            interviewArrangementData.schedule = arrangeInterviews(interviewArrangementData);
            displayArrangementResults(interviewArrangementData);
        } else {
            alert('Đã tải ứng viên từ Calendar thành công! Vui lòng upload file vote phỏng vấn.');
        }
        
        document.getElementById('loading').style.display = 'none';
        
    } catch (error) {
        console.error('Lỗi tải từ Calendar:', error);
        alert('Lỗi khi tải từ Calendar: ' + error.message);
        document.getElementById('loading').style.display = 'none';
    }
}

// Thêm event listener cho nút upload vote để hỗ trợ cả 2 options
document.getElementById('upload-vote-btn').addEventListener('click', function() {
    const fileInput = document.getElementById('interview-vote-file');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Vui lòng chọn file Excel để tải lên');
        return;
    }
    
    // Kiểm tra xem đã có dữ liệu ứng viên chưa
    const dataSource = document.querySelector('input[name="data-source"]:checked').value;
    
    if (dataSource === 'calendar' && interviewArrangementData.candidates.length === 0) {
        // Tự động load từ Calendar nếu chọn option Calendar
        loadFromCalendar();
    }
    
    processVoteFile(file);
});

        // Lấy dữ liệu ứng viên từ calendar (Firestore)
        async function loadCandidatesFromCalendar() {
    try {
        const votingSnapshot = await db.collection('voting_candidates').get();
        
        if (votingSnapshot.empty) {
            console.warn('Không tìm thấy ứng viên nào trong voting_candidates');
            return [];
        }
        
        const votingCandidates = votingSnapshot.docs.map(doc => {
            const data = doc.data();
            return data.email ? data.email.toLowerCase().trim() : null;
        }).filter(email => email);
        
        const applicationsSnapshot = await db.collection('applications').get();
        const candidates = [];
        
        applicationsSnapshot.forEach(doc => {
            const app = doc.data();
            const appEmail = app.email ? app.email.toLowerCase().trim() : '';
            
            if (votingCandidates.includes(appEmail)) {
                const availableSlots = convertCalendarSlotsToInterviewSlots(app.interview_schedule || []);
                
                if (availableSlots.length === 0) {
                    console.warn(`Ứng viên ${app.fullname} không có slot phỏng vấn nào`);
                }
                
                candidates.push({
                    name: app.fullname || 'Không có tên',
                    email: app.email || '',
                    department: app.priority_position || 'Chưa xác định',
                    gen: app.gen || '',
                    availableSlots: availableSlots
                });
            }
        });
        
        console.log(`Đã tải ${candidates.length} ứng viên từ calendar`);
        return candidates;
        
    } catch (error) {
        console.error('Error loading candidates from calendar:', error);
        alert('Lỗi khi tải dữ liệu ứng viên: ' + error.message);
        return [];
    }
}

        // Chuyển đổi slot IDs từ calendar format sang interview format
        function convertCalendarSlotsToInterviewSlots(calendarSlots) {
    if (!calendarSlots || calendarSlots.length === 0) return [];
    
    // Tạo mapping động dựa trên pattern
    const slotMapping = {};
    const timeSlots = [
        'Ca 01: 09h20 - 09h50', 'Ca 02: 10h00 - 10h30', 'Ca 03: 10h40 - 11h10',
        'Ca 04: 11h20 - 11h50', 'Ca 05: 14h00 - 14h30', 'Ca 06: 14h40 - 15h10',
        'Ca 07: 15h20 - 15h50', 'Ca 08: 16h00 - 16h30', 'Ca 09: 20h00 - 20h30',
        'Ca 10: 20h40 - 21h10', 'Ca 11: 21h20 - 21h50', 'Ca 12: 22h00 - 22h30',
        'Ca 01: 08h00 - 08h30', 'Ca 02: 08h40 - 09h10', 'Ca 03: 09h20 - 09h50',
        'Ca 04: 10h00 - 10h30', 'Ca 05: 10h40 - 11h10', 'Ca 06: 11h20 - 11h50',
        'Ca 07: 14h00 - 14h30', 'Ca 08: 14h40 - 15h10', 'Ca 09: 15h20 - 15h50',
        'Ca 10: 16h00 - 16h30'
    ];
    
    // Tạo mapping cho tất cả các slot
    timeSlots.forEach((slot, index) => {
        // Tạo pattern cho cả Thứ Bảy và Chủ Nhật
        const saturdayPattern = `day_.*_${slot.replace(/:/g, '').replace(/\s+/g, ' ').trim()}`;
        const sundayPattern = `day_.*_${slot.replace(/:/g, '').replace(/\s+/g, ' ').trim()}`;
        
        slotMapping[saturdayPattern] = `slot_${index}`;
        slotMapping[sundayPattern] = `slot_${index}`;
    });
    
    return calendarSlots.map(slot => {
        // Tìm pattern phù hợp
        for (const pattern in slotMapping) {
            if (slot.includes(pattern.replace('day_.*_', ''))) {
                return slotMapping[pattern];
            }
        }
        return slot; // Fallback
    }).filter(slot => slot); // Loại bỏ giá trị undefined/null
}

        // Xem trước lịch phỏng vấn
        function previewSchedule() {
            if (interviewArrangementData.schedule.length === 0) {
                alert('Không có dữ liệu để xem trước');
                return;
            }
            
            // Tạo popup preview
            const previewModal = document.createElement('div');
            previewModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            const previewContent = document.createElement('div');
            previewContent.style.cssText = `
                background: white;
                padding: 24px;
                border-radius: 12px;
                max-width: 90%;
                max-height: 90%;
                overflow: auto;
            `;
            
            previewContent.innerHTML = `
                <h3>Xem trước lịch phỏng vấn</h3>
                <div style="margin: 16px 0;">
                    <strong>Tổng số buổi phỏng vấn:</strong> ${interviewArrangementData.schedule.length}
                </div>
                <button id="close-preview" class="btn btn-primary">
                    Đóng
                </button>
            `;
            
            previewModal.appendChild(previewContent);
            document.body.appendChild(previewModal);
            
            // Đóng khi click nút đóng
            document.getElementById('close-preview').addEventListener('click', function() {
                document.body.removeChild(previewModal);
            });
            
            // Đóng khi click outside
            previewModal.addEventListener('click', function(e) {
                if (e.target === previewModal) {
                    document.body.removeChild(previewModal);
                }
            });
        }

        // Trích xuất ngày từ tên slot
        function extractDateFromSlot(slot) {
            if (slot.includes('Ca 01:') || slot.includes('Ca 02:') || slot.includes('Ca 03:') || 
                slot.includes('Ca 04:') || slot.includes('Ca 05:') || slot.includes('Ca 06:') ||
                slot.includes('Ca 07:') || slot.includes('Ca 08:') || slot.includes('Ca 09:') ||
                slot.includes('Ca 10:') || slot.includes('Ca 11:') || slot.includes('Ca 12:')) {
                return 'Thứ Bảy';
            } else {
                return 'Chủ Nhật';
            }
        }

        // Trích xuất thời gian từ tên slot
        function extractTimeFromSlot(slot) {
            const timeMatch = slot.match(/(\d{1,2}h\d{1,2})\s*-\s*(\d{1,2}h\d{1,2})/);
            if (timeMatch) {
                return `${timeMatch[1]} - ${timeMatch[2]}`;
            }
            return slot;
        }

        // Thuật toán sắp xếp phỏng vấn
        function arrangeInterviews(data) {
    const schedule = [];
    
    // Tạo mapping theo department
    const interviewersByDept = {};
    data.interviewers.forEach(interviewer => {
        if (!interviewersByDept[interviewer.department]) {
            interviewersByDept[interviewer.department] = [];
        }
        interviewersByDept[interviewer.department].push(interviewer);
    });
    
    // Sắp xếp ứng viên theo department
    const candidatesByDept = {};
    data.candidates.forEach(candidate => {
        const dept = candidate.department;
        if (!candidatesByDept[dept]) {
            candidatesByDept[dept] = [];
        }
        candidatesByDept[dept].push(candidate);
    });
    
    // Theo dõi số lượng interview của mỗi người
    const interviewerCount = {};
    data.interviewers.forEach(interviewer => {
        interviewerCount[interviewer.name] = 0;
    });
    
    // Sắp xếp phỏng vấn cho từng ban
    Object.keys(candidatesByDept).forEach(dept => {
        const candidates = candidatesByDept[dept];
        const interviewers = interviewersByDept[dept] || [];
        
        if (interviewers.length === 0) {
            console.warn(`Không có nhân sự phỏng vấn cho ban ${dept}`);
            return;
        }
        
        candidates.forEach(candidate => {
            const availableSlots = candidate.availableSlots;
            
            if (availableSlots.length === 0) {
                console.warn(`Ứng viên ${candidate.name} không có slot nào khả dụng`);
                return;
            }
            
            let bestSlot = null;
            let bestInterviewer = null;
            let minScore = Infinity;
            
            // Tìm slot và interviewer tối ưu
            availableSlots.forEach(slotId => {
                const interviewsInSlot = schedule.filter(item => 
                    item.slotId === slotId && item.candidateDepartment === dept
                ).length;
                
                interviewers.forEach(interviewer => {
                    if (interviewer.availableSlots.includes(slotId)) {
                        const currentCount = interviewerCount[interviewer.name] || 0;
                        const slotCount = interviewsInSlot;
                        
                        // Điểm số ưu tiên (càng thấp càng tốt)
                        const score = currentCount * 2 + slotCount;
                        
                        if (score < minScore) {
                            minScore = score;
                            bestSlot = slotId;
                            bestInterviewer = interviewer;
                        }
                    }
                });
            });
            
            if (bestSlot && bestInterviewer) {
                const slot = data.slots.find(s => s.id === bestSlot);
                if (slot) {
                    schedule.push({
                        slotId: bestSlot,
                        slotName: slot.name,
                        time: slot.time,
                        date: slot.date,
                        candidate: candidate.name,
                        candidateDepartment: candidate.department,
                        interviewer: bestInterviewer.name,
                        interviewerDepartment: bestInterviewer.department,
                        note: `Email: ${candidate.email}`
                    });
                    
                    // Cập nhật số lượng interview
                    interviewerCount[bestInterviewer.name] = (interviewerCount[bestInterviewer.name] || 0) + 1;
                }
            } else {
                console.warn(`Không thể sắp xếp phỏng vấn cho ${candidate.name}`);
            }
        });
    });
    
    return schedule;
}

        // Hiển thị kết quả sắp xếp
        function displayArrangementResults(data) {
            // Cập nhật thống kê
            document.getElementById('total-interview-slots').textContent = data.slots.length;
            document.getElementById('total-candidates-arranged').textContent = data.candidates.length;
            document.getElementById('total-interviewers').textContent = data.interviewers.length;
            document.getElementById('total-interviews').textContent = data.schedule.length;
            
            // Hiển thị bảng lịch phỏng vấn
            renderInterviewSchedule(data.schedule);
            
            // Hiển thị kết quả
            document.getElementById('arrangement-results').style.display = 'block';
        }

        // Render bảng lịch phỏng vấn
        function renderInterviewSchedule(schedule) {
            const tbody = document.getElementById('interview-schedule-body');
            tbody.innerHTML = '';
            
            schedule.forEach((item, index) => {
                const tr = document.createElement('tr');
                
                // Xác định class cho department badge
                const deptClass = `department-${item.candidateDepartment.toLowerCase()}`;
                
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.slotName}</td>
                    <td>${item.time}</td>
                    <td>${item.candidate}</td>
                    <td><span class="department-badge ${deptClass}">${getDepartmentName(item.candidateDepartment)}</span></td>
                    <td>${item.interviewer}</td>
                    <td><span class="department-badge ${deptClass}">${getDepartmentName(item.interviewerDepartment)}</span></td>
                    <td>${item.note}</td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // Lọc lịch theo department
        function filterScheduleByDepartment(dept) {
            const tbody = document.getElementById('interview-schedule-body');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                if (dept === 'all') {
                    row.style.display = '';
                } else {
                    const candidateDept = row.cells[4].querySelector('.department-badge').textContent;
                    const display = getDepartmentCode(candidateDept) === dept ? '' : 'none';
                    row.style.display = display;
                }
            });
        }

        // Lấy tên đầy đủ của ban từ mã
        function getDepartmentName(code) {
            const departments = {
                'MD': 'Truyền thông',
                'HR': 'Nhân sự',
                'PD': 'Dự án',
                'ER': 'Đối ngoại'
            };
            return departments[code] || code;
        }

        // Lấy mã ban từ tên đầy đủ
        function getDepartmentCode(name) {
            const departments = {
                'Truyền thông': 'MD',
                'Nhân sự': 'HR',
                'Dự án': 'PD',
                'Đối ngoại': 'ER'
            };
            return departments[name] || name;
        }

        // Tải template mẫu
        function downloadInterviewTemplate() {
            // Tạo dữ liệu mẫu dựa trên file đã cung cấp
            const templateData = [
                ['BAN', 'GEN', 'HỌ VÀ TÊN', 'Ca 01: 09h20 - 09h50', 'Ca 02: 10h00 - 10h30', 'Ca 03: 10h40 - 11h10', 'Ca 04: 11h20 - 11h50', 'Ca 05: 14h00 - 14h30', 'Ca 06: 14h40 - 15h10', 'Ca 07: 15h20 - 15h50', 'Ca 08: 16h00 - 16h30', 'Ca 09: 20h00 - 20h30', 'Ca 10: 20h40 - 21h10', 'Ca 11: 21h20 - 21h50', 'Ca 12: 22h00 - 22h30', 'Ca 01: 08h00 - 08h30', 'Ca 02: 08h40 - 09h10', 'Ca 03: 09h20 - 09h50', 'Ca 04: 10h00 - 10h30', 'Ca 05: 10h40 - 11h10', 'Ca 06: 11h20 - 11h50', 'Ca 07: 14h00 - 14h30', 'Ca 08: 14h40 - 15h10', 'Ca 09: 15h20 - 15h50', 'Ca 10: 16h00 - 16h30'],
                ['ER', '15', 'Đào Mai An', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                ['', '', 'Dương Đức Khoa', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                ['PD', '15', 'Nguyễn Vũ Quỳnh Anh', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                ['', '', 'Nguyễn Thị Kiều Khanh', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                ['HR', '15', 'Trịnh Hà Anh', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                ['', '', 'Nguyễn Hoàng Diễm', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                ['MD', '15', 'Trần Diệu Anh', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                ['', '', 'Bùi Tuấn Anh', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                ['', 'PIC', 'Nguyễn Văn A - HR', 'x', 'x', '', '', 'x', 'x', '', '', '', '', '', '', 'x', 'x', '', '', '', '', '', '', ''],
                ['', '', 'Trần Thị B - PD', '', '', 'x', 'x', '', '', 'x', 'x', '', '', '', '', '', '', 'x', 'x', '', '', '', '', ''],
                ['', '', 'Lê Văn C - MD', '', '', '', '', '', '', '', '', 'x', 'x', 'x', 'x', '', '', '', '', 'x', 'x', 'x', 'x', ''],
                ['', '', 'Phạm Thị D - ER', 'x', 'x', 'x', 'x', '', '', '', '', '', '', '', '', 'x', 'x', 'x', 'x', '', '', '', '', '']
            ];

            // Tạo workbook và worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);

            // Định dạng cột
            ws['!cols'] = [
                { wch: 8 },  // BAN
                { wch: 6 },  // GEN
                { wch: 25 }, // HỌ VÀ TÊN
                { wch: 18 }, // Ca 01
                { wch: 18 }, // Ca 02
                { wch: 18 }, // Ca 03
                { wch: 18 }, // Ca 04
                { wch: 18 }, // Ca 05
                { wch: 18 }, // Ca 06
                { wch: 18 }, // Ca 07
                { wch: 18 }, // Ca 08
                { wch: 18 }, // Ca 09
                { wch: 18 }, // Ca 10
                { wch: 18 }, // Ca 11
                { wch: 18 }, // Ca 12
                { wch: 18 }, // Ca 01 (CN)
                { wch: 18 }, // Ca 02 (CN)
                { wch: 18 }, // Ca 03 (CN)
                { wch: 18 }, // Ca 04 (CN)
                { wch: 18 }, // Ca 05 (CN)
                { wch: 18 }, // Ca 06 (CN)
                { wch: 18 }, // Ca 07 (CN)
                { wch: 18 }, // Ca 08 (CN)
                { wch: 18 }  // Ca 09 (CN)
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Interview Schedule');
            XLSX.writeFile(wb, 'Template_Vote_Phong_Van.xlsx');
        }

        // Xuất kết quả sắp xếp
        function exportInterviewArrangement() {
            if (interviewArrangementData.schedule.length === 0) {
                alert('Không có dữ liệu để xuất');
                return;
            }

            // Tạo dữ liệu cho Excel
            const data = [
                ['STT', 'Ca phỏng vấn', 'Thời gian', 'Ứng viên', 'Ban ứng tuyển', 'Người phỏng vấn', 'Ban phỏng vấn', 'Ghi chú']
            ];

            interviewArrangementData.schedule.forEach((item, index) => {
                data.push([
                    index + 1,
                    item.slotName,
                    item.time,
                    item.candidate,
                    getDepartmentName(item.candidateDepartment),
                    item.interviewer,
                    getDepartmentName(item.interviewerDepartment),
                    item.note
                ]);
            });

            // Tạo worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Định dạng cột
            ws['!cols'] = [
                { wch: 5 },  // STT
                { wch: 25 }, // Ca phỏng vấn
                { wch: 20 }, // Thời gian
                { wch: 25 }, // Ứng viên
                { wch: 15 }, // Ban ứng tuyển
                { wch: 25 }, // Người phỏng vấn
                { wch: 15 }, // Ban phỏng vấn
                { wch: 15 }  // Ghi chú
            ];

            // Tạo workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Lịch phỏng vấn');

            // Xuất file
            const fileName = `Lich_Phong_Van_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // Khởi tạo trang
        document.addEventListener('DOMContentLoaded', function() {
            // Cập nhật avatar người dùng
            const userEmail = sessionStorage.getItem('email') || 'Admin';
            document.getElementById('user-avatar').textContent = userEmail.charAt(0).toUpperCase();
        });
    </script>
</body>
</html>