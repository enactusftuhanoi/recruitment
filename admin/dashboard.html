<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Enactus FTU Hanoi Recruitment</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Clash+Display:wght@600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      :root {
        --primary: #f8f3ce;
        --primary-light: #ffd54f;
        --gray-50: #fafafa;
        --gray-100: #f5f5f5;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
        --white: #ffffff;
        --error: #ef4444;
        --error-light: #fee2e2;
        --success: #10b981;
        --success-light: #d1fae5;
        --warning: #f59e0b;
        --warning-light: #fef3c7;
        --info: #3b82f6;
        --info-light: #dbeafe;
        --border-radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --transition: all 0.3s ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Plus Jakarta Sans", sans-serif;
      }

      body {
        background-color: var(--gray-50);
        color: var(--gray-800);
        min-height: 100vh;
        display: flex;
      }

      /* Sidebar */
      .sidebar {
        width: 260px;
        background: var(--white);
        box-shadow: var(--shadow);
        padding: 24px 0;
        display: flex;
        flex-direction: column;
        z-index: 100;
        transition: var(--transition);
      }

      .logo {
        padding: 0 24px 24px;
        border-bottom: 1px solid var(--gray-200);
        margin-bottom: 24px;
      }

      .logo img {
        height: 60px;
        width: auto;
        display: block;
        margin: 0 auto;
      }

      .nav-menu {
        flex: 1;
      }

      .nav-item {
        padding: 12px 24px;
        display: flex;
        align-items: center;
        color: var(--gray-600);
        text-decoration: none;
        transition: var(--transition);
        margin-bottom: 4px;
        cursor: pointer;
      }

      .nav-item:hover,
      .nav-item.active {
        background-color: var(--primary);
        color: var(--gray-900);
      }

      .nav-item i {
        margin-right: 12px;
        font-size: 18px;
        width: 24px;
        text-align: center;
      }

      .nav-item span {
        font-weight: 500;
      }

      .user-section {
        padding: 16px 24px;
        border-top: 1px solid var(--gray-200);
      }

      .user-info {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-weight: 600;
        color: var(--gray-800);
      }

      .user-details {
        flex: 1;
      }

      .user-name {
        font-weight: 600;
        font-size: 14px;
        color: var(--gray-800);
      }

      .user-role {
        font-size: 12px;
        color: var(--gray-500);
      }

      .logout-btn {
        width: 100%;
        padding: 10px;
        background-color: var(--gray-100);
        border: none;
        border-radius: var(--border-radius);
        color: var(--gray-700);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .logout-btn:hover {
        background-color: var(--error-light);
        color: var(--error);
      }

      .logout-btn i {
        margin-right: 8px;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* Header */
      .header {
        background-color: var(--white);
        padding: 16px 24px;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        justify-content: space-between;
        z-index: 10;
      }

      .page-title {
        font-family: "Clash Display", sans-serif;
        font-size: 24px;
        font-weight: 700;
        color: var(--gray-900);
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .refresh-btn,
      .export-btn {
        padding: 8px 16px;
        background-color: var(--gray-100);
        border: none;
        border-radius: var(--border-radius);
        color: var(--gray-700);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
      }

      .refresh-btn:hover,
      .export-btn:hover {
        background-color: var(--gray-200);
      }

      .refresh-btn i,
      .export-btn i {
        margin-right: 8px;
      }

      .reset-btn {
        padding: 8px 16px;
        background-color: var(--error-light);
        border: none;
        border-radius: var(--border-radius);
        color: var(--error);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
      }

      .reset-btn:hover {
        background-color: var(--error);
        color: var(--white);
      }

      .reset-btn i {
        margin-right: 8px;
      }

      .update-all-rounds-btn {
        padding: 8px 16px;
        background-color: var(--primary-light);
        border: none;
        border-radius: var(--border-radius);
        color: var(--primary);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
      }

      .update-all-rounds-btn:hover {
        background-color: var(--primary);
        color: var(--white);
      }

      .update-all-rounds-btn i {
        margin-right: 8px;
      }

      /* Content */
      .content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }

      /* Stats */
      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
      }

      .stat-card {
        background-color: var(--white);
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
      }

      .stat-title {
        font-size: 14px;
        color: var(--gray-500);
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--gray-800);
        margin-bottom: 8px;
      }

      .stat-comparison {
        font-size: 12px;
        display: flex;
        align-items: center;
      }

      .stat-comparison.positive {
        color: var(--success);
      }

      .stat-comparison.negative {
        color: var(--error);
      }

      /* Filters */
      .filters {
        background-color: var(--white);
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: var(--shadow);
        margin-bottom: 24px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
      }

      .filter-label {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--gray-700);
      }

      .filter-select,
      .filter-input {
        padding: 10px 12px;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius);
        font-size: 14px;
        background-color: var(--white);
        color: var(--gray-800);
      }

      .filter-input {
        display: flex;
        align-items: center;
      }

      .filter-input input {
        flex: 1;
        border: none;
        outline: none;
        padding: 0;
        margin-left: 8px;
      }

      /* Table */
      .table-container {
        background-color: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .applications-table {
        width: 100%;
        border-collapse: collapse;
      }

      .applications-table th {
        background-color: var(--gray-100);
        padding: 16px;
        text-align: left;
        font-weight: 600;
        color: var(--gray-700);
        font-size: 14px;
        border-bottom: 1px solid var(--gray-200);
      }

      .applications-table td {
        padding: 16px;
        border-bottom: 1px solid var(--gray-200);
        font-size: 14px;
        color: var(--gray-700);
      }

      .applications-table tr:last-child td {
        border-bottom: none;
      }

      .applications-table tr:hover {
        background-color: var(--gray-50);
      }

      .applicant-info {
        display: flex;
        align-items: center;
      }

      .applicant-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
        background-color: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--gray-800);
      }

      .applicant-details {
        flex: 1;
      }

      .applicant-name {
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 4px;
      }

      .applicant-contact {
        font-size: 12px;
        color: var(--gray-500);
      }

      .app-input {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius);
        font-size: 14px;
      }

      .app-select {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius);
        font-size: 14px;
        background: #fff;
      }

      .department-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        margin-right: 4px;
      }

      .department-priority {
        background-color: var(--info-light);
        color: var(--info);
      }

      .department-secondary {
        background-color: var(--gray-100);
        color: var(--gray-600);
      }

      /* Department badge color by status */
      .department-badge.status-pass {
        background-color: var(--success-light);
        color: var(--success);
      }

      .department-badge.status-not-pass {
        background-color: var(--error-light);
        color: var(--error);
      }

      .department-badge.status-pending {
        background-color: var(--warning-light);
        color: var(--warning);
      }

      .department-badge.status-voted {
        background-color: var(--primary);
        color: var(--gray-800);
      }

      .department-badge.status-interviewed {
        background-color: var(--info-light);
        color: var(--info);
      }

      .status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-new {
        background-color: var(--info-light);
        color: var(--info);
      }

      .status-pending {
        background-color: var(--warning-light);
        color: var(--warning);
      }

      .status-pass {
        background-color: var(--success-light);
        color: var(--success);
      }

      .status-not-pass {
        background-color: var(--error-light);
        color: var(--error);
      }

      .status-interviewed {
        background-color: var(--info-light);
        color: var(--info);
      }

      .status-voted {
        background-color: var(--primary);
        color: var(--gray-800);
      }

      .status-success {
        background-color: rgb(252, 217, 15);
        color: rgba(30, 30, 30, 0.692);
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 12px;
      }

      .action-btn {
        padding: 6px 12px;
        background-color: var(--gray-100);
        border: none;
        border-radius: var(--border-radius);
        color: var(--gray-700);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
      }

      .action-btn:hover {
        background-color: var(--gray-200);
      }

      .view-btn {
        background-color: var(--info-light);
        color: var(--info);
      }

      .view-btn:hover {
        background-color: var(--info);
        color: var(--white);
      }

      /* Tabs */
      .tabs {
        display: flex;
        border-bottom: 1px solid var(--gray-200);
        margin-bottom: 20px;
      }

      .tab {
        padding: 12px 24px;
        font-weight: 500;
        color: var(--gray-600);
        cursor: pointer;
        transition: var(--transition);
        border-bottom: 2px solid transparent;
      }

      .tab:hover {
        color: var(--gray-800);
      }

      .tab.active {
        color: var(--info);
        border-bottom: 2px solid var(--info);
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background-color: var(--white);
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }

      .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--gray-900);
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--gray-500);
      }

      .modal-body {
        padding: 24px;
      }

      .row-disabled {
        opacity: 0.55;
        pointer-events: auto;
        /* vẫn cho copy text, nhưng inputs bên trong disabled */
        background: #fafafa;
      }

      /* đảm bảo input disabled trông khác */
      .row-disabled .app-input[disabled],
      .row-disabled .app-select[disabled] {
        background: #f5f5f5;
        color: #888;
        border-color: #e5e5e5;
      }

      .row-disabled .save-btn[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .team-btn {
        padding: 8px 16px;
        background-color: var(--info-light);
        border: none;
        border-radius: var(--border-radius);
        color: var(--info);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
      }

      .team-btn:hover {
        background-color: var(--info);
        color: var(--white);
      }

      .team-btn i {
        margin-right: 8px;
      }

      /* Cải thiện giao diện thống kê ban */
      .department-stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
      }

      .department-stat-card {
        background-color: var(--white);
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        border-top: 4px solid var(--primary);
        transition: var(--transition);
      }

      .department-stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }

      .department-stat-header {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .department-stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-size: 18px;
      }

      .department-stat-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--gray-800);
      }

      .department-stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 8px;
      }

      .department-stat-details {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-top: 8px;
      }

      .department-stat-item {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
      }

      .department-stat-label {
        color: var(--gray-500);
      }

      .department-stat-count {
        font-weight: 500;
      }

      .department-stat-progress {
        height: 6px;
        background-color: var(--gray-200);
        border-radius: 3px;
        margin-top: 8px;
        overflow: hidden;
      }

      .department-stat-progress-bar {
        height: 100%;
        border-radius: 3px;
        transition: width 0.5s ease;
      }

      /* Màu sắc cho từng ban */
      .department-md .department-stat-icon {
        background-color: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
      }

      .department-md .department-stat-progress-bar {
        background-color: #3b82f6;
      }

      .department-hr .department-stat-icon {
        background-color: rgba(16, 185, 129, 0.1);
        color: #10b981;
      }

      .department-hr .department-stat-progress-bar {
        background-color: #10b981;
      }

      .department-pd .department-stat-icon {
        background-color: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
      }

      .department-pd .department-stat-progress-bar {
        background-color: #f59e0b;
      }

      .department-er .department-stat-icon {
        background-color: rgba(139, 92, 246, 0.1);
        color: #8b5cf6;
      }

      .department-er .department-stat-progress-bar {
        background-color: #8b5cf6;
      }

      @media (max-width: 1024px) {
        .stats-container {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        s .stats-container {
          grid-template-columns: 1fr;
        }
      }

      /* Thêm vào phần CSS */
      .duplicate-row {
        background-color: var(--warning-light) !important;
        border-left: 4px solid var(--warning);
      }

      .duplicate-row:hover {
        background-color: #fef3cd !important;
      }

      .delete-btn {
        background-color: var(--error-light) !important;
        color: var(--error) !important;
      }

      .delete-btn:hover {
        background-color: var(--error) !important;
        color: var(--white) !important;
      }

      .duplicate-badge {
        background-color: var(--warning);
        color: var(--white);
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 8px;
      }

      /* CSS cho thống kê ban */
      .department-stats-header {
        grid-column: 1 / -1;
        font-size: 18px;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 16px;
        border-bottom: 2px solid var(--primary);
        padding-bottom: 8px;
      }

      .team-preview-card input[type="text"] {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius);
        font-size: 14px;
        margin-bottom: 8px;
      }

      /* Thêm vào phần CSS */
      .archive-btn {
        background-color: var(--warning-light) !important;
        color: var(--warning) !important;
      }

      .archive-btn:hover {
        background-color: var(--warning) !important;
        color: var(--white) !important;
      }

      .restore-btn {
        background-color: var(--success-light) !important;
        color: var(--success) !important;
      }

      .restore-btn:hover {
        background-color: var(--success) !important;
        color: var(--white) !important;
      }

      .archive-badge {
        background-color: var(--warning);
        color: var(--white);
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 8px;
      }

      /* Tabs trong modal */
      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .modal .tabs {
        display: flex;
        border-bottom: 1px solid var(--gray-200);
        margin-bottom: 0;
        padding: 0 24px;
      }

      .modal .tab {
        padding: 12px 24px;
        font-weight: 500;
        color: var(--gray-600);
        cursor: pointer;
        transition: var(--transition);
        border-bottom: 2px solid transparent;
      }

      .modal .tab:hover {
        color: var(--gray-800);
      }

      .modal .tab.active {
        color: var(--info);
        border-bottom: 2px solid var(--info);
      }

      /* Tab khôi phục */
      #restore-tab .applications-table {
        font-size: 12px;
      }

      #restore-tab .applications-table th {
        padding: 8px 12px;
        font-size: 11px;
      }

      #restore-tab .applications-table td {
        padding: 8px 12px;
        vertical-align: top;
      }

      .restore-btn {
        background-color: var(--success-light) !important;
        color: var(--success) !important;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 11px;
      }

      .restore-btn:hover {
        background-color: var(--success) !important;
        color: white !important;
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .sidebar {
          width: 80px;
        }

        .nav-item span {
          display: none;
        }

        .user-details {
          display: none;
        }

        .stats-container {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .stats-container {
          grid-template-columns: 1fr;
        }

        .filters {
          grid-template-columns: 1fr;
        }

        .header {
          flex-direction: column;
          align-items: flex-start;
          gap: 16px;
        }

        .header-actions {
          width: 100%;
          justify-content: space-between;
        }
      }
    </style>
  </head>

  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo">
        <img src="/assets/logo_den.png" alt="Enactus FTU Hanoi Logo" />
      </div>

      <div class="nav-menu">
        <div class="nav-item active" data-tab="dashboard">
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        </div>
        <div
          class="nav-item system-settings-menu"
          style="display: none"
          onclick="window.location.href='response.html'"
        >
          <i class="fas fa-folder-open"></i>
          <span>Response</span>
        </div>
        <div class="nav-item" data-tab="round1">
          <i class="fas fa-file-alt"></i>
          <span>Vòng 1: Đơn</span>
        </div>
        <div class="nav-item" data-tab="round2">
          <i class="fas fa-users"></i>
          <span>Vòng 2: Phỏng vấn nhóm</span>
        </div>
        <div class="nav-item" data-tab="round3">
          <i class="fas fa-tasks"></i>
          <span>Vòng 3: Teamwork</span>
        </div>
        <div class="nav-item" data-tab="round4">
          <i class="fas fa-user-circle"></i>
          <span>Vòng 4: Phỏng vấn cá nhân</span>
        </div>
        <div class="nav-item" data-tab="success">
          <i class="fas fa-trophy"></i>
          <span>Thành viên chính thức</span>
        </div>
        <div
          class="nav-item system-settings-menu"
          style="display: none"
          onclick="window.location.href='calendar.html'"
        >
          <i class="fa-solid fa-calendar-days"></i>
          <span>Calendar</span>
        </div>
        <div
          class="nav-item system-settings-menu"
          style="display: none"
          onclick="window.location.href='interview-arrangement.html'"
        >
          <i class="fa-solid fa-user-clock"></i>
          <span>Interview</span>
        </div>
        <div
          class="nav-item system-settings-menu"
          style="display: none"
          onclick="window.location.href='accounts.html'"
        >
          <i class="fas fa-cog"></i>
          <span>Cấp quyền</span>
        </div>
      </div>

      <div class="user-section">
        <div class="user-info">
          <div class="user-avatar" id="user-avatar">U</div>
          <div class="user-details">
            <div class="user-name" id="user-name">User Name</div>
            <div class="user-role" id="user-role">Role • Department</div>
          </div>
        </div>
        <button class="logout-btn" id="logout-btn">
          <i class="fas fa-sign-out-alt"></i>
          Đăng xuất
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <div class="header">
        <h1 class="page-title" id="page-title">Dashboard</h1>
        <div class="header-actions">
          <button class="team-btn" id="team-division-btn">
            <i class="fas fa-users"></i>
            Chia Team
          </button>

          <button class="reset-btn" id="reset-rounds-btn">
            <i class="fas fa-undo"></i>
            Reset dữ liệu vòng
          </button>
          <button class="update-all-rounds-btn" id="update-round-btn">
            <i class="fas fa-level-up-alt"></i>
            Cập nhật vòng
          </button>
          <button
            class="archive-btn"
            id="archive-apps-btn"
            style="
              padding: 8px 16px;
              background-color: var(--warning-light);
              border: none;
              border-radius: var(--border-radius);
              color: var(--warning);
              font-weight: 500;
              cursor: pointer;
              transition: var(--transition);
              display: flex;
              align-items: center;
            "
          >
            <i class="fas fa-archive"></i>
            Lưu trữ
          </button>
          <button class="refresh-btn" id="refresh-btn">
            <i class="fas fa-sync-alt"></i>
            Làm mới
          </button>
          <button class="export-btn" id="export-btn">
            <i class="fas fa-download"></i>
            Xuất file
          </button>
        </div>
      </div>

      <!-- Content -->
      <div class="content">
        <!-- Stats -->
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-title">Tổng số ứng viên</div>
            <div class="stat-value" id="total-applicants">0</div>
            <div class="stat-comparison positive" id="total-comparison">
              <i class="fas fa-arrow-up"></i>
              <span>0% so với tuần trước</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Đã hoàn thành</div>
            <div class="stat-value" id="completed-applicants">0</div>
            <div class="stat-comparison positive" id="completed-comparison">
              <i class="fas fa-arrow-up"></i>
              <span>0% so với tuần trước</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Đang trong quá trình</div>
            <div class="stat-value" id="inprogress-applicants">0</div>
            <div class="stat-comparison negative" id="inprogress-comparison">
              <i class="fas fa-arrow-down"></i>
              <span>0% so với tuần trước</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Đã loại</div>
            <div class="stat-value" id="rejected-applicants">0</div>
            <div class="stat-comparison positive" id="rejected-comparison">
              <i class="fas fa-arrow-up"></i>
              <span>0% so với tuần trước</span>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="filters">
          <div class="filter-group">
            <label class="filter-label">Tìm kiếm</label>
            <div class="filter-input">
              <i class="fas fa-search"></i>
              <input
                type="text"
                id="search-input"
                placeholder="Tìm theo tên, email, SĐT..."
              />
            </div>
          </div>
          <div class="filter-group">
            <label class="filter-label">Ban ứng tuyển</label>
            <select class="filter-select" id="filter-department">
              <option value="">Tất cả ban</option>
              <option value="MD">Truyền thông</option>
              <option value="HR">Nhân sự</option>
              <option value="PD">Dự án</option>
              <option value="ER">Đối ngoại</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Vòng</label>
            <select class="filter-select" id="filter-round">
              <option value="">Tất cả vòng</option>
              <option value="round1">Vòng 1: Đơn</option>
              <option value="round2">Vòng 2: Phỏng vấn nhóm</option>
              <option value="round3">Vòng 3: Teamwork</option>
              <option value="round4">Vòng 4: Phỏng vấn cá nhân</option>
              <option value="success">Thành viên chính thức</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Trạng thái</label>
            <select class="filter-select" id="filter-status">
              <option value="">Tất cả trạng thái</option>
              <option value="new">New</option>
              <option value="pending">Pending</option>
              <option value="pass">Pass</option>
              <option value="not-pass">Not pass</option>
              <option value="interviewed">Interviewed</option>
              <option value="voted">Voted</option>
              <option value="success">Success</option>
            </select>
          </div>
        </div>

        <!-- Table -->
        <div class="table-container main-dashboard">
          <table class="applications-table">
            <thead>
              <tr>
                <th>Họ và tên</th>
                <th>Ban ứng tuyển</th>
                <th>Email</th>
                <th>SĐT</th>
                <th>Vòng hiện tại</th>
                <th>Trạng thái</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody id="applications-table-body">
              <!-- Data will be populated by JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- Round 1 Content -->
        <div id="round1-content" class="round-content" style="display: none">
          <div
            style="
              margin-top: 30px;
              padding: 20px;
              background: var(--white);
              border-radius: var(--border-radius);
              box-shadow: var(--shadow);
            "
          >
            <h3 style="color: var(--error); margin-bottom: 16px">
              <i class="fas fa-exclamation-triangle"></i>
              Ứng viên apply nhiều lần
            </h3>

            <div
              style="
                margin-bottom: 16px;
                display: flex;
                gap: 12px;
                align-items: center;
              "
            >
              <button
                class="action-btn"
                id="scan-duplicates-btn"
                style="background: var(--warning-light); color: var(--warning)"
              >
                <i class="fas fa-search"></i>
                Quét đơn trùng
              </button>
              <span
                id="duplicates-count"
                style="font-size: 14px; color: var(--gray-600)"
              >
                Chưa quét
              </span>
            </div>

            <div id="duplicates-container" style="display: none">
              <table class="applications-table">
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Số đơn</th>
                    <th>Thông tin ứng viên</th>
                    <th>Hành động</th>
                  </tr>
                </thead>
                <tbody id="duplicates-table-body">
                  <!-- Data will be populated by JavaScript -->
                </tbody>
              </table>
            </div>

            <div
              id="no-duplicates-message"
              style="
                display: none;
                padding: 20px;
                text-align: center;
                color: var(--success);
              "
            >
              <i class="fas fa-check-circle"></i>
              Không có ứng viên nào apply nhiều lần
            </div>
          </div>
          <table class="applications-table">
            <thead>
              <tr>
                <th>Họ và tên</th>
                <th>Email</th>
                <th>SĐT</th>
                <th>Ban ứng tuyển</th>
                <th>Loại đơn</th>
                <th>Thời gian</th>
                <th>Link</th>
                <th>Ghi chú</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody id="round1-table-body"></tbody>
          </table>
        </div>

        <!-- Round 2 Content -->
        <div id="round2-content" class="round-content" style="display: none">
          <table class="applications-table">
            <thead>
              <tr>
                <th>Họ và tên</th>
                <th>Ban ứng tuyển</th>
                <th>Thời gian</th>
                <th>Địa điểm / Link</th>
                <th>Hình thức</th>
                <th>Ghi chú</th>
                <th>Trạng thái</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody id="round2-table-body">
              <!-- Render ứng viên round2 -->
            </tbody>
          </table>
        </div>
        <!-- Round 3 Content -->
        <div id="round3-content" class="round-content" style="display: none">
          <table class="applications-table">
            <thead>
              <tr>
                <th>Team</th>
                <th>Advisor</th>
                <th>Họ và tên</th>
                <th>Ban ứng tuyển</th>
                <th>Ghi chú</th>
                <th>Trạng thái</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody id="round3-table-body"></tbody>
          </table>
        </div>
        <!-- Round 4 Content -->
        <div id="round4-content" class="round-content" style="display: none">
          <table class="applications-table">
            <thead>
              <tr>
                <th>Họ và tên</th>
                <th>Ban ứng tuyển</th>
                <th>Thời gian</th>
                <th>Địa điểm / Link</th>
                <th>Người phỏng vấn</th>
                <th>Hình thức</th>
                <th>Ghi chú</th>
                <th>Trạng thái</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody id="round4-table-body"></tbody>
          </table>
        </div>
        <!-- Success Content -->
        <div id="success-content" class="round-content" style="display: none">
          <h2>Thành viên chính thức</h2>
          <table class="applications-table success-table">
            <thead>
              <tr>
                <th>Họ và tên</th>
                <th>Email</th>
                <th>SĐT</th>
                <th>Ban chính thức</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody id="success-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Cập nhật modal chi tiết ứng viên -->
    <div class="modal" id="application-modal">
      <div class="modal-content" style="max-width: 800px; max-height: 90vh">
        <div class="modal-header">
          <h2 class="modal-title">Chi tiết ứng viên</h2>
          <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body" id="modal-body" style="padding: 0">
          <!-- Tabs -->
          <div
            class="tabs"
            id="application-tabs"
            style="margin: 0; padding: 0 24px"
          >
            <div class="tab active" data-tab="info">Thông tin cá nhân</div>
            <div class="tab" data-tab="application">Đơn ứng tuyển</div>
            <div class="tab" data-tab="history">Lịch sử vòng</div>
          </div>

          <!-- Tab Content -->
          <div id="application-tab-content" style="padding: 24px">
            <!-- Tab Thông tin cá nhân -->
            <div id="info-tab" class="tab-content active">
              <div id="personal-info-edit" style="display: none">
                <!-- Form chỉnh sửa sẽ được thêm ở đây -->
              </div>

              <div id="personal-info-view">
                <!-- Thông tin xem sẽ được thêm ở đây -->
              </div>
            </div>

            <!-- Tab Đơn ứng tuyển -->
            <div id="application-tab" class="tab-content" style="display: none">
              <!-- Nội dung đơn ứng tuyển -->
            </div>

            <!-- Tab Lịch sử vòng -->
            <div id="history-tab" class="tab-content" style="display: none">
              <!-- Lịch sử các vòng -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="export-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Xuất dữ liệu</h2>
          <button class="modal-close" id="export-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div
            style="
              display: grid;
              grid-template-columns: repeat(2, 1fr);
              gap: 16px;
            "
          >
            <button class="action-btn" onclick="exportData('all')">
              Xuất toàn bộ
            </button>
            <button class="action-btn" onclick="exportData('personal')">
              Thông tin cá nhân
            </button>
            <button class="action-btn" onclick="exportData('results')">
              Kết quả ứng tuyển
            </button>
            <button class="action-btn" onclick="exportData('byDepartment')">
              Theo ban
            </button>
            <button class="action-btn" onclick="exportData('byCandidate')">
              Theo ứng viên
            </button>
            <button
              class="action-btn"
              onclick="exportData('personalWithResults')"
            >
              Thông tin + Kết quả
            </button>
          </div>
          <div id="department-filter" style="margin-top: 20px; display: none">
            <label class="filter-label">Chọn ban</label>
            <select class="filter-select" id="export-department">
              <option value="MD">Truyền thông</option>
              <option value="HR">Nhân sự</option>
              <option value="PD">Dự án</option>
              <option value="ER">Đối ngoại</option>
            </select>
            <button
              class="action-btn"
              style="margin-top: 10px"
              onclick="exportDepartmentData()"
            >
              Xuất
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Archive Modal -->

    <div class="modal" id="archive-modal">
      <div class="modal-content" style="max-width: 900px">
        <div class="modal-header">
          <h2 class="modal-title">
            <i class="fas fa-archive" style="color: var(--warning)"></i>
            Quản lý Lưu trữ & Khôi phục
          </h2>
          <button class="modal-close" id="archive-modal-close">&times;</button>
        </div>

        <!-- Tabs -->
        <div class="tabs" style="margin: 0; padding: 0 24px">
          <div class="tab active" data-tab="archive">Lưu trữ</div>
          <div class="tab" data-tab="restore">Khôi phục</div>
        </div>

        <div class="modal-body">
          <!-- TAB LƯU TRỮ -->
          <div id="archive-tab" class="tab-content active">
            <div id="archive-options">
              <h4 style="margin-bottom: 16px">Chọn phương thức lưu trữ</h4>

              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 16px;
                  margin-bottom: 20px;
                "
              >
                <div
                  style="
                    padding: 16px;
                    border: 2px solid var(--info-light);
                    border-radius: 8px;
                    text-align: center;
                    cursor: pointer;
                  "
                  onclick="selectArchiveMethod('single')"
                >
                  <i
                    class="fas fa-user"
                    style="
                      font-size: 24px;
                      color: var(--info);
                      margin-bottom: 8px;
                    "
                  ></i>
                  <div style="font-weight: 600; margin-bottom: 4px">
                    Lưu trữ từng ứng viên
                  </div>
                  <div style="font-size: 12px; color: var(--gray-500)">
                    Chọn ứng viên cụ thể để lưu trữ
                  </div>
                </div>

                <div
                  style="
                    padding: 16px;
                    border: 2px solid var(--warning-light);
                    border-radius: 8px;
                    text-align: center;
                    cursor: pointer;
                  "
                  onclick="selectArchiveMethod('duplicate')"
                >
                  <i
                    class="fas fa-copy"
                    style="
                      font-size: 24px;
                      color: var(--warning);
                      margin-bottom: 8px;
                    "
                  ></i>
                  <div style="font-weight: 600; margin-bottom: 4px">
                    Lưu trữ đơn trùng
                  </div>
                  <div style="font-size: 12px; color: var(--gray-500)">
                    Lưu trữ ứng viên apply nhiều lần
                  </div>
                </div>
              </div>
            </div>

            <!-- Lưu trữ từng ứng viên -->
            <div id="single-archive-section" style="display: none">
              <h4 style="margin-bottom: 16px">Lưu trữ ứng viên</h4>
              <div class="filter-group">
                <label class="filter-label">Tìm kiếm ứng viên</label>
                <div class="filter-input">
                  <i class="fas fa-search"></i>
                  <input
                    type="text"
                    id="archive-search"
                    placeholder="Tìm theo tên, email..."
                  />
                </div>
              </div>

              <div
                id="archive-search-results"
                style="
                  max-height: 300px;
                  overflow-y: auto;
                  margin-top: 16px;
                  display: none;
                "
              >
                <table class="applications-table" style="font-size: 12px">
                  <thead>
                    <tr>
                      <th>Chọn</th>
                      <th>Họ tên</th>
                      <th>Email</th>
                      <th>Vòng hiện tại</th>
                      <th>Trạng thái</th>
                    </tr>
                  </thead>
                  <tbody id="archive-search-results-body"></tbody>
                </table>
              </div>

              <div
                id="selected-archive-apps"
                style="display: none; margin-top: 16px"
              >
                <h5>Ứng viên đã chọn:</h5>
                <div
                  id="selected-apps-list"
                  style="max-height: 200px; overflow-y: auto"
                ></div>
              </div>
            </div>

            <!-- Lưu trữ đơn trùng -->
            <div id="duplicate-archive-section" style="display: none">
              <h4 style="margin-bottom: 16px">Lưu trữ đơn trùng</h4>
              <div id="duplicate-archive-list"></div>
            </div>
          </div>

          <!-- TAB KHÔI PHỤC -->
          <div id="restore-tab" class="tab-content" style="display: none">
            <h4 style="margin-bottom: 16px">
              <i class="fas fa-history" style="color: var(--success)"></i>
              Khôi phục ứng viên đã lưu trữ
            </h4>

            <!-- Ô tìm kiếm -->
            <div class="filter-group">
              <label class="filter-label">Tìm kiếm ứng viên đã lưu trữ</label>
              <div class="filter-input">
                <i class="fas fa-search"></i>
                <input
                  type="text"
                  id="restore-search"
                  placeholder="Tìm theo tên, email..."
                  oninput="searchArchivedApplications()"
                />
              </div>
            </div>

            <!-- Kết quả -->
            <div
              id="restore-results"
              style="max-height: 400px; overflow-y: auto; margin-top: 16px"
            >
              <table class="applications-table" style="font-size: 12px">
                <thead>
                  <tr>
                    <th>Họ tên</th>
                    <th>Email</th>
                    <th>Ban chính</th>
                    <th>Thời gian lưu trữ</th>
                    <th>Hành động</th>
                  </tr>
                </thead>
                <tbody id="restore-results-body"></tbody>
              </table>
            </div>

            <!-- Trạng thái -->
            <div
              id="restore-loading"
              style="
                display: none;
                padding: 20px;
                text-align: center;
                color: var(--gray-500);
              "
            >
              <i
                class="fas fa-spinner fa-spin"
                style="font-size: 24px; margin-bottom: 16px"
              ></i>
              <div>Đang tải danh sách lưu trữ...</div>
            </div>

            <div
              id="no-restore-results"
              style="
                display: none;
                padding: 20px;
                text-align: center;
                color: var(--gray-500);
              "
            >
              <i
                class="fas fa-inbox"
                style="font-size: 48px; margin-bottom: 16px"
              ></i>
              <div>Không có ứng viên nào trong danh sách lưu trữ</div>
            </div>
          </div>

          <!-- BUTTONS CHUNG -->
          <div
            style="
              margin-top: 20px;
              display: flex;
              gap: 8px;
              justify-content: flex-end;
            "
          >
            <button class="action-btn" onclick="closeArchiveModal()">
              Đóng
            </button>
            <button
              class="action-btn archive-btn"
              id="confirm-archive-btn"
              onclick="confirmArchive()"
              style="display: none"
            >
              <i class="fas fa-archive"></i> Xác nhận lưu trữ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Thêm sau modal export -->
    <div class="modal" id="team-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Chia Team Vòng 3</h2>
          <button class="modal-close" id="team-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="team-config">
            <div class="filter-group">
              <label class="filter-label">Phương thức chia</label>
              <select class="filter-select" id="division-method">
                <option value="byTeamCount">Chia theo số team</option>
                <option value="byTeamSize">Chia theo số người mỗi team</option>
              </select>
            </div>
            <div class="filter-group" id="team-count-group">
              <label class="filter-label">Số team</label>
              <input
                type="number"
                class="filter-input"
                id="team-count"
                min="2"
                max="10"
                value="6"
              />
            </div>
            <div
              class="filter-group"
              id="team-size-group"
              style="display: none"
            >
              <label class="filter-label">Số người mỗi team</label>
              <input
                type="number"
                class="filter-input"
                id="team-size"
                min="3"
                max="10"
                value="5"
              />
            </div>
            <button class="action-btn" id="generate-teams-btn">Tạo Team</button>
            <button
              class="action-btn"
              id="reset-teams-btn"
              style="
                background-color: var(--warning-light);
                color: var(--warning);
              "
            >
              <i class="fas fa-undo" style="margin-right: 8px"></i> Reset Team
            </button>
          </div>

          <div id="team-preview" style="display: none; margin-top: 20px">
            <h3>Preview Team</h3>
            <div id="teams-container"></div>
            <div
              class="team-actions"
              style="
                margin-top: 20px;
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
              "
            >
              <button class="action-btn" id="export-teams-btn">
                Export Danh Sách
              </button>
              <button
                class="action-btn"
                id="confirm-teams-btn"
                style="
                  background-color: var(--success-light);
                  color: var(--success);
                "
              >
                <i class="fas fa-check" style="margin-right: 8px"></i>
                Xác Nhận Chia Team
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAOP2j0qV0Ge-q2-Y9zo9Qc3eLmgtVOK3k",
        authDomain: "recruitment-enactusftuhanoi.firebaseapp.com",
        projectId: "recruitment-enactusftuhanoi",
        storageBucket: "recruitment-enactusftuhanoi.firebasestorage.app",
        messagingSenderId: "658928769643",
        appId: "1:658928769643:web:ef4e26633b7c41c922ef2e",
        measurementId: "G-BJT7ZPKYE3",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();

      // Global State
      const userEmail = sessionStorage.getItem("email");
      let userRole = sessionStorage.getItem("role") || null;
      let userDept = sessionStorage.getItem("department") || null;
      let applications = [];
      let currentApplicationId = null;
      let emailSendingInProgress = new Set(); // Theo dõi các email đang được gửi

      // Khởi tạo EmailJS (đã có trong code)
      emailjs.init("HJUuXcN5zo-hOZPoG"); // Public Key

      // Service ID và Template ID
      const SERVICE_ID = "service_oxo8n38";
      const TEMPLATE_ID = "template_1fwgrrk";

      // Check authentication
      if (!userEmail || !userRole) {
        window.location.href = "login.html";
      }

      // Redirect members to response page
      if (userRole === "member") {
        window.location.href = "response.html";
      }

      // Auth state listener
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          try {
            const snap = await db
              .collection("account")
              .where("email", "==", user.email)
              .limit(1)
              .get();

            if (!snap.empty) {
              const doc = snap.docs[0];
              const data = doc.data();

              userRole = data.role || userRole;
              userDept = data.department || userDept;

              // Update session storage
              sessionStorage.setItem("role", userRole);
              sessionStorage.setItem("department", userDept);

              // Update UI
              updateUserInfo(doc.id, userRole, userDept);
              applyRoleUIRules();

              // Load applications
              loadApplications();
            } else {
              // Account doesn't exist
              await auth.signOut();
              window.location.href = "login.html";
              return;
            }
          } catch (e) {
            console.error("Lỗi khi lấy account:", e);
          }
        } else {
          window.location.href = "login.html";
        }
      });

      // Update user info in the sidebar
      function updateUserInfo(fullname, role, department) {
        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const userAvatarEl = document.getElementById("user-avatar");

        if (userNameEl) userNameEl.textContent = fullname;
        if (userRoleEl)
          userRoleEl.textContent = `${role} • ${getDepartmentName(department)}`;
        if (userAvatarEl)
          userAvatarEl.textContent = fullname.charAt(0).toUpperCase();
      }

      // Apply UI rules based on role
      function applyRoleUIRules() {
        // system settings only visible to superadmin
        const systemMenus = document.querySelectorAll(".system-settings-menu");
        if (systemMenus) {
          systemMenus.forEach((menu) => {
            // ✅ SỬA: Cho cả superadmin VÀ admin thấy menu system settings
            menu.style.display =
              userRole === "superadmin" || userRole === "admin"
                ? "block"
                : "none";
          });
        }

        // Reset button only superadmin
        const resetBtn = document.getElementById("reset-rounds-btn");
        if (resetBtn)
          resetBtn.style.display =
            userRole === "superadmin" ? "inline-flex" : "none";

        // Members should be redirected out earlier; but if not:
        if (userRole === "member") {
          window.location.href = "response.html";
        }
      }

      // Load applications from Firestore
      async function loadApplications() {
        try {
          let snapshot;
          try {
            snapshot = await db
              .collection("applications")
              .orderBy("timestamp", "desc")
              .get();
          } catch (e) {
            console.warn(
              "OrderBy failed (index?), falling back to unsorted fetch",
              e
            );
            snapshot = await db.collection("applications").get();
          }

          const allApps = [];
          snapshot.forEach((doc) => {
            const data = doc.data();
            allApps.push({
              id: doc.id,
              ...data,
              priority_status: data.priorityAccepted
                ? "pass"
                : data.priorityRejected
                ? "not-pass"
                : data.priority_status || null,
              secondary_status: data.secondaryAccepted
                ? "pass"
                : data.secondaryRejected
                ? "not-pass"
                : data.secondary_status || null,
              round2_priority_status:
                data.round2_priority_status ||
                (data.round2 && data.round2.priority_status) ||
                null,
              round2_secondary_status:
                data.round2_secondary_status ||
                (data.round2 && data.round2.secondary_status) ||
                null,
              round3_priority_status:
                data.round3_priority_status ||
                (data.round3 && data.round3.priority_status) ||
                null,
              round3_secondary_status:
                data.round3_secondary_status ||
                (data.round3 && data.round3.secondary_status) ||
                null,
              round4_priority_status:
                data.round4_priority_status ||
                (data.round4 && data.round4.priority_status) ||
                null,
              round4_secondary_status:
                data.round4_secondary_status ||
                (data.round4 && data.round4.secondary_status) ||
                null,
              current_round: data.current_round || "round1",
            });

            // === SỬA: Gửi email cho CẢ HAI loại ứng viên ===
            const isNew = isApplicationNew(
              data.timestamp || data.createdAt || data.submittedAt
            );
            const notNotified = !data.notification_sent;

            // Điều kiện gửi email mở rộng - kiểm tra cả ứng viên form và phỏng vấn
            if (isNew && notNotified && data.fullname && data.email) {
              console.log(
                "🆕 Phát hiện đơn mới, gửi email...",
                data.fullname,
                doc.id,
                "Loại:",
                data.application_type || "form"
              );

              sendEmailNotification({
                id: doc.id,
                ...data,
              }).then((success) => {
                if (success) {
                  console.log("✅ Đã xử lý gửi email cho:", data.fullname);
                } else {
                  console.log("❌ Gửi email thất bại cho:", data.fullname);
                }
              });
            }
          });

          if (!snapshot.query || !snapshot.query.explicitOrderBy) {
            allApps.sort((a, b) => {
              const ta =
                a.timestamp && a.timestamp.toMillis
                  ? a.timestamp.toMillis()
                  : a.timestamp || 0;
              const tb =
                b.timestamp && b.timestamp.toMillis
                  ? b.timestamp.toMillis()
                  : b.timestamp || 0;
              return tb - ta;
            });
          }

          if (userRole === "admin") {
            applications = allApps.filter(
              (app) =>
                app.priority_position === userDept ||
                app.secondary_position === userDept ||
                (Array.isArray(app.all_departments) &&
                  app.all_departments.includes(userDept))
            );
          } else {
            applications = allApps;
          }

          renderApplications();
          updateStats();
        } catch (error) {
          console.error("Error loading applications:", error);
          alert("Không thể tải danh sách ứng viên: " + error.message);
        }
      }

      // Thêm vào phần JavaScript, sau các hàm khác

      // Hàm tìm và hiển thị ứng viên apply nhiều lần
      function findAndDisplayDuplicateApplications() {
        console.log("🔍 Đang tìm ứng viên apply nhiều lần...");

        // Nhóm ứng viên theo email
        const applicantsByEmail = {};

        applications.forEach((app) => {
          const email = app.email?.toLowerCase().trim();
          if (!email) return;

          if (!applicantsByEmail[email]) {
            applicantsByEmail[email] = [];
          }
          applicantsByEmail[email].push(app);
        });

        // Lọc những email có từ 2 đơn trở lên
        const duplicates = {};
        let totalDuplicates = 0;

        Object.keys(applicantsByEmail).forEach((email) => {
          if (applicantsByEmail[email].length > 1) {
            duplicates[email] = applicantsByEmail[email];
            totalDuplicates += applicantsByEmail[email].length;
          }
        });

        // Hiển thị kết quả trong console
        console.log(
          `📊 Tổng số ứng viên apply nhiều lần: ${
            Object.keys(duplicates).length
          }`
        );
        console.log(`📝 Tổng số đơn trùng: ${totalDuplicates}`);

        // Hiển thị kết quả trong UI
        displayDuplicatesInUI(duplicates);

        return duplicates;
      }

      // Hiển thị danh sách đơn trùng trong UI
      function displayDuplicatesInUI(duplicates) {
        const container = document.getElementById("duplicates-container");
        const noDuplicatesMessage = document.getElementById(
          "no-duplicates-message"
        );
        const countElement = document.getElementById("duplicates-count");
        const tbody = document.getElementById("duplicates-table-body");

        tbody.innerHTML = "";

        if (Object.keys(duplicates).length === 0) {
          container.style.display = "none";
          noDuplicatesMessage.style.display = "block";
          countElement.textContent = "Không có đơn trùng";
          countElement.style.color = "var(--success)";
          return;
        }

        container.style.display = "block";
        noDuplicatesMessage.style.display = "none";
        countElement.textContent = `Tìm thấy ${
          Object.keys(duplicates).length
        } ứng viên apply nhiều lần (${
          Object.values(duplicates).flat().length
        } đơn)`;
        countElement.style.color = "var(--error)";

        Object.keys(duplicates).forEach((email) => {
          const apps = duplicates[email];
          const row = document.createElement("tr");
          row.className = "duplicate-row";

          // Tạo dropdown cho từng ứng viên
          let applicationsHTML = "";
          apps.forEach((app, index) => {
            const formattedTime = formatApplicationTime(app.timestamp);
            const applicationType =
              app.application_type === "interview" ? "Phỏng vấn" : "Form";
            const currentRound = getRoundText(app.current_round);

            applicationsHTML += `
                <div style="padding: 8px; margin: 4px 0; background: var(--gray-50); border-radius: 4px; border-left: 3px solid var(--info);">
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>${index + 1}. ${
              app.fullname || "Chưa có tên"
            }</strong>
                            <span class="duplicate-badge">${applicationType}</span>
                        </div>
                        <div style="font-size: 12px; color: var(--gray-500);">
                            ID: ${app.id}
                        </div>
                    </div>
                    <div style="font-size: 12px; margin-top: 4px;">
                        <div>SĐT: ${app.phone || "Chưa có"}</div>
                        <div>Vòng: ${currentRound}</div>
                        <div>Ban ưu tiên: ${getDepartmentName(
                          app.priority_position
                        )}</div>
                        <div>Ban dự bị: ${getDepartmentName(
                          app.secondary_position
                        )}</div>
                        <div>Thời gian: ${formattedTime}</div>
                        ${
                          app.round1 && app.round1.time
                            ? `<div>Thời gian PV: ${app.round1.time}</div>`
                            : ""
                        }
                        ${
                          app.round1 && app.round1.link
                            ? `<div>Link: <a href="${app.round1.link}" target="_blank">${app.round1.link}</a></div>`
                            : ""
                        }
                    </div>
                </div>
            `;
          });

          row.innerHTML = `
            <td style="font-weight: 600; color: var(--error);">${email}</td>
            <td>
                <span class="duplicate-badge" style="background: var(--error);">${
                  apps.length
                } đơn</span>
            </td>
            <td>${applicationsHTML}</td>
            <td>
                ${
                  userRole === "superadmin"
                    ? `
                    <button class="action-btn delete-btn" onclick="showDeleteOptions('${email}')" 
                            style="margin-bottom: 8px; width: 100%;">
                        <i class="fas fa-trash"></i>
                        Xóa đơn
                    </button>
                    <button class="action-btn" onclick="mergeApplications('${email}')" 
                            style="margin-bottom: 8px; width: 100%; background: var(--info-light); color: var(--info);">
                        <i class="fas fa-compress"></i>
                        Gộp đơn
                    </button>
                    <button class="action-btn archive-btn" onclick="selectDuplicateForArchive('${email}')" 
                            style="margin-bottom: 8px; width: 100%;">
                        <i class="fas fa-archive"></i>
                        Lưu trữ
                    </button>
                `
                    : `
                    <span style="color: var(--gray-500); font-size: 12px;">
                        Chỉ Super Admin
                    </span>
                `
                }
            </td>
        `;

          tbody.appendChild(row);
        });
      }

      // Định dạng thời gian ứng dụng
      function formatApplicationTime(timestamp) {
        if (!timestamp) return "Chưa có thời gian";

        try {
          let appTime;
          if (timestamp.toDate) {
            appTime = timestamp.toDate();
          } else if (timestamp instanceof Date) {
            appTime = timestamp;
          } else if (typeof timestamp === "string") {
            appTime = new Date(timestamp);
          } else if (typeof timestamp === "number") {
            appTime = new Date(timestamp);
          } else {
            return "Lỗi định dạng";
          }

          if (appTime) {
            return (
              appTime.toLocaleString("vi-VN", {
                timeZone: "Asia/Ho_Chi_Minh",
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                hour12: false,
              }) + " GMT+7"
            );
          }
        } catch (e) {
          return "Lỗi định dạng thời gian";
        }

        return "Chưa có thời gian";
      }

      // Hiển thị options xóa đơn trùng
      function showDeleteOptions(email) {
        const duplicates = findAndDisplayDuplicateApplications();
        const apps = duplicates[email];

        if (!apps || apps.length === 0) return;

        let optionsHTML = `
        <h4 style="margin-bottom: 16px;">Xử lý đơn trùng - ${email}</h4>
        <p style="color: var(--gray-600); margin-bottom: 16px;">Chọn đơn để xóa (giữ lại đơn có thông tin đầy đủ nhất):</p>
    `;

        apps.forEach((app, index) => {
          const formattedTime = formatApplicationTime(app.timestamp);
          const applicationType =
            app.application_type === "interview" ? "Phỏng vấn" : "Form";
          const hasPhone = app.phone && app.phone.trim() !== "";
          const hasFullname = app.fullname && app.fullname.trim() !== "";

          optionsHTML += `
            <div style="padding: 12px; margin: 8px 0; border: 1px solid var(--gray-300); border-radius: 8px; background: ${
              hasPhone && hasFullname
                ? "var(--success-light)"
                : "var(--gray-50)"
            };">
                <label style="display: block; cursor: pointer;">
                    <input type="radio" name="deleteApp" value="${
                      app.id
                    }" style="margin-right: 8px;">
                    <strong>Đơn ${index + 1}:</strong> ${
            app.fullname || "Chưa có tên"
          } 
                    <span class="duplicate-badge" style="background: ${
                      applicationType === "Phỏng vấn"
                        ? "var(--info)"
                        : "var(--warning)"
                    };">${applicationType}</span>
                    ${
                      hasPhone && hasFullname
                        ? '<span class="duplicate-badge" style="background: var(--success);">Đầy đủ</span>'
                        : ""
                    }
                </label>
                <div style="font-size: 12px; color: var(--gray-600); margin-left: 24px;">
                    <div>SĐT: ${app.phone || "Chưa có"}</div>
                    <div>Thời gian: ${formattedTime}</div>
                    <div>ID: ${app.id}</div>
                </div>
            </div>
        `;
        });

        optionsHTML += `
        <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: flex-end;">
            <button class="action-btn" onclick="closeDeleteModal()">Hủy</button>
            <button class="action-btn delete-btn" onclick="deleteSelectedApplication('${email}')">Xóa đơn đã chọn</button>
        </div>
    `;

        // Tạo modal tạm thời
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.display = "flex";
        modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-trash" style="color: var(--error);"></i>
                    Xử lý đơn trùng
                </h2>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                ${optionsHTML}
            </div>
        </div>
    `;

        modal.id = "delete-duplicates-modal";
        document.body.appendChild(modal);
      }

      // Đóng modal xóa
      function closeDeleteModal() {
        const modal = document.getElementById("delete-duplicates-modal");
        if (modal) {
          modal.remove();
        }
      }

      // Xóa đơn đã chọn
      async function deleteSelectedApplication(email) {
        const selectedRadio = document.querySelector(
          'input[name="deleteApp"]:checked'
        );

        if (!selectedRadio) {
          alert("Vui lòng chọn một đơn để xóa");
          return;
        }

        const appIdToDelete = selectedRadio.value;
        const appToDelete = applications.find(
          (app) => app.id === appIdToDelete
        );

        if (!appToDelete) {
          alert("Không tìm thấy đơn ứng tuyển");
          return;
        }

        if (
          !confirm(
            `Bạn có chắc muốn xóa đơn của "${
              appToDelete.fullname || "ứng viên"
            }"?\n\nEmail: ${appToDelete.email}\nID: ${
              appToDelete.id
            }\n\nHành động này không thể hoàn tác!`
          )
        ) {
          return;
        }

        try {
          await db.collection("applications").doc(appIdToDelete).delete();
          alert("✅ Đã xóa đơn ứng tuyển thành công");

          // Cập nhật lại danh sách
          closeDeleteModal();
          await refreshApplications();
          findAndDisplayDuplicateApplications();
        } catch (error) {
          console.error("Lỗi khi xóa đơn:", error);
          alert("❌ Lỗi khi xóa đơn: " + error.message);
        }
      }

      // Gộp đơn (chức năng nâng cao)
      async function mergeApplications(email) {
        const duplicates = findAndDisplayDuplicateApplications();
        const apps = duplicates[email];

        if (!apps || apps.length < 2) return;

        // Tìm đơn có thông tin đầy đủ nhất
        let bestApp = apps[0];
        let maxScore = 0;

        apps.forEach((app) => {
          let score = 0;
          if (app.fullname && app.fullname.trim()) score += 3;
          if (app.phone && app.phone.trim()) score += 2;
          if (app.answers && Object.keys(app.answers).length > 0)
            score += Object.keys(app.answers).length;
          if (app.application_type === "interview") score += 1;

          if (score > maxScore) {
            maxScore = score;
            bestApp = app;
          }
        });

        const otherApps = apps.filter((app) => app.id !== bestApp.id);

        let confirmMessage = `Gộp ${otherApps.length} đơn vào đơn chính?\n\n`;
        confirmMessage += `Đơn chính: ${bestApp.fullname} (${bestApp.email})\n`;
        confirmMessage += `Số đơn sẽ xóa: ${otherApps.length}\n\n`;
        confirmMessage += `Đơn chính sẽ được giữ lại, các đơn khác sẽ bị xóa.`;

        if (!confirm(confirmMessage)) {
          return;
        }

        try {
          // Xóa các đơn trùng
          const batch = db.batch();
          otherApps.forEach((app) => {
            const appRef = db.collection("applications").doc(app.id);
            batch.delete(appRef);
          });

          await batch.commit();
          alert(`✅ Đã gộp thành công! Đã xóa ${otherApps.length} đơn trùng`);

          // Cập nhật lại danh sách
          await refreshApplications();
          findAndDisplayDuplicateApplications();
        } catch (error) {
          console.error("Lỗi khi gộp đơn:", error);
          alert("❌ Lỗi khi gộp đơn: " + error.message);
        }
      }

      // Thêm event listener cho nút quét đơn trùng
      document.addEventListener("DOMContentLoaded", function () {
        const scanBtn = document.getElementById("scan-duplicates-btn");
        if (scanBtn) {
          scanBtn.addEventListener(
            "click",
            findAndDisplayDuplicateApplications
          );
        }
      });

      // Thêm event listener cho nút reset team
      document
        .getElementById("reset-teams-btn")
        .addEventListener("click", async () => {
          if (
            !confirm(
              "Bạn có chắc muốn reset toàn bộ team? Tất cả thông tin team hiện tại sẽ bị xóa."
            )
          ) {
            return;
          }

          try {
            // Tìm tất cả ứng viên đang có team trong vòng 3
            const round3Apps = applications.filter(
              (app) =>
                app.current_round === "round3" && app.round3 && app.round3.team
            );

            if (round3Apps.length === 0) {
              alert("Không có team nào để reset!");
              return;
            }

            const batch = db.batch();

            // Xóa thông tin team của tất cả ứng viên
            round3Apps.forEach((app) => {
              const appRef = db.collection("applications").doc(app.id);
              batch.update(appRef, {
                "round3.team": firebase.firestore.FieldValue.delete(),
                "round3.teamId": firebase.firestore.FieldValue.delete(),
                "round3.teamOrder": firebase.firestore.FieldValue.delete(),
                "round3.advisor1": firebase.firestore.FieldValue.delete(),
                "round3.advisor2": firebase.firestore.FieldValue.delete(),
              });
            });

            await batch.commit();

            alert(
              `✅ Đã reset ${round3Apps.length} ứng viên về trạng thái chưa có team!`
            );

            // Đóng modal và refresh dữ liệu
            document.getElementById("team-modal").style.display = "none";
            await refreshApplications();
          } catch (error) {
            console.error("Lỗi khi reset team:", error);
            alert("❌ Lỗi khi reset team: " + error.message);
          }
        });

      // Biến toàn cục
      let selectedArchiveMethod = null;
      let selectedAppsForArchive = new Set();
      let currentDuplicateEmail = null;

      // Mở modal lưu trữ
      function openArchiveModal() {
        document.getElementById("archive-modal").style.display = "flex";
        resetArchiveModal();

        // KHỞI TẠO TABS KHI MỞ MODAL
        setupArchiveModalTabs();
      }

      // Đóng modal lưu trữ
      function closeArchiveModal() {
        document.getElementById("archive-modal").style.display = "none";
        resetArchiveModal();
      }

      // Reset modal
      function resetArchiveModal() {
        selectedArchiveMethod = null;
        selectedAppsForArchive.clear();
        currentDuplicateEmail = null;

        document.getElementById("archive-options").style.display = "block";
        document.getElementById("single-archive-section").style.display =
          "none";
        document.getElementById("duplicate-archive-section").style.display =
          "none";
        document.getElementById("confirm-archive-btn").style.display = "none";
      }

      // Chọn phương thức lưu trữ
      function selectArchiveMethod(method) {
        selectedArchiveMethod = method;
        document.getElementById("archive-options").style.display = "none";

        if (method === "single") {
          document.getElementById("single-archive-section").style.display =
            "block";
          setupSingleArchive();
        } else if (method === "duplicate") {
          document.getElementById("duplicate-archive-section").style.display =
            "block";
          setupDuplicateArchive();
        }

        document.getElementById("confirm-archive-btn").style.display =
          "inline-flex";
      }

      // Thiết lập lưu trữ từng ứng viên
      function setupSingleArchive() {
        const searchInput = document.getElementById("archive-search");
        searchInput.addEventListener(
          "input",
          debounce(searchArchiveCandidates, 300)
        );
      }

      // Tìm kiếm ứng viên để lưu trữ
      function searchArchiveCandidates() {
        const searchTerm = document
          .getElementById("archive-search")
          .value.toLowerCase();
        const resultsBody = document.getElementById(
          "archive-search-results-body"
        );
        const resultsContainer = document.getElementById(
          "archive-search-results"
        );

        if (searchTerm.length < 2) {
          resultsContainer.style.display = "none";
          return;
        }

        const filteredApps = applications.filter(
          (app) =>
            (app.fullname && app.fullname.toLowerCase().includes(searchTerm)) ||
            (app.email && app.email.toLowerCase().includes(searchTerm))
        );

        resultsBody.innerHTML = "";

        if (filteredApps.length === 0) {
          resultsBody.innerHTML =
            '<tr><td colspan="5" style="text-align: center; color: var(--gray-500);">Không tìm thấy ứng viên</td></tr>';
        } else {
          filteredApps.forEach((app) => {
            const isSelected = selectedAppsForArchive.has(app.id);
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>
                    <input type="checkbox" ${isSelected ? "checked" : ""} 
                           onchange="toggleAppSelection('${
                             app.id
                           }', this.checked)">
                </td>
                <td>${app.fullname || "Chưa có tên"}</td>
                <td>${app.email}</td>
                <td>${getRoundText(app.current_round)}</td>
                <td>
                    <span class="status-badge ${getStatusClass(
                      computeOverallStatus(app)
                    )}">
                        ${getStatusText(computeOverallStatus(app))}
                    </span>
                </td>
            `;
            resultsBody.appendChild(row);
          });
        }

        resultsContainer.style.display = "block";
        updateSelectedAppsList();
      }

      // Chọn/bỏ chọn ứng viên
      function toggleAppSelection(appId, isSelected) {
        if (isSelected) {
          selectedAppsForArchive.add(appId);
        } else {
          selectedAppsForArchive.delete(appId);
        }
        updateSelectedAppsList();
      }

      // Cập nhật danh sách ứng viên đã chọn
      function updateSelectedAppsList() {
        const selectedList = document.getElementById("selected-apps-list");
        const selectedSection = document.getElementById(
          "selected-archive-apps"
        );

        if (selectedAppsForArchive.size === 0) {
          selectedSection.style.display = "none";
          return;
        }

        let html = "";
        selectedAppsForArchive.forEach((appId) => {
          const app = applications.find((a) => a.id === appId);
          if (app) {
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; 
                           padding: 8px; margin: 4px 0; background: var(--gray-50); border-radius: 4px;">
                    <div>
                        <strong>${app.fullname || "Chưa có tên"}</strong>
                        <div style="font-size: 12px; color: var(--gray-500);">${
                          app.email
                        }</div>
                    </div>
                    <button class="action-btn delete-btn" onclick="toggleAppSelection('${
                      app.id
                    }', false)" 
                            style="padding: 4px 8px; font-size: 12px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
          }
        });

        selectedList.innerHTML = html;
        selectedSection.style.display = "block";
      }

      // Thiết lập lưu trữ đơn trùng
      function setupDuplicateArchive() {
        const duplicates = findAndDisplayDuplicateApplications();
        const container = document.getElementById("duplicate-archive-list");

        if (Object.keys(duplicates).length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--gray-500);">
                <i class="fas fa-check-circle" style="font-size: 24px; margin-bottom: 8px;"></i>
                <div>Không có ứng viên apply nhiều lần</div>
            </div>
        `;
          return;
        }

        let html =
          '<p style="color: var(--gray-600); margin-bottom: 16px;">Chọn ứng viên apply nhiều lần để lưu trữ:</p>';

        Object.keys(duplicates).forEach((email) => {
          const apps = duplicates[email];
          html += `
            <div style="padding: 16px; margin: 12px 0; border: 1px solid var(--gray-200); border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div>
                        <strong style="color: var(--error);">${email}</strong>
                        <span class="archive-badge">${apps.length} đơn</span>
                    </div>
                    <button class="action-btn archive-btn" onclick="selectDuplicateForArchive('${email}')">
                        <i class="fas fa-archive"></i>
                        Lưu trữ
                    </button>
                </div>
                
                <div style="font-size: 12px;">
                    ${apps
                      .map(
                        (app, index) => `
                        <div style="padding: 8px; margin: 4px 0; background: var(--gray-50); border-radius: 4px;">
                            <strong>Đơn ${index + 1}:</strong> ${
                          app.fullname || "Chưa có tên"
                        }
                            <span class="duplicate-badge" style="background: ${
                              app.application_type === "interview"
                                ? "var(--info)"
                                : "var(--warning)"
                            };">
                                ${
                                  app.application_type === "interview"
                                    ? "Phỏng vấn"
                                    : "Form"
                                }
                            </span>
                            <div style="margin-top: 4px;">
                                SĐT: ${app.phone || "Chưa có"} | 
                                Vòng: ${getRoundText(app.current_round)} |
                                Thời gian: ${formatApplicationTime(
                                  app.timestamp
                                )}
                            </div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            </div>
        `;
        });

        container.innerHTML = html;
      }

      // Chọn đơn trùng để lưu trữ
      function selectDuplicateForArchive(email) {
        currentDuplicateEmail = email;
        const duplicates = findAndDisplayDuplicateApplications();
        const apps = duplicates[email];

        if (!apps || apps.length === 0) return;

        let optionsHTML = `
        <h4 style="margin-bottom: 16px;">Lưu trữ đơn trùng - ${email}</h4>
        <p style="color: var(--gray-600); margin-bottom: 16px;">Chọn đơn để lưu trữ (giữ lại đơn có thông tin đầy đủ nhất):</p>
    `;

        apps.forEach((app, index) => {
          const formattedTime = formatApplicationTime(app.timestamp);
          const applicationType =
            app.application_type === "interview" ? "Phỏng vấn" : "Form";
          const hasPhone = app.phone && app.phone.trim() !== "";
          const hasFullname = app.fullname && app.fullname.trim() !== "";

          optionsHTML += `
            <div style="padding: 12px; margin: 8px 0; border: 1px solid var(--gray-300); border-radius: 8px; 
                       background: ${
                         hasPhone && hasFullname
                           ? "var(--success-light)"
                           : "var(--gray-50)"
                       };">
                <label style="display: block; cursor: pointer;">
                    <input type="radio" name="archiveApp" value="${
                      app.id
                    }" style="margin-right: 8px;">
                    <strong>Đơn ${index + 1}:</strong> ${
            app.fullname || "Chưa có tên"
          } 
                    <span class="duplicate-badge" style="background: ${
                      applicationType === "Phỏng vấn"
                        ? "var(--info)"
                        : "var(--warning)"
                    };">
                        ${applicationType}
                    </span>
                    ${
                      hasPhone && hasFullname
                        ? '<span class="duplicate-badge" style="background: var(--success);">Đầy đủ</span>'
                        : ""
                    }
                </label>
                <div style="font-size: 12px; color: var(--gray-600); margin-left: 24px;">
                    <div>SĐT: ${app.phone || "Chưa có"}</div>
                    <div>Thời gian: ${formattedTime}</div>
                    <div>ID: ${app.id}</div>
                </div>
            </div>
        `;
        });

        optionsHTML += `
        <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: flex-end;">
            <button class="action-btn" onclick="closeArchiveSelection()">Hủy</button>
            <button class="action-btn archive-btn" onclick="archiveSelectedDuplicate()">Lưu trữ đơn đã chọn</button>
        </div>
    `;

        // Tạo modal lựa chọn
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.display = "flex";
        modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-archive" style="color: var(--warning);"></i>
                    Lưu trữ đơn trùng
                </h2>
                <button class="modal-close" onclick="closeArchiveSelection()">&times;</button>
            </div>
            <div class="modal-body">
                ${optionsHTML}
            </div>
        </div>
    `;
        modal.id = "archive-selection-modal";
        document.body.appendChild(modal);
      }

      // Đóng modal lựa chọn lưu trữ
      function closeArchiveSelection() {
        const modal = document.getElementById("archive-selection-modal");
        if (modal) {
          modal.remove();
        }
      }

      // Lưu trữ đơn trùng đã chọn
      async function archiveSelectedDuplicate() {
        const selectedRadio = document.querySelector(
          'input[name="archiveApp"]:checked'
        );

        if (!selectedRadio) {
          alert("Vui lòng chọn một đơn để lưu trữ");
          return;
        }

        const appIdToArchive = selectedRadio.value;
        await archiveApplication(appIdToArchive);
      }

      // Xác nhận lưu trữ
      async function confirmArchive() {
        if (selectedArchiveMethod === "single") {
          if (selectedAppsForArchive.size === 0) {
            alert("Vui lòng chọn ít nhất một ứng viên để lưu trữ");
            return;
          }

          const appIds = Array.from(selectedAppsForArchive);
          await archiveMultipleApplications(appIds);
        } else if (selectedArchiveMethod === "duplicate") {
          // Đã xử lý trong selectDuplicateForArchive
          return;
        }
      }

      // Lưu trữ nhiều ứng viên
      async function archiveMultipleApplications(appIds) {
        if (!confirm(`Bạn có chắc muốn lưu trữ ${appIds.length} ứng viên?`)) {
          return;
        }

        try {
          let successCount = 0;

          for (const appId of appIds) {
            const success = await archiveApplication(appId);
            if (success) successCount++;
          }

          alert(
            `✅ Đã lưu trữ thành công ${successCount}/${appIds.length} ứng viên`
          );
          closeArchiveModal();
          await refreshApplications();
        } catch (error) {
          console.error("Lỗi khi lưu trữ nhiều ứng viên:", error);
          alert("❌ Lỗi khi lưu trữ: " + error.message);
        }
      }

      // Lưu trữ một ứng viên
      async function archiveApplication(appId) {
        try {
          const app = applications.find((a) => a.id === appId);
          if (!app) {
            alert("Không tìm thấy ứng viên");
            return false;
          }

          // Di chuyển dữ liệu sang collection archived_applications
          const archiveData = {
            ...app,
            archived_at: new Date(),
            archived_by: userEmail,
            original_id: appId, // Giữ lại ID gốc để có thể restore
          };

          // Lưu vào collection archived
          await db
            .collection("archived_applications")
            .doc(appId)
            .set(archiveData);

          // Xóa khỏi collection applications
          await db.collection("applications").doc(appId).delete();

          console.log("✅ Đã lưu trữ ứng viên:", app.fullname);
          return true;
        } catch (error) {
          console.error("Lỗi khi lưu trữ ứng viên:", error);
          alert("❌ Lỗi khi lưu trữ: " + error.message);
          return false;
        }
      }

      // Biến toàn cục mới
      let archivedApplications = [];

      // Xử lý chuyển tab
      // Xử lý chuyển tab trong modal archive
      function setupArchiveModalTabs() {
        const tabs = document.querySelectorAll("#archive-modal .tab");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            // Xóa active tất cả tabs
            tabs.forEach((t) => t.classList.remove("active"));
            document.querySelectorAll(".tab-content").forEach((content) => {
              content.style.display = "none";
            });

            // Active tab được click
            tab.classList.add("active");
            const tabName = tab.getAttribute("data-tab");
            const tabContent = document.getElementById(`${tabName}-tab`);
            if (tabContent) {
              tabContent.style.display = "block";
            }

            // Nếu là tab restore, load dữ liệu
            if (tabName === "restore") {
              console.log("🔄 Đang tải tab khôi phục...");
              loadArchivedApplications();
            }
          });
        });
      }

      // Hàm tải danh sách ứng viên đã lưu trữ
      async function loadArchivedApplications() {
        const loadingElement = document.getElementById("restore-loading");
        const resultsElement = document.getElementById("restore-results");
        const noResultsElement = document.getElementById("no-restore-results");

        loadingElement.style.display = "block";
        resultsElement.style.display = "none";
        noResultsElement.style.display = "none";

        try {
          console.log("📥 Đang tải danh sách archive từ Firestore...");

          // Lấy toàn bộ dữ liệu từ collection archived_applications
          const snapshot = await db
            .collection("archived_applications")
            .orderBy("archived_at", "desc")
            .get();

          archivedApplications = [];
          snapshot.forEach((doc) => {
            const data = doc.data();

            // Đảm bảo lấy đầy đủ thông tin cần thiết
            const archivedApp = {
              id: doc.id,
              original_id: data.original_id || doc.id,
              fullname: data.fullname || "Chưa có tên",
              email: data.email || "Chưa có email",
              phone: data.phone || "Chưa có SĐT",
              priority_position: data.priority_position,
              secondary_position: data.secondary_position,
              archived_at: data.archived_at,
              archived_by: data.archived_by || "Không rõ",
              application_type: data.application_type || "form",
              timestamp: data.timestamp,
              current_round: data.current_round || "round1",
              status: data.status || "new",
            };

            archivedApplications.push(archivedApp);
          });

          console.log(
            `📊 Tổng số ứng viên trong archive: ${archivedApplications.length}`
          );

          // Hiển thị tất cả ứng viên đã lưu trữ
          displayArchivedApplications(archivedApplications);
        } catch (error) {
          console.error("❌ Lỗi khi tải danh sách lưu trữ:", error);

          // Hiển thị thông báo lỗi
          const tbody = document.getElementById("restore-results-body");
          tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; color: var(--error); padding: 20px;">
                    <i class="fas fa-exclamation-triangle"></i><br>
                    Lỗi khi tải dữ liệu: ${error.message}
                </td>
            </tr>
        `;
          resultsElement.style.display = "block";
          noResultsElement.style.display = "none";
        } finally {
          loadingElement.style.display = "none";
        }
      }

      // Hiển thị danh sách ứng viên đã lưu trữ (SỬA LẠI)
      function displayArchivedApplications(apps) {
        const tbody = document.getElementById("restore-results-body");
        const noResults = document.getElementById("no-restore-results");
        const resultsContainer = document.getElementById("restore-results");

        tbody.innerHTML = "";

        if (apps.length === 0) {
          resultsContainer.style.display = "none";
          noResults.style.display = "block";
          return;
        }

        resultsContainer.style.display = "block";
        noResults.style.display = "none";

        apps.forEach((app) => {
          const tr = document.createElement("tr");

          // Format thời gian lưu trữ
          let archiveTime = "Không rõ";
          try {
            if (app.archived_at) {
              if (app.archived_at.toDate) {
                archiveTime = app.archived_at.toDate().toLocaleString("vi-VN");
              } else if (app.archived_at instanceof Date) {
                archiveTime = app.archived_at.toLocaleString("vi-VN");
              } else if (typeof app.archived_at === "string") {
                archiveTime = new Date(app.archived_at).toLocaleString("vi-VN");
              } else if (typeof app.archived_at === "number") {
                archiveTime = new Date(app.archived_at).toLocaleString("vi-VN");
              }
            }
          } catch (e) {
            console.warn("Lỗi format thời gian archive:", e);
            archiveTime = "Lỗi định dạng";
          }

          const archivedBy = app.archived_by || "Không rõ";
          const fullname = app.fullname || "Chưa có tên";
          const email = app.email || "Chưa có email";
          const priorityDept = app.priority_position
            ? getDepartmentName(app.priority_position)
            : "Chưa có";
          const secondaryDept =
            app.secondary_position && app.secondary_position !== "None"
              ? getDepartmentName(app.secondary_position)
              : null;

          // Hiển thị loại đơn
          const appType =
            app.application_type === "interview"
              ? '<span class="duplicate-badge" style="background: var(--info); margin-left: 4px; font-size: 10px;">Phỏng vấn</span>'
              : '<span class="duplicate-badge" style="background: var(--warning); margin-left: 4px; font-size: 10px;">Form</span>';

          tr.innerHTML = `
            <td>
                <div style="font-weight: 500;">${fullname}</div>
                <div style="font-size: 11px; color: var(--gray-500);">
                    ${appType}
                    <div>ID: ${app.id.substring(0, 8)}...</div>
                </div>
            </td>
            <td>${email}</td>
            <td>
                <span class="department-badge department-priority">
                    ${priorityDept}
                </span>
                ${
                  secondaryDept
                    ? `<span class="department-badge department-secondary" style="margin-left: 4px;">
                        ${secondaryDept}
                    </span>`
                    : ""
                }
            </td>
            <td style="font-size: 11px; color: var(--gray-500);">
                <div>${archiveTime}</div>
                <div>Bởi: ${archivedBy}</div>
            </td>
            <td style="min-width: 120px;">
                <button class="action-btn restore-btn" onclick="handleRestoreApplication('${
                  app.id
                }')" 
                        style="margin-bottom: 4px; width: 100%; font-size: 11px; padding: 6px 8px;">
                    <i class="fas fa-undo"></i>
                    Khôi phục
                </button>
                ${
                  userRole === "superadmin"
                    ? `
                <button class="action-btn delete-btn" onclick="permanentlyDelete('${app.id}')" 
                        style="width: 100%; font-size: 10px; padding: 4px 6px;">
                    <i class="fas fa-trash"></i>
                    Xóa vĩnh viễn
                </button>
                `
                    : ""
                }
            </td>
        `;
          tbody.appendChild(tr);
        });
      }

      // Hàm xử lý khôi phục ứng viên
      async function handleRestoreApplication(archivedAppId) {
        console.log("🔄 Bắt đầu khôi phục:", archivedAppId);

        try {
          const success = await restoreApplication(archivedAppId);
          if (success) {
            console.log("✅ Khôi phục thành công");
            // Tự động refresh danh sách
            setTimeout(() => {
              loadArchivedApplications();
            }, 1000);
          }
        } catch (error) {
          console.error("❌ Lỗi trong handleRestoreApplication:", error);
        }
      }

      // Tìm kiếm ứng viên đã lưu trữ
      function searchArchivedApplications() {
        const searchTerm = document
          .getElementById("restore-search")
          .value.toLowerCase()
          .trim();

        if (!searchTerm) {
          // Nếu không có search term, hiển thị tất cả
          displayArchivedApplications(archivedApplications);
          return;
        }

        const filteredApps = archivedApplications.filter((app) => {
          const searchFields = [
            app.fullname,
            app.email,
            app.phone,
            app.priority_position
              ? getDepartmentName(app.priority_position)
              : "",
            app.secondary_position
              ? getDepartmentName(app.secondary_position)
              : "",
            app.application_type,
          ].filter(Boolean); // Loại bỏ các giá trị null/undefined

          return searchFields.some((field) =>
            field.toString().toLowerCase().includes(searchTerm)
          );
        });

        displayArchivedApplications(filteredApps);
      }

      // Hàm khôi phục ứng viên từ archive (SỬA LẠI)
      async function restoreApplication(archivedAppId) {
        if (
          !confirm(
            "Bạn có chắc muốn khôi phục ứng viên này về danh sách chính?\n\nỨng viên sẽ được chuyển từ archive về danh sách ứng viên thường."
          )
        ) {
          return false;
        }

        try {
          console.log("🔄 Đang khôi phục ứng viên:", archivedAppId);

          // Lấy dữ liệu từ archived_applications
          const archivedDoc = await db
            .collection("archived_applications")
            .doc(archivedAppId)
            .get();
          if (!archivedDoc.exists) {
            alert("❌ Không tìm thấy ứng viên trong archive");
            return false;
          }

          const archivedData = archivedDoc.data();
          console.log("📋 Dữ liệu archive:", archivedData);

          // Chuẩn bị dữ liệu để khôi phục - LOẠI BỎ CÁC TRƯỜNG METADATA CỦA ARCHIVE
          const restoreData = { ...archivedData };

          // XÓA các trường metadata của archive
          delete restoreData.archived_at;
          delete restoreData.archived_by;
          delete restoreData.original_id;

          // Đảm bảo có các trường bắt buộc
          if (!restoreData.current_round) {
            restoreData.current_round = "round1";
          }
          if (!restoreData.status) {
            restoreData.status = "new";
          }

          console.log("📤 Dữ liệu khôi phục:", restoreData);

          // Sử dụng original_id nếu có, nếu không thì dùng archivedAppId
          const targetAppId = archivedData.original_id || archivedAppId;

          // 🔄 KHÔI PHỤC VỀ COLLECTION APPLICATIONS
          await db.collection("applications").doc(targetAppId).set(restoreData);

          // XÓA KHỎI ARCHIVE
          await db
            .collection("archived_applications")
            .doc(archivedAppId)
            .delete();

          alert("✅ Đã khôi phục ứng viên thành công!");

          // Refresh lại danh sách archive và applications
          await loadArchivedApplications();
          await refreshApplications(); // Cập nhật danh sách chính

          return true;
        } catch (error) {
          console.error("❌ Lỗi khi khôi phục ứng viên:", error);
          alert("❌ Lỗi khi khôi phục: " + error.message);
          return false;
        }
      }

      async function debugArchiveCollection() {
        try {
          console.log("🔍 Đang kiểm tra collection archived_applications...");
          const snapshot = await db.collection("archived_applications").get();
          console.log(
            `📊 Tổng số documents trong archived_applications: ${snapshot.size}`
          );

          snapshot.forEach((doc) => {
            console.log(`📄 Document ${doc.id}:`, doc.data());
          });

          if (snapshot.size === 0) {
            console.log("ℹ️ Collection archived_applications đang trống");
          }
        } catch (error) {
          console.error("❌ Lỗi khi debug archive collection:", error);
        }
      }

      // Xóa vĩnh viễn ứng viên (SỬA LẠI)
      async function permanentlyDelete(archivedAppId) {
        if (
          !confirm(
            "⚠️ Bạn có CHẮC CHẮN muốn xóa VĨNH VIỄN ứng viên này?\n\nHành động này không thể hoàn tác!"
          )
        ) {
          return;
        }

        try {
          console.log("🗑️ Đang xóa vĩnh viễn:", archivedAppId);
          await db
            .collection("archived_applications")
            .doc(archivedAppId)
            .delete();
          alert("✅ Đã xóa vĩnh viễn ứng viên");

          // Refresh lại danh sách
          await loadArchivedApplications();
        } catch (error) {
          console.error("❌ Lỗi khi xóa vĩnh viễn:", error);
          alert("❌ Lỗi khi xóa: " + error.message);
        }
      }

      // Sửa hàm resetArchiveModal để reset cả tabs
      function resetArchiveModal() {
        selectedArchiveMethod = null;
        selectedAppsForArchive.clear();
        currentDuplicateEmail = null;

        // Reset về tab archive
        document
          .querySelectorAll("#archive-modal .tab")
          .forEach((tab, index) => {
            if (index === 0) {
              tab.classList.add("active");
            } else {
              tab.classList.remove("active");
            }
          });

        document.querySelectorAll(".tab-content").forEach((content, index) => {
          if (index === 0) {
            content.style.display = "block";
          } else {
            content.style.display = "none";
          }
        });

        document.getElementById("archive-options").style.display = "block";
        document.getElementById("single-archive-section").style.display =
          "none";
        document.getElementById("duplicate-archive-section").style.display =
          "none";
        document.getElementById("confirm-archive-btn").style.display = "none";

        // Clear search và reset danh sách
        document.getElementById("restore-search").value = "";

        // Reset danh sách archive về trạng thái ban đầu
        if (archivedApplications && archivedApplications.length > 0) {
          displayArchivedApplications(archivedApplications);
        }
      }

      // Thêm event listener cho search input
      document.addEventListener("DOMContentLoaded", function () {
        const restoreSearch = document.getElementById("restore-search");
        if (restoreSearch) {
          restoreSearch.addEventListener(
            "input",
            debounce(searchArchivedApplications, 300)
          );
        }
      });

      // GỌI HÀM DEBUG KHI CẦN (có thể gọi trong console browser)
      window.debugArchive = debugArchiveCollection;

      // Hàm kiểm tra nhanh trạng thái archive
      window.checkArchiveStatus = async function () {
        const count = await debugArchiveCollection();
        if (count === 0) {
          alert(
            "📭 Collection archived_applications đang trống.\n\nHãy thử lưu trữ một vài ứng viên trước khi sử dụng tính năng khôi phục."
          );
        } else {
          alert(`📊 Tìm thấy ${count} ứng viên trong archive.`);
        }
      };

      // Hàm debounce cho search
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Thêm event listener cho nút đóng modal archive
      document
        .getElementById("archive-modal-close")
        .addEventListener("click", closeArchiveModal);

      // Thêm hàm này sau hàm loadApplications()
      async function refreshApplications() {
        await loadApplications();

        // Cập nhật UI theo tab hiện tại
        const activeTab = document
          .querySelector(".nav-item.active")
          .getAttribute("data-tab");
        switch (activeTab) {
          case "dashboard":
            renderApplications();
            break;
          case "round1":
            renderRound1();
            break;
          case "round2":
            renderRound2();
            break;
          case "round3":
            renderRound3();
            break;
          case "round4":
            renderRound4();
            break;
          case "success":
            renderSuccess();
            break;
        }
      }

      // Biến lưu trữ team phân chia tạm thời
      let temporaryTeams = [];

      // Mở modal chia team
      document
        .getElementById("team-division-btn")
        .addEventListener("click", () => {
          document.getElementById("team-modal").style.display = "flex";
          loadRound3Candidates();
        });

      // Đóng modal
      document
        .getElementById("team-modal-close")
        .addEventListener("click", () => {
          document.getElementById("team-modal").style.display = "none";
        });

      // Chuyển đổi phương thức chia
      document
        .getElementById("division-method")
        .addEventListener("change", (e) => {
          const method = e.target.value;
          document.getElementById("team-count-group").style.display =
            method === "byTeamCount" ? "block" : "none";
          document.getElementById("team-size-group").style.display =
            method === "byTeamSize" ? "block" : "none";
        });

      // Xử lý upload template team
      async function handleTeamTemplateUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
          const data = await readExcelFile(file);
          const validationResult = validateTeamTemplate(data);

          if (!validationResult.isValid) {
            alert(
              `Lỗi validate template: ${validationResult.errors.join(", ")}`
            );
            return;
          }

          const teams = processTeamTemplate(
            data,
            validationResult.candidateMap
          );
          temporaryTeams = teams;
          renderTeamPreview(teams);
          document.getElementById("team-preview").style.display = "block";
        } catch (error) {
          console.error("Lỗi xử lý file template:", error);
          alert("Lỗi khi xử lý file template: " + error.message);
        }
      }

      // Đọc file Excel
      function readExcelFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = function (e) {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: "array" });
              const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
              const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                header: 1,
              });
              resolve(jsonData);
            } catch (error) {
              reject(error);
            }
          };

          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
        });
      }

      // Validate template team
      function validateTeamTemplate(data) {
        const errors = [];
        const candidateMap = new Map();
        const teamStructure = {};

        // Kiểm tra định dạng cơ bản
        if (data.length < 3) {
          errors.push("File không đúng định dạng template");
          return { isValid: false, errors };
        }

        // Lấy danh sách ứng viên từ hệ thống (CHỈ những người có ban hợp lệ)
        const round3Candidates = loadRound3Candidates();
        const systemCandidateMap = new Map(
          round3Candidates.map((c) => [c.email.toLowerCase(), c])
        );

        let currentTeam = null;

        for (let i = 2; i < data.length; i++) {
          const row = data[i];
          if (!row || row.length < 6) continue;

          const [team, supporter, stt, name, department, email] = row;

          // Dòng mô tả team
          if (team && !stt && !name && !email) {
            currentTeam = team;
            teamStructure[currentTeam] = teamStructure[currentTeam] || {
              members: [],
            };
            continue;
          }

          // Dòng ứng viên
          if (stt && name && email) {
            const normalizedEmail = email.toLowerCase().trim();

            // Kiểm tra email có trong hệ thống không
            if (!systemCandidateMap.has(normalizedEmail)) {
              errors.push(
                `Ứng viên ${name} (${email}) không tồn tại trong hệ thống hoặc không đủ điều kiện vào vòng 3`
              );
              continue;
            }

            const systemCandidate = systemCandidateMap.get(normalizedEmail);

            // Kiểm tra ứng viên đã được phân team chưa
            if (candidateMap.has(normalizedEmail)) {
              errors.push(
                `Ứng viên ${name} (${email}) xuất hiện trong nhiều team`
              );
            }

            // 🛠️ SỬA: Kiểm tra ban có khớp với ban CHÍNH THỨC (đã pass cả 2 vòng) không
            let isValidDepartment = false;
            let expectedDepartments = [];

            // Kiểm tra ban priority hợp lệ
            if (
              systemCandidate.priority_status === "pass" &&
              systemCandidate.round2_priority_status === "pass" &&
              department === systemCandidate.priority_position
            ) {
              isValidDepartment = true;
              expectedDepartments.push(systemCandidate.priority_position);
            }

            // Kiểm tra ban secondary hợp lệ
            if (
              systemCandidate.secondary_status === "pass" &&
              systemCandidate.round2_secondary_status === "pass" &&
              department === systemCandidate.secondary_position
            ) {
              isValidDepartment = true;
              expectedDepartments.push(systemCandidate.secondary_position);
            }

            if (!isValidDepartment) {
              errors.push(
                `Ban của ${name} trong template (${department}) không khớp với ban chính thức trong hệ thống (${expectedDepartments.join(
                  " hoặc "
                )})`
              );
            }

            candidateMap.set(normalizedEmail, {
              id: systemCandidate.id,
              name: name,
              email: email,
              department: department,
              team: currentTeam,
            });

            if (currentTeam) {
              teamStructure[currentTeam].members.push({
                id: systemCandidate.id,
                name: name,
                email: email,
                department: department,
              });
            }
          }
        }

        // 🛠️ SỬA: Kiểm tra số lượng ứng viên (chỉ những người có ban hợp lệ)
        const validCandidatesCount = round3Candidates.length;
        if (candidateMap.size !== validCandidatesCount) {
          const missingCount = validCandidatesCount - candidateMap.size;
          errors.push(`Thiếu ${missingCount} ứng viên trong template`);

          // Liệt kê ứng viên bị thiếu
          round3Candidates.forEach((candidate) => {
            const normalizedEmail = candidate.email.toLowerCase();
            if (!candidateMap.has(normalizedEmail)) {
              errors.push(
                `Thiếu ứng viên: ${candidate.fullname} (${
                  candidate.email
                }) - Ban: ${getValidDepartments(candidate).join(", ")}`
              );
            }
          });
        }

        return {
          isValid: errors.length === 0,
          errors,
          candidateMap,
          teamStructure,
        };
      }

      // 🛠️ Hàm helper để lấy danh sách ban hợp lệ của ứng viên
      function getValidDepartments(candidate) {
        const validDepts = [];
        if (
          candidate.priority_status === "pass" &&
          candidate.round2_priority_status === "pass"
        ) {
          validDepts.push(candidate.priority_position);
        }
        if (
          candidate.secondary_status === "pass" &&
          candidate.round2_secondary_status === "pass"
        ) {
          validDepts.push(candidate.secondary_position);
        }
        return validDepts;
      }

      // Xử lý template thành teams
      function processTeamTemplate(data, candidateMap) {
        const teams = [];
        const teamMap = new Map();

        // Tạo cấu trúc teams
        Array.from(candidateMap.values()).forEach((candidate) => {
          if (!teamMap.has(candidate.team)) {
            const teamId = teams.length + 1;
            teamMap.set(candidate.team, {
              id: teamId,
              name: candidate.team,
              members: [],
              departments: { MD: 0, HR: 0, PD: 0, ER: 0 },
            });
            teams.push(teamMap.get(candidate.team));
          }

          const team = teamMap.get(candidate.team);
          team.members.push({
            id: candidate.id,
            name: candidate.name,
            email: candidate.email,
            department: candidate.department,
          });
          team.departments[candidate.department]++;
        });

        return teams;
      }

      // Tải template mẫu
      function downloadTeamTemplate() {
        const candidates = loadRound3Candidates();

        // Tạo dữ liệu template
        const templateData = [
          ["DANH SÁCH TEAM VÒNG 3 - TEMPLATE"],
          ["Lưu ý:"],
          ["- Mỗi ứng viên chỉ xuất hiện trong 1 team duy nhất"],
          ["- Giữ nguyên cấu trúc file"],
          [
            "- Điền tên team vào cột A (các dòng trống sẽ thuộc team phía trên)",
          ],
          ["- Điền supporter vào cột B"],
          ["- Không sửa cột STT, Họ và tên, Ban, Email"],
          ["- Ban phải khớp với ban chính thức của ứng viên trong hệ thống"],
          [
            "- Ứng viên có thể có 1 hoặc 2 ban hợp lệ (đã pass cả vòng 1 và vòng 2)",
          ],
          [],
          ["Team", "Supporter", "STT", "Họ và tên", "Ban", "Email", "Ghi chú"],
        ];

        // Thêm danh sách ứng viên mẫu (chỉ những người có ban hợp lệ)
        let stt = 1;
        candidates.forEach((candidate) => {
          // 🛠️ SỬA: Lấy tất cả các ban hợp lệ (có thể 1 hoặc 2 ban)
          const validDepartments = getValidDepartments(candidate);

          if (validDepartments.length > 0) {
            // Nếu có 2 ban hợp lệ, tạo 2 dòng (hoặc 1 dòng với ghi chú)
            if (validDepartments.length === 2) {
              templateData.push([
                "", // Team - để trống cho người dùng điền
                "", // Supporter - để trống
                stt,
                candidate.fullname,
                validDepartments[0], // Ban chính thức 1
                candidate.email,
                "Có 2 ban hợp lệ",
              ]);
              stt++;

              templateData.push([
                "", // Team - để trống cho người dùng điền
                "", // Supporter - để trống
                stt,
                candidate.fullname,
                validDepartments[1], // Ban chính thức 2
                candidate.email,
                "Có 2 ban hợp lệ",
              ]);
              stt++;
            } else {
              // Chỉ có 1 ban hợp lệ
              templateData.push([
                "", // Team - để trống cho người dùng điền
                "", // Supporter - để trống
                stt,
                candidate.fullname,
                validDepartments[0], // Ban chính thức
                candidate.email,
                "",
              ]);
              stt++;
            }
          }
        });

        // Tạo file Excel
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(templateData);

        // Định dạng cột
        ws["!cols"] = [
          { wch: 15 },
          { wch: 25 },
          { wch: 8 },
          { wch: 25 },
          { wch: 15 },
          { wch: 30 },
          { wch: 15 },
        ];

        XLSX.utils.book_append_sheet(wb, ws, "Template Team");
        XLSX.writeFile(wb, "Template_Chia_Team_Vong_3.xlsx");
      }

      // Tải danh sách ứng viên vòng 3
      function loadRound3Candidates() {
        return applications.filter((app) => {
          if (app.current_round !== "round3") return false;

          // CHỈ lấy các ban đã pass vòng 1 VÀ pass vòng 2
          const validPassedDepartments = [];

          if (
            app.priority_status === "pass" &&
            app.round2_priority_status === "pass"
          ) {
            validPassedDepartments.push("priority");
          }
          if (
            app.secondary_status === "pass" &&
            app.round2_secondary_status === "pass"
          ) {
            validPassedDepartments.push("secondary");
          }

          return validPassedDepartments.length > 0;
        });
      }

      // Cải tiến hàm phân loại ứng viên theo ban
      function categorizeCandidatesByDepartment(candidates) {
        const byDepartment = {
          MD: [],
          HR: [],
          PD: [],
          ER: [],
        };

        candidates.forEach((candidate) => {
          // CHỈ thêm vào các ban đã PASS vòng 1 VÀ PASS vòng 2
          if (
            candidate.priority_status === "pass" &&
            candidate.round2_priority_status === "pass"
          ) {
            byDepartment[candidate.priority_position].push({
              id: candidate.id,
              name: candidate.fullname,
              email: candidate.email,
              department: candidate.priority_position,
              hasTwoDepartments:
                candidate.secondary_status === "pass" &&
                candidate.round2_secondary_status === "pass",
              originalCandidate: candidate,
            });
          }

          if (
            candidate.secondary_status === "pass" &&
            candidate.round2_secondary_status === "pass"
          ) {
            byDepartment[candidate.secondary_position].push({
              id: candidate.id,
              name: candidate.fullname,
              email: candidate.email,
              department: candidate.secondary_position,
              hasTwoDepartments:
                candidate.priority_status === "pass" &&
                candidate.round2_priority_status === "pass",
              originalCandidate: candidate,
            });
          }
        });

        return byDepartment;
      }

      // Tạo team
      document
        .getElementById("generate-teams-btn")
        .addEventListener("click", () => {
          const candidates = loadRound3Candidates();
          if (candidates.length === 0) {
            alert("Không có ứng viên nào pass vòng 2 để chia team!");
            return;
          }

          const method = document.getElementById("division-method").value;
          let teams = [];

          if (method === "byTeamCount") {
            const teamCount = parseInt(
              document.getElementById("team-count").value
            );
            teams = divideByTeamCountImproved(candidates, teamCount);
          } else {
            const teamSize = parseInt(
              document.getElementById("team-size").value
            );
            teams = divideByTeamSizeImproved(candidates, teamSize);
          }

          temporaryTeams = teams;
          renderTeamPreview(teams);
          document.getElementById("team-preview").style.display = "block";
        });

      // Thêm hàm divideByTeamSizeImproved
      function divideByTeamSizeImproved(candidates, teamSize) {
        const totalCandidates = candidates.reduce((total, candidate) => {
          let count = 0;
          if (candidate.round2_priority_status === "pass") count++;
          if (candidate.round2_secondary_status === "pass") count++;
          return total + count;
        }, 0);

        const teamCount = Math.ceil(totalCandidates / teamSize);
        return divideByTeamCountImproved(candidates, teamCount);
      }

      function findBestTeamForDepartment(teams, department, candidateId) {
        let bestTeamIndex = 0;
        let minScore = Infinity;

        for (let i = 0; i < teams.length; i++) {
          const team = teams[i];

          // Bỏ qua team đã có ứng viên này
          if (team.assignedCandidates.has(candidateId)) {
            continue;
          }

          // Tính điểm: ưu tiên team có ít ứng viên ban này nhất
          const departmentCount = team.departments[department] || 0;

          // Thêm điểm phụ để cân bằng số lượng thành viên giữa các team
          const sizePenalty = team.members.length / 10;

          const totalScore = departmentCount + sizePenalty;

          if (totalScore < minScore) {
            minScore = totalScore;
            bestTeamIndex = i;
          }
        }

        return bestTeamIndex;
      }

      // Chia theo số team
      function divideByTeamCount(candidates, teamCount) {
        // Phân loại ứng viên theo ban
        const byDepartment = {
          MD: [],
          HR: [],
          PD: [],
          ER: [],
        };

        candidates.forEach((candidate) => {
          // Xác định ban chính thức (ưu tiên ban pass)
          let dept = null;
          if (candidate.round2_priority_status === "pass") {
            dept = candidate.priority_position;
          } else if (candidate.round2_secondary_status === "pass") {
            dept = candidate.secondary_position;
          }

          if (dept && byDepartment[dept]) {
            byDepartment[dept].push({
              id: candidate.id,
              name: candidate.fullname,
              email: candidate.email,
              department: dept,
            });
          }
        });

        // Khởi tạo teams
        const teams = Array.from({ length: teamCount }, (_, i) => ({
          id: i + 1,
          name: `Team ${i + 1}`,
          members: [],
          departments: { MD: 0, HR: 0, PD: 0, ER: 0 },
        }));

        // Phân phối ứng viên vào các team
        const depts = ["MD", "HR", "PD", "ER"];
        let teamIndex = 0;

        depts.forEach((dept) => {
          const candidatesInDept = [...byDepartment[dept]];

          while (candidatesInDept.length > 0) {
            const candidate = candidatesInDept.shift();
            teams[teamIndex].members.push(candidate);
            teams[teamIndex].departments[dept]++;

            // Tìm team tiếp theo với ít ứng viên nhất của ban này
            teamIndex = findNextTeam(teams, dept, teamIndex);
          }
        });

        return teams;
      }

      // Cải tiến hàm chia team tự động
      function divideByTeamCountImproved(candidates, teamCount) {
        // Phân loại ứng viên theo ban (CHỈ các ban đã pass cả 2 vòng)
        const byDepartment = categorizeCandidatesByDepartment(candidates);

        // Khởi tạo teams
        const teams = Array.from({ length: teamCount }, (_, i) => ({
          id: i + 1,
          name: `Team ${i + 1}`,
          members: [],
          departments: { MD: 0, HR: 0, PD: 0, ER: 0 },
          assignedCandidates: new Set(), // Theo dõi ứng viên đã được phân
        }));

        // Tạo danh sách ứng viên duy nhất (mỗi người 1 bản ghi)
        const allCandidates = [];
        const candidateMap = new Map(); // Để tránh trùng lặp

        candidates.forEach((candidate) => {
          if (candidateMap.has(candidate.id)) return;

          // Xác định xem ứng viên pass những ban nào
          const passedDepartments = [];
          let hasTwoDepartments = false;

          if (candidate.round2_priority_status === "pass") {
            passedDepartments.push({
              department: candidate.priority_position,
              type: "priority",
            });
          }

          if (candidate.round2_secondary_status === "pass") {
            passedDepartments.push({
              department: candidate.secondary_position,
              type: "secondary",
            });
          }

          hasTwoDepartments = passedDepartments.length === 2;

          if (passedDepartments.length > 0) {
            const candidateData = {
              id: candidate.id,
              name: candidate.fullname,
              email: candidate.email,
              passedDepartments: passedDepartments,
              hasTwoDepartments: hasTwoDepartments,
              originalCandidate: candidate,
            };

            allCandidates.push(candidateData);
            candidateMap.set(candidate.id, candidateData);
          }
        });

        // Ưu tiên xếp ứng viên có 2 ban trước (giúp cân bằng team)
        const sortedCandidates = [...allCandidates].sort((a, b) => {
          if (a.hasTwoDepartments && !b.hasTwoDepartments) return -1;
          if (!a.hasTwoDepartments && b.hasTwoDepartments) return 1;
          return 0;
        });

        // Xáo trộn nhẹ để tránh thứ tự cố định
        const shuffledCandidates = sortedCandidates.sort(
          () => Math.random() - 0.3
        );

        // Phân phối ứng viên vào các team
        shuffledCandidates.forEach((candidate) => {
          // Tìm team tốt nhất cho ứng viên này (dựa trên tất cả các ban họ pass)
          const bestTeamIndex = findBestTeamForCandidate(
            teams,
            candidate.passedDepartments,
            candidate.id
          );

          // Thêm ứng viên vào team
          teams[bestTeamIndex].members.push(candidate);

          // Cập nhật số lượng cho tất cả các ban mà ứng viên pass
          candidate.passedDepartments.forEach((dept) => {
            teams[bestTeamIndex].departments[dept.department]++;
          });

          teams[bestTeamIndex].assignedCandidates.add(candidate.id);
        });

        // Clean up
        teams.forEach((team) => {
          delete team.assignedCandidates;
        });

        return teams;
      }

      // Tìm team tốt nhất cho ứng viên
      function findBestTeamForCandidate(teams, passedDepartments, candidateId) {
        let bestTeamIndex = 0;
        let minScore = Infinity;

        for (let i = 0; i < teams.length; i++) {
          const team = teams[i];

          // Bỏ qua team đã có ứng viên này
          if (
            team.assignedCandidates &&
            team.assignedCandidates.has(candidateId)
          ) {
            continue;
          }

          // Tính điểm dựa trên tất cả các ban mà ứng viên pass
          let totalScore = 0;

          passedDepartments.forEach((dept) => {
            const departmentCount = team.departments[dept.department] || 0;
            totalScore += departmentCount;
          });

          // Thêm điểm phụ để cân bằng số lượng thành viên giữa các team
          const sizePenalty = team.members.length / 10;
          totalScore += sizePenalty;

          if (totalScore < minScore) {
            minScore = totalScore;
            bestTeamIndex = i;
          }
        }

        return bestTeamIndex;
      }

      // Chia theo số lượng mỗi team
      function divideByTeamSize(candidates, teamSize) {
        const teamCount = Math.ceil(candidates.length / teamSize);
        return divideByTeamCount(candidates, teamCount);
      }

      // Tìm team tiếp theo để phân phối
      function findNextTeam(teams, department, currentIndex) {
        let minCount = Infinity;
        let nextIndex = currentIndex;

        for (let i = 0; i < teams.length; i++) {
          const index = (currentIndex + i + 1) % teams.length;
          if (teams[index].departments[department] < minCount) {
            minCount = teams[index].departments[department];
            nextIndex = index;
          }
        }

        return nextIndex;
      }

      // Render preview team
      function renderTeamPreview(teams) {
        const container = document.getElementById("teams-container");
        container.innerHTML = "";

        teams.forEach((team) => {
          const teamDiv = document.createElement("div");
          teamDiv.className = "team-preview-card";
          teamDiv.style.cssText = `
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        `;

          // Thêm input cho supporter
          // Thêm input cho supporter
          let supporterHTML = `
  <div style="margin-bottom: 12px;">
    <label style="font-weight: 500; margin-bottom: 8px; display: block;">Supporter:</label>
    <input type="text" class="app-input" id="supporter-${team.id}" 
        placeholder="Nhập tên supporter (cách nhau bằng dấu ,)" 
        style="width: 100%; margin-bottom: 8px;">
    <small style="color: var(--gray-500);">VD: Võ Hà Vy - PD, Đặng Vũ Quỳnh Trang - HR</small>
  </div>
`;

          let membersHTML = "";
          team.members.forEach((member, index) => {
            // 🛠️ SỬA: CHỈ hiển thị các ban đã PASS cả vòng 1 và vòng 2
            let departmentBadges = "";
            let validPassedDepartments = [];

            // Kiểm tra ban priority
            if (
              member.originalCandidate &&
              member.originalCandidate.priority_status === "pass" &&
              member.originalCandidate.round2_priority_status === "pass"
            ) {
              validPassedDepartments.push({
                department: member.originalCandidate.priority_position,
                type: "priority",
              });
            }

            // Kiểm tra ban secondary
            if (
              member.originalCandidate &&
              member.originalCandidate.secondary_status === "pass" &&
              member.originalCandidate.round2_secondary_status === "pass"
            ) {
              validPassedDepartments.push({
                department: member.originalCandidate.secondary_position,
                type: "secondary",
              });
            }

            // Render badges chỉ cho các ban hợp lệ
            validPassedDepartments.forEach((dept) => {
              departmentBadges += `
                    <span class="department-badge status-pass" style="margin-left: 4px;">
                        ${getDepartmentName(dept.department)}
                    </span>
                `;
            });

            // 🛠️ SỬA: Hiển thị icon nếu ứng viên có 2 ban hợp lệ
            const twoDeptIcon =
              validPassedDepartments.length === 2
                ? '<i class="fas fa-layer-group" style="margin-left: 8px; color: var(--warning);" title="Ứng viên pass 2 ban"></i>'
                : "";

            membersHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--gray-200);">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; margin-bottom: 4px;">
                            <strong>${index + 1}. ${member.name}</strong>
                            ${departmentBadges}
                            ${twoDeptIcon}
                        </div>
                        <div style="font-size: 12px; color: var(--gray-500);">${
                          member.email
                        }</div>
                        ${
                          validPassedDepartments.length === 0
                            ? '<div style="font-size: 11px; color: var(--error); margin-top: 2px;">⚠️ Không có ban hợp lệ</div>'
                            : ""
                        }
                    </div>
                </div>
            `;
          });

          // 🛠️ SỬA: Cập nhật thống kê department chỉ cho các ban hợp lệ
          const validDepartmentCounts = { MD: 0, HR: 0, PD: 0, ER: 0 };
          team.members.forEach((member) => {
            if (member.originalCandidate) {
              if (
                member.originalCandidate.priority_status === "pass" &&
                member.originalCandidate.round2_priority_status === "pass"
              ) {
                validDepartmentCounts[
                  member.originalCandidate.priority_position
                ]++;
              }
              if (
                member.originalCandidate.secondary_status === "pass" &&
                member.originalCandidate.round2_secondary_status === "pass"
              ) {
                validDepartmentCounts[
                  member.originalCandidate.secondary_position
                ]++;
              }
            }
          });

          teamDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h4 style="margin: 0;">${team.name}</h4>
                <div>
                    <span style="margin-right: 12px;">Tổng: ${team.members.length}</span>
                    <span style="margin-right: 8px; color: var(--info);">MD: ${validDepartmentCounts.MD}</span>
                    <span style="margin-right: 8px; color: var(--success);">HR: ${validDepartmentCounts.HR}</span>
                    <span style="margin-right: 8px; color: var(--warning);">PD: ${validDepartmentCounts.PD}</span>
                    <span style="color: var(--error);">ER: ${validDepartmentCounts.ER}</span>
                </div>
            </div>
            ${supporterHTML}
            <div style="max-height: 300px; overflow-y: auto;">
                ${membersHTML}
            </div>
        `;

          container.appendChild(teamDiv);
        });
      }

      // Export danh sách team
      document
        .getElementById("export-teams-btn")
        .addEventListener("click", () => {
          if (temporaryTeams.length === 0) {
            alert("Chưa có team nào để export!");
            return;
          }

          exportTeamsToExcel(temporaryTeams);
        });

      // Xác nhận chia team
      // Xác nhận chia team
      document
        .getElementById("confirm-teams-btn")
        .addEventListener("click", async () => {
          if (temporaryTeams.length === 0) {
            alert("Chưa có team nào để xác nhận!");
            return;
          }

          if (
            !confirm(
              "Xác nhận chia team này? Dữ liệu sẽ được lưu vào hệ thống."
            )
          ) {
            return;
          }

          try {
            // Lưu thông tin team vào Firestore
            const batch = db.batch();

            temporaryTeams.forEach((team) => {
              // Lấy supporter từ input
              const supporterInput = document.getElementById(
                `supporter-${team.id}`
              );
              const supporter = supporterInput ? supporterInput.value : "";

              team.members.forEach(async (member, index) => {
                const appRef = db.collection("applications").doc(member.id);

                // Cập nhật thông tin team cho ứng viên
                const updates = {
                  "round3.team": team.name,
                  "round3.teamId": team.id,
                  "round3.teamOrder": index + 1,
                };

                // Thêm supporter nếu có
                if (supporter) {
                  updates["round3.supporter"] = supporter;
                }

                batch.update(appRef, updates);
              });
            });

            await batch.commit();
            alert("✅ Đã lưu thông tin team thành công!");
            document.getElementById("team-modal").style.display = "none";

            // Cập nhật ngay lập tức thay vì reload toàn bộ
            await updateApplicationsWithTeamInfo(temporaryTeams);

            // Render lại bảng vòng 3
            renderRound3();
          } catch (error) {
            console.error("Lỗi khi lưu team:", error);
            alert("❌ Lỗi khi lưu team: " + error.message);
          }
        });

      // Hàm helper để lấy danh sách ban hợp lệ của ứng viên
      function getValidDepartments(candidate) {
        const validDepts = [];
        if (
          candidate.priority_status === "pass" &&
          candidate.round2_priority_status === "pass"
        ) {
          validDepts.push(candidate.priority_position);
        }
        if (
          candidate.secondary_status === "pass" &&
          candidate.round2_secondary_status === "pass"
        ) {
          validDepts.push(candidate.secondary_position);
        }
        return validDepts;
      }

      // Hàm cập nhật ứng dụng với thông tin team
      async function updateApplicationsWithTeamInfo(teams) {
        teams.forEach((team) => {
          team.members.forEach((member, index) => {
            const appIndex = applications.findIndex(
              (app) => app.id === member.id
            );
            if (appIndex !== -1) {
              if (!applications[appIndex].round3) {
                applications[appIndex].round3 = {};
              }
              applications[appIndex].round3.team = team.name;
              applications[appIndex].round3.teamId = team.id;
              applications[appIndex].round3.teamOrder = index + 1;
            }
          });
        });
      }

      async function updateApplicationsWithTeamInfo(teams) {
        teams.forEach((team) => {
          team.members.forEach((member) => {
            const appIndex = applications.findIndex(
              (app) => app.id === member.id
            );
            if (appIndex !== -1) {
              if (!applications[appIndex].round3) {
                applications[appIndex].round3 = {};
              }
              applications[appIndex].round3.team = team.name;
              applications[appIndex].round3.teamId = team.id;
              applications[appIndex].round3.teamOrder = member.index || 0;
            }
          });
        });
      }

      // Sửa hàm exportTeamsToExcel để bao gồm supporter
      function exportTeamsToExcel(teams) {
        const wb = XLSX.utils.book_new();
        const data = [];

        // Tiêu đề
        data.push(["DANH SÁCH CHÍNH THỨC VÒNG 3 - TEAMWORK"]);
        data.push(["Lưu ý: Mỗi ứng viên chỉ thuộc 1 team duy nhất"]);
        data.push([
          "Ứng viên có thể có 1 hoặc 2 ban hợp lệ (đã pass cả vòng 1 và vòng 2)",
        ]);
        data.push([]);
        data.push([
          "Team",
          "Supporter",
          "STT",
          "Họ và tên",
          "Các ban hợp lệ",
          "Email",
          "Ghi chú",
        ]);

        teams.forEach((team) => {
          // Lấy supporter từ input
          const supporterInput = document.getElementById(
            `supporter-${team.id}`
          );
          const supporter = supporterInput ? supporterInput.value : "";

          // Dòng team với supporter
          data.push([team.name, supporter, "", "", "", "", ""]);

          // Thành viên
          team.members.forEach((member, index) => {
            // 🛠️ SỬA: Liệt kê tất cả các ban hợp lệ (đã pass cả 2 vòng)
            const validDepartments = [];

            if (member.originalCandidate) {
              if (
                member.originalCandidate.priority_status === "pass" &&
                member.originalCandidate.round2_priority_status === "pass"
              ) {
                validDepartments.push(
                  getDepartmentName(member.originalCandidate.priority_position)
                );
              }
              if (
                member.originalCandidate.secondary_status === "pass" &&
                member.originalCandidate.round2_secondary_status === "pass"
              ) {
                validDepartments.push(
                  getDepartmentName(member.originalCandidate.secondary_position)
                );
              }
            }

            const passedDepts = validDepartments.join(", ");
            const note = validDepartments.length === 2 ? "Pass 2 ban" : "";

            data.push([
              "", // Team
              "", // Supporter
              index + 1, // STT
              member.name, // Họ và tên
              passedDepts, // Các ban hợp lệ
              member.email, // Email
              note, // Ghi chú
            ]);
          });

          data.push([]); // Dòng trống giữa các team
        });

        const ws = XLSX.utils.aoa_to_sheet(data);

        // Định dạng cột
        ws["!cols"] = [
          { wch: 15 },
          { wch: 25 },
          { wch: 8 },
          { wch: 25 },
          { wch: 20 },
          { wch: 30 },
          { wch: 15 },
        ];

        XLSX.utils.book_append_sheet(wb, ws, "Danh sách team");
        XLSX.writeFile(wb, "Danh_sach_team_vong_3.xlsx");
      }

      // Hàm hiển thị options khi click vào badge
      function showStatusOptions(badgeElement, appId, banType) {
        const app = applications.find((a) => a.id === appId);
        if (!app) return;

        // Kiểm tra quyền chỉnh sửa
        if (!canEditBan(app, banType)) {
          alert("Bạn không có quyền chỉnh sửa ban này.");
          return;
        }

        // Tạo dropdown tạm thời
        const currentStatus = app[`round2_${banType}_status`] || "pending";
        const dropdown = document.createElement("select");
        dropdown.className = "app-select";
        dropdown.style.width = "100%";
        dropdown.innerHTML = `
        <option value="pending" ${
          currentStatus === "pending" ? "selected" : ""
        }>Pending</option>
        <option value="pass" ${
          currentStatus === "pass" ? "selected" : ""
        }>Pass</option>
        <option value="not-pass" ${
          currentStatus === "not-pass" ? "selected" : ""
        }>Not pass</option>
    `;

        // Thay thế badge bằng dropdown
        badgeElement.parentNode.replaceChild(dropdown, badgeElement);

        // Auto-save khi thay đổi
        dropdown.addEventListener("change", async function () {
          const newStatus = this.value;
          try {
            await db
              .collection("applications")
              .doc(appId)
              .update({
                [`round2_${banType}_status`]: newStatus,
              });

            // Thay dropdown bằng badge mới
            const newBadge = document.createElement("span");
            newBadge.className = `status-badge ${getStatusClass(newStatus)}`;
            newBadge.style.cursor = "pointer";
            newBadge.textContent = getStatusText(newStatus);
            newBadge.onclick = () =>
              showStatusOptions(newBadge, appId, banType);

            this.parentNode.replaceChild(newBadge, this);

            // Reload để cập nhật UI
            loadApplications();
          } catch (error) {
            console.error("Lỗi khi cập nhật trạng thái:", error);
            alert("Lỗi khi cập nhật trạng thái: " + error.message);
          }
        });

        // Auto-focus để người dùng có thể chọn ngay
        dropdown.focus();
      }

      // Thêm các hàm filter sau

      function filterRound1Applications() {
        const departmentFilter =
          document.getElementById("filter-department").value;
        const statusFilter = document.getElementById("filter-status").value;
        const searchText = document
          .getElementById("search-input")
          .value.toLowerCase();

        return applications.filter((app) => {
          // SỬA: BỎ điều kiện "app.current_round !== "round1""
          // Tab vòng 1 cần hiển thị TẤT CẢ ứng viên để xem đơn ứng tuyển

          // Department filter
          if (departmentFilter) {
            const hasPriorityDept = app.priority_position === departmentFilter;
            const hasSecondaryDept =
              app.secondary_position === departmentFilter;
            if (!hasPriorityDept && !hasSecondaryDept) return false;
          }

          // Status filter - SỬA: Sử dụng trạng thái thực tế của vòng 1
          if (statusFilter) {
            // Lấy trạng thái thực tế từ vòng 1 (priority_status và secondary_status)
            const hasPassPriority = app.priority_status === "pass";
            const hasPassSecondary = app.secondary_status === "pass";
            const hasNotPassPriority = app.priority_status === "not-pass";
            const hasNotPassSecondary = app.secondary_status === "not-pass";
            const isPending =
              !hasPassPriority &&
              !hasPassSecondary &&
              !hasNotPassPriority &&
              !hasNotPassSecondary;

            let actualStatus;
            if (hasPassPriority || hasPassSecondary) {
              actualStatus = "pass";
            } else if (hasNotPassPriority && hasNotPassSecondary) {
              actualStatus = "not-pass";
            } else if (isPending) {
              actualStatus = "pending";
            } else {
              actualStatus = "new";
            }

            if (actualStatus !== statusFilter) return false;
          }

          // Search filter
          if (
            searchText &&
            !(
              (app.fullname || "").toLowerCase().includes(searchText) ||
              (app.email || "").toLowerCase().includes(searchText) ||
              (app.phone || "").toLowerCase().includes(searchText)
            )
          )
            return false;

          return true;
        });
      }

      function filterRound2Applications() {
        const departmentFilter =
          document.getElementById("filter-department").value;
        const statusFilter = document.getElementById("filter-status").value;
        const searchText = document
          .getElementById("search-input")
          .value.toLowerCase();

        return applications.filter((app) => {
          if (app.current_round !== "round2") return false;

          // Department filter
          if (departmentFilter) {
            const hasPriorityDept = app.priority_position === departmentFilter;
            const hasSecondaryDept =
              app.secondary_position === departmentFilter;
            if (!hasPriorityDept && !hasSecondaryDept) return false;
          }

          // Status filter
          if (statusFilter) {
            const round2Status = computeOverallStatus(app);
            if (round2Status !== statusFilter) return false;
          }

          // Search filter
          if (
            searchText &&
            !(
              (app.fullname || "").toLowerCase().includes(searchText) ||
              (app.email || "").toLowerCase().includes(searchText) ||
              (app.phone || "").toLowerCase().includes(searchText)
            )
          )
            return false;

          return true;
        });
      }

      function filterRound3Applications() {
        const departmentFilter =
          document.getElementById("filter-department").value;
        const statusFilter = document.getElementById("filter-status").value;
        const searchText = document
          .getElementById("search-input")
          .value.toLowerCase();

        return applications.filter((app) => {
          // Điều kiện QUAN TRỌNG: phải ở vòng 3 VÀ có ít nhất 1 ban PASS vòng 2
          if (app.current_round !== "round3") return false;

          const hasPassedRound2 =
            app.round2_priority_status === "pass" ||
            app.round2_secondary_status === "pass";

          if (!hasPassedRound2) return false;

          // Department filter - chỉ kiểm tra các ban đã PASS vòng 2
          if (departmentFilter) {
            const hasMatchingDept =
              (app.round2_priority_status === "pass" &&
                app.priority_position === departmentFilter) ||
              (app.round2_secondary_status === "pass" &&
                app.secondary_position === departmentFilter);

            if (!hasMatchingDept) return false;
          }

          // Status filter - chỉ kiểm tra trạng thái round3 của các ban đã PASS vòng 2
          if (statusFilter) {
            let hasMatchingStatus = false;

            if (app.round2_priority_status === "pass") {
              hasMatchingStatus =
                hasMatchingStatus ||
                app.round3_priority_status === statusFilter;
            }
            if (app.round2_secondary_status === "pass") {
              hasMatchingStatus =
                hasMatchingStatus ||
                app.round3_secondary_status === statusFilter;
            }

            if (!hasMatchingStatus) return false;
          }

          // Search filter
          if (
            searchText &&
            !(
              (app.fullname || "").toLowerCase().includes(searchText) ||
              (app.email || "").toLowerCase().includes(searchText) ||
              (app.phone || "").toLowerCase().includes(searchText)
            )
          )
            return false;

          return true;
        });
      }

      function filterRound4Applications() {
        const departmentFilter =
          document.getElementById("filter-department").value;
        const statusFilter = document.getElementById("filter-status").value;
        const searchText = document
          .getElementById("search-input")
          .value.toLowerCase();

        return applications.filter((app) => {
          if (app.current_round !== "round4") return false;

          // SỬA: Kiểm tra ứng viên có ít nhất 1 ban pass vòng 3
          const hasPassedRound3 =
            app.round3_priority_status === "pass" ||
            app.round3_secondary_status === "pass";

          if (!hasPassedRound3) return false;

          // Department filter
          if (departmentFilter) {
            // SỬA: Chỉ kiểm tra ban đã pass vòng 3
            const hasPriorityDept =
              app.priority_position === departmentFilter &&
              app.round3_priority_status === "pass";
            const hasSecondaryDept =
              app.secondary_position === departmentFilter &&
              app.round3_secondary_status === "pass";
            if (!hasPriorityDept && !hasSecondaryDept) return false;
          }

          // Status filter - kiểm tra trạng thái round4
          if (statusFilter) {
            const hasMatchingStatus =
              (app.round4_priority_status === statusFilter &&
                app.round3_priority_status === "pass") ||
              (app.round4_secondary_status === statusFilter &&
                app.round3_secondary_status === "pass");

            if (!hasMatchingStatus) return false;
          }

          // Search filter
          if (
            searchText &&
            !(
              (app.fullname || "").toLowerCase().includes(searchText) ||
              (app.email || "").toLowerCase().includes(searchText) ||
              (app.phone || "").toLowerCase().includes(searchText)
            )
          )
            return false;

          return true;
        });
      }

      function filterSuccessApplications() {
        const departmentFilter =
          document.getElementById("filter-department").value;
        const statusFilter = document.getElementById("filter-status").value;
        const searchText = document
          .getElementById("search-input")
          .value.toLowerCase();

        return applications.filter((app) => {
          if (app.current_round !== "success") return false;

          // Department filter - ở success chỉ kiểm tra final_department
          if (departmentFilter && app.final_department !== departmentFilter) {
            return false;
          }

          // Status filter - ở success luôn là 'success'
          if (statusFilter && statusFilter !== "success") return false;

          // Search filter
          if (
            searchText &&
            !(
              (app.fullname || "").toLowerCase().includes(searchText) ||
              (app.email || "").toLowerCase().includes(searchText) ||
              (app.phone || "").toLowerCase().includes(searchText)
            )
          )
            return false;

          return true;
        });
      }

      // === THÊM CÁC HÀM HỖ TRỢ SAU HÀM loadApplications ===

      // Helper function để lấy tên ban
      function getDepartmentName(code) {
        const departments = {
          MD: "Truyền thông",
          HR: "Nhân sự",
          PD: "Dự án",
          ER: "Đối ngoại",
        };
        return departments[code] || code;
      }

      // Hàm kiểm tra đơn mới (trong vòng 10 phút)
      function isApplicationNew(timestamp) {
        if (!timestamp) return false;

        const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000); // 10 phút trước

        let appTime;
        if (timestamp.toDate) {
          // Firestore Timestamp
          appTime = timestamp.toDate();
        } else if (timestamp instanceof Date) {
          // JavaScript Date
          appTime = timestamp;
        } else if (typeof timestamp === "string") {
          // String date
          appTime = new Date(timestamp);
        } else if (typeof timestamp === "number") {
          // Unix timestamp
          appTime = new Date(timestamp);
        } else {
          return false;
        }

        return appTime > tenMinutesAgo;
      }

      // Hàm gửi email thông báo
      async function sendEmailNotification(application) {
        if (emailSendingInProgress.has(application.id)) {
          console.log(
            "⏳ Email đang được gửi cho ứng viên này:",
            application.fullname
          );
          return false;
        }

        try {
          console.log("📨 Đang gửi email thông báo...", application.fullname);

          emailSendingInProgress.add(application.id);

          const applicationTime = application.timestamp?.toDate
            ? application.timestamp.toDate()
            : new Date(
                application.timestamp ||
                  application.createdAt ||
                  application.submittedAt
              );

          const templateParams = {
            applicant_name: application.fullname || "Ứng viên",
            applicant_email: application.email || "Chưa cung cấp",
            applicant_phone: application.phone || "Chưa cung cấp",
            priority_department: getDepartmentName(
              application.priority_position
            ),
            secondary_department: getDepartmentName(
              application.secondary_position
            ),
            application_type:
              application.application_type === "interview"
                ? "Phỏng vấn thay đơn"
                : "Điền form",
            timestamp: applicationTime.toLocaleString("vi-VN"),
            to_email: [
              "recruitment.enactusftuhanoi@gmail.com",
              "tuhm2567@gmail.com",
              "lylm.enactusftu@gmail.com",
              "phuongntt556.enactusftu@gmail.com",
              "linhnk23.enactusftu@gmail.com",
              "lanntt.enactusftu@gmail.com",
              "anhtt19.enactusftu@gmail.com",
              "trangvd.enactusftu@gmail.com",
              "ngandlb.enactusftu@gmail.com",
              "tuannta.enactusftu@gmail.com",
              "trangnq.enactusftu@gmail.com",
              "linhdp63.enactusftu@gmail.com",
            ],
          };

          const result = await emailjs.send(
            "service_oxo8n38",
            "template_1fwgrrk",
            templateParams
          );

          console.log("✅ Email thông báo đã gửi thành công!", result);

          // Đánh dấu đã gửi thông báo
          if (application.id) {
            await db.collection("applications").doc(application.id).update({
              notification_sent: true,
              notification_sent_at: new Date(),
            });
            console.log(
              "✅ Đã đánh dấu gửi thông báo cho:",
              application.fullname
            );
          }

          return true;
        } catch (error) {
          console.error("❌ Lỗi gửi email:", error);

          if (error.text) {
            console.error("Chi tiết lỗi EmailJS:", error.text);
          }

          return false;
        } finally {
          emailSendingInProgress.delete(application.id);
        }
      }

      // Render applications to the table
      function renderApplications() {
        const tbody = document.getElementById("applications-table-body");
        if (!tbody) return;

        // Clear table
        tbody.innerHTML = "";

        // Filter applications
        const departmentFilter =
          document.getElementById("filter-department").value;
        const roundFilter = document.getElementById("filter-round").value;
        const statusFilter = document.getElementById("filter-status").value;
        const searchText = document
          .getElementById("search-input")
          .value.toLowerCase();

        const filteredApplications = applications.filter((app) => {
          // Department filter
          if (
            departmentFilter &&
            app.priority_position !== departmentFilter &&
            app.secondary_position !== departmentFilter
          ) {
            return false;
          }

          // Round filter (simplified for demo)
          if (roundFilter) {
            // This would need to be expanded based on your round data structure
            if (roundFilter === "round1" && app.current_round !== "round1")
              return false;
            // Add similar checks for other rounds
          }

          // Status filter
          if (statusFilter && computeOverallStatus(app) !== statusFilter)
            return false;

          // Search filter
          if (
            searchText &&
            !(
              (app.fullname || "").toLowerCase().includes(searchText) ||
              (app.email || "").toLowerCase().includes(searchText) ||
              (app.phone || "").toLowerCase().includes(searchText)
            )
          )
            return false;

          return true;
        });

        // Populate table
        filteredApplications.forEach((app) => {
          const tr = document.createElement("tr");

          // Applicant info
          tr.innerHTML = `
                    <td>
                        <div class="applicant-info">
                            <div class="applicant-avatar">${
                              app.fullname
                                ? app.fullname.charAt(0).toUpperCase()
                                : "U"
                            }</div>
                            <div class="applicant-details">
                                <div class="applicant-name">${
                                  app.fullname || "Chưa có tên"
                                }</div>
                                <div class="applicant-contact">${
                                  app.email || "Chưa cung cấp"
                                }</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        ${renderDepartment(
                          app.priority_position,
                          getDeptStatusForRound(app, "priority")
                        )}
                        ${
                          app.secondary_position &&
                          app.secondary_position !== "None"
                            ? renderDepartment(
                                app.secondary_position,
                                getDeptStatusForRound(app, "secondary")
                              )
                            : ""
                        }
                    </td>
                    <td>${app.email || "Chưa cung cấp"}</td>
                    <td>${app.phone || "Chưa cung cấp"}</td>
                    <td>${getRoundText(app.current_round)}</td>
                    <td>
                        <span class="status-badge ${getStatusClass(
                          computeOverallStatus(app)
                        )}">
                            ${getStatusText(computeOverallStatus(app))}
                        </span>
                    </td>
                    <td>
                        <button class="action-btn view-btn" data-id="${
                          app.id
                        }">Xem</button>
                    </td>
                `;

          tbody.appendChild(tr);
        });

        // Add event listeners to view buttons
        document.querySelectorAll(".view-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const appId = e.target.getAttribute("data-id");
            showApplicationDetail(appId);
          });
        });
      }

      // Trong hàm renderRound1(), sửa phần event listener
      function renderRound1() {
        const tbody = document.getElementById("round1-table-body");
        tbody.innerHTML = "";

        const filteredApps = filterRound1Applications();

        filteredApps.forEach((app) => {
          if (app.current_round !== "round1") return;

          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td>${app.fullname}</td>
                    <td>${app.email}</td>
                    <td>${app.phone || ""}</td>
                    <td>
                        ${renderDepartment(
                          app.priority_position,
                          app.priority_status
                        )}
                        ${
                          app.secondary_position &&
                          app.secondary_position !== "None"
                            ? renderDepartment(
                                app.secondary_position,
                                app.secondary_status
                              )
                            : ""
                        }
                    </td>
                    <td>${app.application_type || "form"}</td>
                    <td>${
                      app.application_type !== "form"
                        ? app.round1?.time || ""
                        : ""
                    }</td>
                    <td>${
                      app.application_type !== "form"
                        ? `<a href="${
                            app.round1?.link || "#"
                          }" target="_blank" style="color: #3B82F6; text-decoration: none;">Link</a>`
                        : "-"
                    }</td>
                    <td>${
                      app.application_type !== "form"
                        ? app.round1?.note || ""
                        : "-"
                    }</td>
                    <td>
                        <button class="action-btn view-btn" data-id="${app.id}">
                            <i class="fas fa-external-link-alt" style="margin-right: 4px;"></i>
                            Xem
                        </button>
                    </td>
                `;
          tbody.appendChild(tr);
        });

        // Sửa phần event listener - thêm kiểm tra authentication
        tbody.querySelectorAll(".view-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const appId = e.target.getAttribute("data-id");

            // Kiểm tra authentication trước khi chuyển hướng
            if (!userEmail || !userRole) {
              alert("Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.");
              window.location.href = "login.html";
              return;
            }

            // Mở trang response với ID ứng viên
            window.open(`response.html?id=${appId}`, "_blank");
          });
        });
        // Tự động quét đơn trùng khi vào tab round1
        setTimeout(() => {
          findAndDisplayDuplicateApplications();
        }, 1000);
      }

      function renderRound2() {
        const tbody = document.getElementById("round2-table-body");
        tbody.innerHTML = "";

        const filteredApps = filterRound2Applications();

        filteredApps.forEach((app) => {
          if (app.current_round !== "round2") return;

          // Lấy thông tin chung từ round2 (ưu tiên lấy từ priority nếu có)
          const round2Data = app.round2 || {};
          const commonData = round2Data.priority || round2Data.secondary || {};

          const tr = document.createElement("tr");

          // Thông tin chung chỉ hiển thị 1 lần (đã bỏ cột thành viên nhóm)
          tr.innerHTML = `
      <td>
        <div class="applicant-info">
          <div class="applicant-avatar">${
            app.fullname ? app.fullname.charAt(0).toUpperCase() : "U"
          }</div>
          <div class="applicant-details">
            <div class="applicant-name">${app.fullname}</div>
            <div class="applicant-contact">${app.email}</div>
          </div>
        </div>
      </td>
      <td>
        ${renderDepartment(app.priority_position, app.round2_priority_status)}
        ${
          app.secondary_position && app.secondary_position !== "None"
            ? renderDepartment(
                app.secondary_position,
                app.round2_secondary_status
              )
            : ""
        }
      </td>
      <td><input class="app-input" value="${
        commonData.time || ""
      }" data-field="common.time"></td>
      <td><input class="app-input" value="${
        commonData.location || ""
      }" data-field="common.location"></td>
      <td>
        <select class="app-select" data-field="common.method">
          <option value="offline" ${
            commonData.method === "offline" ? "selected" : ""
          }>Offline</option>
          <option value="online" ${
            commonData.method === "online" ? "selected" : ""
          }>Online</option>
        </select>
      </td>
      <td><input class="app-input" value="${
        commonData.note || ""
      }" data-field="common.note"></td>
      <td>
        <!-- Phần trạng thái chia theo ban -->
        <div id="status-section-${app.id}">
          ${renderStatusSection(app)}
        </div>
      </td>
      <td>
        <button class="action-btn save-btn" data-id="${app.id}">Lưu</button>
      </td>
    `;

          tbody.appendChild(tr);
        });

        // Event listeners cho nút lưu
        tbody.querySelectorAll(".save-btn").forEach((btn) => {
          btn.addEventListener("click", async (ev) => {
            const appId = btn.dataset.id;
            const row = btn.closest("tr");
            const app = applications.find((a) => a.id === appId);

            if (!app) {
              alert("Ứng viên không tồn tại");
              return;
            }

            const updates = {};

            // Lưu thông tin chung
            const commonInputs = row.querySelectorAll(
              "[data-field^='common.']"
            );
            commonInputs.forEach((input) => {
              const field = input.dataset.field.replace("common.", "");

              // Lưu vào cả 2 ban (priority và secondary) nếu có
              if (
                app.round2_priority_status &&
                app.round2_priority_status !== "not-pass"
              ) {
                updates[`round2.priority.${field}`] = input.value;
              }
              if (
                app.round2_secondary_status &&
                app.round2_secondary_status !== "not-pass"
              ) {
                updates[`round2.secondary.${field}`] = input.value;
              }
            });

            // Lưu trạng thái theo ban
            const statusSection = document.getElementById(
              `status-section-${appId}`
            );
            const statusSelects =
              statusSection.querySelectorAll(".ban-status-select");

            statusSelects.forEach((select) => {
              const banType = select.dataset.banType;
              const newStatus = select.value;

              updates[`round2_${banType}_status`] = newStatus;
            });

            try {
              await db.collection("applications").doc(appId).update(updates);
              alert("✅ Đã lưu thông tin!");
              refreshApplications();
            } catch (err) {
              console.error(err);
              alert("❌ Lưu thất bại: " + (err.message || err));
            }
          });
        });
      }

      // Hàm render phần trạng thái chia theo ban
      function renderStatusSection(app) {
        let html = "";
        const positions = [];

        // Thêm ban priority nếu có trạng thái
        if (app.priority_position && app.round2_priority_status) {
          positions.push({
            type: "priority",
            dept: app.priority_position,
            status: app.round2_priority_status,
            canEdit: canEditBan(app, "priority"),
          });
        }

        // Thêm ban secondary nếu có trạng thái và không phải "None"
        if (
          app.secondary_position &&
          app.secondary_position !== "None" &&
          app.round2_secondary_status
        ) {
          positions.push({
            type: "secondary",
            dept: app.secondary_position,
            status: app.round2_secondary_status,
            canEdit: canEditBan(app, "secondary"),
          });
        }

        positions.forEach((pos, index) => {
          html += `
      <div style="margin-bottom: ${
        index < positions.length - 1 ? "8px" : "0"
      };">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
          <span style="font-size: 12px; color: var(--gray-600);">${getDepartmentName(
            pos.dept
          )}:</span>
          <span class="status-badge ${getStatusClass(
            pos.status
          )}" style="font-size: 11px;">
            ${getStatusText(pos.status)}
          </span>
        </div>
        <select class="app-select ban-status-select" 
                data-ban-type="${pos.type}" 
                ${!pos.canEdit ? "disabled" : ""}
                style="width: 100%; font-size: 12px; padding: 4px 8px;">
          <option value="pending" ${
            pos.status === "pending" ? "selected" : ""
          }>Pending</option>
          <option value="pass" ${
            pos.status === "pass" ? "selected" : ""
          }>Pass</option>
          <option value="not-pass" ${
            pos.status === "not-pass" ? "selected" : ""
          }>Not pass</option>
        </select>
      </div>
    `;
        });

        return html;
      }

      function simplifyTeamRendering() {
        const tbody = document.getElementById("round3-table-body");
        tbody.innerHTML = "";

        const filteredApps = filterRound3Applications();

        filteredApps.forEach((app) => {
          const tr = document.createElement("tr");

          // Chỉ hiển thị các ban đã pass vòng 2
          const passedDepartments = [];
          if (app.round2_priority_status === "pass")
            passedDepartments.push("priority");
          if (app.round2_secondary_status === "pass")
            passedDepartments.push("secondary");

          tr.innerHTML = `
      <td>${app.round3?.team || "Chưa có team"}</td>
      <td>${app.round3?.advisor1 || ""} ${app.round3?.advisor2 || ""}</td>
      <td>${app.fullname}</td>
      <td>
        ${passedDepartments
          .map((type) =>
            renderDepartment(
              type === "priority"
                ? app.priority_position
                : app.secondary_position,
              app[`round3_${type}_status`] || "pending"
            )
          )
          .join("")}
      </td>
      <td>
        ${passedDepartments
          .map(
            (type) =>
              `<input class="app-input" value="${
                app.round3?.[type]?.note || ""
              }" 
                 data-field="${type}.note" data-id="${app.id}" 
                 placeholder="Ghi chú ${type}" style="margin-bottom: 4px;">`
          )
          .join("")}
      </td>
      <td>
        ${passedDepartments
          .map((type) => {
            const status = app[`round3_${type}_status`] || "pending";
            return `
            <select class="app-select" data-field="${type}.status" data-id="${
              app.id
            }" style="margin-bottom: 4px;">
              <option value="pending" ${
                status === "pending" ? "selected" : ""
              }>Pending</option>
              <option value="pass" ${
                status === "pass" ? "selected" : ""
              }>Pass</option>
              <option value="not-pass" ${
                status === "not-pass" ? "selected" : ""
              }>Not pass</option>
            </select>
          `;
          })
          .join("")}
      </td>
      <td>
        <button class="action-btn save-btn" data-id="${app.id}">Lưu</button>
      </td>
    `;

          tbody.appendChild(tr);
        });

        // Gọi hàm setup handlers
        setupRound3SaveHandlers();
      }

      function canEditRound3(app, banType) {
        if (userRole === "superadmin") return true;
        if (userRole === "admin") {
          const dept =
            banType === "priority"
              ? app.priority_position
              : app.secondary_position;
          return dept === userDept;
        }
        return false;
      }

      function renderRound3() {
        const tbody = document.getElementById("round3-table-body");
        tbody.innerHTML = "";

        const filteredApps = filterRound3Applications();

        // Nhóm ứng viên theo team
        const teams = {};

        filteredApps.forEach((app) => {
          // CHỈ lấy các ban đã PASS vòng 2
          const passedDepartments = [];

          if (app.round2_priority_status === "pass") {
            passedDepartments.push({
              type: "priority",
              dept: app.priority_position,
              status: app.round3_priority_status || "pending",
            });
          }

          if (app.round2_secondary_status === "pass") {
            passedDepartments.push({
              type: "secondary",
              dept: app.secondary_position,
              status: app.round3_secondary_status || "pending",
            });
          }

          // Nếu không có ban nào pass vòng 2 thì bỏ qua
          if (passedDepartments.length === 0) return;

          const teamInfo = app.round3 || {};
          const teamName = teamInfo.team || "Chưa có team";

          if (!teams[teamName]) {
            teams[teamName] = [];
          }

          teams[teamName].push({
            app,
            passedDepartments,
            teamInfo,
          });
        });

        // Sắp xếp teams theo thứ tự số
        const sortedTeamNames = Object.keys(teams).sort((a, b) => {
          const numA = parseInt(a.replace("Team", "")) || 0;
          const numB = parseInt(b.replace("Team", "")) || 0;
          return numA - numB;
        });

        // Render từng team
        sortedTeamNames.forEach((teamName) => {
          const teamMembers = teams[teamName];
          const teamAdvisors = getTeamAdvisors(teamMembers);

          teamMembers.forEach((member, index) => {
            const { app, passedDepartments } = member;
            const tr = document.createElement("tr");

            // Cột Team - merge cho các thành viên cùng team
            if (index === 0) {
              tr.innerHTML += `<td rowspan="${teamMembers.length}" style="font-weight: 600; color: var(--info); vertical-align: middle;">${teamName}</td>`;
            }

            // Cột Advisor - merge cho các thành viên cùng team
            if (index === 0) {
              let advisorHTML = "";
              teamAdvisors.forEach((advisor, idx) => {
                advisorHTML += `
                        <input class="app-input" 
                            value="${advisor || ""}" 
                            placeholder="Advisor ${idx + 1}"
                            data-field="team.advisor${idx + 1}"
                            data-team="${teamName}"
                            style="margin-bottom: 4px; width: 100%;">
                    `;
              });
              // Thêm input trống nếu chưa đủ 2 advisor
              while (teamAdvisors.length < 2) {
                advisorHTML += `
                        <input class="app-input" 
                            value="" 
                            placeholder="Advisor ${teamAdvisors.length + 1}"
                            data-field="team.advisor${teamAdvisors.length + 1}"
                            data-team="${teamName}"
                            style="margin-bottom: 4px; width: 100%;">
                    `;
                teamAdvisors.push("");
              }
              tr.innerHTML += `<td rowspan="${teamMembers.length}" style="min-width: 150px; vertical-align: middle;">${advisorHTML}</td>`;
            }

            // Cột Họ và tên
            tr.innerHTML += `<td style="font-weight: 500;">${app.fullname}</td>`;

            // Cột Ban ứng tuyển - CHỈ hiển thị ban đã PASS vòng 2
            let departmentsHTML = "";
            passedDepartments.forEach((pos) => {
              const status = app[`round3_${pos.type}_status`] || "pending";
              departmentsHTML += renderDepartment(pos.dept, status);
            });
            tr.innerHTML += `<td>${departmentsHTML}</td>`;

            // Cột Ghi chú
            let noteHTML = "";
            passedDepartments.forEach((pos) => {
              const data = app.round3?.[pos.type] || {};
              const canEditThisBan = canEditBan(app, pos.type);

              noteHTML += `
                    <input class="app-input" ${
                      !canEditThisBan ? "disabled" : ""
                    } 
                        value="${data.note || ""}" 
                        placeholder="Ghi chú ${getDepartmentName(pos.dept)}"
                        data-field="${pos.type}.note"
                        style="margin-bottom: 4px; width: 100%;">
                `;
            });
            tr.innerHTML += `<td style="min-width: 200px;">${noteHTML}</td>`;

            // Cột Trạng thái
            let statusHTML = "";
            passedDepartments.forEach((pos) => {
              const status = app[`round3_${pos.type}_status`] || "pending";
              const canEditThisBan = canEditBan(app, pos.type);

              statusHTML += `
                    <div style="margin-bottom: 8px;">
                        <select class="app-select" ${
                          !canEditThisBan ? "disabled" : ""
                        } data-field="${pos.type}.status" style="width: 100%;">
                            <option value="pending" ${
                              status === "pending" ? "selected" : ""
                            }>Pending</option>
                            <option value="pass" ${
                              status === "pass" ? "selected" : ""
                            }>Pass</option>
                            <option value="not-pass" ${
                              status === "not-pass" ? "selected" : ""
                            }>Not pass</option>
                        </select>
                    </div>
                `;
            });
            tr.innerHTML += `<td style="min-width: 120px;">${statusHTML}</td>`;

            // Cột Hành động
            let actionHTML = "";
            if (passedDepartments.length > 0) {
              const canEditAny = passedDepartments.some((pos) =>
                canEditBan(app, pos.type)
              );
              actionHTML = `
                    <button class="action-btn save-btn" data-id="${app.id}" 
                        style="background: var(--success-light); color: var(--success);" 
                        ${!canEditAny ? "disabled" : ""}>
                        Lưu
                    </button>
                `;
            }
            tr.innerHTML += `<td style="min-width: 80px;">${actionHTML}</td>`;

            tbody.appendChild(tr);
          });
        });

        // Event listeners cho nút lưu
        tbody.querySelectorAll(".save-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            const row = btn.closest("tr");
            const app = applications.find((a) => a.id === id);
            if (!app) {
              alert("Ứng viên không tồn tại");
              return;
            }

            // CHỈ lấy các ban đã PASS vòng 2
            const passedDepartments = [];
            if (app.round2_priority_status === "pass") {
              passedDepartments.push({
                type: "priority",
                dept: app.priority_position,
              });
            }
            if (app.round2_secondary_status === "pass") {
              passedDepartments.push({
                type: "secondary",
                dept: app.secondary_position,
              });
            }

            const updates = {};

            // Thu thập tất cả dữ liệu từ các input
            passedDepartments.forEach((pos) => {
              if (!canEditBan(app, pos.type)) return;

              // Lấy ghi chú
              const noteInput = row.querySelector(
                `[data-field="${pos.type}.note"]`
              );
              if (noteInput) {
                updates[`round3.${pos.type}.note`] = noteInput.value;
              }

              // Lấy trạng thái
              const statusSelect = row.querySelector(
                `[data-field="${pos.type}.status"]`
              );
              if (statusSelect) {
                updates[`round3_${pos.type}_status`] = statusSelect.value;
              }
            });

            if (Object.keys(updates).length === 0) {
              alert("Không có quyền chỉnh sửa cho ứng viên này");
              return;
            }

            try {
              await db.collection("applications").doc(id).update(updates);
              alert("Đã lưu thay đổi!");
              refreshApplications();
            } catch (error) {
              alert(`Lỗi khi lưu: ${error.message}`);
            }
          });
        });

        // Event listeners cho advisor (lưu cho cả team)
        tbody
          .querySelectorAll('[data-field^="team.advisor"]')
          .forEach((input) => {
            input.addEventListener("change", async () => {
              const teamName = input.dataset.team;
              const advisorField = input.dataset.field;
              const advisorValue = input.value;

              // Tìm tất cả ứng viên trong team này
              const teamMembers = applications.filter((app) => {
                if (app.current_round !== "round3") return false;
                const teamInfo = app.round3 || {};
                return teamInfo.team === teamName;
              });

              if (teamMembers.length === 0) return;

              // Cập nhật advisor cho tất cả thành viên trong team
              const batch = db.batch();
              teamMembers.forEach((app) => {
                const appRef = db.collection("applications").doc(app.id);
                batch.update(appRef, {
                  [`round3.${advisorField}`]: advisorValue,
                });
              });

              try {
                await batch.commit();
                console.log(`Đã cập nhật ${advisorField} cho team ${teamName}`);
              } catch (error) {
                console.error("Lỗi khi cập nhật advisor:", error);
              }
            });
          });
      }

      // Thêm hàm này để xử lý lưu dữ liệu vòng 3
      function setupRound3SaveHandlers() {
        const tbody = document.getElementById("round3-table-body");

        tbody.querySelectorAll(".save-btn").forEach((btn) => {
          btn.addEventListener("click", async function () {
            const appId = this.dataset.id;
            const row = this.closest("tr");
            const app = applications.find((a) => a.id === appId);

            if (!app) {
              alert("Ứng viên không tồn tại");
              return;
            }

            const updates = {};

            // Lấy các ban đã pass vòng 2
            const passedDepartments = [];
            if (app.round2_priority_status === "pass")
              passedDepartments.push("priority");
            if (app.round2_secondary_status === "pass")
              passedDepartments.push("secondary");

            // Thu thập dữ liệu từ các input
            passedDepartments.forEach((banType) => {
              // Lấy ghi chú
              const noteInput = row.querySelector(
                `[data-field="${banType}.note"]`
              );
              if (noteInput) {
                updates[`round3.${banType}.note`] = noteInput.value;
              }

              // Lấy trạng thái
              const statusSelect = row.querySelector(
                `[data-field="${banType}.status"]`
              );
              if (statusSelect) {
                updates[`round3_${banType}_status`] = statusSelect.value;
              }
            });

            if (Object.keys(updates).length === 0) {
              alert("Không có dữ liệu để lưu");
              return;
            }

            try {
              await db.collection("applications").doc(appId).update(updates);
              alert("✅ Đã lưu thông tin vòng 3!");
              refreshApplications();
            } catch (error) {
              console.error("Lỗi khi lưu:", error);
              alert("❌ Lỗi khi lưu: " + error.message);
            }
          });
        });
      }

      // Hàm lấy advisors từ team (lấy từ member đầu tiên)
      function getTeamAdvisors(teamMembers) {
        if (teamMembers.length === 0) return [];

        const firstMember = teamMembers[0];
        const advisors = [];

        // Lấy advisor từ round3.team.advisor1 và round3.team.advisor2
        const teamData = firstMember.app.round3 || {};
        if (teamData.team && teamData.advisor1) {
          advisors.push(teamData.advisor1);
        }
        if (teamData.team && teamData.advisor2) {
          advisors.push(teamData.advisor2);
        }

        return advisors;
      }

      function renderRound4() {
        const tbody = document.getElementById("round4-table-body");
        tbody.innerHTML = "";

        const filteredApps = filterRound4Applications();

        filteredApps.forEach((app) => {
          if (app.current_round !== "round4") return;

          // SỬA: Chỉ hiển thị ban đã pass vòng 3
          const positions = [
            {
              type: "priority",
              dept: app.priority_position,
              prev: app.round3_priority_status,
            },
            {
              type: "secondary",
              dept: app.secondary_position,
              prev: app.round3_secondary_status,
            },
          ].filter(
            (pos) => pos.dept && pos.dept !== "null" && pos.prev === "pass"
          ); // CHỈ GIỮ BAN PASS VÒNG 3

          if (positions.length === 0) return;

          positions.forEach((pos, idx) => {
            if (userRole === "admin" && pos.dept !== userDept) return;

            const status = app[`round4_${pos.type}_status`] || "pending";
            const data = app.round4?.[pos.type] || {};

            const canEditThisBan = canEditBan(app, pos.type);
            const rowClass = canEditThisBan ? "" : "row-disabled";

            const tr = document.createElement("tr");
            tr.className = rowClass;

            if (idx === 0)
              tr.innerHTML += `<td rowspan="${positions.length}">${app.fullname}</td>`;

            // SỬA: Hiển thị badge giống vòng 2
            tr.innerHTML += `
                        <td>${renderDepartment(pos.dept, status)}</td>
                        <td><input class="app-input" ${
                          !canEditThisBan ? "disabled" : ""
                        } value="${data.time || ""}" data-field="${
              pos.type
            }.time"></td>
                        <td><input class="app-input" ${
                          !canEditThisBan ? "disabled" : ""
                        } value="${data.location || ""}" data-field="${
              pos.type
            }.location"></td>
                        <td><input class="app-input" ${
                          !canEditThisBan ? "disabled" : ""
                        } value="${data.interviewer || ""}" data-field="${
              pos.type
            }.interviewer"></td>
                        <td>
                            <select class="app-select" ${
                              !canEditThisBan ? "disabled" : ""
                            } data-field="${pos.type}.method">
                                <option value="offline" ${
                                  data.method === "offline" ? "selected" : ""
                                }>Offline</option>
                                <option value="online" ${
                                  data.method === "online" ? "selected" : ""
                                }>Online</option>
                            </select>
                        </td>
                        <td><input class="app-input" ${
                          !canEditThisBan ? "disabled" : ""
                        } value="${data.note || ""}" data-field="${
              pos.type
            }.note"></td>
                        <td>
                            <!-- HIỂN THỊ BADGE VÀ SELECT GIỐNG VÒNG 2 -->
                            <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
                                <span class="status-badge ${getStatusClass(
                                  status
                                )}" style="margin-bottom: 4px;">
                                    ${getStatusText(status)}
                                </span>
                                <select class="app-select" ${
                                  !canEditThisBan ? "disabled" : ""
                                } data-field="${
              pos.type
            }.status" style="width: 100%; font-size: 12px; padding: 4px 8px;">
                                    <option value="pending" ${
                                      status === "pending" ? "selected" : ""
                                    }>Pending</option>
                                    <option value="interviewed" ${
                                      status === "interviewed" ? "selected" : ""
                                    }>Interviewed</option>
                                    <option value="pass" ${
                                      status === "pass" ? "selected" : ""
                                    }>Pass</option>
                                    <option value="not-pass" ${
                                      status === "not-pass" ? "selected" : ""
                                    }>Not pass</option>
                                </select>
                            </div>
                        </td>
                        <td><button class="action-btn save-btn" data-id="${
                          app.id
                        }" data-type="${pos.type}" ${
              !canEditThisBan ? "disabled" : ""
            }>Lưu</button></td>
                    `;
            tbody.appendChild(tr);
          });
        });

        tbody.querySelectorAll(".save-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            const type = btn.dataset.type;
            const row = btn.closest("tr");
            const app = applications.find((a) => a.id === id);
            if (!app) {
              alert("Ứng viên không tồn tại");
              return;
            }

            // 🔒 Check quyền
            if (!canEditBan(app, type)) {
              alert("Bạn không có quyền chỉnh sửa ban này.");
              return;
            }

            const inputs = row.querySelectorAll("[data-field]");
            const updates = {};

            inputs.forEach((input) => {
              const [banType, field] = input.dataset.field.split(".");
              if (banType === type)
                updates[`round4.${type}.${field}`] = input.value;
            });

            const statusSelect = row.querySelector('[data-field$=".status"]');
            if (statusSelect)
              updates[`round4_${type}_status`] = statusSelect.value;

            await db.collection("applications").doc(id).update(updates);
            alert(`✅ Đã lưu thay đổi vòng 4 (${type})`);
            refreshApplications();
          });
        });
      }

      function sortRound3Table() {
        const tbody = document.getElementById("round3-table-body");
        const rows = Array.from(tbody.querySelectorAll("tr"));

        rows.sort((a, b) => {
          const teamA = a.cells[0].querySelector("input").value.toLowerCase();
          const teamB = b.cells[0].querySelector("input").value.toLowerCase();

          // Sắp xếp theo thứ tự team
          if (teamA < teamB) return -1;
          if (teamA > teamB) return 1;
          return 0;
        });

        // Xóa và thêm lại các dòng đã sắp xếp
        rows.forEach((row) => tbody.appendChild(row));
      }

      // Sửa hàm calculateWeekComparison để tính toán chính xác
      async function calculateWeekComparison() {
        try {
          const now = new Date();
          const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

          // Lấy dữ liệu ứng viên từ tuần trước
          const lastWeekSnapshot = await db
            .collection("applications")
            .where("timestamp", ">=", oneWeekAgo)
            .get();

          const lastWeekApps = lastWeekSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          // Tính toán số liệu tuần trước - SỬA LẠI THEO LOGIC MỚI
          const lastWeekTotal = lastWeekApps.length;
          const lastWeekCompleted = lastWeekApps.filter(
            (app) => computeOverallStatus(app) === "success"
          ).length;
          const lastWeekRejected = lastWeekApps.filter(
            (app) => computeOverallStatus(app) === "not-pass"
          ).length;
          const lastWeekInProgress =
            lastWeekTotal - lastWeekCompleted - lastWeekRejected;

          // Tính toán số liệu hiện tại - SỬA LẠI THEO LOGIC MỚI
          const currentTotal = applications.length;
          const currentCompleted = applications.filter(
            (app) => computeOverallStatus(app) === "success"
          ).length;
          const currentRejected = applications.filter(
            (app) => computeOverallStatus(app) === "not-pass"
          ).length;
          const currentInProgress =
            currentTotal - currentCompleted - currentRejected;

          // Tính phần trăm thay đổi
          return {
            total: calculatePercentageChange(lastWeekTotal, currentTotal),
            completed: calculatePercentageChange(
              lastWeekCompleted,
              currentCompleted
            ),
            inProgress: calculatePercentageChange(
              lastWeekInProgress,
              currentInProgress
            ),
            rejected: calculatePercentageChange(
              lastWeekRejected,
              currentRejected
            ),
          };
        } catch (error) {
          console.error("Lỗi tính toán phần trăm:", error);
          return {
            total: 0,
            completed: 0,
            inProgress: 0,
            rejected: 0,
          };
        }
      }

      // Kiểm tra quyền chỉnh sửa theo ban
      function canEditBan(app, banType) {
        if (userRole === "superadmin") return true;
        if (userRole === "admin") {
          const dept =
            banType === "priority"
              ? app.priority_position
              : app.secondary_position;
          return dept === userDept;
        }
        return false;
      }

      // Hàm tính phần trăm thay đổi
      function calculatePercentageChange(oldValue, newValue) {
        if (oldValue === 0) {
          return newValue > 0 ? 100 : 0;
        }
        const change = ((newValue - oldValue) / oldValue) * 100;
        return Math.round(change * 10) / 10; // Làm tròn 1 chữ số thập phân
      }

      // Sửa hàm updateStats()
      async function updateStats() {
        document.getElementById("total-applicants").textContent =
          applications.length;

        const completed = applications.filter(
          (app) => computeOverallStatus(app) === "success"
        ).length;
        const rejected = applications.filter(
          (app) => computeOverallStatus(app) === "not-pass"
        ).length;
        const inProgress = applications.length - completed - rejected;

        document.getElementById("completed-applicants").textContent = completed;
        document.getElementById("inprogress-applicants").textContent =
          inProgress;
        document.getElementById("rejected-applicants").textContent = rejected;

        // Tính toán và cập nhật phần trăm so với tuần trước
        const comparisons = await calculateWeekComparison();

        updateComparisonElement("total-applicants", comparisons.total);
        updateComparisonElement("completed-applicants", comparisons.completed);
        updateComparisonElement(
          "inprogress-applicants",
          comparisons.inProgress
        );
        updateComparisonElement("rejected-applicants", comparisons.rejected);

        // Cập nhật thống kê theo ban
        updateDepartmentStats();
      }

      // Thêm CSS cho thống kê ban
      const style = document.createElement("style");
      style.textContent = `
            .department-stats-header {
                grid-column: 1 / -1;
                font-size: 18px;
                font-weight: 600;
                color: var(--gray-700);
                margin-bottom: 16px;
                border-bottom: 2px solid var(--primary);
                padding-bottom: 8px;
            }
            
            .department-stat-item {
                display: flex;
                justify-content: space-between;
                margin-bottom: 4px;
                font-size: 12px;
            }
            
            .department-stat-label {
                color: var(--gray-500);
            }
            
            .department-stat-value {
                font-weight: 500;
            }
        `;
      document.head.appendChild(style);

      // Hàm cập nhật UI phần trăm - SỬA LẠI
      function updateComparisonElement(statId, percentage) {
        const statElement = document
          .getElementById(statId)
          .closest(".stat-card");
        const comparisonElement = statElement.querySelector(".stat-comparison");
        const iconElement = comparisonElement.querySelector("i");
        const textElement = comparisonElement.querySelector("span");

        // Cập nhật số phần trăm
        const absPercentage = Math.abs(percentage);
        textElement.textContent = `${absPercentage}% so với tuần trước`;

        // Cập nhật màu và icon dựa trên giá trị
        if (percentage > 0) {
          comparisonElement.className = "stat-comparison positive";
          iconElement.className = "fas fa-arrow-up";
        } else if (percentage < 0) {
          comparisonElement.className = "stat-comparison negative";
          iconElement.className = "fas fa-arrow-down";
        } else {
          comparisonElement.className = "stat-comparison";
          iconElement.className = "fas fa-minus";
          textElement.textContent = "0% so với tuần trước";
        }
      }

      // Thêm hàm thống kê theo ban
      function updateDepartmentStats() {
        const departmentStats = {
          MD: { total: 0, completed: 0, inProgress: 0, rejected: 0 },
          HR: { total: 0, completed: 0, inProgress: 0, rejected: 0 },
          PD: { total: 0, completed: 0, inProgress: 0, rejected: 0 },
          ER: { total: 0, completed: 0, inProgress: 0, rejected: 0 },
        };

        // Đếm thống kê theo ban
        applications.forEach((app) => {
          const status = computeOverallStatus(app);

          // Đếm cho ban ưu tiên
          if (app.priority_position && departmentStats[app.priority_position]) {
            departmentStats[app.priority_position].total++;
            if (status === "success")
              departmentStats[app.priority_position].completed++;
            else if (status === "not-pass")
              departmentStats[app.priority_position].rejected++;
            else departmentStats[app.priority_position].inProgress++;
          }

          // Đếm cho ban dự bị (nếu có)
          if (
            app.secondary_position &&
            app.secondary_position !== "None" &&
            departmentStats[app.secondary_position]
          ) {
            departmentStats[app.secondary_position].total++;
            if (status === "success")
              departmentStats[app.secondary_position].completed++;
            else if (status === "not-pass")
              departmentStats[app.secondary_position].rejected++;
            else departmentStats[app.secondary_position].inProgress++;
          }
        });

        // Cập nhật UI cho thống kê ban
        updateDepartmentStatsUI(departmentStats);
      }

      // Cập nhật UI thống kê theo ban
      function updateDepartmentStatsUI(stats) {
        const totalApplicants = applications.length;
        let statsHTML = "";

        Object.keys(stats).forEach((deptCode) => {
          const dept = stats[deptCode];
          if (dept.total > 0) {
            const percentage = Math.round((dept.total / totalApplicants) * 100);
            const icon = getDepartmentIcon(deptCode);

            statsHTML += `
                        <div class="department-stat-card department-${deptCode.toLowerCase()}">
                            <div class="department-stat-header">
                                <div class="department-stat-icon">
                                    <i class="${icon}"></i>
                                </div>
                                <div class="department-stat-title">${getDepartmentName(
                                  deptCode
                                )}</div>
                            </div>
                            <div class="department-stat-value">${
                              dept.total
                            }</div>
                            <div class="department-stat-details">
                                <div class="department-stat-item">
                                    <span class="department-stat-label">Hoàn thành:</span>
                                    <span class="department-stat-count" style="color: var(--success);">${
                                      dept.completed
                                    }</span>
                                </div>
                                <div class="department-stat-item">
                                    <span class="department-stat-label">Đang xử lý:</span>
                                    <span class="department-stat-count" style="color: var(--warning);">${
                                      dept.inProgress
                                    }</span>
                                </div>
                                <div class="department-stat-item">
                                    <span class="department-stat-label">Đã loại:</span>
                                    <span class="department-stat-count" style="color: var(--error);">${
                                      dept.rejected
                                    }</span>
                                </div>
                            </div>
                            <div class="department-stat-progress">
                                <div class="department-stat-progress-bar" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
          }
        });

        // Thêm vào stats container
        const departmentStatsContainer = document.getElementById(
          "department-stats-container"
        );
        if (!departmentStatsContainer) {
          // Tạo container mới nếu chưa có
          const newContainer = document.createElement("div");
          newContainer.id = "department-stats-container";
          newContainer.className = "department-stats-container";
          newContainer.style.marginTop = "20px";
          newContainer.innerHTML = `<h3 style="grid-column: 1 / -1; margin-bottom: 16px; color: var(--gray-700);">Thống kê theo ban</h3>${statsHTML}`;
          document
            .querySelector(".content")
            .insertBefore(newContainer, document.querySelector(".filters"));
        } else {
          departmentStatsContainer.innerHTML = `<h3 style="grid-column: 1 / -1; margin-bottom: 16px; color: var(--gray-700);">Thống kê theo ban</h3>${statsHTML}`;
        }
      }

      // Hàm lấy icon cho từng ban
      function getDepartmentIcon(code) {
        switch (code) {
          case "MD":
            return "fas fa-bullhorn";
          case "HR":
            return "fas fa-users";
          case "PD":
            return "fas fa-project-diagram";
          case "ER":
            return "fas fa-handshake";
          default:
            return "fas fa-building";
        }
      }

      function renderDepartment(code, status) {
        const badgeClass = status
          ? `department-badge ${getStatusClass(status)}`
          : "department-badge department-secondary";
        return `
                <span class="${badgeClass}" style="margin-right: 4px; margin-bottom: 4px; display: inline-block;">
                    ${getDepartmentName(code)}
                </span>
            `;
      }

      // Show application details in modal
      // Hàm hiển thị chi tiết ứng viên (sửa lại)
      function showApplicationDetail(appId) {
        const application = applications.find((app) => app.id === appId);
        if (!application) return;

        currentApplicationId = appId;
        const modalBody = document.getElementById("modal-body");

        // Tạo nội dung modal với tabs
        modalBody.innerHTML = `
    <div class="tabs" id="application-tabs" style="margin: 0; padding: 0 24px;">
      <div class="tab active" data-tab="info">Thông tin cá nhân</div>
      <div class="tab" data-tab="application">Đơn ứng tuyển</div>
      <div class="tab" data-tab="history">Lịch sử vòng</div>
    </div>

    <div id="application-tab-content" style="padding: 24px;">
      <!-- Tab Thông tin cá nhân -->
      <div id="info-tab" class="tab-content active">
        ${renderPersonalInfo(application, false)}
      </div>

      <!-- Tab Đơn ứng tuyển -->
      <div id="application-tab" class="tab-content" style="display: none;">
        <div style="text-align: center; padding: 40px 20px;">
          <i class="fas fa-file-alt" style="font-size: 48px; color: var(--gray-400); margin-bottom: 16px;"></i>
          <h3 style="color: var(--gray-600); margin-bottom: 16px;">Đơn ứng tuyển đầy đủ</h3>
          <p style="color: var(--gray-500); margin-bottom: 24px;">Nhấn nút bên dưới để xem toàn bộ thông tin ứng tuyển và câu trả lời chi tiết</p>
          <button class="action-btn view-btn" id="view-full-application" 
                  style="background-color: var(--info); color: white; padding: 12px 24px; font-size: 16px;">
            <i class="fas fa-external-link-alt" style="margin-right: 8px;"></i>
            Xem đơn ứng tuyển đầy đủ
          </button>
        </div>
      </div>

      <!-- Tab Lịch sử vòng -->
      <div id="history-tab" class="tab-content" style="display: none;">
        ${renderRoundHistory(application)}
      </div>
    </div>
  `;

        // Show modal
        document.getElementById("application-modal").style.display = "flex";

        // Thêm event listeners cho tabs
        setupApplicationTabs();

        // Thêm sự kiện cho nút xem đơn đầy đủ
        document
          .getElementById("view-full-application")
          .addEventListener("click", () => {
            window.open(`response.html?id=${appId}`, "_blank");
          });
      }

      // Hàm render thông tin cá nhân
      function renderPersonalInfo(application, isEditMode = false) {
        if (isEditMode) {
          return `
      <div id="personal-info-edit">
        <h3 style="margin-bottom: 20px; color: var(--gray-800);">
          <i class="fas fa-edit" style="margin-right: 8px;"></i>
          Chỉnh sửa thông tin
        </h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
          <div class="filter-group">
            <label class="filter-label">Họ và tên *</label>
            <input type="text" class="filter-input" id="edit-fullname" value="${
              application.fullname || ""
            }" 
                   style="width: 100%; padding: 10px 12px;">
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Email *</label>
            <input type="email" class="filter-input" id="edit-email" value="${
              application.email || ""
            }" 
                   style="width: 100%; padding: 10px 12px;">
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
          <div class="filter-group">
            <label class="filter-label">Số điện thoại</label>
            <input type="tel" class="filter-input" id="edit-phone" value="${
              application.phone || ""
            }" 
                   style="width: 100%; padding: 10px 12px;">
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
          <div class="filter-group">
            <label class="filter-label">Ban ưu tiên</label>
            <select class="filter-select" id="edit-priority-dept" style="width: 100%;">
              <option value="">Chọn ban</option>
              <option value="MD" ${
                application.priority_position === "MD" ? "selected" : ""
              }>Truyền thông</option>
              <option value="HR" ${
                application.priority_position === "HR" ? "selected" : ""
              }>Nhân sự</option>
              <option value="PD" ${
                application.priority_position === "PD" ? "selected" : ""
              }>Dự án</option>
              <option value="ER" ${
                application.priority_position === "ER" ? "selected" : ""
              }>Đối ngoại</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Ban dự bị</label>
            <select class="filter-select" id="edit-secondary-dept" style="width: 100%;">
              <option value="">Chọn ban</option>
              <option value="None" ${
                !application.secondary_position ||
                application.secondary_position === "None"
                  ? "selected"
                  : ""
              }>Không có</option>
              <option value="MD" ${
                application.secondary_position === "MD" ? "selected" : ""
              }>Truyền thông</option>
              <option value="HR" ${
                application.secondary_position === "HR" ? "selected" : ""
              }>Nhân sự</option>
              <option value="PD" ${
                application.secondary_position === "PD" ? "selected" : ""
              }>Dự án</option>
              <option value="ER" ${
                application.secondary_position === "ER" ? "selected" : ""
              }>Đối ngoại</option>
            </select>
          </div>
        </div>

        <div class="filter-group" style="margin-bottom: 20px;">
          <label class="filter-label">Ghi chú</label>
          <textarea class="filter-input" id="edit-notes" 
                    style="width: 100%; padding: 10px 12px; min-height: 80px; resize: vertical;">${
                      application.notes || ""
                    }</textarea>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
          <button class="action-btn" id="cancel-edit-btn">
            <i class="fas fa-times" style="margin-right: 8px;"></i>
            Hủy
          </button>
          <button class="action-btn view-btn" id="save-edit-btn">
            <i class="fas fa-save" style="margin-right: 8px;"></i>
            Lưu thay đổi
          </button>
        </div>
      </div>
    `;
        } else {
          return `
      <div id="personal-info-view">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
          <div style="display: flex; align-items: center;">
            <div style="width: 80px; height: 80px; border-radius: 50%; background-color: var(--primary); 
                      display: flex; align-items: center; justify-content: center; 
                      font-size: 32px; font-weight: bold; margin-right: 20px;">
              ${
                application.fullname
                  ? application.fullname.charAt(0).toUpperCase()
                  : "U"
              }
            </div>
            <div>
              <h3 style="margin: 0 0 8px 0; color: var(--gray-900);">${
                application.fullname || "Ứng viên"
              }</h3>
              <p style="margin: 0; color: var(--gray-600);">
                <i class="fas fa-envelope" style="margin-right: 8px;"></i>
                ${application.email || "Chưa cung cấp email"}
              </p>
              <p style="margin: 4px 0 0 0; color: var(--gray-600);">
                <i class="fas fa-phone" style="margin-right: 8px;"></i>
                ${application.phone || "Chưa cung cấp SĐT"}
              </p>
            </div>
          </div>
          
          ${
            canEditApplication(application)
              ? `
            <button class="action-btn" id="edit-info-btn" style="align-self: flex-start;">
              <i class="fas fa-edit" style="margin-right: 8px;"></i>
              Chỉnh sửa
            </button>
          `
              : ""
          }
        </div>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 24px;">
          <div class="info-card">
            <h4 style="margin-bottom: 12px; color: var(--gray-700);">
              <i class="fas fa-user-tag" style="margin-right: 8px;"></i>
              Thông tin ứng tuyển
            </h4>
            <div class="info-item">
              <span class="info-label">Ban ưu tiên:</span>
              <span class="info-value">${getDepartmentName(
                application.priority_position
              )}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Ban dự bị:</span>
              <span class="info-value">
                ${
                  application.secondary_position &&
                  application.secondary_position !== "None"
                    ? getDepartmentName(application.secondary_position)
                    : "Không có"
                }
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">Loại đơn:</span>
              <span class="info-value">
                <span class="status-badge ${
                  application.application_type === "interview"
                    ? "status-interviewed"
                    : "status-pending"
                }">
                  ${
                    application.application_type === "interview"
                      ? "Phỏng vấn"
                      : "Form"
                  }
                </span>
              </span>
            </div>
          </div>

          <div class="info-card">
            <h4 style="margin-bottom: 12px; color: var(--gray-700);">
              <i class="fas fa-chart-line" style="margin-right: 8px;"></i>
              Trạng thái hiện tại
            </h4>
            <div class="info-item">
              <span class="info-label">Vòng hiện tại:</span>
              <span class="info-value">${getRoundText(
                application.current_round
              )}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Trạng thái:</span>
              <span class="info-value">
                <span class="status-badge ${getStatusClass(
                  computeOverallStatus(application)
                )}">
                  ${getStatusText(computeOverallStatus(application))}
                </span>
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">Thời gian apply:</span>
              <span class="info-value">${formatApplicationTime(
                application.timestamp
              )}</span>
            </div>
            ${
              application.notification_sent
                ? `
            <div class="info-item">
              <span class="info-label">Đã gửi thông báo:</span>
              <span class="info-value" style="color: var(--success);">
                <i class="fas fa-check-circle" style="margin-right: 4px;"></i>
                Đã gửi
              </span>
            </div>
            `
                : ""
            }
          </div>
        </div>

        ${
          application.notes
            ? `
        <div class="info-card">
          <h4 style="margin-bottom: 12px; color: var(--gray-700);">
            <i class="fas fa-sticky-note" style="margin-right: 8px;"></i>
            Ghi chú
          </h4>
          <div style="padding: 12px; background: var(--gray-50); border-radius: 8px; color: var(--gray-700);">
            ${application.notes}
          </div>
        </div>
        `
            : ""
        }
      </div>

      <style>
        .info-card {
          background: var(--white);
          border: 1px solid var(--gray-200);
          border-radius: 12px;
          padding: 20px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .info-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 0;
          border-bottom: 1px solid var(--gray-100);
        }
        
        .info-item:last-child {
          border-bottom: none;
        }
        
        .info-label {
          font-weight: 500;
          color: var(--gray-600);
          font-size: 14px;
        }
        
        .info-value {
          color: var(--gray-800);
          font-weight: 500;
          text-align: right;
        }
      </style>
    `;
        }
      }

      // Hàm render lịch sử vòng
      function renderRoundHistory(application) {
        const rounds = [
          { name: "Vòng 1: Đơn", status: computeRound1Status(application) },
          {
            name: "Vòng 2: Phỏng vấn nhóm",
            status: computeRound2Status(application),
          },
          {
            name: "Vòng 3: Teamwork",
            status: computeRound3Status(application),
          },
          {
            name: "Vòng 4: Phỏng vấn cá nhân",
            status: computeRound4Status(application),
          },
          {
            name: "Thành viên chính thức",
            status:
              application.current_round === "success" ? "success" : "pending",
          },
        ];

        let html = `
    <h3 style="margin-bottom: 20px; color: var(--gray-800);">
      <i class="fas fa-history" style="margin-right: 8px;"></i>
      Lịch sử các vòng tuyển dụng
    </h3>
    
    <div style="display: flex; flex-direction: column; gap: 12px;">
  `;

        rounds.forEach((round, index) => {
          const isCurrent =
            application.current_round === `round${index + 1}` ||
            (application.current_round === "success" && index === 4);

          html += `
      <div class="round-history-item ${isCurrent ? "current" : ""}">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="round-number ${
            round.status !== "pending" ? "completed" : ""
          }">
            ${index + 1}
          </div>
          <div style="flex: 1;">
            <div style="font-weight: 500; margin-bottom: 4px;">${
              round.name
            }</div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span class="status-badge ${getStatusClass(round.status)}">
                ${getStatusText(round.status)}
              </span>
              ${isCurrent ? '<span class="current-badge">Hiện tại</span>' : ""}
            </div>
          </div>
        </div>
      </div>
    `;
        });

        html += `</div>`;

        // Thêm CSS
        html += `
    <style>
      .round-history-item {
        padding: 16px;
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        transition: all 0.3s ease;
      }
      
      .round-history-item.current {
        border-color: var(--info);
        background: var(--info-light);
      }
      
      .round-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--gray-200);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--gray-600);
      }
      
      .round-number.completed {
        background: var(--success);
        color: var(--white);
      }
      
      .current-badge {
        background: var(--info);
        color: var(--white);
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
      }
    </style>
  `;

        return html;
      }

      // Hàm thiết lập tabs
      function setupApplicationTabs() {
        const tabs = document.querySelectorAll("#application-tabs .tab");
        const tabContents = document.querySelectorAll(
          "#application-tab-content .tab-content"
        );

        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            // Remove active class from all tabs and contents
            tabs.forEach((t) => t.classList.remove("active"));
            tabContents.forEach((c) => (c.style.display = "none"));

            // Add active class to clicked tab
            tab.classList.add("active");

            // Show corresponding content
            const tabName = tab.getAttribute("data-tab");
            document.getElementById(`${tabName}-tab`).style.display = "block";
          });
        });

        // Thêm event listener cho nút chỉnh sửa
        const editBtn = document.getElementById("edit-info-btn");
        if (editBtn) {
          editBtn.addEventListener("click", () => {
            const application = applications.find(
              (app) => app.id === currentApplicationId
            );
            if (application) {
              document.getElementById("info-tab").innerHTML =
                renderPersonalInfo(application, true);
              setupEditForm();
            }
          });
        }
      }

      // Hàm thiết lập form chỉnh sửa
      function setupEditForm() {
        // Cancel button
        document
          .getElementById("cancel-edit-btn")
          .addEventListener("click", () => {
            const application = applications.find(
              (app) => app.id === currentApplicationId
            );
            if (application) {
              document.getElementById("info-tab").innerHTML =
                renderPersonalInfo(application, false);
              setupApplicationTabs(); // Re-setup tabs và event listeners
            }
          });

        // Save button
        document
          .getElementById("save-edit-btn")
          .addEventListener("click", async () => {
            await saveApplicationChanges();
          });
      }

      // Hàm lưu thay đổi
      async function saveApplicationChanges() {
        const application = applications.find(
          (app) => app.id === currentApplicationId
        );
        if (!application) return;

        const updates = {
          fullname: document.getElementById("edit-fullname").value,
          email: document.getElementById("edit-email").value,
          phone: document.getElementById("edit-phone").value,
          priority_position:
            document.getElementById("edit-priority-dept").value,
          secondary_position: document.getElementById("edit-secondary-dept")
            .value,
          notes: document.getElementById("edit-notes").value,
          updated_at: new Date(),
        };

        // Validate required fields
        if (!updates.fullname || !updates.email) {
          alert("Vui lòng điền đầy đủ họ tên và email");
          return;
        }

        try {
          await db
            .collection("applications")
            .doc(currentApplicationId)
            .update(updates);

          // Cập nhật local data
          Object.assign(application, updates);

          alert("✅ Đã cập nhật thông tin ứng viên thành công!");

          // Quay lại chế độ xem
          document.getElementById("info-tab").innerHTML = renderPersonalInfo(
            application,
            false
          );
          setupApplicationTabs();

          // Refresh applications list
          refreshApplications();
        } catch (error) {
          console.error("Lỗi khi cập nhật ứng viên:", error);
          alert("❌ Lỗi khi cập nhật: " + error.message);
        }
      }

      // Các hàm helper để tính trạng thái từng vòng
      function computeRound1Status(app) {
        if (app.priority_status === "pass" || app.secondary_status === "pass")
          return "pass";
        if (
          app.priority_status === "not-pass" &&
          app.secondary_status === "not-pass"
        )
          return "not-pass";
        return app.priority_status || app.secondary_status || "pending";
      }

      function computeRound2Status(app) {
        if (
          app.round2_priority_status === "pass" ||
          app.round2_secondary_status === "pass"
        )
          return "pass";
        if (
          app.round2_priority_status === "not-pass" &&
          app.round2_secondary_status === "not-pass"
        )
          return "not-pass";
        return (
          app.round2_priority_status || app.round2_secondary_status || "pending"
        );
      }

      function computeRound3Status(app) {
        if (
          app.round3_priority_status === "pass" ||
          app.round3_secondary_status === "pass"
        )
          return "pass";
        if (
          app.round3_priority_status === "not-pass" &&
          app.round3_secondary_status === "not-pass"
        )
          return "not-pass";
        return (
          app.round3_priority_status || app.round3_secondary_status || "pending"
        );
      }

      function computeRound4Status(app) {
        if (
          app.round4_priority_status === "pass" ||
          app.round4_secondary_status === "pass"
        )
          return "pass";
        if (
          app.round4_priority_status === "not-pass" &&
          app.round4_secondary_status === "not-pass"
        )
          return "not-pass";
        return (
          app.round4_priority_status || app.round4_secondary_status || "pending"
        );
      }

      // Helper functions
      // Kiểm tra admin có quyền chỉnh cho ứng viên cụ thể không
      function canEditApplication(app) {
        if (userRole === "superadmin") return true;
        if (userRole === "admin") {
          // admin chỉ thao tác nếu là ban priority hoặc secondary hoặc all_departments chứa userDept
          const p = app.priority_position;
          const s = app.secondary_position;
          const arr = Array.isArray(app.all_departments)
            ? app.all_departments
            : [];
          return p === userDept || s === userDept || arr.includes(userDept);
        }
        return false; // member không được chỉnh
      }

      // Kiểm tra admin có quyền chỉnh riêng 1 ban (priority/secondary) không
      function canEditBan(app, banType) {
        // banType = 'priority' hoặc 'secondary'
        if (userRole === "superadmin") return true;
        if (userRole === "admin") {
          const dept =
            banType === "priority"
              ? app.priority_position
              : app.secondary_position;
          const arr = Array.isArray(app.all_departments)
            ? app.all_departments
            : [];
          return dept === userDept || arr.includes(userDept);
        }
        return false;
      }

      function getDepartmentName(code) {
        switch (code) {
          case "MD":
            return "Truyền thông";
          case "HR":
            return "Nhân sự";
          case "PD":
            return "Dự án";
          case "ER":
            return "Đối ngoại";
          default:
            return code;
        }
      }

      function getRoundText(round) {
        switch (round) {
          case "round1":
            return "Vòng 1: Đơn";
          case "round2":
            return "Vòng 2: Phỏng vấn nhóm";
          case "round3":
            return "Vòng 3: Teamwork";
          case "round4":
            return "Vòng 4: Phỏng vấn cá nhân";
          case "success":
            return "Thành viên chính thức";
          default:
            return "Chưa xác định";
        }
      }

      function getDeptStatusForRound(app, type /* 'priority'|'secondary' */) {
        // Trả về trạng thái per-dept theo vòng hiện tại nhưng fallback về vòng trước nếu không tồn tại
        const round = app.current_round || "round1";

        // thứ tự ưu tiên lấy trạng thái (từ mới -> cũ)
        let keys = [];
        if (round === "round4") {
          keys = [
            `round4_${type}_status`,
            `round3_${type}_status`,
            `round2_${type}_status`,
            `${type}_status`,
          ];
        } else if (round === "round3") {
          keys = [
            `round3_${type}_status`,
            `round2_${type}_status`,
            `${type}_status`,
          ];
        } else if (round === "round2") {
          keys = [`round2_${type}_status`, `${type}_status`];
        } else {
          keys = [`${type}_status`];
        }

        for (const k of keys) {
          if (app[k]) return app[k];
        }

        // Nếu code lưu trạng thái nested (ví dụ round2: { priority: { status: 'pass' } }), cố gắng đọc nested
        try {
          if (
            round === "round2" &&
            app.round2 &&
            app.round2[type] &&
            app.round2[type].status
          )
            return app.round2[type].status;
          if (
            round === "round3" &&
            app.round3 &&
            app.round3[type] &&
            app.round3[type].status
          )
            return app.round3[type].status;
          if (
            round === "round4" &&
            app.round4 &&
            app.round4[type] &&
            app.round4[type].status
          )
            return app.round4[type].status;
        } catch (e) {
          // ignore
        }

        return null;
      }

      function getStatusClass(status) {
        switch (status) {
          case "new":
            return "status-new";
          case "pending":
            return "status-pending";
          case "pass":
            return "status-pass";
          case "not-pass":
            return "status-not-pass";
          case "interviewed":
            return "status-interviewed";
          case "voted":
            return "status-voted";
          case "success":
            return "status-success"; // ✅ thêm mới
          default:
            return "status-pending";
        }
      }

      function getStatusText(status) {
        switch (status) {
          case "new":
            return "New";
          case "pending":
            return "Pending";
          case "pass":
            return "Pass";
          case "not-pass":
            return "Not pass";
          case "interviewed":
            return "Interviewed";
          case "voted":
            return "Voted";
          case "success":
            return "Success";
          default:
            return status;
        }
      }

      function computeOverallStatus(application) {
        const round = application.current_round || "round1";

        // nếu đã là thành viên chính thức thì ưu tiên trả về success
        if (round === "success" || application.status === "success") {
          return "success";
        }

        // lấy trạng thái per-dept theo vòng
        const p = getDeptStatusForRound(application, "priority");
        const s = getDeptStatusForRound(application, "secondary");

        // trạng thái global/nested cho vòng hiện tại (round2.status, round3.status...)
        const perRoundStatus = application[`${round}_status`] || null;

        // nếu có trạng thái đặc thù (voted/interviewed) -> trả trực tiếp
        if (perRoundStatus === "voted" || perRoundStatus === "interviewed")
          return perRoundStatus;

        // nếu 1 trong 2 ban pass -> tổng là pass
        if (p === "pass" || s === "pass") return "pass";

        // nếu cả 2 ban not-pass -> tổng là not-pass
        if (
          (p === "not-pass" && s === "not-pass") ||
          (p === "not-pass" && !s) ||
          (!p && s === "not-pass")
        )
          return "not-pass";

        // nếu perRoundStatus explicit pass/not-pass -> dùng nó
        if (perRoundStatus === "pass" || perRoundStatus === "not-pass")
          return perRoundStatus;

        // default:
        if (round === "round1") return application.status || "new";
        return "pending";
      }

      function renderSuccess() {
        const tbody = document.getElementById("success-table-body");
        tbody.innerHTML = "";

        const filteredApps = filterSuccessApplications();

        filteredApps.forEach((app) => {
          if (app.current_round !== "success") return;

          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td>${app.fullname}</td>
                    <td>${app.email}</td>
                    <td>${app.phone || ""}</td>
                    <td>${getDepartmentName(app.final_department)}</td>
                    <td>
                        <button class="action-btn view-btn" data-id="${
                          app.id
                        }">Xem</button>
                    </td>
                `;
          tbody.appendChild(tr);
        });

        // Thêm event listeners cho nút xem
        tbody.querySelectorAll(".view-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const appId = e.target.getAttribute("data-id");
            showApplicationDetail(appId);
          });
        });
      }

      // Export data functions (simplified for demo)

      function exportData(type) {
        alert(
          `Chức năng xuất dữ liệu ${type} sẽ được thực hiện ở phiên bản hoàn thiện.`
        );
        document.getElementById("export-modal").style.display = "none";
      }

      function exportDepartmentData() {
        const dept = document.getElementById("export-department").value;
        alert(
          `Chức năng xuất dữ liệu cho ban ${getDepartmentName(
            dept
          )} sẽ được thực hiện ở phiên bản hoàn thiện.`
        );
        document.getElementById("export-modal").style.display = "none";
      }

      // Event listeners
      document.getElementById("logout-btn").addEventListener("click", () => {
        auth.signOut().then(() => {
          sessionStorage.clear();
          window.location.href = "login.html";
        });
      });

      document
        .getElementById("reset-rounds-btn")
        ?.addEventListener("click", async () => {
          if (userRole !== "superadmin") {
            alert("Chỉ superadmin mới có quyền reset dữ liệu vòng.");
            return;
          }

          if (
            !confirm(
              "⚠️ Bạn có chắc muốn reset toàn bộ dữ liệu vòng? (Dữ liệu form ứng viên sẽ giữ nguyên)"
            )
          ) {
            return;
          }

          try {
            const snapshot = await db.collection("applications").get();
            const batch = db.batch();

            snapshot.forEach((doc) => {
              const data = doc.data();

              // Giữ lại thông tin cá nhân, answers
              const newData = {
                fullname: data.fullname || null,
                email: data.email || null,
                phone: data.phone || null,
                answers: data.answers || {},
                priority_position: data.priority_position || null,
                secondary_position: data.secondary_position || null,
                timestamp:
                  data.timestamp ||
                  firebase.firestore.FieldValue.serverTimestamp(),

                // Reset toàn bộ dữ liệu vòng
                current_round: "round1",
                status: "new",
              };

              batch.set(doc.ref, newData, { merge: true });
            });

            await batch.commit();
            alert("✅ Đã reset dữ liệu vòng cho tất cả ứng viên!");
            loadApplications(); // refresh lại bảng
          } catch (error) {
            console.error("Lỗi khi reset vòng:", error);
            alert("❌ Lỗi khi reset vòng: " + error.message);
          }
        });

      document
        .getElementById("update-round-btn")
        ?.addEventListener("click", async () => {
          const newRoundStr = prompt(
            "Bạn muốn chuyển tất cả ứng viên pass sang vòng mấy? (vd: 2,3,4, success)"
          );
          if (!newRoundStr) return;

          let newRound = newRoundStr.toLowerCase();
          if (["2", "3", "4"].includes(newRound)) {
            newRound = parseInt(newRound);
          } else if (newRound !== "success") {
            alert("Chỉ hỗ trợ nhập 2, 3, 4 hoặc success.");
            return;
          }

          if (
            !confirm(
              `⚠️ Bạn có chắc muốn chuyển TẤT CẢ ứng viên đã pass sang vòng ${newRound}?`
            )
          )
            return;

          try {
            const snapshot = await db.collection("applications").get();
            const batch = db.batch();
            let updatedCount = 0;

            snapshot.forEach((doc) => {
              const data = doc.data();

              // Nếu đang là admin, chỉ thao tác những app thuộc dept họ
              if (userRole === "admin") {
                const belongs =
                  data.priority_position === userDept ||
                  data.secondary_position === userDept ||
                  (Array.isArray(data.all_departments) &&
                    data.all_departments.includes(userDept));
                if (!belongs) return; // skip
              }

              const tempApp = {
                ...data,
                priority_status: data.priorityAccepted
                  ? "pass"
                  : data.priorityRejected
                  ? "not-pass"
                  : (data.round1 && data.round1.priority_status) || null,
                secondary_status: data.secondaryAccepted
                  ? "pass"
                  : data.secondaryRejected
                  ? "not-pass"
                  : (data.round1 && data.round1.secondary_status) || null,
                round2_priority_status: data.round2_priority_status || null,
                round2_secondary_status: data.round2_secondary_status || null,
                round3_priority_status: data.round3_priority_status || null,
                round3_secondary_status: data.round3_secondary_status || null,
                round4_priority_status: data.round4_priority_status || null,
                round4_secondary_status: data.round4_secondary_status || null,
                current_round: data.current_round || "round1",
              };

              if (computeOverallStatus(tempApp) === "pass") {
                const updates = {};

                if (newRound === 2) {
                  updates["current_round"] = "round2";
                  updates["status"] = "in-progress";
                  if (tempApp.priority_status === "pass")
                    updates["round2_priority_status"] = "pending";
                  if (tempApp.secondary_status === "pass")
                    updates["round2_secondary_status"] = "pending";
                }

                if (newRound === 3) {
                  updates["current_round"] = "round3";
                  updates["status"] = "in-progress";
                  if (tempApp.round2_priority_status === "pass")
                    updates["round3_priority_status"] = "pending";
                  if (tempApp.round2_secondary_status === "pass")
                    updates["round3_secondary_status"] = "pending";
                }

                if (newRound === 4) {
                  updates["current_round"] = "round4";
                  updates["status"] = "in-progress";
                  if (tempApp.round3_priority_status === "pass")
                    updates["round4_priority_status"] = "pending";
                  if (tempApp.round3_secondary_status === "pass")
                    updates["round4_secondary_status"] = "pending";
                }

                if (newRound === "success") {
                  let finalDept = null;
                  if (tempApp.round4_priority_status === "pass") {
                    finalDept = data.priority_position;
                  } else if (tempApp.round4_secondary_status === "pass") {
                    finalDept = data.secondary_position;
                  }

                  if (finalDept) {
                    updates["current_round"] = "success";
                    updates["status"] = "success";
                    updates["final_department"] = finalDept;
                  }
                }

                // chỉ update nếu có thay đổi hợp lệ
                if (Object.keys(updates).length > 0) {
                  batch.update(doc.ref, updates);
                  updatedCount++;
                }
              }
            });

            await batch.commit();
            alert(
              `✅ Đã cập nhật ${updatedCount} ứng viên pass sang vòng ${newRound}`
            );
            loadApplications();
          } catch (error) {
            console.error("Lỗi khi cập nhật vòng:", error);
            alert("❌ Lỗi khi cập nhật vòng: " + error.message);
          }
        });

      document.getElementById("refresh-btn").addEventListener("click", () => {
        refreshApplications(); // THAY loadApplications() BẰNG refreshApplications()
      });

      document.getElementById("export-btn").addEventListener("click", () => {
        document.getElementById("export-modal").style.display = "flex";
      });

      document.getElementById("modal-close").addEventListener("click", () => {
        document.getElementById("application-modal").style.display = "none";
      });

      document
        .getElementById("export-modal-close")
        .addEventListener("click", () => {
          document.getElementById("export-modal").style.display = "none";
        });

      // Filter event listeners
      document
        .getElementById("filter-department")
        .addEventListener("change", renderApplications);
      document
        .getElementById("filter-round")
        .addEventListener("change", renderApplications);
      document
        .getElementById("filter-status")
        .addEventListener("change", renderApplications);
      document
        .getElementById("search-input")
        .addEventListener("input", renderApplications);

      // Tab switching - sửa lại
      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", () => {
          const tab = item.getAttribute("data-tab");
          if (!tab) return;

          // reset active
          document
            .querySelectorAll(".nav-item")
            .forEach((i) => i.classList.remove("active"));
          item.classList.add("active");

          // đổi tiêu đề
          document.getElementById("page-title").textContent =
            item.querySelector("span").textContent;

          // ẩn tất cả nội dung
          document
            .querySelectorAll(".round-content")
            .forEach((c) => (c.style.display = "none"));
          document
            .querySelectorAll(".main-dashboard")
            .forEach((c) => (c.style.display = "none"));

          // hiển thị nội dung phù hợp
          if (tab === "dashboard") {
            document
              .querySelectorAll(".main-dashboard")
              .forEach((c) => (c.style.display = "block"));
            renderApplications();
          } else {
            // Hiển thị nội dung vòng tương ứng
            document.getElementById(tab + "-content").style.display = "block";

            // Gọi hàm render tương ứng
            if (tab === "round1") renderRound1();
            if (tab === "round2") renderRound2();
            if (tab === "round3") renderRound3();
            if (tab === "round4") renderRound4();
            if (tab === "success") renderSuccess();
          }
        });
      });

      // Thêm vào cuối phần event listeners
      document
        .getElementById("archive-apps-btn")
        .addEventListener("click", openArchiveModal);

      // Khởi tạo tabs khi modal được mở
      document
        .getElementById("archive-apps-btn")
        .addEventListener("click", () => {
          openArchiveModal();
          setTimeout(setupArchiveModalTabs, 100); // Đảm bảo DOM đã render
        });

      function applyFiltersToCurrentTab() {
        const activeTab = document
          .querySelector(".nav-item.active")
          .getAttribute("data-tab");

        switch (activeTab) {
          case "dashboard":
            renderApplications();
            break;
          case "round1":
            renderRound1();
            break;
          case "round2":
            renderRound2();
            break;
          case "round3":
            renderRound3();
            break;
          case "round4":
            renderRound4();
            break;
          case "success":
            renderSuccess();
            break;
        }
        updateStats();
      }

      // Gắn event cho tất cả filter
      document
        .getElementById("filter-department")
        .addEventListener("change", applyFiltersToCurrentTab);
      document
        .getElementById("filter-round")
        .addEventListener("change", applyFiltersToCurrentTab);
      document
        .getElementById("filter-status")
        .addEventListener("change", applyFiltersToCurrentTab);
      document
        .getElementById("search-input")
        .addEventListener("input", applyFiltersToCurrentTab);

      // Initialize UI
      updateUserInfo(userEmail, userRole, userDept);
      applyRoleUIRules();
    </script>
  </body>
</html>
