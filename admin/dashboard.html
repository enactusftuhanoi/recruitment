<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Enactus FTU Hanoi Recruitment</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Clash+Display:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root {
            --primary: #F8F3CE;
            --primary-light: #FFD54F;
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --white: #FFFFFF;
            --error: #EF4444;
            --error-light: #FEE2E2;
            --success: #10B981;
            --success-light: #D1FAE5;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --info: #3B82F6;
            --info-light: #DBEAFE;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        body {
            background-color: var(--gray-50);
            color: var(--gray-800);
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--white);
            box-shadow: var(--shadow);
            padding: 24px 0;
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: var(--transition);
        }

        .logo {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 24px;
        }

        .logo img {
            height: 60px;
            width: auto;
            display: block;
            margin: 0 auto;
        }

        .nav-menu {
            flex: 1;
        }

        .nav-item {
            padding: 12px 24px;
            display: flex;
            align-items: center;
            color: var(--gray-600);
            text-decoration: none;
            transition: var(--transition);
            margin-bottom: 4px;
            cursor: pointer;
        }

        .nav-item:hover, .nav-item.active {
            background-color: var(--primary);
            color: var(--gray-900);
        }

        .nav-item i {
            margin-right: 12px;
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .nav-item span {
            font-weight: 500;
        }

        .user-section {
            padding: 16px 24px;
            border-top: 1px solid var(--gray-200);
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--gray-800);
        }

        .user-role {
            font-size: 12px;
            color: var(--gray-500);
        }

        .logout-btn {
            width: 100%;
            padding: 10px;
            background-color: var(--gray-100);
            border: none;
            border-radius: var(--border-radius);
            color: var(--gray-700);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logout-btn:hover {
            background-color: var(--error-light);
            color: var(--error);
        }

        .logout-btn i {
            margin-right: 8px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background-color: var(--white);
            padding: 16px 24px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }

        .page-title {
            font-family: 'Clash Display', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .refresh-btn, .export-btn {
            padding: 8px 16px;
            background-color: var(--gray-100);
            border: none;
            border-radius: var(--border-radius);
            color: var(--gray-700);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }

        .refresh-btn:hover, .export-btn:hover {
            background-color: var(--gray-200);
        }

        .refresh-btn i, .export-btn i {
            margin-right: 8px;
        }

        .reset-btn {
            padding: 8px 16px;
            background-color: var(--error-light);
            border: none;
            border-radius: var(--border-radius);
            color: var(--error);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }
        .reset-btn:hover {
            background-color: var(--error);
            color: var(--white);
        }
        .reset-btn i {
            margin-right: 8px;
        }

        .update-all-rounds-btn {
            padding: 8px 16px;
            background-color: var(--primary-light);
            border: none;
            border-radius: var(--border-radius);
            color: var(--primary);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }
        .update-all-rounds-btn:hover {
            background-color: var(--primary);
            color: var(--white);
        }
        .update-all-rounds-btn i {
            margin-right: 8px;
        }

        /* Content */
        .content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        /* Stats */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        .stat-title {
            font-size: 14px;
            color: var(--gray-500);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 8px;
        }

        .stat-comparison {
            font-size: 12px;
            display: flex;
            align-items: center;
        }

        .stat-comparison.positive {
            color: var(--success);
        }

        .stat-comparison.negative {
            color: var(--error);
        }

        /* Filters */
        .filters {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--gray-700);
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 14px;
            background-color: var(--white);
            color: var(--gray-800);
        }

        .filter-input {
            display: flex;
            align-items: center;
        }

        .filter-input input {
            flex: 1;
            border: none;
            outline: none;
            padding: 0;
            margin-left: 8px;
        }

        /* Table */
        .table-container {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .applications-table {
            width: 100%;
            border-collapse: collapse;
        }

        .applications-table th {
            background-color: var(--gray-100);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 14px;
            border-bottom: 1px solid var(--gray-200);
        }

        .applications-table td {
            padding: 16px;
            border-bottom: 1px solid var(--gray-200);
            font-size: 14px;
            color: var(--gray-700);
        }

        .applications-table tr:last-child td {
            border-bottom: none;
        }

        .applications-table tr:hover {
            background-color: var(--gray-50);
        }

        .applicant-info {
            display: flex;
            align-items: center;
        }

        .applicant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--gray-800);
        }

        .applicant-details {
            flex: 1;
        }

        .applicant-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .applicant-contact {
            font-size: 12px;
            color: var(--gray-500);
        }

        .app-input {
          width: 100%;
          padding: 6px 10px;
          border: 1px solid var(--gray-300);
          border-radius: var(--border-radius);
          font-size: 14px;
        }

        .app-select {
          width: 100%;
          padding: 6px 10px;
          border: 1px solid var(--gray-300);
          border-radius: var(--border-radius);
          font-size: 14px;
          background: #fff;
        }

        .department-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 4px;
        }

        .department-priority {
            background-color: var(--info-light);
            color: var(--info);
        }

        .department-secondary {
            background-color: var(--gray-100);
            color: var(--gray-600);
        }

        /* Department badge color by status */
        .department-badge.status-pass {
            background-color: var(--success-light);
            color: var(--success);
        }
        .department-badge.status-not-pass {
            background-color: var(--error-light);
            color: var(--error);
        }
        .department-badge.status-pending {
            background-color: var(--warning-light);
            color: var(--warning);
        }
        .department-badge.status-voted {
            background-color: var(--primary);
            color: var(--gray-800);
        }
        .department-badge.status-interviewed {
            background-color: var(--info-light);
            color: var(--info);
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-new {
            background-color: var(--info-light);
            color: var(--info);
        }

        .status-pending {
            background-color: var(--warning-light);
            color: var(--warning);
        }

        .status-pass {
            background-color: var(--success-light);
            color: var(--success);
        }

        .status-not-pass {
            background-color: var(--error-light);
            color: var(--error);
        }

        .status-interviewed {
            background-color: var(--info-light);
            color: var(--info);
        }

        .status-voted {
            background-color: var(--primary);
            color: var(--gray-800);
        }
        
        .status-success {
          background-color: rgb(252, 217, 15);
          color: rgba(30, 30, 30, 0.692);
          font-weight: bold;
          padding: 4px 8px;
          border-radius: 12px;
        }

        .action-btn {
            padding: 6px 12px;
            background-color: var(--gray-100);
            border: none;
            border-radius: var(--border-radius);
            color: var(--gray-700);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .action-btn:hover {
            background-color: var(--gray-200);
        }

        .view-btn {
            background-color: var(--info-light);
            color: var(--info);
        }

        .view-btn:hover {
            background-color: var(--info);
            color: var(--white);
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 2px solid transparent;
        }

        .tab:hover {
            color: var(--gray-800);
        }

        .tab.active {
            color: var(--info);
            border-bottom: 2px solid var(--info);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--white);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-500);
        }

        .modal-body {
            padding: 24px;
        }

        .row-disabled {
          opacity: 0.55;
          pointer-events: auto; /* v·∫´n cho copy text, nh∆∞ng inputs b√™n trong disabled */
          background: #fafafa;
        }

        /* ƒë·∫£m b·∫£o input disabled tr√¥ng kh√°c */
        .row-disabled .app-input[disabled],
        .row-disabled .app-select[disabled] {
          background: #f5f5f5;
          color: #888;
          border-color: #e5e5e5;
        }
        .row-disabled .save-btn[disabled] {
          opacity: 0.6;
          cursor: not-allowed;
        }

        /* C·∫£i thi·ªán giao di·ªán th·ªëng k√™ ban */
        .department-stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .department-stat-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            border-top: 4px solid var(--primary);
            transition: var(--transition);
        }
        
        .department-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .department-stat-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .department-stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
        }
        
        .department-stat-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-800);
        }
        
        .department-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }
        
        .department-stat-details {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 8px;
        }
        
        .department-stat-item {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }
        
        .department-stat-label {
            color: var(--gray-500);
        }
        
        .department-stat-count {
            font-weight: 500;
        }
        
        .department-stat-progress {
            height: 6px;
            background-color: var(--gray-200);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .department-stat-progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        /* M√†u s·∫Øc cho t·ª´ng ban */
        .department-md .department-stat-icon { background-color: rgba(59, 130, 246, 0.1); color: #3B82F6; }
        .department-md .department-stat-progress-bar { background-color: #3B82F6; }
        
        .department-hr .department-stat-icon { background-color: rgba(16, 185, 129, 0.1); color: #10B981; }
        .department-hr .department-stat-progress-bar { background-color: #10B981; }
        
        .department-pd .department-stat-icon { background-color: rgba(245, 158, 11, 0.1); color: #F59E0B; }
        .department-pd .department-stat-progress-bar { background-color: #F59E0B; }
        
        .department-er .department-stat-icon { background-color: rgba(139, 92, 246, 0.1); color: #8B5CF6; }
        .department-er .department-stat-progress-bar { background-color: #8B5CF6; }

        @media (max-width: 1024px) {
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {s
            .stats-container {
                grid-template-columns: 1fr;
            }
        }

        /* CSS cho th·ªëng k√™ ban */
        .department-stats-header {
            grid-column: 1 / -1;
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 16px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 8px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
            }
            
            .nav-item span {
                display: none;
            }
            
            .user-details {
                display: none;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <img src="/assets/logo_den.png" alt="Enactus FTU Hanoi Logo">
        </div>
        
        <div class="nav-menu">
            <div class="nav-item active" data-tab="dashboard">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </div>
            <div class="nav-item system-settings-menu" style="display: none;" onclick="window.location.href='response.html'">
                <i class="fas fa-folder-open"></i>
                <span>Response</span>
            </div>
            <div class="nav-item" data-tab="round1">
                <i class="fas fa-file-alt"></i>
                <span>V√≤ng 1: ƒê∆°n</span>
            </div>
            <div class="nav-item" data-tab="round2">
                <i class="fas fa-users"></i>
                <span>V√≤ng 2: Ph·ªèng v·∫•n nh√≥m</span>
            </div>
            <div class="nav-item" data-tab="round3">
                <i class="fas fa-tasks"></i>
                <span>V√≤ng 3: Teamwork</span>
            </div>
            <div class="nav-item" data-tab="round4">
                <i class="fas fa-user-circle"></i>
                <span>V√≤ng 4: Ph·ªèng v·∫•n c√° nh√¢n</span>
            </div>
            <div class="nav-item" data-tab="success">
                <i class="fas fa-trophy"></i>
                <span>Th√†nh vi√™n ch√≠nh th·ª©c</span>
            </div>
            <div class="nav-item system-settings-menu" style="display: none;" onclick="window.location.href='calendar.html'">
                <i class="fa-solid fa-calendar-days"></i>
                <span>Calendar</span>
            </div>
            <div class="nav-item system-settings-menu" style="display: none;" onclick="window.location.href='accounts.html'">
                <i class="fas fa-cog"></i>
                <span>C·∫•p quy·ªÅn</span>
            </div>
        </div>
        
        <div class="user-section">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">U</div>
                <div class="user-details">
                    <div class="user-name" id="user-name">User Name</div>
                    <div class="user-role" id="user-role">Role ‚Ä¢ Department</div>
                </div>
            </div>
            <button class="logout-btn" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                ƒêƒÉng xu·∫•t
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <h1 class="page-title" id="page-title">Dashboard</h1>
            <div class="header-actions">
                <button class="reset-btn" id="reset-rounds-btn">
                    <i class="fas fa-undo"></i>
                    Reset d·ªØ li·ªáu v√≤ng
                </button>
                <button class="update-all-rounds-btn" id="update-round-btn">
                    <i class="fas fa-level-up-alt"></i>
                    C·∫≠p nh·∫≠t v√≤ng
                </button>
                <button class="refresh-btn" id="refresh-btn">
                    <i class="fas fa-sync-alt"></i>
                    L√†m m·ªõi
                </button>
                <button class="export-btn" id="export-btn">
                    <i class="fas fa-download"></i>
                    Xu·∫•t file
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Stats -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-title">T·ªïng s·ªë ·ª©ng vi√™n</div>
                    <div class="stat-value" id="total-applicants">0</div>
                    <div class="stat-comparison positive" id="total-comparison">
                        <i class="fas fa-arrow-up"></i>
                        <span>0% so v·ªõi tu·∫ßn tr∆∞·ªõc</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ƒê√£ ho√†n th√†nh</div>
                    <div class="stat-value" id="completed-applicants">0</div>
                    <div class="stat-comparison positive" id="completed-comparison">
                        <i class="fas fa-arrow-up"></i>
                        <span>0% so v·ªõi tu·∫ßn tr∆∞·ªõc</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ƒêang trong qu√° tr√¨nh</div>
                    <div class="stat-value" id="inprogress-applicants">0</div>
                    <div class="stat-comparison negative" id="inprogress-comparison">
                        <i class="fas fa-arrow-down"></i>
                        <span>0% so v·ªõi tu·∫ßn tr∆∞·ªõc</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ƒê√£ lo·∫°i</div>
                    <div class="stat-value" id="rejected-applicants">0</div>
                    <div class="stat-comparison positive" id="rejected-comparison">
                        <i class="fas fa-arrow-up"></i>
                        <span>0% so v·ªõi tu·∫ßn tr∆∞·ªõc</span>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label class="filter-label">T√¨m ki·∫øm</label>
                    <div class="filter-input">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-input" placeholder="T√¨m theo t√™n, email, SƒêT...">
                    </div>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Ban ·ª©ng tuy·ªÉn</label>
                    <select class="filter-select" id="filter-department">
                        <option value="">T·∫•t c·∫£ ban</option>
                        <option value="MD">Truy·ªÅn th√¥ng</option>
                        <option value="HR">Nh√¢n s·ª±</option>
                        <option value="PD">D·ª± √°n</option>
                        <option value="ER">ƒê·ªëi ngo·∫°i</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">V√≤ng</label>
                    <select class="filter-select" id="filter-round">
                        <option value="">T·∫•t c·∫£ v√≤ng</option>
                        <option value="round1">V√≤ng 1: ƒê∆°n</option>
                        <option value="round2">V√≤ng 2: Ph·ªèng v·∫•n nh√≥m</option>
                        <option value="round3">V√≤ng 3: Teamwork</option>
                        <option value="round4">V√≤ng 4: Ph·ªèng v·∫•n c√° nh√¢n</option>
                        <option value="success">Th√†nh vi√™n ch√≠nh th·ª©c</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Tr·∫°ng th√°i</label>
                    <select class="filter-select" id="filter-status">
                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option value="new">New</option>
                        <option value="pending">Pending</option>
                        <option value="pass">Pass</option>
                        <option value="not-pass">Not pass</option>
                        <option value="interviewed">Interviewed</option>
                        <option value="voted">Voted</option>
                        <option value="success">Success</option>
                    </select>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container main-dashboard">
                <table class="applications-table">
                    <thead>
                        <tr>
                            <th>H·ªç t√™n</th>
                            <th>Ban ·ª©ng tuy·ªÉn</th>
                            <th>Email</th>
                            <th>SƒêT</th>
                            <th>V√≤ng hi·ªán t·∫°i</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="applications-table-body">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Round 1 Content -->
            <div id="round1-content" class="round-content" style="display:none;">

              <table class="applications-table">
                <thead>
                  <tr>
                    <th>H·ªç t√™n</th>
                    <th>Email</th>
                    <th>SƒêT</th>
                    <th>Ban ·ª©ng tuy·ªÉn</th>
                    <th>Lo·∫°i ƒë∆°n</th>
                    <th>Th·ªùi gian</th>
                    <th>Link</th>
                    <th>Ghi ch√∫</th>
                    <th>H√†nh ƒë·ªông</th>
                  </tr>
                </thead>
                <tbody id="round1-table-body"></tbody>
              </table>
            </div>
            <!-- Round 2 Content -->
            <div id="round2-content" class="round-content" style="display:none;">
              <table class="applications-table">
                <thead>
                  <tr>
                    <th>H·ªç t√™n</th>
                    <th>Ban ·ª©ng tuy·ªÉn</th>
                    <th>Th·ªùi gian</th>
                    <th>ƒê·ªãa ƒëi·ªÉm / Link</th>
                    <th>Th√†nh vi√™n nh√≥m</th>
                    <th>H√¨nh th·ª©c</th>
                    <th>Ghi ch√∫</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                  </tr>
                </thead>
                <tbody id="round2-table-body">
                  <!-- Render ·ª©ng vi√™n round2 -->
                </tbody>
              </table>
            </div>
            <!-- Round 3 Content -->
            <div id="round3-content" class="round-content" style="display:none;">
              <table class="applications-table">
                <thead>
                  <tr>
                    <th>H·ªç t√™n</th>
                    <th>Ban ·ª©ng tuy·ªÉn</th>
                    <th>Team</th>
                    <th>T√™n team</th>
                    <th>Advisor</th>
                    <th>Th√†nh vi√™n nh√≥m</th>
                    <th>Pitching (th·ªùi gian)</th>
                    <th>Pitching (ƒë·ªãa ƒëi·ªÉm / link)</th>
                    <th>Pitching (STT)</th>
                    <th>T√†i li·ªáu</th>
                    <th>Ghi ch√∫</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                  </tr>
                </thead>
                <tbody id="round3-table-body"></tbody>
              </table>
            </div>
            <!-- Round 4 Content -->
            <div id="round4-content" class="round-content" style="display:none;">
              <table class="applications-table">
                <thead>
                  <tr>
                    <th>H·ªç t√™n</th>
                    <th>Ban ·ª©ng tuy·ªÉn</th>
                    <th>Th·ªùi gian</th>
                    <th>ƒê·ªãa ƒëi·ªÉm / Link</th>
                    <th>Ng∆∞·ªùi ph·ªèng v·∫•n</th>
                    <th>H√¨nh th·ª©c</th>
                    <th>Ghi ch√∫</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                  </tr>
                </thead>
                <tbody id="round4-table-body"></tbody>
              </table>
            </div>
            <!-- Success Content -->
            <div id="success-content" class="round-content" style="display:none;">
              <h2>Th√†nh vi√™n ch√≠nh th·ª©c</h2>
              <table class="applications-table success-table">
                <thead>
                  <tr>
                    <th>H·ªç t√™n</th>
                    <th>Email</th>
                    <th>SƒêT</th>
                    <th>Ban ch√≠nh th·ª©c</th>
                    <th>H√†nh ƒë·ªông</th>
                  </tr>
                </thead>
                <tbody id="success-table-body"></tbody>
              </table>
            </div>
        </div>
    </div>

    <!-- Application Detail Modal -->
    <div class="modal" id="application-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Chi ti·∫øt ·ª©ng vi√™n</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="export-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Xu·∫•t d·ªØ li·ªáu</h2>
                <button class="modal-close" id="export-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                    <button class="action-btn" onclick="exportData('all')">Xu·∫•t to√†n b·ªô</button>
                    <button class="action-btn" onclick="exportData('personal')">Th√¥ng tin c√° nh√¢n</button>
                    <button class="action-btn" onclick="exportData('results')">K·∫øt qu·∫£ ·ª©ng tuy·ªÉn</button>
                    <button class="action-btn" onclick="exportData('byDepartment')">Theo ban</button>
                    <button class="action-btn" onclick="exportData('byCandidate')">Theo ·ª©ng vi√™n</button>
                    <button class="action-btn" onclick="exportData('personalWithResults')">Th√¥ng tin + K·∫øt qu·∫£</button>
                </div>
                <div id="department-filter" style="margin-top: 20px; display: none;">
                    <label class="filter-label">Ch·ªçn ban</label>
                    <select class="filter-select" id="export-department">
                        <option value="MD">Truy·ªÅn th√¥ng</option>
                        <option value="HR">Nh√¢n s·ª±</option>
                        <option value="PD">D·ª± √°n</option>
                        <option value="ER">ƒê·ªëi ngo·∫°i</option>
                    </select>
                    <button class="action-btn" style="margin-top: 10px;" onclick="exportDepartmentData()">Xu·∫•t</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOP2j0qV0Ge-q2-Y9zo9Qc3eLmgtVOK3k",
            authDomain: "recruitment-enactusftuhanoi.firebaseapp.com",
            projectId: "recruitment-enactusftuhanoi",
            storageBucket: "recruitment-enactusftuhanoi.firebasestorage.app",
            messagingSenderId: "658928769643",
            appId: "1:658928769643:web:ef4e26633b7c41c922ef2e",
            measurementId: "G-BJT7ZPKYE3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global State
        const userEmail = sessionStorage.getItem("email");
        let userRole = sessionStorage.getItem("role") || null;
        let userDept = sessionStorage.getItem("department") || null;
        let applications = [];
        let currentApplicationId = null;
        let emailSendingInProgress = new Set(); // Theo d√µi c√°c email ƒëang ƒë∆∞·ª£c g·ª≠i

        // Kh·ªüi t·∫°o EmailJS (ƒë√£ c√≥ trong code)
        emailjs.init('HJUuXcN5zo-hOZPoG'); // Public Key

        // Service ID v√† Template ID
        const SERVICE_ID = 'service_oxo8n38';
        const TEMPLATE_ID = 'template_1fwgrrk';

        // Check authentication
        if (!userEmail || !userRole) {
            window.location.href = "login.html";
        }

        // Redirect members to response page
        if (userRole === 'member') {
            window.location.href = "response.html";
        }

        // Auth state listener
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const snap = await db.collection('account')
                                       .where('email', '==', user.email)
                                       .limit(1)
                                       .get();

                    if (!snap.empty) {
                        const doc = snap.docs[0];
                        const data = doc.data();

                        userRole = data.role || userRole;
                        userDept = data.department || userDept;

                        // Update session storage
                        sessionStorage.setItem("role", userRole);
                        sessionStorage.setItem("department", userDept);

                        // Update UI
                        updateUserInfo(doc.id, userRole, userDept);
                        applyRoleUIRules();

                        // Load applications
                        loadApplications();
                    } else {
                        // Account doesn't exist
                        await auth.signOut();
                        window.location.href = 'login.html';
                        return;
                    }
                } catch (e) {
                    console.error('L·ªói khi l·∫•y account:', e);
                }
            } else {
                window.location.href = 'login.html';
            }
        });
        

        // Update user info in the sidebar
        function updateUserInfo(fullname, role, department) {
            const userNameEl = document.getElementById('user-name');
            const userRoleEl = document.getElementById('user-role');
            const userAvatarEl = document.getElementById('user-avatar');
            
            if (userNameEl) userNameEl.textContent = fullname;
            if (userRoleEl) userRoleEl.textContent = `${role} ‚Ä¢ ${getDepartmentName(department)}`;
            if (userAvatarEl) userAvatarEl.textContent = fullname.charAt(0).toUpperCase();
        }

        // Apply UI rules based on role
        function applyRoleUIRules() {
            // system settings only visible to superadmin
            const systemMenus = document.querySelectorAll('.system-settings-menu');
            if (systemMenus) {
                systemMenus.forEach(menu => {
                    // ‚úÖ S·ª¨A: Cho c·∫£ superadmin V√Ä admin th·∫•y menu system settings
                    menu.style.display = (userRole === 'superadmin' || userRole === 'admin') ? 'block' : 'none';
                });
            }

            // Reset button only superadmin
            const resetBtn = document.getElementById('reset-rounds-btn');
            if (resetBtn) resetBtn.style.display = (userRole === 'superadmin') ? 'inline-flex' : 'none';

            // Members should be redirected out earlier; but if not:
            if (userRole === 'member') {
                window.location.href = "response.html";
            }
        }

        // Load applications from Firestore
        async function loadApplications() {
            try {
                let snapshot;
                try {
                    snapshot = await db.collection('applications').orderBy('timestamp', 'desc').get();
                } catch (e) {
                    console.warn('OrderBy failed (index?), falling back to unsorted fetch', e);
                    snapshot = await db.collection('applications').get();
                }

                const allApps = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allApps.push({
                        id: doc.id,
                        ...data,
                        priority_status: data.priorityAccepted ? 'pass' : (data.priorityRejected ? 'not-pass' : (data.priority_status || null)),
                        secondary_status: data.secondaryAccepted ? 'pass' : (data.secondaryRejected ? 'not-pass' : (data.secondary_status || null)),
                        round2_priority_status: data.round2_priority_status || (data.round2 && data.round2.priority_status) || null,
                        round2_secondary_status: data.round2_secondary_status || (data.round2 && data.round2.secondary_status) || null,
                        round3_priority_status: data.round3_priority_status || (data.round3 && data.round3.priority_status) || null,
                        round3_secondary_status: data.round3_secondary_status || (data.round3 && data.round3.secondary_status) || null,
                        round4_priority_status: data.round4_priority_status || (data.round4 && data.round4.priority_status) || null,
                        round4_secondary_status: data.round4_secondary_status || (data.round4 && data.round4.secondary_status) || null,
                        current_round: data.current_round || 'round1'
                    });

                    // === S·ª¨A: G·ª≠i email cho C·∫¢ HAI lo·∫°i ·ª©ng vi√™n ===
                    const isNew = isApplicationNew(data.timestamp || data.createdAt || data.submittedAt);
                    const notNotified = !data.notification_sent;
                    
                    // ƒêi·ªÅu ki·ªán g·ª≠i email m·ªü r·ªông - ki·ªÉm tra c·∫£ ·ª©ng vi√™n form v√† ph·ªèng v·∫•n
                    if (isNew && notNotified && data.fullname && data.email) {
                        console.log('üÜï Ph√°t hi·ªán ƒë∆°n m·ªõi, g·ª≠i email...', data.fullname, doc.id, 'Lo·∫°i:', data.application_type || 'form');
                        
                        sendEmailNotification({
                            id: doc.id,
                            ...data
                        }).then(success => {
                            if (success) {
                                console.log('‚úÖ ƒê√£ x·ª≠ l√Ω g·ª≠i email cho:', data.fullname);
                            } else {
                                console.log('‚ùå G·ª≠i email th·∫•t b·∫°i cho:', data.fullname);
                            }
                        });
                    }
                });

                if (!snapshot.query || !snapshot.query.explicitOrderBy) {
                    allApps.sort((a,b) => {
                        const ta = a.timestamp && a.timestamp.toMillis ? a.timestamp.toMillis() : (a.timestamp || 0);
                        const tb = b.timestamp && b.timestamp.toMillis ? b.timestamp.toMillis() : (b.timestamp || 0);
                        return tb - ta;
                    });
                }

                if (userRole === 'admin') {
                    applications = allApps.filter(app =>
                        app.priority_position === userDept || app.secondary_position === userDept ||
                        (Array.isArray(app.all_departments) && app.all_departments.includes(userDept))
                    );
                } else {
                    applications = allApps;
                }

                renderApplications();
                updateStats();
            } catch (error) {
                console.error('Error loading applications:', error);
                alert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ·ª©ng vi√™n: ' + error.message);
            }
        }
        

        // === TH√äM C√ÅC H√ÄM H·ªñ TR·ª¢ SAU H√ÄM loadApplications ===

        // Helper function ƒë·ªÉ l·∫•y t√™n ban
        function getDepartmentName(code) {
        const departments = {
            'MD': 'Truy·ªÅn th√¥ng',
            'HR': 'Nh√¢n s·ª±',
            'PD': 'D·ª± √°n',
            'ER': 'ƒê·ªëi ngo·∫°i'
        };
        return departments[code] || code;
        }

        // H√†m ki·ªÉm tra ƒë∆°n m·ªõi (trong v√≤ng 10 ph√∫t)
        function isApplicationNew(timestamp) {
            if (!timestamp) return false;
            
            const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000); // 10 ph√∫t tr∆∞·ªõc
            
            let appTime;
            if (timestamp.toDate) {
                // Firestore Timestamp
                appTime = timestamp.toDate();
            } else if (timestamp instanceof Date) {
                // JavaScript Date
                appTime = timestamp;
            } else if (typeof timestamp === 'string') {
                // String date
                appTime = new Date(timestamp);
            } else if (typeof timestamp === 'number') {
                // Unix timestamp
                appTime = new Date(timestamp);
            } else {
                return false;
            }
            
            return appTime > tenMinutesAgo;
        }

        // H√†m g·ª≠i email th√¥ng b√°o
        async function sendEmailNotification(application) {
            if (emailSendingInProgress.has(application.id)) {
                console.log('‚è≥ Email ƒëang ƒë∆∞·ª£c g·ª≠i cho ·ª©ng vi√™n n√†y:', application.fullname);
                return false;
            }
            
            try {
                console.log('üì® ƒêang g·ª≠i email th√¥ng b√°o...', application.fullname);
                
                emailSendingInProgress.add(application.id);
                
                const applicationTime = application.timestamp?.toDate ? 
                    application.timestamp.toDate() : 
                    new Date(application.timestamp || application.createdAt || application.submittedAt);
                
                const templateParams = {
                    applicant_name: application.fullname || '·ª®ng vi√™n',
                    applicant_email: application.email || 'Ch∆∞a cung c·∫•p',
                    applicant_phone: application.phone || 'Ch∆∞a cung c·∫•p',
                    priority_department: getDepartmentName(application.priority_position),
                    secondary_department: getDepartmentName(application.secondary_position),
                    application_type: application.application_type === 'interview' ? 'Ph·ªèng v·∫•n thay ƒë∆°n' : 'ƒêi·ªÅn form',
                    timestamp: applicationTime.toLocaleString('vi-VN'),
                    to_email: [
                        'recruitment.enactusftuhanoi@gmail.com',
                        'tuhm2567@gmail.com',
                        'lylm.enactusftu@gmail.com', 
                        'phuongntt556.enactusftu@gmail.com',
                        'linhnk23.enactusftu@gmail.com',
                        'lanntt.enactusftu@gmail.com',
                        'anhtt19.enactusftu@gmail.com',
                        'trangvd.enactusftu@gmail.com',
                        'ngandlb.enactusftu@gmail.com',
                        'tuannta.enactusftu@gmail.com',
                        'trangnq.enactusftu@gmail.com',
                        'linhdp63.enactusftu@gmail.com'
                    ]
                };

                const result = await emailjs.send(
                    'service_oxo8n38',
                    'template_1fwgrrk', 
                    templateParams
                );
                
                console.log('‚úÖ Email th√¥ng b√°o ƒë√£ g·ª≠i th√†nh c√¥ng!', result);
                
                // ƒê√°nh d·∫•u ƒë√£ g·ª≠i th√¥ng b√°o
                if (application.id) {
                    await db.collection('applications').doc(application.id).update({
                        notification_sent: true,
                        notification_sent_at: new Date()
                    });
                    console.log('‚úÖ ƒê√£ ƒë√°nh d·∫•u g·ª≠i th√¥ng b√°o cho:', application.fullname);
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå L·ªói g·ª≠i email:', error);
                
                if (error.text) {
                    console.error('Chi ti·∫øt l·ªói EmailJS:', error.text);
                }
                
                return false;
            } finally {
                emailSendingInProgress.delete(application.id);
            }
        }

        // Render applications to the table
        function renderApplications() {
            const tbody = document.getElementById('applications-table-body');
            if (!tbody) return;

            // Clear table
            tbody.innerHTML = '';

            // Filter applications
            const departmentFilter = document.getElementById('filter-department').value;
            const roundFilter = document.getElementById('filter-round').value;
            const statusFilter = document.getElementById('filter-status').value;
            const searchText = document.getElementById('search-input').value.toLowerCase();

            const filteredApplications = applications.filter(app => {
                // Department filter
                if (departmentFilter && 
                    app.priority_position !== departmentFilter && 
                    app.secondary_position !== departmentFilter) {
                    return false;
                }
                
                // Round filter (simplified for demo)
                if (roundFilter) {
                    // This would need to be expanded based on your round data structure
                    if (roundFilter === 'round1' && app.current_round !== 'round1') return false;
                    // Add similar checks for other rounds
                }
                
                // Status filter
                if (statusFilter && computeOverallStatus(app) !== statusFilter) return false;
                
                // Search filter
                if (searchText && !(
                    (app.fullname || '').toLowerCase().includes(searchText) ||
                    (app.email || '').toLowerCase().includes(searchText) ||
                    (app.phone || '').toLowerCase().includes(searchText)
                )) return false;
                
                return true;
            });

            // Populate table
            filteredApplications.forEach(app => {
                const tr = document.createElement('tr');
                
                // Applicant info
                tr.innerHTML = `
                    <td>
                        <div class="applicant-info">
                            <div class="applicant-avatar">${app.fullname ? app.fullname.charAt(0).toUpperCase() : 'U'}</div>
                            <div class="applicant-details">
                                <div class="applicant-name">${app.fullname || 'Ch∆∞a c√≥ t√™n'}</div>
                                <div class="applicant-contact">${app.email || 'Ch∆∞a cung c·∫•p'}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        ${renderDepartment(app.priority_position, getDeptStatusForRound(app, 'priority'))}
                        ${app.secondary_position && app.secondary_position !== 'None' 
                            ? renderDepartment(app.secondary_position, getDeptStatusForRound(app, 'secondary')) 
                            : ''}
                    </td>
                    <td>${app.email || 'Ch∆∞a cung c·∫•p'}</td>
                    <td>${app.phone || 'Ch∆∞a cung c·∫•p'}</td>
                    <td>${getRoundText(app.current_round)}</td>
                    <td>
                        <span class="status-badge ${getStatusClass(computeOverallStatus(app))}">
                            ${getStatusText(computeOverallStatus(app))}
                        </span>
                    </td>
                    <td>
                        <button class="action-btn view-btn" data-id="${app.id}">Xem</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });

            // Add event listeners to view buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const appId = e.target.getAttribute('data-id');
                    showApplicationDetail(appId);
                });
            });
        }

        // Trong h√†m renderRound1(), s·ª≠a ph·∫ßn event listener
        function renderRound1() {
            const tbody = document.getElementById('round1-table-body');
            tbody.innerHTML = '';

            applications.forEach(app => {
                if (app.current_round !== 'round1') return;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${app.fullname}</td>
                    <td>${app.email}</td>
                    <td>${app.phone || ''}</td>
                    <td>
                        ${renderDepartment(app.priority_position, app.priority_status)}
                        ${app.secondary_position && app.secondary_position !== 'None'
                        ? renderDepartment(app.secondary_position, app.secondary_status)
                        : ''}
                    </td>
                    <td>${app.application_type || 'form'}</td>
                    <td>${app.application_type !== 'form' ? (app.round1?.time || '') : ''}</td>
                    <td>${app.application_type !== 'form'
                        ? `<a href="${app.round1?.link || '#'}" target="_blank" style="color: #3B82F6; text-decoration: none;">Link</a>`
                        : '-'}</td>
                    <td>${app.application_type !== 'form' ? (app.round1?.note || '') : '-'}</td>
                    <td>
                        <button class="action-btn view-btn" data-id="${app.id}">
                            <i class="fas fa-external-link-alt" style="margin-right: 4px;"></i>
                            Xem
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // S·ª≠a ph·∫ßn event listener - th√™m ki·ªÉm tra authentication
            tbody.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const appId = e.target.getAttribute('data-id');
                    
                    // Ki·ªÉm tra authentication tr∆∞·ªõc khi chuy·ªÉn h∆∞·ªõng
                    if (!userEmail || !userRole) {
                        alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // M·ªü trang response v·ªõi ID ·ª©ng vi√™n
                    window.open(`response.html?id=${appId}`, '_blank');
                });
            });
        }

        function renderRound2() {
          const tbody = document.getElementById('round2-table-body');
          tbody.innerHTML = '';

          applications.forEach(app => {
            if (app.current_round !== 'round2') return;

            // ch·ªâ gi·ªØ ban pass v√≤ng 1 (t·ª´ response map)
            const positions = [
            { type: 'priority', dept: app.priority_position, prev: app.priority_status },
            { type: 'secondary', dept: app.secondary_position, prev: app.secondary_status }
            ].filter(pos => pos.dept && pos.dept !== 'null' && pos.prev === 'pass');

            // L·ªçc theo quy·ªÅn admin
            const visiblePositions = positions.filter(pos => {
            if (userRole === 'admin') {
                return pos.dept === userDept;
            }
            return true; // superadmin th√¨ th·∫•y t·∫•t c·∫£
            });

            if (visiblePositions.length === 0) return;

            visiblePositions.forEach((pos, idx) => {
            const status = app[`round2_${pos.type}_status`] || 'pending';
            const data = app.round2?.[pos.type] || {};

            const canEditThisBan = canEditBan(app, pos.type);
            const rowClass = canEditThisBan ? '' : 'row-disabled';

            const tr = document.createElement('tr');
            tr.className = rowClass;

            // T√™n ·ª©ng vi√™n ch·ªâ hi·ªÉn th·ªã 1 l·∫ßn v·ªõi rowspan = s·ªë d√≤ng th·ª±c s·ª± render
            if (idx === 0) {
                tr.innerHTML += `<td rowspan="${visiblePositions.length}">${app.fullname}</td>`;
            }
              tr.innerHTML += `
                <td>${pos.dept}</td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.time || ''}" data-field="${pos.type}.time"></td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.location || ''}" data-field="${pos.type}.location"></td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.members || ''}" data-field="${pos.type}.members"></td>
                <td>
                  <select class="app-select" ${!canEditThisBan ? 'disabled' : ''} data-field="${pos.type}.method">
                    <option value="offline" ${data.method==='offline'?'selected':''}>Offline</option>
                    <option value="online" ${data.method==='online'?'selected':''}>Online</option>
                  </select>
                </td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.note || ''}" data-field="${pos.type}.note"></td>
                <td>
                  <select class="app-select" ${!canEditThisBan ? 'disabled' : ''} data-field="${pos.type}.status">
                    <option value="pending" ${status==='pending'?'selected':''}>Pending</option>
                    <option value="pass" ${status==='pass'?'selected':''}>Pass</option>
                    <option value="not-pass" ${status==='not-pass'?'selected':''}>Not pass</option>
                  </select>
                </td>
                <td>
                  <button class="action-btn save-btn" data-id="${app.id}" data-type="${pos.type}" ${!canEditThisBan ? 'disabled' : ''}>L∆∞u</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          });

          tbody.querySelectorAll('.save-btn').forEach(btn => {
            btn.addEventListener('click', async (ev) => {
              const id = btn.dataset.id;
              const type = btn.dataset.type;
              const row = btn.closest('tr');

              // t√¨m app t·ª´ b·ªô nh·ªõ applications
              const app = applications.find(a => a.id === id);
              if (!app) { alert('·ª®ng vi√™n kh√¥ng t·ªìn t·∫°i'); return; }

              // ki·ªÉm tra quy·ªÅn
              if (!canEditBan(app, type)) {
                alert('B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a ban n√†y.');
                return;
              }

              // Thu th·∫≠p inputs
              const inputs = row.querySelectorAll('[data-field]');
              const updates = {};
              inputs.forEach(input => {
                const [banType, field] = input.dataset.field.split('.');
                if (banType === type) updates[`round2.${type}.${field}`] = input.value;
              });

              // tr·∫°ng th√°i ri√™ng flat field
              const statusSelect = row.querySelector('[data-field$=".status"]');
              if (statusSelect) updates[`round2_${type}_status`] = statusSelect.value;

              try {
                await db.collection('applications').doc(id).update(updates);
                alert('ƒê√£ l∆∞u!');
                loadApplications();
              } catch (err) {
                console.error(err);
                alert('L∆∞u th·∫•t b·∫°i: ' + (err.message || err));
              }
            });
          });
        }

        function renderRound3() {
          const tbody = document.getElementById('round3-table-body');
          tbody.innerHTML = '';

          applications.forEach(app => {
            if (app.current_round !== 'round3') return;

            // ch·ªâ gi·ªØ ban pass v√≤ng 2
            const positions = [
              { type: 'priority', dept: app.priority_position, prev: app.round2_priority_status },
              { type: 'secondary', dept: app.secondary_position, prev: app.round2_secondary_status }
            ].filter(pos => pos.dept && pos.dept !== 'null' && pos.prev === 'pass');

            if (positions.length === 0) return;

            positions.forEach((pos, idx) => {
              if (userRole === 'admin' && pos.dept !== userDept) return;

              const status = app[`round3_${pos.type}_status`] || 'pending';
              const data = app.round3?.[pos.type] || {};

              const canEditThisBan = canEditBan(app, pos.type);
              const rowClass = canEditThisBan ? '' : 'row-disabled';

              const tr = document.createElement('tr');
              tr.className = rowClass;

              if (idx === 0) tr.innerHTML += `<td rowspan="${positions.length}">${app.fullname}</td>`;

              tr.innerHTML += `
                <td>${pos.dept}</td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.team || ''}" data-field="${pos.type}.team"></td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.teamName || ''}" data-field="${pos.type}.teamName"></td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.advisor || ''}" data-field="${pos.type}.advisor"></td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.members || ''}" data-field="${pos.type}.members"></td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.pitchTime || ''}" data-field="${pos.type}.pitchTime"></td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.pitchLocation || ''}" data-field="${pos.type}.pitchLocation"></td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.pitchOrder || ''}" data-field="${pos.type}.pitchOrder"></td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.document || ''}" data-field="${pos.type}.document"></td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.note || ''}" data-field="${pos.type}.note"></td>
                <td>
                  <select class="app-select" ${!canEditThisBan ? 'disabled' : ''} data-field="${pos.type}.status">
                    <option value="pending" ${status==='pending'?'selected':''}>Pending</option>
                    <option value="pass" ${status==='pass'?'selected':''}>Pass</option>
                    <option value="not-pass" ${status==='not-pass'?'selected':''}>Not pass</option>
                  </select>
                </td>
                <td><button class="action-btn save-btn" data-id="${app.id}" data-type="${pos.type}" ${!canEditThisBan ? 'disabled' : ''}>L∆∞u</button></td>
              `;
              tbody.appendChild(tr);
            });
          });

          tbody.querySelectorAll('.save-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const id = btn.dataset.id;
              const type = btn.dataset.type;
              const row = btn.closest('tr');
              const app = applications.find(a => a.id === id);
              if (!app) { alert('·ª®ng vi√™n kh√¥ng t·ªìn t·∫°i'); return; }

              // üîí Check quy·ªÅn
              if (!canEditBan(app, type)) {
                alert('B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a ban n√†y.');
                return;
              }

              const inputs = row.querySelectorAll('[data-field]');
              const updates = {};

              inputs.forEach(input => {
                const [banType, field] = input.dataset.field.split('.');
                if (banType === type) updates[`round3.${type}.${field}`] = input.value;
              });

              const statusSelect = row.querySelector('[data-field$=".status"]');
              if (statusSelect) updates[`round3_${type}_status`] = statusSelect.value;

              await db.collection('applications').doc(id).update(updates);
              alert(`‚úÖ ƒê√£ l∆∞u thay ƒë·ªïi v√≤ng 3 (${type})`);
            });
          });
        }

        function renderRound4() {
          const tbody = document.getElementById('round4-table-body');
          tbody.innerHTML = '';

          applications.forEach(app => {
            if (app.current_round !== 'round4') return;

            // ch·ªâ gi·ªØ ban pass v√≤ng 3
            const positions = [
              { type: 'priority', dept: app.priority_position, prev: app.round3_priority_status },
              { type: 'secondary', dept: app.secondary_position, prev: app.round3_secondary_status }
            ].filter(pos => pos.dept && pos.dept !== 'null' && pos.prev === 'pass');

            if (positions.length === 0) return;

            positions.forEach((pos, idx) => {
              if (userRole === 'admin' && pos.dept !== userDept) return;

              const status = app[`round4_${pos.type}_status`] || 'pending';
              const data = app.round4?.[pos.type] || {};

              const canEditThisBan = canEditBan(app, pos.type);
              const rowClass = canEditThisBan ? '' : 'row-disabled';

              const tr = document.createElement('tr');
              tr.className = rowClass;

              if (idx === 0) tr.innerHTML += `<td rowspan="${positions.length}">${app.fullname}</td>`;

              tr.innerHTML += `
                <td>${pos.dept}</td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.time || ''}" data-field="${pos.type}.time"></td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.location || ''}" data-field="${pos.type}.location"></td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.interviewer || ''}" data-field="${pos.type}.interviewer"></td>
                <td>
                  <select class="app-select" ${!canEditThisBan ? 'disabled' : ''} data-field="${pos.type}.method">
                    <option value="offline" ${data.method==='offline'?'selected':''}>Offline</option>
                    <option value="online" ${data.method==='online'?'selected':''}>Online</option>
                  </select>
                </td>
                <td><input class="app-input" ${!canEditThisBan ? 'disabled' : ''} value="${data.note || ''}" data-field="${pos.type}.note"></td>
                <td>
                  <select class="app-select" ${!canEditThisBan ? 'disabled' : ''} data-field="${pos.type}.status">
                    <option value="pending" ${status==='pending'?'selected':''}>Pending</option>
                    <option value="interviewed" ${status==='interviewed'?'selected':''}>Interviewed</option>
                    <option value="pass" ${status==='pass'?'selected':''}>Pass</option>
                    <option value="not-pass" ${status==='not-pass'?'selected':''}>Not pass</option>
                  </select>
                </td>
                <td><button class="action-btn save-btn" data-id="${app.id}" data-type="${pos.type}" ${!canEditThisBan ? 'disabled' : ''}>L∆∞u</button></td>
              `;
              tbody.appendChild(tr);
            });
          });

          tbody.querySelectorAll('.save-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const id = btn.dataset.id;
              const type = btn.dataset.type;
              const row = btn.closest('tr');
              const app = applications.find(a => a.id === id);
              if (!app) { alert('·ª®ng vi√™n kh√¥ng t·ªìn t·∫°i'); return; }

              // üîí Check quy·ªÅn
              if (!canEditBan(app, type)) {
                alert('B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a ban n√†y.');
                return;
              }

              const inputs = row.querySelectorAll('[data-field]');
              const updates = {};

              inputs.forEach(input => {
                const [banType, field] = input.dataset.field.split('.');
                if (banType === type) updates[`round4.${type}.${field}`] = input.value;
              });

              const statusSelect = row.querySelector('[data-field$=".status"]');
              if (statusSelect) updates[`round4_${type}_status`] = statusSelect.value;

              await db.collection('applications').doc(id).update(updates);
              alert(`‚úÖ ƒê√£ l∆∞u thay ƒë·ªïi v√≤ng 4 (${type})`);
            });
          });
        }

        // S·ª≠a h√†m calculateWeekComparison ƒë·ªÉ t√≠nh to√°n ch√≠nh x√°c
        async function calculateWeekComparison() {
            try {
                const now = new Date();
                const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                
                // L·∫•y d·ªØ li·ªáu ·ª©ng vi√™n t·ª´ tu·∫ßn tr∆∞·ªõc
                const lastWeekSnapshot = await db.collection('applications')
                    .where('timestamp', '>=', oneWeekAgo)
                    .get();
                
                const lastWeekApps = lastWeekSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // T√≠nh to√°n s·ªë li·ªáu tu·∫ßn tr∆∞·ªõc - S·ª¨A L·∫†I THEO LOGIC M·ªöI
                const lastWeekTotal = lastWeekApps.length;
                const lastWeekCompleted = lastWeekApps.filter(app => 
                    computeOverallStatus(app) === 'success'
                ).length;
                const lastWeekRejected = lastWeekApps.filter(app => 
                    computeOverallStatus(app) === 'not-pass'
                ).length;
                const lastWeekInProgress = lastWeekTotal - lastWeekCompleted - lastWeekRejected;
                
                // T√≠nh to√°n s·ªë li·ªáu hi·ªán t·∫°i - S·ª¨A L·∫†I THEO LOGIC M·ªöI
                const currentTotal = applications.length;
                const currentCompleted = applications.filter(app => 
                    computeOverallStatus(app) === 'success'
                ).length;
                const currentRejected = applications.filter(app => 
                    computeOverallStatus(app) === 'not-pass'
                ).length;
                const currentInProgress = currentTotal - currentCompleted - currentRejected;
                
                // T√≠nh ph·∫ßn trƒÉm thay ƒë·ªïi
                return {
                    total: calculatePercentageChange(lastWeekTotal, currentTotal),
                    completed: calculatePercentageChange(lastWeekCompleted, currentCompleted),
                    inProgress: calculatePercentageChange(lastWeekInProgress, currentInProgress),
                    rejected: calculatePercentageChange(lastWeekRejected, currentRejected)
                };
            } catch (error) {
                console.error('L·ªói t√≠nh to√°n ph·∫ßn trƒÉm:', error);
                return {
                    total: 0,
                    completed: 0,
                    inProgress: 0,
                    rejected: 0
                };
            }
        }

        // H√†m t√≠nh ph·∫ßn trƒÉm thay ƒë·ªïi
        function calculatePercentageChange(oldValue, newValue) {
            if (oldValue === 0) {
                return newValue > 0 ? 100 : 0;
            }
            const change = ((newValue - oldValue) / oldValue) * 100;
            return Math.round(change * 10) / 10; // L√†m tr√≤n 1 ch·ªØ s·ªë th·∫≠p ph√¢n
        }

        // S·ª≠a h√†m updateStats()
        async function updateStats() {
            document.getElementById('total-applicants').textContent = applications.length;
            
            const completed = applications.filter(app => computeOverallStatus(app) === 'success').length;
            const rejected = applications.filter(app => computeOverallStatus(app) === 'not-pass').length;
            const inProgress = applications.length - completed - rejected;
            
            document.getElementById('completed-applicants').textContent = completed;
            document.getElementById('inprogress-applicants').textContent = inProgress;
            document.getElementById('rejected-applicants').textContent = rejected;
            
            // T√≠nh to√°n v√† c·∫≠p nh·∫≠t ph·∫ßn trƒÉm so v·ªõi tu·∫ßn tr∆∞·ªõc
            const comparisons = await calculateWeekComparison();
            
            updateComparisonElement('total-applicants', comparisons.total);
            updateComparisonElement('completed-applicants', comparisons.completed);
            updateComparisonElement('inprogress-applicants', comparisons.inProgress);
            updateComparisonElement('rejected-applicants', comparisons.rejected);

            // C·∫≠p nh·∫≠t th·ªëng k√™ theo ban
            updateDepartmentStats();
        }

        // Th√™m CSS cho th·ªëng k√™ ban
        const style = document.createElement('style');
        style.textContent = `
            .department-stats-header {
                grid-column: 1 / -1;
                font-size: 18px;
                font-weight: 600;
                color: var(--gray-700);
                margin-bottom: 16px;
                border-bottom: 2px solid var(--primary);
                padding-bottom: 8px;
            }
            
            .department-stat-item {
                display: flex;
                justify-content: space-between;
                margin-bottom: 4px;
                font-size: 12px;
            }
            
            .department-stat-label {
                color: var(--gray-500);
            }
            
            .department-stat-value {
                font-weight: 500;
            }
        `;
        document.head.appendChild(style);

        // H√†m c·∫≠p nh·∫≠t UI ph·∫ßn trƒÉm - S·ª¨A L·∫†I
        function updateComparisonElement(statId, percentage) {
            const statElement = document.getElementById(statId).closest('.stat-card');
            const comparisonElement = statElement.querySelector('.stat-comparison');
            const iconElement = comparisonElement.querySelector('i');
            const textElement = comparisonElement.querySelector('span');
            
            // C·∫≠p nh·∫≠t s·ªë ph·∫ßn trƒÉm
            const absPercentage = Math.abs(percentage);
            textElement.textContent = `${absPercentage}% so v·ªõi tu·∫ßn tr∆∞·ªõc`;
            
            // C·∫≠p nh·∫≠t m√†u v√† icon d·ª±a tr√™n gi√° tr·ªã
            if (percentage > 0) {
                comparisonElement.className = 'stat-comparison positive';
                iconElement.className = 'fas fa-arrow-up';
            } else if (percentage < 0) {
                comparisonElement.className = 'stat-comparison negative';
                iconElement.className = 'fas fa-arrow-down';
            } else {
                comparisonElement.className = 'stat-comparison';
                iconElement.className = 'fas fa-minus';
                textElement.textContent = '0% so v·ªõi tu·∫ßn tr∆∞·ªõc';
            }
        }

        // Th√™m h√†m th·ªëng k√™ theo ban
        function updateDepartmentStats() {
            const departmentStats = {
                'MD': { total: 0, completed: 0, inProgress: 0, rejected: 0 },
                'HR': { total: 0, completed: 0, inProgress: 0, rejected: 0 },
                'PD': { total: 0, completed: 0, inProgress: 0, rejected: 0 },
                'ER': { total: 0, completed: 0, inProgress: 0, rejected: 0 }
            };

            // ƒê·∫øm th·ªëng k√™ theo ban
            applications.forEach(app => {
                const status = computeOverallStatus(app);
                
                // ƒê·∫øm cho ban ∆∞u ti√™n
                if (app.priority_position && departmentStats[app.priority_position]) {
                    departmentStats[app.priority_position].total++;
                    if (status === 'success') departmentStats[app.priority_position].completed++;
                    else if (status === 'not-pass') departmentStats[app.priority_position].rejected++;
                    else departmentStats[app.priority_position].inProgress++;
                }
                
                // ƒê·∫øm cho ban d·ª± b·ªã (n·∫øu c√≥)
                if (app.secondary_position && app.secondary_position !== 'None' && departmentStats[app.secondary_position]) {
                    departmentStats[app.secondary_position].total++;
                    if (status === 'success') departmentStats[app.secondary_position].completed++;
                    else if (status === 'not-pass') departmentStats[app.secondary_position].rejected++;
                    else departmentStats[app.secondary_position].inProgress++;
                }
            });

            // C·∫≠p nh·∫≠t UI cho th·ªëng k√™ ban
            updateDepartmentStatsUI(departmentStats);
        }

        // C·∫≠p nh·∫≠t UI th·ªëng k√™ theo ban
        function updateDepartmentStatsUI(stats) {
            const totalApplicants = applications.length;
            let statsHTML = '';
            
            Object.keys(stats).forEach(deptCode => {
                const dept = stats[deptCode];
                if (dept.total > 0) {
                    const percentage = Math.round((dept.total / totalApplicants) * 100);
                    const icon = getDepartmentIcon(deptCode);
                    
                    statsHTML += `
                        <div class="department-stat-card department-${deptCode.toLowerCase()}">
                            <div class="department-stat-header">
                                <div class="department-stat-icon">
                                    <i class="${icon}"></i>
                                </div>
                                <div class="department-stat-title">${getDepartmentName(deptCode)}</div>
                            </div>
                            <div class="department-stat-value">${dept.total}</div>
                            <div class="department-stat-details">
                                <div class="department-stat-item">
                                    <span class="department-stat-label">Ho√†n th√†nh:</span>
                                    <span class="department-stat-count" style="color: var(--success);">${dept.completed}</span>
                                </div>
                                <div class="department-stat-item">
                                    <span class="department-stat-label">ƒêang x·ª≠ l√Ω:</span>
                                    <span class="department-stat-count" style="color: var(--warning);">${dept.inProgress}</span>
                                </div>
                                <div class="department-stat-item">
                                    <span class="department-stat-label">ƒê√£ lo·∫°i:</span>
                                    <span class="department-stat-count" style="color: var(--error);">${dept.rejected}</span>
                                </div>
                            </div>
                            <div class="department-stat-progress">
                                <div class="department-stat-progress-bar" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }
            });

            // Th√™m v√†o stats container
            const departmentStatsContainer = document.getElementById('department-stats-container');
            if (!departmentStatsContainer) {
                // T·∫°o container m·ªõi n·∫øu ch∆∞a c√≥
                const newContainer = document.createElement('div');
                newContainer.id = 'department-stats-container';
                newContainer.className = 'department-stats-container';
                newContainer.style.marginTop = '20px';
                newContainer.innerHTML = `<h3 style="grid-column: 1 / -1; margin-bottom: 16px; color: var(--gray-700);">Th·ªëng k√™ theo ban</h3>${statsHTML}`;
                document.querySelector('.content').insertBefore(newContainer, document.querySelector('.filters'));
            } else {
                departmentStatsContainer.innerHTML = `<h3 style="grid-column: 1 / -1; margin-bottom: 16px; color: var(--gray-700);">Th·ªëng k√™ theo ban</h3>${statsHTML}`;
            }
        }

        // H√†m l·∫•y icon cho t·ª´ng ban
        function getDepartmentIcon(code) {
            switch(code) {
                case 'MD': return 'fas fa-bullhorn';
                case 'HR': return 'fas fa-users';
                case 'PD': return 'fas fa-project-diagram';
                case 'ER': return 'fas fa-handshake';
                default: return 'fas fa-building';
            }
        }

        function renderDepartment(code, status) {
            // n·∫øu c√≥ status -> map sang class m√†u ƒë·∫∑c th√π, n·∫øu kh√¥ng -> default gray badge
            const badgeClass = status ? `department-badge ${getStatusClass(status)}` : 'department-badge department-secondary';
            return `
                <span class="${badgeClass}">
                    ${getDepartmentName(code)}
                </span>
            `;
        }

        // Show application details in modal
        function showApplicationDetail(appId) {
            const application = applications.find(app => app.id === appId);
            if (!application) return;

            currentApplicationId = appId;
            const modalBody = document.getElementById('modal-body');
            
            // Basic info
            modalBody.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 20px;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background-color: #F8F3CE; 
                                display: flex; align-items: center; justify-content: center; 
                                font-size: 32px; font-weight: bold; margin-right: 20px;">
                        ${application.fullname ? application.fullname.charAt(0).toUpperCase() : 'U'}
                    </div>
                    <div>
                        <h3 style="margin: 0 0 8px 0;">${application.fullname || '·ª®ng vi√™n'}</h3>
                        <p style="margin: 0; color: #6B7280;">${application.email || 'Ch∆∞a cung c·∫•p email'}</p>
                        <p style="margin: 4px 0 0 0; color: #6B7280;">${application.phone || 'Ch∆∞a cung c·∫•p SƒêT'}</p>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; font-weight: 500; margin-bottom: 4px;">Ban ∆∞u ti√™n</label>
                        <div style="padding: 8px 12px; background-color: #F3F4F6; border-radius: 8px;">
                            ${getDepartmentName(application.priority_position)}
                        </div>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 500; margin-bottom: 4px;">Ban d·ª± b·ªã</label>
                        <div style="padding: 8px 12px; background-color: #F3F4F6; border-radius: 8px;">
                            ${application.secondary_position && application.secondary_position !== 'None' ? 
                            getDepartmentName(application.secondary_position) : 'Kh√¥ng c√≥'}
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 500; margin-bottom: 12px;">Xem ƒë∆°n ·ª©ng tuy·ªÉn ƒë·∫ßy ƒë·ªß</label>
                    <div style="padding: 16px; background-color: #F9FAFB; border-radius: 8px; text-align: center;">
                        <p style="margin-bottom: 16px; color: #6B7280;">Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ xem to√†n b·ªô th√¥ng tin ·ª©ng tuy·ªÉn v√† c√¢u tr·∫£ l·ªùi chi ti·∫øt</p>
                        <button class="action-btn view-btn" id="view-full-application" style="background-color: #3B82F6; color: white; padding: 10px 20px;">
                            <i class="fas fa-external-link-alt" style="margin-right: 8px;"></i>
                            Xem ƒë∆°n ·ª©ng tuy·ªÉn ƒë·∫ßy ƒë·ªß
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 12px;">
                    <button class="action-btn" id="close-modal-btn">ƒê√≥ng</button>
                </div>
            `;
            
            // Show modal
            document.getElementById('application-modal').style.display = 'flex';
            
            // Add event listeners
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                document.getElementById('application-modal').style.display = 'none';
            });

            // Th√™m s·ª± ki·ªán cho n√∫t xem ƒë∆°n ƒë·∫ßy ƒë·ªß
            document.getElementById('view-full-application').addEventListener('click', () => {
                // Chuy·ªÉn h∆∞·ªõng sang trang response v·ªõi ID ·ª©ng vi√™n
                window.open(`response.html?id=${appId}`, '_blank');
            });
        }

        // Helper functions
        // Ki·ªÉm tra admin c√≥ quy·ªÅn ch·ªânh cho ·ª©ng vi√™n c·ª• th·ªÉ kh√¥ng
        function canEditApplication(app) {
          if (userRole === 'superadmin') return true;
          if (userRole === 'admin') {
            // admin ch·ªâ thao t√°c n·∫øu l√† ban priority ho·∫∑c secondary ho·∫∑c all_departments ch·ª©a userDept
            const p = app.priority_position;
            const s = app.secondary_position;
            const arr = Array.isArray(app.all_departments) ? app.all_departments : [];
            return (p === userDept) || (s === userDept) || arr.includes(userDept);
          }
          return false; // member kh√¥ng ƒë∆∞·ª£c ch·ªânh
        }

        // Ki·ªÉm tra admin c√≥ quy·ªÅn ch·ªânh ri√™ng 1 ban (priority/secondary) kh√¥ng
        function canEditBan(app, banType) { // banType = 'priority' ho·∫∑c 'secondary'
          if (userRole === 'superadmin') return true;
          if (userRole === 'admin') {
            const dept = (banType === 'priority') ? app.priority_position : app.secondary_position;
            const arr = Array.isArray(app.all_departments) ? app.all_departments : [];
            return dept === userDept || arr.includes(userDept);
          }
          return false;
        }

        function getDepartmentName(code) {
            switch(code) {
                case 'MD': return 'Truy·ªÅn th√¥ng';
                case 'HR': return 'Nh√¢n s·ª±';
                case 'PD': return 'D·ª± √°n';
                case 'ER': return 'ƒê·ªëi ngo·∫°i';
                default: return code;
            }
        }

        function getRoundText(round) {
            switch(round) {
                case "round1": return "V√≤ng 1: ƒê∆°n";
                case "round2": return "V√≤ng 2: Ph·ªèng v·∫•n nh√≥m";
                case "round3": return "V√≤ng 3: Teamwork";
                case "round4": return "V√≤ng 4: Ph·ªèng v·∫•n c√° nh√¢n";
                case "success": return "Th√†nh vi√™n ch√≠nh th·ª©c";
                default: return "Ch∆∞a x√°c ƒë·ªãnh";
            }
        }

        function getDeptStatusForRound(app, type /* 'priority'|'secondary' */) {
          // Tr·∫£ v·ªÅ tr·∫°ng th√°i per-dept theo v√≤ng hi·ªán t·∫°i nh∆∞ng fallback v·ªÅ v√≤ng tr∆∞·ªõc n·∫øu kh√¥ng t·ªìn t·∫°i
          const round = app.current_round || 'round1';

          // th·ª© t·ª± ∆∞u ti√™n l·∫•y tr·∫°ng th√°i (t·ª´ m·ªõi -> c≈©)
          let keys = [];
          if (round === 'round4') {
              keys = [`round4_${type}_status`, `round3_${type}_status`, `round2_${type}_status`, `${type}_status`];
          } else if (round === 'round3') {
              keys = [`round3_${type}_status`, `round2_${type}_status`, `${type}_status`];
          } else if (round === 'round2') {
              keys = [`round2_${type}_status`, `${type}_status`];
          } else {
              keys = [`${type}_status`];
          }

          for (const k of keys) {
              if (app[k]) return app[k];
          }

          // N·∫øu code l∆∞u tr·∫°ng th√°i nested (v√≠ d·ª• round2: { priority: { status: 'pass' } }), c·ªë g·∫Øng ƒë·ªçc nested
          try {
              if (round === 'round2' && app.round2 && app.round2[type] && app.round2[type].status) return app.round2[type].status;
              if (round === 'round3' && app.round3 && app.round3[type] && app.round3[type].status) return app.round3[type].status;
              if (round === 'round4' && app.round4 && app.round4[type] && app.round4[type].status) return app.round4[type].status;
          } catch (e) {
              // ignore
          }

          return null;
      }

        function getStatusClass(status) {
            switch(status) {
                case 'new': return 'status-new';
                case 'pending': return 'status-pending';
                case 'pass': return 'status-pass';
                case 'not-pass': return 'status-not-pass';
                case 'interviewed': return 'status-interviewed';
                case 'voted': return 'status-voted';
                case "success": return "status-success"; // ‚úÖ th√™m m·ªõi
                default: return 'status-pending';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'new': return 'New';
                case 'pending': return 'Pending';
                case 'pass': return 'Pass';
                case 'not-pass': return 'Not pass';
                case 'interviewed': return 'Interviewed';
                case 'voted': return 'Voted';
                case "success": return "Success"; 
                default: return status;
            }
        }

        function computeOverallStatus(application) {
          const round = application.current_round || "round1";

          // n·∫øu ƒë√£ l√† th√†nh vi√™n ch√≠nh th·ª©c th√¨ ∆∞u ti√™n tr·∫£ v·ªÅ success
          if (round === "success" || application.status === "success") {
              return "success";
          }

          // l·∫•y tr·∫°ng th√°i per-dept theo v√≤ng
          const p = getDeptStatusForRound(application, "priority");
          const s = getDeptStatusForRound(application, "secondary");

          // tr·∫°ng th√°i global/nested cho v√≤ng hi·ªán t·∫°i (round2.status, round3.status...)
          const perRoundStatus = application[`${round}_status`] || null;

          // n·∫øu c√≥ tr·∫°ng th√°i ƒë·∫∑c th√π (voted/interviewed) -> tr·∫£ tr·ª±c ti·∫øp
          if (perRoundStatus === 'voted' || perRoundStatus === 'interviewed') return perRoundStatus;

          // n·∫øu 1 trong 2 ban pass -> t·ªïng l√† pass
          if (p === "pass" || s === "pass") return "pass";

          // n·∫øu c·∫£ 2 ban not-pass -> t·ªïng l√† not-pass
          if ((p === "not-pass" && s === "not-pass") || (p === "not-pass" && !s) || (!p && s === "not-pass")) return "not-pass";

          // n·∫øu perRoundStatus explicit pass/not-pass -> d√πng n√≥
          if (perRoundStatus === "pass" || perRoundStatus === "not-pass") return perRoundStatus;

          // default:
          if (round === "round1") return application.status || "new";
          return "pending";
      }

      function renderSuccess() {
            const tbody = document.getElementById('success-table-body');
            tbody.innerHTML = '';

            applications.forEach(app => {
                if (app.current_round !== 'success') return;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${app.fullname}</td>
                    <td>${app.email}</td>
                    <td>${app.phone || ''}</td>
                    <td>${getDepartmentName(app.final_department)}</td>
                    <td>
                        <button class="action-btn view-btn" data-id="${app.id}">Xem</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Th√™m event listeners cho n√∫t xem
            tbody.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const appId = e.target.getAttribute('data-id');
                    showApplicationDetail(appId);
                });
            });
        }

        // Export data functions (simplified for demo)
        
        function exportData(type) {
            alert(`Ch·ª©c nƒÉng xu·∫•t d·ªØ li·ªáu ${type} s·∫Ω ƒë∆∞·ª£c th·ª±c hi·ªán ·ªü phi√™n b·∫£n ho√†n thi·ªán.`);
            document.getElementById('export-modal').style.display = 'none';
        }

        function exportDepartmentData() {
            const dept = document.getElementById('export-department').value;
            alert(`Ch·ª©c nƒÉng xu·∫•t d·ªØ li·ªáu cho ban ${getDepartmentName(dept)} s·∫Ω ƒë∆∞·ª£c th·ª±c hi·ªán ·ªü phi√™n b·∫£n ho√†n thi·ªán.`);
            document.getElementById('export-modal').style.display = 'none';
        }

        // Event listeners
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => {
                sessionStorage.clear();
                window.location.href = 'login.html';
            });
        });

        document.getElementById('reset-rounds-btn')?.addEventListener('click', async () => {
            if (userRole !== 'superadmin') {
              alert('Ch·ªâ superadmin m·ªõi c√≥ quy·ªÅn reset d·ªØ li·ªáu v√≤ng.');
              return;
            }

            if (!confirm("‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën reset to√†n b·ªô d·ªØ li·ªáu v√≤ng? (D·ªØ li·ªáu form ·ª©ng vi√™n s·∫Ω gi·ªØ nguy√™n)")) {
                return;
            }

            try {
                const snapshot = await db.collection('applications').get();
                const batch = db.batch();

                snapshot.forEach(doc => {
                    const data = doc.data();

                    // Gi·ªØ l·∫°i th√¥ng tin c√° nh√¢n, answers
                    const newData = {
                        fullname: data.fullname || null,
                        email: data.email || null,
                        phone: data.phone || null,
                        answers: data.answers || {},
                        priority_position: data.priority_position || null,
                        secondary_position: data.secondary_position || null,
                        timestamp: data.timestamp || firebase.firestore.FieldValue.serverTimestamp(),

                        // Reset to√†n b·ªô d·ªØ li·ªáu v√≤ng
                        current_round: "round1",
                        status: "new"
                    };

                    batch.set(doc.ref, newData, { merge: true });
                });

                await batch.commit();
                alert("‚úÖ ƒê√£ reset d·ªØ li·ªáu v√≤ng cho t·∫•t c·∫£ ·ª©ng vi√™n!");
                loadApplications(); // refresh l·∫°i b·∫£ng
            } catch (error) {
                console.error("L·ªói khi reset v√≤ng:", error);
                alert("‚ùå L·ªói khi reset v√≤ng: " + error.message);
            }
        });

        document.getElementById("update-round-btn")?.addEventListener("click", async () => {
          const newRoundStr = prompt("B·∫°n mu·ªën chuy·ªÉn t·∫•t c·∫£ ·ª©ng vi√™n pass sang v√≤ng m·∫•y? (vd: 2,3,4, success)");
          if (!newRoundStr) return;

          let newRound = newRoundStr.toLowerCase();
          if (["2","3","4"].includes(newRound)) {
            newRound = parseInt(newRound);
          } else if (newRound !== "success") {
            alert("Ch·ªâ h·ªó tr·ª£ nh·∫≠p 2, 3, 4 ho·∫∑c success.");
            return;
          }

          if (!confirm(`‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën chuy·ªÉn T·∫§T C·∫¢ ·ª©ng vi√™n ƒë√£ pass sang v√≤ng ${newRound}?`)) return;

          try {
            const snapshot = await db.collection("applications").get();
            const batch = db.batch();
            let updatedCount = 0;

            snapshot.forEach(doc => {
              const data = doc.data();

              // N·∫øu ƒëang l√† admin, ch·ªâ thao t√°c nh·ªØng app thu·ªôc dept h·ªç
              if (userRole === 'admin') {
                const belongs = (data.priority_position === userDept) ||
                                (data.secondary_position === userDept) ||
                                (Array.isArray(data.all_departments) && data.all_departments.includes(userDept));
                if (!belongs) return; // skip
              }

              const tempApp = {
                ...data,
                priority_status: data.priorityAccepted ? "pass" : (data.priorityRejected ? "not-pass" : (data.round1 && data.round1.priority_status) || null),
                secondary_status: data.secondaryAccepted ? "pass" : (data.secondaryRejected ? "not-pass" : (data.round1 && data.round1.secondary_status) || null),
                round2_priority_status: data.round2_priority_status || null,
                round2_secondary_status: data.round2_secondary_status || null,
                round3_priority_status: data.round3_priority_status || null,
                round3_secondary_status: data.round3_secondary_status || null,
                round4_priority_status: data.round4_priority_status || null,
                round4_secondary_status: data.round4_secondary_status || null,
                current_round: data.current_round || 'round1'
              };

              if (computeOverallStatus(tempApp) === "pass") {
                const updates = {};

                if (newRound === 2) {
                  updates["current_round"] = "round2";
                  updates["status"] = "in-progress";
                  if (tempApp.priority_status === "pass") updates["round2_priority_status"] = "pending";
                  if (tempApp.secondary_status === "pass") updates["round2_secondary_status"] = "pending";
                }

                if (newRound === 3) {
                  updates["current_round"] = "round3";
                  updates["status"] = "in-progress";
                  if (tempApp.round2_priority_status === "pass") updates["round3_priority_status"] = "pending";
                  if (tempApp.round2_secondary_status === "pass") updates["round3_secondary_status"] = "pending";
                }

                if (newRound === 4) {
                  updates["current_round"] = "round4";
                  updates["status"] = "in-progress";
                  if (tempApp.round3_priority_status === "pass") updates["round4_priority_status"] = "pending";
                  if (tempApp.round3_secondary_status === "pass") updates["round4_secondary_status"] = "pending";
                }

                if (newRound === "success") {
                  let finalDept = null;
                  if (tempApp.round4_priority_status === "pass") {
                    finalDept = data.priority_position;
                  } else if (tempApp.round4_secondary_status === "pass") {
                    finalDept = data.secondary_position;
                  }

                  if (finalDept) {
                    updates["current_round"] = "success";
                    updates["status"] = "success";
                    updates["final_department"] = finalDept;
                  }
                }

                // ch·ªâ update n·∫øu c√≥ thay ƒë·ªïi h·ª£p l·ªá
                if (Object.keys(updates).length > 0) {
                  batch.update(doc.ref, updates);
                  updatedCount++;
                }
              }
            });

            await batch.commit();
            alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t ${updatedCount} ·ª©ng vi√™n pass sang v√≤ng ${newRound}`);
            loadApplications();
          } catch (error) {
            console.error("L·ªói khi c·∫≠p nh·∫≠t v√≤ng:", error);
            alert("‚ùå L·ªói khi c·∫≠p nh·∫≠t v√≤ng: " + error.message);
          }
        });

        document.getElementById('refresh-btn').addEventListener('click', () => {
            loadApplications();
        });

        document.getElementById('export-btn').addEventListener('click', () => {
            document.getElementById('export-modal').style.display = 'flex';
        });

        document.getElementById('modal-close').addEventListener('click', () => {
            document.getElementById('application-modal').style.display = 'none';
        });

        document.getElementById('export-modal-close').addEventListener('click', () => {
            document.getElementById('export-modal').style.display = 'none';
        });

        // Filter event listeners
        document.getElementById('filter-department').addEventListener('change', renderApplications);
        document.getElementById('filter-round').addEventListener('change', renderApplications);
        document.getElementById('filter-status').addEventListener('change', renderApplications);
        document.getElementById('search-input').addEventListener('input', renderApplications);

        // Tab switching - s·ª≠a l·∫°i
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const tab = item.getAttribute('data-tab');
                if (!tab) return;

                // reset active
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                // ƒë·ªïi ti√™u ƒë·ªÅ
                document.getElementById('page-title').textContent = item.querySelector('span').textContent;

                // ·∫©n t·∫•t c·∫£ n·ªôi dung
                document.querySelectorAll('.round-content').forEach(c => c.style.display = 'none');
                document.querySelectorAll('.main-dashboard').forEach(c => c.style.display = 'none');

                // hi·ªÉn th·ªã n·ªôi dung ph√π h·ª£p
                if (tab === 'dashboard') {
                    document.querySelectorAll('.main-dashboard').forEach(c => c.style.display = 'block');
                    renderApplications();
                } else {
                    // Hi·ªÉn th·ªã n·ªôi dung v√≤ng t∆∞∆°ng ·ª©ng
                    document.getElementById(tab + '-content').style.display = 'block';
                    
                    // G·ªçi h√†m render t∆∞∆°ng ·ª©ng
                    if (tab === 'round1') renderRound1();
                    if (tab === 'round2') renderRound2();
                    if (tab === 'round3') renderRound3();
                    if (tab === 'round4') renderRound4();
                    if (tab === 'success') renderSuccess();
                }
            });
        });

        // Initialize UI
        updateUserInfo(userEmail, userRole, userDept);
        applyRoleUIRules();
    </script>
</body>
</html>