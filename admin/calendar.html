<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar | Enactus FTU Hanoi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Clash+Display:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root {
            --primary: #F8F3CE;
            --primary-light: #FFD54F;
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --white: #FFFFFF;
            --error: #EF4444;
            --error-light: #FEE2E2;
            --success: #10B981;
            --success-light: #D1FAE5;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --info: #3B82F6;
            --info-light: #DBEAFE;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        body {
            background-color: var(--gray-50);
            color: var(--gray-800);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background-color: var(--white);
            padding: 16px 24px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 50px;
            width: auto;
        }

        .nav-links {
            display: flex;
            gap: 16px;
        }

        .nav-link {
            padding: 8px 16px;
            border-radius: var(--border-radius);
            color: var(--gray-700);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }

        .nav-link:hover, .nav-link.active {
            background-color: var(--primary);
            color: var(--gray-800);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--gray-800);
        }

        .logout-btn {
            padding: 8px 16px;
            background-color: var(--gray-100);
            border: none;
            border-radius: var(--border-radius);
            color: var(--gray-700);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }

        .logout-btn:hover {
            background-color: var(--error-light);
            color: var(--error);
        }

        .logout-btn i {
            margin-right: 8px;
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: var(--transition);
        }

        .tab.active {
            color: var(--gray-900);
            border-bottom-color: var(--primary);
        }

        .tab:hover:not(.active) {
            color: var(--gray-800);
        }

        /* Card */
        .card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .card-header {
            margin-bottom: 20px;
        }

        .card-title {
            font-family: 'Clash Display', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .card-subtitle {
            color: var(--gray-600);
        }

        /* Interview Schedule */
        .interview-day {
            margin-bottom: 32px;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .day-header {
            background-color: var(--gray-100);
            padding: 16px;
            font-weight: 600;
            color: var(--gray-800);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-count {
            background-color: var(--info);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            padding: 16px;
        }

        .time-slot {
            position: relative;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 12px;
        }

        .slot-time {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .slot-count {
            font-size: 14px;
            color: var(--gray-600);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(248, 243, 206, 0.3);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--gray-800);
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
        }

        .btn-secondary {
            background-color: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background-color: var(--gray-300);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #0da271;
        }

        .btn-danger {
            background-color: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn i {
            margin-right: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px 20px;
        }

        .loading i {
            font-size: 32px;
            color: var(--gray-400);
            margin-bottom: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--gray-600);
            font-size: 14px;
        }

        .stat-voted {
            color: var(--success);
        }

        .stat-not-voted {
            color: var(--warning);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-family: 'Clash Display', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-500);
        }

        .close-modal:hover {
            color: var(--gray-700);
        }

        /* Candidate List */
        .candidate-list {
            margin-top: 20px;
        }

        .candidate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            margin-bottom: 12px;
        }

        .candidate-info {
            flex: 1;
        }

        .candidate-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .candidate-email {
            color: var(--gray-600);
            font-size: 14px;
        }

        .candidate-actions {
            display: flex;
            gap: 8px;
        }

        /* Improved Remove Slot Button */
        .remove-slot-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: var(--error-light);
            color: var(--error);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            transition: var(--transition);
        }

        .remove-slot-btn:hover {
            background-color: var(--error);
            color: white;
        }

        /* New Candidate Action Buttons */
        .candidate-delete-btn {
            background-color: var(--error-light);
            color: var(--error);
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }

        .candidate-delete-btn:hover {
            background-color: var(--error);
            color: white;
        }

        .candidate-reset-btn {
            background-color: var(--warning-light);
            color: var(--warning);
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }

        .candidate-reset-btn:hover {
            background-color: var(--warning);
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .time-slots {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <img src="/assets/logo_den.png" alt="Enactus FTU Hanoi Logo">
        </div>
        
        <div class="nav-links">
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="calendar.html" class="nav-link active">Lịch & Vote</a>
            <a href="accounts.html" class="nav-link">Tài khoản</a>
        </div>
        
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">A</div>
            <button class="logout-btn" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                Đăng xuất
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="tabs">
            <button class="tab active" data-tab="schedule">Lịch phỏng vấn</button>
            <button class="tab" data-tab="manage">Quản lý Lịch</button>
            <button class="tab" data-tab="settings">Cài đặt</button>
        </div>

        <div id="loading" class="loading">
            <i class="fas fa-spinner"></i>
            <p>Đang tải dữ liệu...</p>
        </div>

        <!-- Schedule Tab -->
        <div id="schedule-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Lịch phỏng vấn ứng viên</h2>
                    <p class="card-subtitle">Tổng quan về lịch phỏng vấn đã được ứng viên chọn</p>
                </div>

                <!-- Statistics Section -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-candidates">0</div>
                        <div class="stat-label">Tổng số ứng viên</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-voted" id="voted-candidates">0</div>
                        <div class="stat-label">Đã chọn lịch</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-not-voted" id="not-voted-candidates">0</div>
                        <div class="stat-label">Chưa chọn lịch</div>
                    </div>
                </div>

                <div id="interview-schedule">
                    <!-- Interview schedule will be populated by JavaScript -->
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="export-schedule-btn">
                        <i class="fas fa-download"></i>
                        Xuất lịch phỏng vấn
                    </button>
                </div>
            </div>
        </div>

        <!-- Manage Tab -->
        <div id="manage-tab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Quản lý lịch phỏng vấn</h2>
                    <p class="card-subtitle">Tạo và quản lý lịch phỏng vấn cho ứng viên chọn</p>
                </div>

                <div class="form-group">
                    <label class="form-label">Lịch phỏng vấn hiện tại</label>
                    <div id="current-schedule">
                        <!-- Current schedule will be populated by JavaScript -->
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Thêm ngày phỏng vấn</label>
                    <div class="form-group">
                        <input type="date" class="form-input" id="interview-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Thêm khung giờ (mỗi khung giờ một dòng, ví dụ: 08:00 - 09:00)</label>
                        <textarea class="form-textarea" id="time-slots" placeholder="08:00 - 09:00&#10;09:00 - 10:00&#10;10:00 - 11:00"></textarea>
                    </div>
                    <button class="btn btn-secondary" id="add-day-btn">
                        <i class="fas fa-plus"></i>
                        Thêm ngày
                    </button>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="save-schedule-btn">
                        <i class="fas fa-save"></i>
                        Lưu lịch phỏng vấn
                    </button>
                    <button class="btn btn-success" id="publish-schedule-btn">
                        <i class="fas fa-bell"></i>
                        Công bố lịch phỏng vấn
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Cài đặt hệ thống</h2>
                    <p class="card-subtitle">Quản lý dữ liệu ứng viên và cài đặt hệ thống</p>
                </div>

                <div class="form-group">
                    <label class="form-label">Nạp dữ liệu ứng viên</label>
                    <p class="card-subtitle">Nhập danh sách email ứng viên để cấp quyền truy cập lịch phỏng vấn</p>
                    <textarea class="form-textarea" id="candidate-emails" placeholder="Nhập email ứng viên, mỗi email một dòng"></textarea>
                    <button class="btn btn-primary" id="load-candidates-btn" style="margin-top: 12px;">
                        <i class="fas fa-upload"></i>
                        Nạp dữ liệu ứng viên
                    </button>
                </div>

                <div class="form-group">
                    <label class="form-label">Danh sách ứng viên có quyền vote</label>
                    <div id="candidate-list">
                        <!-- Candidate list will be populated by JavaScript -->
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-danger" id="lock-schedule-btn">
                        <i class="fas fa-lock"></i>
                        Khóa lịch phỏng vấn
                    </button>
                    <button class="btn btn-danger" id="clear-votes-btn">
                        <i class="fas fa-trash"></i>
                        Xóa dữ liệu vote
                    </button>
                    <button class="btn btn-danger" id="clear-candidates-btn">
                        <i class="fas fa-trash-alt"></i>
                        Xóa toàn bộ ứng viên khỏi danh sách vote
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Candidate Confirmation Modal -->
    <div id="candidate-confirm-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Xác nhận dữ liệu ứng viên</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="candidate-confirm-list">
                <!-- Candidate confirmation list will be populated by JavaScript -->
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="confirm-candidates-btn">Xác nhận và nạp dữ liệu</button>
                <button class="btn btn-secondary close-modal">Hủy</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOP2j0qV0Ge-q2-Y9zo9Qc3eLmgtVOK3k",
            authDomain: "recruitment-enactusftuhanoi.firebaseapp.com",
            projectId: "recruitment-enactusftuhanoi",
            storageBucket: "recruitment-enactusftuhanoi.firebasestorage.app",
            messagingSenderId: "658928769643",
            appId: "1:658928769643:web:ef4e26633b7c41c922ef2e",
            measurementId: "G-BJT7ZPKYE3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global State
        let currentUser = null;
        let interviewSchedule = [];
        let applications = [];
        let votes = [];
        let votingCandidates = []; // Danh sách ứng viên có quyền vote
        let candidates = []; // Danh sách ứng viên đầy đủ thông tin

        // Check authentication and admin role
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-avatar').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'A';
                
                try {
                    // Check if user is admin or superadmin
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (!userDoc.exists) {
                        // Try to check in account collection
                        const accountSnapshot = await db.collection('account')
                            .where('email', '==', user.email)
                            .limit(1)
                            .get();
                        
                        if (!accountSnapshot.empty) {
                            const accountData = accountSnapshot.docs[0].data();
                            const userRole = accountData.role;
                            
                            // Allow both admin and superadmin
                            if (userRole !== 'admin' && userRole !== 'superadmin') {
                                window.location.href = '../user/profile.html';
                                return;
                            }
                        } else {
                            // Not found in either collection, redirect to user page
                            window.location.href = '../user/profile.html';
                            return;
                        }
                    } else {
                        const userData = userDoc.data();
                        // Allow both admin and superadmin
                        if (userData.role !== 'admin' && userData.role !== 'superadmin') {
                            window.location.href = '../user/profile.html';
                            return;
                        }
                    }
                    
                    // Load data
                    await Promise.all([
                        loadInterviewSchedule(),
                        loadApplications(),
                        loadVotes(),
                        loadVotingCandidates()
                    ]);
                    
                    document.getElementById('loading').style.display = 'none';
                    renderInterviewSchedule();
                    renderStatistics();
                    renderCandidateList();
                    
                } catch (error) {
                    console.error('Error checking admin role:', error);
                    alert('Có lỗi xảy ra khi kiểm tra quyền truy cập');
                }
            } else {
                // User is not signed in, redirect to login
                window.location.href = '../user/login.html';
            }
        });

        // Load interview schedule
        async function loadInterviewSchedule() {
            try {
                const scheduleDoc = await db.collection('system').doc('interview_schedule').get();
                
                if (scheduleDoc.exists) {
                    const data = scheduleDoc.data();
                    interviewSchedule = data.schedule || [];
                } else {
                    // Save default schedule
                    await db.collection('system').doc('interview_schedule').set({
                        schedule: interviewSchedule,
                        published: false,
                        locked: false
                    });
                }
            } catch (error) {
                console.error('Error loading interview schedule:', error);
            }
        }

        // Load applications
        async function loadApplications() {
            try {
                const snapshot = await db.collection('applications').get();
                applications = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        ...data
                    };
                });
            } catch (error) {
                console.error('Error loading applications:', error);
            }
        }

        // Load votes
        async function loadVotes() {
            try {
                const snapshot = await db.collection('votes').get();
                votes = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        ...data
                    };
                });
            } catch (error) {
                console.error('Error loading votes:', error);
            }
        }

        // Load danh sách ứng viên có quyền vote
        async function loadVotingCandidates() {
            try {
                const snapshot = await db.collection('voting_candidates').get();
                votingCandidates = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        email: data.email,
                        addedAt: data.addedAt || new Date(),
                        addedBy: data.addedBy || ''
                    };
                });
                
                // Đồng bộ với applications để lấy thông tin đầy đủ
                await syncVotingCandidatesWithApplications();
            } catch (error) {
                console.error('Error loading voting candidates:', error);
                // Nếu collection chưa tồn tại, tạo collection mới
                votingCandidates = [];
            }
        }

        // Đồng bộ danh sách voting candidates với applications
        async function syncVotingCandidatesWithApplications() {
            try {
                // Tạo danh sách candidates đầy đủ thông tin
                candidates = votingCandidates.map(vc => {
                    const app = applications.find(a => a.email === vc.email);
                    return {
                        id: vc.id,
                        email: vc.email,
                        name: app ? app.fullname || '' : '',
                        priority: app ? app.priority_position || '' : '',
                        backup: app ? app.backup_position || '' : '',
                        phone: app ? app.phone || '' : '',
                        interview_schedule: app ? app.interview_schedule || [] : [],
                        addedAt: vc.addedAt
                    };
                });
            } catch (error) {
                console.error('Error syncing voting candidates:', error);
            }
        }

        // Render statistics
        function renderStatistics() {
            // Total candidates
            document.getElementById('total-candidates').textContent = candidates.length;
            
            // Count voted and not voted
            let votedCount = 0;
            let notVotedCount = 0;
            
            candidates.forEach(candidate => {
                if (candidate.interview_schedule && candidate.interview_schedule.length > 0) {
                    votedCount++;
                } else {
                    notVotedCount++;
                }
            });
            
            document.getElementById('voted-candidates').textContent = votedCount;
            document.getElementById('not-voted-candidates').textContent = notVotedCount;
        }

        // Render interview schedule
        function renderInterviewSchedule() {
            const container = document.getElementById('interview-schedule');
            container.innerHTML = '';
            
            if (interviewSchedule.length === 0) {
                container.innerHTML = '<p>Chưa có lịch phỏng vấn nào được tạo.</p>';
                return;
            }
            
            // Calculate counts for each slot
            const slotCounts = {};
            
            candidates.forEach(candidate => {
                if (candidate.interview_schedule) {
                    candidate.interview_schedule.forEach(slot => {
                        slotCounts[slot] = (slotCounts[slot] || 0) + 1;
                    });
                }
            });
            
            interviewSchedule.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'interview-day';
                
                let dayHTML = `
                    <div class="day-header">
                        <span>${day.date}</span>
                        <span class="day-count">${day.slots.length} khung giờ</span>
                    </div>
                    <div class="time-slots">
                `;
                
                day.slots.forEach(slot => {
                    const slotId = `${day.id}_${slot.replace(/\s+/g, '_')}`;
                    const count = slotCounts[slotId] || 0;
                    
                    dayHTML += `
                        <div class="time-slot">
                            <div class="slot-time">${slot}</div>
                            <div class="slot-count">${count} ứng viên</div>
                        </div>
                    `;
                });
                
                dayHTML += `</div>`;
                dayElement.innerHTML = dayHTML;
                container.appendChild(dayElement);
            });
            
            // Also render in manage tab
            renderCurrentSchedule();
        }

        // Render current schedule in manage tab
        function renderCurrentSchedule() {
            const container = document.getElementById('current-schedule');
            container.innerHTML = '';
            
            if (interviewSchedule.length === 0) {
                container.innerHTML = '<p>Chưa có lịch phỏng vấn nào được tạo.</p>';
                return;
            }
            
            interviewSchedule.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'interview-day';
                
                let dayHTML = `
                    <div class="day-header">
                        <span>${day.date}</span>
                        <button class="btn btn-danger remove-day-btn" data-day-id="${day.id}">
                            <i class="fas fa-trash"></i>
                            Xóa ngày
                        </button>
                    </div>
                    <div class="time-slots">
                `;
                
                day.slots.forEach(slot => {
                    dayHTML += `
                        <div class="time-slot">
                            <div class="slot-time">${slot}</div>
                            <button class="remove-slot-btn" data-day-id="${day.id}" data-slot="${slot}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                });
                
                dayHTML += `</div>`;
                dayElement.innerHTML = dayHTML;
                container.appendChild(dayElement);
            });
            
            // Add event listeners for remove buttons
            document.querySelectorAll('.remove-day-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const dayId = this.getAttribute('data-day-id');
                    removeDay(dayId);
                });
            });
            
            document.querySelectorAll('.remove-slot-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const dayId = this.getAttribute('data-day-id');
                    const slot = this.getAttribute('data-slot');
                    removeSlot(dayId, slot);
                });
            });
        }

        // Remove a day from schedule
        function removeDay(dayId) {
            if (confirm('Bạn có chắc chắn muốn xóa ngày này?')) {
                interviewSchedule = interviewSchedule.filter(day => day.id !== dayId);
                renderCurrentSchedule();
            }
        }

        // Remove a slot from schedule
        function removeSlot(dayId, slot) {
            if (confirm('Bạn có chắc chắn muốn xóa khung giờ này?')) {
                const dayIndex = interviewSchedule.findIndex(day => day.id === dayId);
                if (dayIndex !== -1) {
                    interviewSchedule[dayIndex].slots = interviewSchedule[dayIndex].slots.filter(s => s !== slot);
                    renderCurrentSchedule();
                }
            }
        }

        // Render candidate list - CHỈ HIỂN THỊ ỨNG VIÊN CÓ QUYỀN VOTE
        function renderCandidateList() {
            const container = document.getElementById('candidate-list');
            container.innerHTML = '';
            
            if (candidates.length === 0) {
                container.innerHTML = '<p>Chưa có ứng viên nào trong danh sách vote.</p>';
                return;
            }
            
            candidates.forEach(candidate => {
                const candidateElement = document.createElement('div');
                candidateElement.className = 'candidate-item';
                
                const hasVoted = candidate.interview_schedule && candidate.interview_schedule.length > 0;
                const voteStatus = hasVoted ? 'Đã chọn lịch' : 'Chưa chọn lịch';
                const statusClass = hasVoted ? 'stat-voted' : 'stat-not-voted';
                
                candidateElement.innerHTML = `
                    <div class="candidate-info">
                        <div class="candidate-name">${candidate.name || 'Chưa có tên'}</div>
                        <div class="candidate-email">${candidate.email}</div>
                        <div class="${statusClass}" style="font-size: 12px; margin-top: 4px;">${voteStatus}</div>
                    </div>
                    <div class="candidate-actions">
                        <button class="candidate-delete-btn" data-candidate-id="${candidate.id}" data-candidate-email="${candidate.email}">
                            <i class="fas fa-trash"></i>
                            Xóa
                        </button>
                        <button class="candidate-reset-btn" data-candidate-id="${candidate.id}" data-candidate-email="${candidate.email}">
                            <i class="fas fa-undo"></i>
                            Reset
                        </button>
                    </div>
                `;
                
                container.appendChild(candidateElement);
            });
            
            // Add event listeners
            document.querySelectorAll('.candidate-delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const candidateId = this.getAttribute('data-candidate-id');
                    const candidateEmail = this.getAttribute('data-candidate-email');
                    removeCandidateFromVoting(candidateId, candidateEmail);
                });
            });
            
            document.querySelectorAll('.candidate-reset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const candidateEmail = this.getAttribute('data-candidate-email');
                    resetCandidateVote(candidateEmail);
                });
            });
        }

        // Xóa ứng viên khỏi danh sách có quyền vote (KHÔNG xóa khỏi applications)
        async function removeCandidateFromVoting(candidateId, candidateEmail) {
            if (confirm('Bạn có chắc chắn muốn xóa ứng viên này khỏi danh sách có quyền vote?')) {
                try {
                    // Xóa khỏi collection voting_candidates
                    await db.collection('voting_candidates').doc(candidateId).delete();
                    
                    // Reload data
                    await loadVotingCandidates();
                    renderCandidateList();
                    renderStatistics();
                    
                    alert('Đã xóa ứng viên khỏi danh sách vote thành công');
                } catch (error) {
                    console.error('Error removing candidate from voting:', error);
                    alert('Có lỗi xảy ra khi xóa ứng viên khỏi danh sách vote');
                }
            }
        }

        // Reset vote của ứng viên (chỉ reset trong applications)
        async function resetCandidateVote(candidateEmail) {
            if (confirm('Bạn có chắc chắn muốn reset kết quả vote của ứng viên này?')) {
                try {
                    // Tìm application của ứng viên
                    const application = applications.find(app => app.email === candidateEmail);
                    
                    if (application) {
                        // Reset interview_schedule trong applications
                        await db.collection('applications').doc(application.id).update({
                            interview_schedule: []
                        });
                    }
                    
                    // Xóa votes của ứng viên này
                    const voteQuery = await db.collection('votes')
                        .where('candidateEmail', '==', candidateEmail)
                        .get();
                    
                    if (!voteQuery.empty) {
                        const batch = db.batch();
                        voteQuery.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                    }
                    
                    // Reload data
                    await loadApplications();
                    await syncVotingCandidatesWithApplications();
                    renderCandidateList();
                    renderStatistics();
                    
                    alert('Đã reset kết quả vote của ứng viên thành công');
                } catch (error) {
                    console.error('Error resetting candidate vote:', error);
                    alert('Có lỗi xảy ra khi reset kết quả vote');
                }
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    // Hide all tab contents
                    document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Show corresponding tab content
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).style.display = 'block';
                });
            });
            
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', function() {
                if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
                    auth.signOut().then(() => {
                        window.location.href = '../user/login.html';
                    }).catch(error => {
                        console.error('Error signing out:', error);
                    });
                }
            });
            
            // Add day button
            document.getElementById('add-day-btn').addEventListener('click', function() {
                const date = document.getElementById('interview-date').value;
                const slotsText = document.getElementById('time-slots').value;
                
                if (!date) {
                    alert('Vui lòng chọn ngày phỏng vấn');
                    return;
                }
                
                if (!slotsText.trim()) {
                    alert('Vui lòng nhập ít nhất một khung giờ');
                    return;
                }
                
                const slots = slotsText.split('\n').map(s => s.trim()).filter(s => s);
                
                // Format date to dd/mm/yyyy
                const dateObj = new Date(date);
                const formattedDate = `${dateObj.getDate().toString().padStart(2, '0')}/${(dateObj.getMonth() + 1).toString().padStart(2, '0')}/${dateObj.getFullYear()}`;
                
                // Check if day already exists
                const existingDayIndex = interviewSchedule.findIndex(day => day.date === formattedDate);
                
                if (existingDayIndex !== -1) {
                    // Add slots to existing day
                    interviewSchedule[existingDayIndex].slots = [...new Set([...interviewSchedule[existingDayIndex].slots, ...slots])];
                } else {
                    // Create new day
                    const newDay = {
                        id: 'day_' + Date.now(),
                        date: formattedDate,
                        slots: slots
                    };
                    
                    interviewSchedule.push(newDay);
                }
                
                // Reset form
                document.getElementById('interview-date').value = '';
                document.getElementById('time-slots').value = '';
                
                // Update UI
                renderCurrentSchedule();
            });
            
            // Save schedule button
            document.getElementById('save-schedule-btn').addEventListener('click', async function() {
                try {
                    await db.collection('system').doc('interview_schedule').set({
                        schedule: interviewSchedule,
                        published: false,
                        locked: false
                    }, { merge: true });
                    
                    alert('Lịch phỏng vấn đã được lưu thành công!');
                } catch (error) {
                    console.error('Error saving schedule:', error);
                    alert('Có lỗi xảy ra khi lưu lịch phỏng vấn');
                }
            });
            
            // Publish schedule button
            document.getElementById('publish-schedule-btn').addEventListener('click', async function() {
                if (interviewSchedule.length === 0) {
                    alert('Vui lòng tạo lịch phỏng vấn trước khi công bố');
                    return;
                }
                
                if (confirm('Bạn có chắc chắn muốn công bố lịch phỏng vấn này?')) {
                    try {
                        await db.collection('system').doc('interview_schedule').set({
                            schedule: interviewSchedule,
                            published: true,
                            locked: false
                        }, { merge: true });
                        
                        alert('Lịch phỏng vấn đã được công bố thành công!');
                    } catch (error) {
                        console.error('Error publishing schedule:', error);
                        alert('Có lỗi xảy ra khi công bố lịch phỏng vấn');
                    }
                }
            });
            
            // Load candidates from email list - THÊM VÀO DANH SÁCH CÓ QUYỀN VOTE
            document.getElementById('load-candidates-btn').addEventListener('click', async function() {
                const emailsText = document.getElementById('candidate-emails').value.trim();
                
                if (!emailsText) {
                    alert('Vui lòng nhập danh sách email ứng viên');
                    return;
                }
                
                const emails = emailsText.split('\n').map(email => email.trim()).filter(email => email);
                
                // Validate emails
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const invalidEmails = emails.filter(email => !emailRegex.test(email));
                
                if (invalidEmails.length > 0) {
                    alert(`Các email sau không hợp lệ: ${invalidEmails.join(', ')}`);
                    return;
                }
                
                try {
                    let addedCount = 0;
                    let existingCount = 0;
                    
                    for (const email of emails) {
                        // Kiểm tra xem ứng viên đã có trong danh sách vote chưa
                        const existing = votingCandidates.find(vc => vc.email === email);
                        
                        if (!existing) {
                            // Thêm vào collection voting_candidates
                            await db.collection('voting_candidates').add({
                                email: email,
                                addedAt: new Date(),
                                addedBy: currentUser.email
                            });
                            addedCount++;
                        } else {
                            existingCount++;
                        }
                    }
                    
                    // Reload data
                    await loadVotingCandidates();
                    renderCandidateList();
                    renderStatistics();
                    
                    // Clear input
                    document.getElementById('candidate-emails').value = '';
                    
                    let message = `Đã thêm ${addedCount} ứng viên vào danh sách có quyền vote`;
                    if (existingCount > 0) {
                        message += ` (${existingCount} ứng viên đã tồn tại trong danh sách)`;
                    }
                    alert(message);
                } catch (error) {
                    console.error('Error adding candidates to voting list:', error);
                    alert('Có lỗi xảy ra khi thêm ứng viên vào danh sách vote');
                }
            });
            
            // Xóa toàn bộ ứng viên khỏi danh sách vote (KHÔNG xóa khỏi applications)
            document.getElementById('clear-candidates-btn').addEventListener('click', async function() {
                if (confirm('Bạn có chắc chắn muốn xóa TOÀN BỘ ứng viên khỏi danh sách có quyền vote? Hành động này không thể hoàn tác.')) {
                    try {
                        // Xóa toàn bộ documents trong collection voting_candidates
                        const snapshot = await db.collection('voting_candidates').get();
                        
                        if (snapshot.empty) {
                            alert('Không có ứng viên nào trong danh sách vote để xóa');
                            return;
                        }
                        
                        const batch = db.batch();
                        
                        snapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        await batch.commit();
                        
                        // Reload data
                        await loadVotingCandidates();
                        renderCandidateList();
                        renderStatistics();
                        
                        alert('Đã xóa toàn bộ ứng viên khỏi danh sách vote thành công');
                    } catch (error) {
                        console.error('Error clearing voting candidates:', error);
                        alert('Có lỗi xảy ra khi xóa ứng viên khỏi danh sách vote');
                    }
                }
            });
            
            // Xóa dữ liệu vote (chỉ reset interview_schedule và xóa votes)
            document.getElementById('clear-votes-btn').addEventListener('click', async function() {
                if (confirm('Bạn có chắc chắn muốn xóa toàn bộ dữ liệu vote? Hành động này không thể hoàn tác.')) {
                    try {
                        // Reset interview_schedule cho tất cả applications
                        const batch = db.batch();
                        
                        applications.forEach(app => {
                            const appRef = db.collection('applications').doc(app.id);
                            batch.update(appRef, { interview_schedule: [] });
                        });
                        
                        await batch.commit();
                        
                        // Xóa toàn bộ votes
                        const votesSnapshot = await db.collection('votes').get();
                        const deleteBatch = db.batch();
                        
                        votesSnapshot.docs.forEach(doc => {
                            deleteBatch.delete(doc.ref);
                        });
                        
                        await deleteBatch.commit();
                        
                        // Reload data
                        await Promise.all([
                            loadApplications(),
                            loadVotes()
                        ]);
                        await syncVotingCandidatesWithApplications();
                        
                        renderCandidateList();
                        renderStatistics();
                        
                        alert('Đã xóa toàn bộ dữ liệu vote thành công');
                    } catch (error) {
                        console.error('Error clearing votes:', error);
                        alert('Có lỗi xảy ra khi xóa dữ liệu vote');
                    }
                }
            });
            
            // Lock schedule button
            document.getElementById('lock-schedule-btn').addEventListener('click', async function() {
                if (confirm('Bạn có chắc chắn muốn khóa lịch phỏng vấn? Ứng viên sẽ không thể chọn lịch sau khi khóa.')) {
                    try {
                        await db.collection('system').doc('interview_schedule').set({
                            locked: true
                        }, { merge: true });
                        
                        alert('Đã khóa lịch phỏng vấn thành công!');
                    } catch (error) {
                        console.error('Error locking schedule:', error);
                        alert('Có lỗi xảy ra khi khóa lịch phỏng vấn');
                    }
                }
            });
            
            // Export schedule button
            document.getElementById('export-schedule-btn').addEventListener('click', function() {
                exportScheduleToExcel();
            });
            
            // Close modal buttons
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
        });

        // Export schedule to Excel
        function exportScheduleToExcel() {
            if (interviewSchedule.length === 0) {
                alert('Không có lịch phỏng vấn để xuất');
                return;
            }
            
            // Create data array
            const data = [];
            
            // Add headers
            data.push(['Ngày', 'Khung giờ', 'Số lượng ứng viên', 'Danh sách ứng viên']);
            
            // Calculate counts for each slot
            const slotCandidates = {};
            
            candidates.forEach(candidate => {
                if (candidate.interview_schedule) {
                    candidate.interview_schedule.forEach(slot => {
                        if (!slotCandidates[slot]) {
                            slotCandidates[slot] = [];
                        }
                        slotCandidates[slot].push(candidate.name || candidate.email);
                    });
                }
            });
            
            // Add data rows
            interviewSchedule.forEach(day => {
                day.slots.forEach(slot => {
                    const slotId = `${day.id}_${slot.replace(/\s+/g, '_')}`;
                    const candidatesList = slotCandidates[slotId] || [];
                    const count = candidatesList.length;
                    
                    data.push([
                        day.date, 
                        slot, 
                        count,
                        candidatesList.join(', ')
                    ]);
                });
            });
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Lịch phỏng vấn');
            
            // Generate file and download
            XLSX.writeFile(wb, 'lich_phong_van.xlsx');
        }
        
        // Publish schedule button - CẬP NHẬT
        document.getElementById('publish-schedule-btn').addEventListener('click', async function() {
            if (interviewSchedule.length === 0) {
                alert('Vui lòng tạo lịch phỏng vấn trước khi công bố');
                return;
            }
            
            if (confirm('Bạn có chắc chắn muốn công bố lịch phỏng vấn này?')) {
                try {
                    await db.collection('system').doc('interview_schedule').set({
                        schedule: interviewSchedule,
                        published: true,
                        locked: false,
                        published_at: new Date() // Thêm thời gian công bố
                    }, { merge: true });
                    
                    alert('Lịch phỏng vấn đã được công bố thành công!');
                } catch (error) {
                    console.error('Error publishing schedule:', error);
                    alert('Có lỗi xảy ra khi công bố lịch phỏng vấn');
                }
            }
        });
    </script>
</body>
</html>