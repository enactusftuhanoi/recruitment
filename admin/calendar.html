<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar | Enactus FTU Hanoi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Clash+Display:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root {
            --primary: #F8F3CE;
            --primary-light: #FFD54F;
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --white: #FFFFFF;
            --error: #EF4444;
            --error-light: #FEE2E2;
            --success: #10B981;
            --success-light: #D1FAE5;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --info: #3B82F6;
            --info-light: #DBEAFE;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        body {
            background-color: var(--gray-50);
            color: var(--gray-800);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background-color: var(--white);
            padding: 16px 24px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 50px;
            width: auto;
        }

        .nav-links {
            display: flex;
            gap: 16px;
        }

        .nav-link {
            padding: 8px 16px;
            border-radius: var(--border-radius);
            color: var(--gray-700);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }

        .nav-link:hover, .nav-link.active {
            background-color: var(--primary);
            color: var(--gray-800);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--gray-800);
        }

        .logout-btn {
            padding: 8px 16px;
            background-color: var(--gray-100);
            border: none;
            border-radius: var(--border-radius);
            color: var(--gray-700);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }

        .logout-btn:hover {
            background-color: var(--error-light);
            color: var(--error);
        }

        .logout-btn i {
            margin-right: 8px;
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: var(--transition);
        }

        .tab.active {
            color: var(--gray-900);
            border-bottom-color: var(--primary);
        }

        .tab:hover:not(.active) {
            color: var(--gray-800);
        }

        /* Card */
        .card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .card-header {
            margin-bottom: 20px;
        }

        .card-title {
            font-family: 'Clash Display', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .card-subtitle {
            color: var(--gray-600);
        }

        /* Interview Schedule */
        .interview-day {
            margin-bottom: 32px;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .day-header {
            background-color: var(--gray-100);
            padding: 16px;
            font-weight: 600;
            color: var(--gray-800);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-count {
            background-color: var(--info);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            padding: 16px;
        }

        .time-slot {
            position: relative;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 12px;
        }

        .slot-time {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .slot-count {
            font-size: 14px;
            color: var(--gray-600);
        }

        /* Vote Results */
        .vote-results {
            margin-top: 20px;
        }

        .vote-item {
            margin-bottom: 16px;
            padding: 16px;
            background-color: var(--gray-50);
            border-radius: var(--border-radius);
        }

        .vote-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .vote-option {
            font-weight: 600;
        }

        .vote-count {
            color: var(--gray-600);
        }

        .vote-bar-wrap {
            height: 8px;
            background-color: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .vote-bar {
            height: 100%;
            background-color: var(--success);
            transition: width 0.3s ease;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(248, 243, 206, 0.3);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--gray-800);
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
        }

        .btn-secondary {
            background-color: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background-color: var(--gray-300);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #0da271;
        }

        .btn i {
            margin-right: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px 20px;
        }

        .loading i {
            font-size: 32px;
            color: var(--gray-400);
            margin-bottom: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .time-slots {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <img src="/assets/logo_den.png" alt="Enactus FTU Hanoi Logo">
        </div>
        
        <div class="nav-links">
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="calendar.html" class="nav-link active">Lịch & Vote</a>
            <a href="accounts.html" class="nav-link">Tài khoản</a>
        </div>
        
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">A</div>
            <button class="logout-btn" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                Đăng xuất
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="tabs">
            <button class="tab active" data-tab="schedule">Lịch phỏng vấn</button>
            <button class="tab" data-tab="votes">Kết quả Vote</button>
            <button class="tab" data-tab="manage">Quản lý Lịch</button>
        </div>

        <div id="loading" class="loading">
            <i class="fas fa-spinner"></i>
            <p>Đang tải dữ liệu...</p>
        </div>

        <!-- Schedule Tab -->
        <div id="schedule-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Lịch phỏng vấn ứng viên</h2>
                    <p class="card-subtitle">Tổng quan về lịch phỏng vấn đã được ứng viên chọn</p>
                </div>

                <div id="interview-schedule">
                    <!-- Interview schedule will be populated by JavaScript -->
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="export-schedule-btn">
                        <i class="fas fa-download"></i>
                        Xuất lịch phỏng vấn
                    </button>
                </div>
            </div>
        </div>

        <!-- Votes Tab -->
        <div id="votes-tab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Kết quả Vote ứng viên</h2>
                    <p class="card-subtitle">Tổng hợp kết quả vote từ các ban cho ứng viên</p>
                </div>

                <div class="form-group">
                    <label class="form-label">Chọn ứng viên</label>
                    <select class="form-select" id="candidate-select">
                        <option value="">-- Chọn ứng viên --</option>
                    </select>
                </div>

                <div id="vote-results">
                    <!-- Vote results will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Manage Tab -->
        <div id="manage-tab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Quản lý lịch phỏng vấn</h2>
                    <p class="card-subtitle">Tạo và quản lý lịch phỏng vấn cho ứng viên chọn</p>
                </div>

                <div class="form-group">
                    <label class="form-label">Lịch phỏng vấn hiện tại</label>
                    <div id="current-schedule">
                        <!-- Current schedule will be populated by JavaScript -->
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Thêm ngày phỏng vấn</label>
                    <div class="form-group">
                        <input type="date" class="form-input" id="interview-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Thêm khung giờ (mỗi khung giờ một dòng, ví dụ: 08:00 - 09:00)</label>
                        <textarea class="form-textarea" id="time-slots" placeholder="08:00 - 09:00&#10;09:00 - 10:00&#10;10:00 - 11:00"></textarea>
                    </div>
                    <button class="btn btn-secondary" id="add-day-btn">
                        <i class="fas fa-plus"></i>
                        Thêm ngày
                    </button>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="save-schedule-btn">
                        <i class="fas fa-save"></i>
                        Lưu lịch phỏng vấn
                    </button>
                    <button class="btn btn-success" id="publish-schedule-btn">
                        <i class="fas fa-bell"></i>
                        Công bố lịch phỏng vấn
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOP2j0qV0Ge-q2-Y9zo9Qc3eLmgtVOK3k",
            authDomain: "recruitment-enactusftuhanoi.firebaseapp.com",
            projectId: "recruitment-enactusftuhanoi",
            storageBucket: "recruitment-enactusftuhanoi.firebasestorage.app",
            messagingSenderId: "658928769643",
            appId: "1:658928769643:web:ef4e26633b7c41c922ef2e",
            measurementId: "G-BJT7ZPKYE3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global State
        let currentUser = null;
        let interviewSchedule = [];
        let applications = [];
        let votes = [];

        // Check authentication and admin role
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-avatar').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'A';
                
                try {
                    // Check if user is admin or superadmin - SỬA LẠI ĐÂY
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (!userDoc.exists) {
                        // Try to check in account collection (theo cấu trúc response.js)
                        const accountSnapshot = await db.collection('account')
                            .where('email', '==', user.email)
                            .limit(1)
                            .get();
                        
                        if (!accountSnapshot.empty) {
                            const accountData = accountSnapshot.docs[0].data();
                            const userRole = accountData.role;
                            
                            // Allow both admin and superadmin - SỬA LẠI ĐÂY
                            if (userRole !== 'admin' && userRole !== 'superadmin') {
                                window.location.href = '../user/profile.html';
                                return;
                            }
                        } else {
                            // Not found in either collection, redirect to user page
                            window.location.href = '../user/profile.html';
                            return;
                        }
                    } else {
                        const userData = userDoc.data();
                        // Allow both admin and superadmin - SỬA LẠI ĐÂY
                        if (userData.role !== 'admin' && userData.role !== 'superadmin') {
                            window.location.href = '../user/profile.html';
                            return;
                        }
                    }
                    
                    // Load data
                    await Promise.all([
                        loadInterviewSchedule(),
                        loadApplications(),
                        loadVotes()
                    ]);
                    
                    document.getElementById('loading').style.display = 'none';
                    renderInterviewSchedule();
                    populateCandidateSelect();
                    
                } catch (error) {
                    console.error('Error checking admin role:', error);
                    alert('Có lỗi xảy ra khi kiểm tra quyền truy cập');
                }
            } else {
                // User is not signed in, redirect to login
                window.location.href = '../user/login.html';
            }
        });

        // Load interview schedule
        async function loadInterviewSchedule() {
            try {
                const scheduleDoc = await db.collection('system').doc('interview_schedule').get();
                
                if (scheduleDoc.exists) {
                    interviewSchedule = scheduleDoc.data().schedule;
                } else {
                    
                    // Save default schedule
                    await db.collection('system').doc('interview_schedule').set({
                        schedule: interviewSchedule,
                        published: false
                    });
                }
            } catch (error) {
                console.error('Error loading interview schedule:', error);
            }
        }

        // Load applications
        async function loadApplications() {
            try {
                const snapshot = await db.collection('applications').get();
                applications = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        ...data
                    };
                });
            } catch (error) {
                console.error('Error loading applications:', error);
            }
        }

        // Load votes
        async function loadVotes() {
            try {
                const snapshot = await db.collection('votes').get();
                votes = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        ...data
                    };
                });
            } catch (error) {
                console.error('Error loading votes:', error);
            }
        }

        // Render interview schedule
        function renderInterviewSchedule() {
            const container = document.getElementById('interview-schedule');
            container.innerHTML = '';
            
            if (interviewSchedule.length === 0) {
                container.innerHTML = '<p>Chưa có lịch phỏng vấn nào được tạo.</p>';
                return;
            }
            
            // Calculate counts for each slot
            const slotCounts = {};
            
            applications.forEach(app => {
                if (app.interview_schedule) {
                    app.interview_schedule.forEach(slot => {
                        slotCounts[slot] = (slotCounts[slot] || 0) + 1;
                    });
                }
            });
            
            interviewSchedule.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'interview-day';
                
                let dayHTML = `
                    <div class="day-header">
                        <span>${day.date}</span>
                        <span class="day-count">${day.slots.length} khung giờ</span>
                    </div>
                    <div class="time-slots">
                `;
                
                day.slots.forEach(slot => {
                    const slotId = `${day.id}_${slot.replace(/\s+/g, '_')}`;
                    const count = slotCounts[slotId] || 0;
                    
                    dayHTML += `
                        <div class="time-slot">
                            <div class="slot-time">${slot}</div>
                            <div class="slot-count">${count} ứng viên</div>
                        </div>
                    `;
                });
                
                dayHTML += `</div>`;
                dayElement.innerHTML = dayHTML;
                container.appendChild(dayElement);
            });
            
            // Also render in manage tab
            renderCurrentSchedule();
        }

        // Render current schedule in manage tab
        function renderCurrentSchedule() {
            const container = document.getElementById('current-schedule');
            container.innerHTML = '';
            
            if (interviewSchedule.length === 0) {
                container.innerHTML = '<p>Chưa có lịch phỏng vấn nào được tạo.</p>';
                return;
            }
            
            interviewSchedule.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'interview-day';
                
                let dayHTML = `
                    <div class="day-header">
                        <span>${day.date}</span>
                        <button class="btn btn-secondary remove-day-btn" data-day="${day.id}">
                            <i class="fas fa-trash"></i>
                            Xóa
                        </button>
                    </div>
                    <div class="time-slots">
                `;
                
                day.slots.forEach(slot => {
                    dayHTML += `
                        <div class="time-slot">
                            <div class="slot-time">${slot}</div>
                        </div>
                    `;
                });
                
                dayHTML += `</div>`;
                dayElement.innerHTML = dayHTML;
                container.appendChild(dayElement);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-day-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const dayId = this.getAttribute('data-day');
                    removeDay(dayId);
                });
            });
        }

        // Remove day from schedule
        function removeDay(dayId) {
            if (confirm('Bạn có chắc chắn muốn xóa ngày này khỏi lịch phỏng vấn?')) {
                interviewSchedule = interviewSchedule.filter(day => day.id !== dayId);
                renderCurrentSchedule();
            }
        }

        // Populate candidate select
        function populateCandidateSelect() {
            const select = document.getElementById('candidate-select');
            select.innerHTML = '<option value="">-- Chọn ứng viên --</option>';
            
            applications.forEach(app => {
                const option = document.createElement('option');
                option.value = app.id;
                option.textContent = `${app.fullname || 'Chưa có tên'} - ${app.email}`;
                select.appendChild(option);
            });
            
            // Add change event
            select.addEventListener('change', function() {
                if (this.value) {
                    showVoteResults(this.value);
                } else {
                    document.getElementById('vote-results').innerHTML = '';
                }
            });
        }

        // Show vote results for a candidate
        function showVoteResults(candidateId) {
            const candidate = applications.find(app => app.id === candidateId);
            const candidateVotes = votes.filter(vote => vote.candidate_id === candidateId);
            
            const container = document.getElementById('vote-results');
            
            if (!candidate) {
                container.innerHTML = '<p>Không tìm thấy thông tin ứng viên.</p>';
                return;
            }
            
            let html = `
                <div class="vote-results">
                    <h3>Kết quả vote cho ${candidate.fullname || 'Ứng viên'}</h3>
                    <p>Email: ${candidate.email}</p>
                    <p>Vị trí ứng tuyển: ${candidate.priority_position ? getDepartmentName(candidate.priority_position) : 'Chưa có'}</p>
            `;
            
            if (candidateVotes.length === 0) {
                html += '<p>Chưa có vote nào cho ứng viên này.</p>';
            } else {
                // Group votes by department
                const deptVotes = {};
                
                candidateVotes.forEach(vote => {
                    if (!deptVotes[vote.department]) {
                        deptVotes[vote.department] = {
                            yes: 0,
                            no: 0,
                            total: 0
                        };
                    }
                    
                    if (vote.vote === 'yes') {
                        deptVotes[vote.department].yes++;
                    } else {
                        deptVotes[vote.department].no++;
                    }
                    
                    deptVotes[vote.department].total++;
                });
                
                // Render vote results by department
                for (const dept in deptVotes) {
                    const deptVote = deptVotes[dept];
                    const yesPercentage = (deptVote.yes / deptVote.total) * 100;
                    
                    html += `
                        <div class="vote-item">
                            <div class="vote-meta">
                                <span class="vote-option">${dept}</span>
                                <span class="vote-count">${deptVote.yes}/${deptVote.total} (${yesPercentage.toFixed(1)}%)</span>
                            </div>
                            <div class="vote-bar-wrap">
                                <div class="vote-bar" style="width: ${yesPercentage}%"></div>
                            </div>
                        </div>
                    `;
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Helper function to get department name
        function getDepartmentName(code) {
            const departments = {
                'MD': 'Truyền thông',
                'HR': 'Nhân sự',
                'ER': 'Đối ngoại',
                'PD': 'Dự án'
            };
            return departments[code] || code;
        }

        // Add day to schedule
        document.getElementById('add-day-btn').addEventListener('click', function() {
            const dateInput = document.getElementById('interview-date');
            const slotsTextarea = document.getElementById('time-slots');
            
            if (!dateInput.value) {
                alert('Vui lòng chọn ngày phỏng vấn');
                return;
            }
            
            if (!slotsTextarea.value.trim()) {
                alert('Vui lòng nhập ít nhất một khung giờ');
                return;
            }
            
            // Parse date
            const date = new Date(dateInput.value);
            const formattedDate = date.toLocaleDateString('vi-VN', {
                weekday: 'long',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            
            // Parse time slots
            const slots = slotsTextarea.value.split('\n')
                .map(slot => slot.trim())
                .filter(slot => slot.length > 0);
            
            // Add to schedule
            const newDay = {
                id: 'day_' + Date.now(),
                date: formattedDate,
                slots: slots
            };
            
            interviewSchedule.push(newDay);
            renderCurrentSchedule();
            
            // Clear inputs
            dateInput.value = '';
            slotsTextarea.value = '';
        });

        // Save schedule
        document.getElementById('save-schedule-btn').addEventListener('click', async function() {
            try {
                await db.collection('system').doc('interview_schedule').set({
                    schedule: interviewSchedule,
                    updated: new Date()
                });
                
                alert('Đã lưu lịch phỏng vấn thành công!');
            } catch (error) {
                console.error('Error saving schedule:', error);
                alert('Có lỗi xảy ra khi lưu lịch phỏng vấn');
            }
        });

        // Publish schedule
        document.getElementById('publish-schedule-btn').addEventListener('click', async function() {
            if (interviewSchedule.length === 0) {
                alert('Vui lòng tạo lịch phỏng vấn trước khi công bố');
                return;
            }
            
            if (confirm('Bạn có chắc chắn muốn công bố lịch phỏng vấn này cho ứng viên?')) {
                try {
                    await db.collection('system').doc('interview_schedule').update({
                        published: true,
                        published_at: new Date()
                    });
                    
                    alert('Đã công bố lịch phỏng vấn thành công!');
                } catch (error) {
                    console.error('Error publishing schedule:', error);
                    alert('Có lỗi xảy ra khi công bố lịch phỏng vấn');
                }
            }
        });

// Export schedule - FIXED SLOT MATCHING
document.getElementById('export-schedule-btn').addEventListener('click', function() {
    // Chuẩn bị dữ liệu
    const data = [];
    
    // Tạo header
    const header = ['STT', 'Họ và tên', 'Email', 'SĐT', 'Ban ưu tiên', 'Ban dự bị'];
    
    // Tạo mapping slot - QUAN TRỌNG: tạo đúng format slotId
    const slotMapping = [];
    let currentHeaderIndex = 6; // Bắt đầu từ cột thứ 7

    interviewSchedule.forEach(day => {
        day.slots.forEach(slot => {
            const headerName = `${day.date} - ${slot}`;
            header.push(headerName);
            
            // Tạo slotKey theo ĐÚNG format đang dùng trong ứng dụng
            // Format phải khớp với cách lưu trong interview_schedule của ứng viên
            const slotKey = `${day.id}_${slot.replace(/\s+/g, '_').replace(/-/g, '_')}`;
            
            slotMapping.push({
                key: slotKey,
                header: headerName,
                index: currentHeaderIndex
            });
            
            currentHeaderIndex++;
        });
    });

    data.push(header);
    
    // DEBUG: Log tất cả slot mapping
    console.log('=== SLOT MAPPING ===');
    slotMapping.forEach(slot => {
        console.log(`Slot: ${slot.key} -> Column: ${slot.index}`);
    });

    // Dữ liệu ứng viên
    let stt = 1;
    let hasData = false;
    
    applications.forEach(app => {
        // Lấy ban dự bị - thử nhiều field
        const backupDept = app.backup_position || app.backup_department || app.secondary_position || app.backup || '';
        
        const row = [
            stt++,
            app.fullname || 'Chưa có tên',
            app.email || '',
            app.phone || '',
            app.priority_position ? getDepartmentName(app.priority_position) : '',
            backupDept ? getDepartmentName(backupDept) : ''
        ];
        
        // Khởi tạo tất cả các ca là rỗng
        for (let i = 0; i < header.length - 6; i++) {
            row.push('');
        }

        // Đánh dấu X cho các ca đã chọn - FIX QUAN TRỌNG
        if (app.interview_schedule && app.interview_schedule.length > 0) {
            hasData = true;
            
            console.log(`=== ỨNG VIÊN: ${app.fullname} ===`);
            console.log('Slot đã chọn:', app.interview_schedule);
            
            app.interview_schedule.forEach(slotId => {
                console.log(`🔍 Đang tìm slot: "${slotId}"`);
                
                // TÌM SLOT THEO NHIỀU CÁCH KHÁC NHAU
                let foundSlot = null;
                
                // Cách 1: So sánh chính xác
                foundSlot = slotMapping.find(item => item.key === slotId);
                
                // Cách 2: Nếu không tìm thấy, thử normalize
                if (!foundSlot) {
                    const normalizedSlotId = slotId.replace(/\s+/g, '_').replace(/-/g, '_');
                    foundSlot = slotMapping.find(item => item.key === normalizedSlotId);
                }
                
                // Cách 3: Thử tìm bằng phần đầu (dayId)
                if (!foundSlot) {
                    const dayIdPart = slotId.split('_')[0];
                    foundSlot = slotMapping.find(item => item.key.startsWith(dayIdPart + '_'));
                }
                
                // Cách 4: Thử tìm bằng contains
                if (!foundSlot) {
                    foundSlot = slotMapping.find(item => slotId.includes(item.key.split('_')[1]));
                }
                
                if (foundSlot) {
                    row[foundSlot.index] = 'X';
                    console.log(`✅ Đã đánh dấu X tại cột ${foundSlot.index}: ${foundSlot.header}`);
                } else {
                    console.log(`❌ KHÔNG tìm thấy slot: ${slotId}`);
                    console.log('Các slot available:', slotMapping.map(s => s.key));
                    
                    // THỬ TẠO SLOT KEY TỪ DỮ LIỆU GỐC
                    const dayMatch = interviewSchedule.find(day => 
                        slotId.includes(day.id) || day.id.includes(slotId.split('_')[0])
                    );
                    
                    if (dayMatch) {
                        // Thử tìm slot time trong day đó
                        const timeMatch = dayMatch.slots.find(slot => {
                            const slotTime = slot.replace(/\s+/g, '_').replace(/-/g, '_');
                            return slotId.includes(slotTime) || slotTime.includes(slotId.split('_')[1]);
                        });
                        
                        if (timeMatch) {
                            const reconstructedKey = `${dayMatch.id}_${timeMatch.replace(/\s+/g, '_').replace(/-/g, '_')}`;
                            const reconstructedSlot = slotMapping.find(item => item.key === reconstructedKey);
                            if (reconstructedSlot) {
                                row[reconstructedSlot.index] = 'X';
                                console.log(`✅ Đánh dấu X bằng reconstructed key: ${reconstructedKey}`);
                            }
                        }
                    }
                }
            });
        }
        
        data.push(row);
    });

    // Nếu không có ứng viên nào có lịch
    if (!hasData) {
        const emptyRow = ['1', 'Không có ứng viên nào chọn lịch', '', '', '', ''];
        for (let i = 0; i < header.length - 6; i++) {
            emptyRow.push('');
        }
        data.push(emptyRow);
    }

    // Tạo worksheet
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // Set column widths
    const colWidths = [];
    for (let i = 0; i < header.length; i++) {
        if (i === 1) colWidths.push({wch: 25}); // Họ tên
        else if (i === 2) colWidths.push({wch: 30}); // Email
        else if (i >= 6) colWidths.push({wch: 22}); // Các cột slot (rộng hơn)
        else colWidths.push({wch: 15});
    }
    ws['!cols'] = colWidths;
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Lịch phỏng vấn');
    
    // Export
    XLSX.writeFile(wb, 'lich_phong_van_enactus_' + new Date().toISOString().split('T')[0] + '.xlsx');
    
    alert('Đã export lịch phỏng vấn thành công!');
});

// Helper function FIXED - tìm index của time slot trong header
function findTimeSlotIndex(slotId, slotMapping, header) {
    console.log('🔍 Tìm slotId:', slotId);
    
    // Tìm trong mapping trước
    const mappedSlot = slotMapping.find(item => item.key === slotId);
    if (mappedSlot) {
        const index = header.indexOf(mappedSlot.header);
        console.log('📍 Tìm thấy qua mapping:', index);
        return index;
    }
    
    // Fallback: thử các format khác
    const alternativeFormats = [
        slotId,
        slotId.replace(/_/g, ' '),
        slotId.replace(/_/g, ' - ')
    ];
    
    for (const format of alternativeFormats) {
        const index = header.findIndex(h => h.includes(format));
        if (index !== -1) {
            console.log('📍 Tìm thấy với format thay thế:', index);
            return index;
        }
    }
    
    console.log('❌ Không tìm thấy slot:', slotId);
    return -1;
}
        
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show corresponding content
                const tabId = this.getAttribute('data-tab');
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                document.getElementById(`${tabId}-tab`).style.display = 'block';
            });
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = '../user/login.html';
            });
        });
    </script>
</body>
</html>